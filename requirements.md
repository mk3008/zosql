# zosql 要件定義書

## 1. プロジェクト概要

### 1.1 背景と課題
SQLの構文には以下の根本的な問題がある：
- 1文しか記述できず、長文になりがち
- CTEは可読性に貢献するが効果は限定的
- ファイル分割ができない（通常のプログラミング言語では可能）
- ユニットテストができない
- デバッグ時にコードを破壊する必要がある（コメントアウトによる部分テスト）

### 1.2 解決方針
- 長大なSQLを実行可能な単位に分割し、独立して保守可能にする
- 分割したSQLを元の状態に合成できるようにする
- 既存のSQL仕様・知識・リソースを最大限活用（独自構文は避ける）
- CTEをimport文のように扱い、モジュール化を実現

## 2. 機能要件

### 2.1 SQL分解機能
- 複雑なSQLクエリをCTE単位で分解
- 各CTEを独立した実行可能なSQLファイルとして出力
- CTE間の依存関係を保持・管理
- 再帰的な分解（CTEがCTEを参照する場合）に対応
- （将来課題）UNIONクエリの分解対応
  - 複数のUNIONグループの識別方法
  - 復元可能性の担保方法
- （将来課題）サブクエリのCTEへの格上げ
  - 自動的な名前付けの方法
  - どのサブクエリを格上げするかの基準

### 2.2 SQL合成機能
- 分解されたCTEファイルから元のSQLを再構築
- CTEをワンライナーで表現し、import文のような簡潔な記述を実現
- 内部参照のみのCTEは改行せずにコンパクトに表示

### 2.3 デバッグサポート
- SQL100%互換を維持（VSCode拡張機能でのデバッグ実行を可能に）
- デバッグ用パラメータのコメントベース管理
  ```sql
  --@debug
  WHERE user_id = 123
  --@debug
  /* @prod
  WHERE user_id = :user_id
  */
  ```
- 合成時にデバッグブロックを無視（デフォルトで有効）

### 2.4 開発支援機能
- ファイル変更の監視（watch機能）
- 変更時の自動再合成
- 静的SQL解析（DB接続不要）

## 3. 非機能要件

### 3.1 対応環境
- データベース：PostgreSQL（rawsql-tsの特性によりDB非依存の見込み）
- 実行環境：Node.js
- 形態：CLIツール（PoCとして軽量に実装）

### 3.2 パフォーマンス
- 5000行規模のSQLに対応
- CTEの数：10個以上に対応
- 合成後は100行以下への圧縮表示を目標

### 3.3 保守性
- 本番環境での既存SQL保守が主用途
- 将来的にはCTEライブラリとしての再利用を想定
- チーム開発でのリソース共有に対応

## 4. 技術仕様

### 4.1 使用技術
- 言語：TypeScript
- コアライブラリ：rawsql-ts
  - SQL解析（AST生成）
  - CTE抽出・分解
  - SQL再構築・フォーマット
  - コメント解析

### 4.2 ファイル命名規則（案）
- メインSQL：`main.sql`
- CTEファイル：`{cte_name}.cte.sql`
- デバッグ用：コメントベースで同一ファイル内に記述

### 4.3 アーキテクチャ
- rawsql-tsとzosqlの関係性
  - rawsql-ts：コア機能（ブラウザでも動作）
  - zosql：CLIツールとして実装
  - コア化可能な機能はrawsql-tsへ移行

## 5. 開発方針

### 5.1 フェーズ
1. PoC実装（最小限の分解・合成機能）
2. 有効性の検証
3. 機能拡張（要件変更に柔軟に対応）

### 5.2 AI協調開発
- AIとの共同保守・開発を前提
- コメントベースの記述によりコンテキスト把握を容易に
- 変更履歴の追跡しやすさを重視

## 6. 期待される効果

- 5000行のSQLを100行以下に圧縮表示
- 各CTEの独立したテスト・デバッグが可能
- 問題箇所の特定と修正が容易
- CTEの再利用によるSQL開発の効率化