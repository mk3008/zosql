var e,t,i,n,s,r,a,l,o,u,h,p,c,d,m,w,f,y,v,C,x,E,g,S,k,T,b,I,N,A,O,P,$,L,F,_,R,B,Q,q,U,W,V,K,j,M,D,z,J,H,G,Y,X,Z,ee,te,ie,ne,se,re,ae,le,oe,ue,he,pe,ce,de,me,we,fe,ye,ve,Ce,xe,Ee,ge=class{constructor(){this.comments=null}getKind(){return this.constructor.kind}accept(e){return e.visit(this)}toSqlString(e){return this.accept(e)}},Se=((e=class extends ge{constructor(e){super(),this.insertClause=e.insertClause,this.selectQuery=e.selectQuery??null}}).kind=Symbol("InsertQuery"),e),ke=((t=class extends ge{constructor(e){super(),this.selectQuery=e}}).kind=Symbol("InlineQuery"),t),Te=((i=class extends ge{constructor(e){super(),this.values=e}}).kind=Symbol("ValueList"),i),be=(n=class extends ge{get namespaces(){return this.qualifiedName.namespaces}get column(){return this.qualifiedName.name instanceof We?this.qualifiedName.name:new We(this.qualifiedName.name.value)}constructor(e,t){super();let i="string"==typeof t?new We(t):t;this.qualifiedName=new it(Ze(e),i)}toString(){return this.qualifiedName.toString()}getNamespace(){return this.qualifiedName.namespaces?this.qualifiedName.namespaces.map(e=>e.name).join("."):""}},n.kind=Symbol("ColumnReference"),n),Ie=(s=class extends ge{constructor(e,t,i,n,s=null){super(),this.qualifiedName=new it(e,t),this.argument=i,this.over=n,this.withinGroup=s}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}},s.kind=Symbol("FunctionCall"),s),Ne=((Ee=Ne||{}).Rows="rows",Ee.Range="range",Ee.Groups="groups",Ee),Ae=(e=>(e.UnboundedPreceding="unbounded preceding",e.UnboundedFollowing="unbounded following",e.CurrentRow="current row",e))(Ae||{}),Oe=((r=class extends ge{constructor(e){super(),this.bound=e}}).kind=Symbol("WindowFrameStaticBound"),r),Pe=(a=class extends ge{constructor(e,t){super(),this.value=e,this.isFollowing=t}},a.kind=Symbol("WindowFrameBoundary"),a),$e=(l=class extends ge{constructor(e,t,i){super(),this.frameType=e,this.startBound=t,this.endBound=i}},l.kind=Symbol("WindowFrameSpec"),l),Le=(o=class extends ge{constructor(e,t,i=null){super(),this.partition=e,this.order=t,this.frameSpec=i}},o.kind=Symbol("WindowFrameExpression"),o),Fe=(u=class extends ge{constructor(e,t){super(),this.operator=new Ue(e),this.expression=t}},u.kind=Symbol("UnaryExpression"),u),_e=(h=class extends ge{constructor(e,t,i){super(),this.left=e,this.operator=new Ue(t),this.right=i}},h.kind=Symbol("BinaryExpression"),h),Re=(p=class extends ge{constructor(e,t){super(),this.value=e,this.isDollarString=t}},p.kind=Symbol("LiteralExpression"),p),Be=(c=class extends ge{constructor(e,t=null){super(),this.name=new Ue(e),this.value=t,this.index=null}},c.kind=Symbol("ParameterExpression"),c),Qe=(d=class extends ge{constructor(e,t=null){super(),this.cases=e,this.elseValue=t}},d.kind=Symbol("SwitchCaseArgument"),d),qe=(m=class extends ge{constructor(e,t){super(),this.key=e,this.value=t}},m.kind=Symbol("CaseKeyValuePair"),m),Ue=((w=class extends ge{constructor(e){super(),this.value=e}}).kind=Symbol("RawString"),w),We=((f=class extends ge{constructor(e){super(),this.name=e}}).kind=Symbol("IdentifierString"),f),Ve=((y=class extends ge{constructor(e){super(),this.expression=e}}).kind=Symbol("ParenExpression"),y),Ke=(v=class extends ge{constructor(e,t){super(),this.input=e,this.castType=t}},v.kind=Symbol("CastExpression"),v),je=(C=class extends ge{constructor(e,t){super(),this.condition=e,this.switchCase=t}},C.kind=Symbol("CaseExpression"),C),Me=((x=class extends ge{constructor(e){super(),this.expression=e}}).kind=Symbol("ArrayExpression"),x),De=((E=class extends ge{constructor(e){super(),this.query=e}}).kind=Symbol("ArrayQueryExpression"),E),ze=(g=class extends ge{constructor(e,t,i,n){super(),this.expression=e,this.lower=t,this.upper=i,this.negated=n}},g.kind=Symbol("BetweenExpression"),g),Je=(S=class extends ge{constructor(e,t){super(),this.specifier=new Ue(e),this.value=new Re(t)}},S.kind=Symbol("StringSpecifierExpression"),S),He=(k=class extends ge{constructor(e,t,i=null){super(),this.qualifiedName=new it(e,t),this.argument=i}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}getTypeName(){let e=this.qualifiedName.name instanceof Ue?this.qualifiedName.name.value:this.qualifiedName.name.name;return this.qualifiedName.namespaces&&this.qualifiedName.namespaces.length>0?this.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+e:e}},k.kind=Symbol("TypeValue"),k),Ge=((T=class extends ge{constructor(e){super(),this.values=e}}).kind=Symbol("TupleExpression"),T),Ye=(b=class extends ge{constructor(e,t,i){super(),this.array=e,this.startIndex=t,this.endIndex=i}},b.kind=Symbol("ArraySliceExpression"),b),Xe=(I=class extends ge{constructor(e,t){super(),this.array=e,this.index=t}},I.kind=Symbol("ArrayIndexExpression"),I);function Ze(e){if(null==e)return null;if("string"==typeof e)return""===e.trim()?null:[new We(e)];if(Array.isArray(e)){if(0===e.length)return null;if("string"==typeof e[0]){let t=e.filter(e=>""!==e.trim());return 0===t.length?null:t.map(e=>new We(e))}{let t=e.filter(e=>""!==e.name.trim());return 0===t.length?null:t}}return null}var et,tt,it=(N=class extends ge{constructor(e,t){super(),this.namespaces=Ze(e),this.name="string"==typeof t?new Ue(t):t}toString(){let e=this.name instanceof Ue?this.name.value:this.name.name;return this.namespaces&&this.namespaces.length>0?this.namespaces.map(e=>e.name).join(".")+"."+e:e}},N.kind=Symbol("QualifiedName"),N),nt=(A=class extends ge{constructor(e,t=null){super(),this.value=e,this.identifier=t?new We(t):null}},A.kind=Symbol("SelectItem"),A),st=(O=class extends ge{constructor(e,t=null,i=[]){super(),this.items=e,this.distinct=t,this.hints=i}},O.kind=Symbol("SelectClause"),O),rt=((P=class extends ge{constructor(){super()}}).kind=Symbol("Distinct"),P),at=(($=class extends ge{constructor(e){super(),this.value=e}}).kind=Symbol("DistinctOn"),$),lt=((L=class extends ge{constructor(e){super(),this.condition=e}}).kind=Symbol("WhereClause"),L),ot=((F=class extends ge{constructor(e){super(),this.value=e}}).kind=Symbol("PartitionByClause"),F),ut=(_=class extends ge{constructor(e,t){super(),this.name=new We(e),this.expression=t}},_.kind=Symbol("WindowFrameClause"),_),ht=((R=class extends ge{constructor(e){super(),this.windows=e}}).kind=Symbol("WindowsClause"),R),pt=((B=class extends ge{constructor(e){super(),this.order=e}}).kind=Symbol("OrderByClause"),B),ct=(Q=class extends ge{constructor(e,t,i){super(),this.value=e,this.sortDirection=null===t?"asc":t,this.nullsPosition=i}},Q.kind=Symbol("OrderByItem"),Q),dt=((q=class extends ge{constructor(e){super(),this.grouping=e}}).kind=Symbol("GroupByClause"),q),mt=((U=class extends ge{constructor(e){super(),this.condition=e}}).kind=Symbol("HavingClause"),U),wt=(W=class extends ge{get namespaces(){return this.qualifiedName.namespaces}get table(){return this.qualifiedName.name instanceof We?this.qualifiedName.name:new We(this.qualifiedName.name.value)}get identifier(){return this.table}constructor(e,t){super();let i="string"==typeof t?new We(t):t;this.qualifiedName=new it(e,i)}getSourceName(){return this.qualifiedName.namespaces&&this.qualifiedName.namespaces.length>0?this.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+(this.qualifiedName.name instanceof Ue?this.qualifiedName.name.value:this.qualifiedName.name.name):this.qualifiedName.name instanceof Ue?this.qualifiedName.name.value:this.qualifiedName.name.name}},W.kind=Symbol("TableSource"),W),ft=(V=class extends ge{constructor(e,t){if(super(),"object"==typeof e&&null!==e&&"name"in e){let t=e;this.qualifiedName=new it(t.namespaces,t.name)}else this.qualifiedName=new it(null,e);this.argument=t}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}},V.kind=Symbol("FunctionSource"),V),yt=((K=class extends ge{constructor(e){super(),this.source=e}}).kind=Symbol("ParenSource"),K),vt=((j=class extends ge{constructor(e){super(),this.query=e}}).kind=Symbol("SubQuerySource"),j),Ct=(M=class extends ge{constructor(e,t){super(),this.datasource=e,this.aliasExpression=t}getAliasName(){return this.aliasExpression?this.aliasExpression.table.name:this.datasource instanceof wt?this.datasource.getSourceName():null}},M.kind=Symbol("SourceExpression"),M),xt=((D=class extends ge{constructor(e){super(),this.condition=e}}).kind=Symbol("JoinOnClause"),D),Et=((z=class extends ge{constructor(e){super(),this.condition=e}}).kind=Symbol("JoinUsingClause"),z),gt=(J=class extends ge{constructor(e,t,i,n){super(),this.joinType=new Ue(e),this.source=t,this.condition=i,this.lateral=n}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source instanceof wt?this.source.table.name:null}},J.kind=Symbol("JoinItem"),J),St=(H=class extends ge{constructor(e,t){super(),this.source=e,this.joins=t}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source.datasource instanceof wt?this.source.datasource.table.name:null}getSources(){let e=[this.source];if(this.joins)for(let t of this.joins)e.push(t.source);return e}},H.kind=Symbol("FromClause"),H),kt=(G=class extends ge{constructor(e,t,i){super(),this.query=e,this.materialized=i,this.aliasExpression="string"==typeof t?new Pt(t,null):t}getSourceAliasName(){return this.aliasExpression.table.name}},G.kind=Symbol("CommonTable"),G),Tt=(Y=class extends ge{constructor(e,t){super(),this.recursive=e,this.tables=t}},Y.kind=Symbol("WithClause"),Y),bt=((X=class extends ge{constructor(e){super(),this.value=e}}).kind=Symbol("LimitClause"),X),It=((Z=class extends ge{constructor(e){super(),this.value=e}}).kind=Symbol("OffsetClause"),Z),Nt=((ee=class extends ge{constructor(e){super(),this.expression=e}}).kind=Symbol("FetchClause"),ee),At=(te=class extends ge{constructor(e,t,i){super(),this.type=e,this.count=t,this.unit=i}},te.kind=Symbol("FetchExpression"),te),Ot=((ie=class extends ge{constructor(e){super(),this.lockMode=e}}).kind=Symbol("ForClause"),ie),Pt=(ne=class extends ge{constructor(e,t){super(),this.table=new We(e),this.columns=null!==t?t.map(e=>new We(e)):null}},ne.kind=Symbol("SourceAliasExpression"),ne),$t=(se=class extends ge{constructor(e){super(),this.columns=e.map(e=>"string"==typeof e?new We(e):e)}},se.kind=Symbol("ReturningClause"),se),Lt=(re=class extends ge{constructor(e){super(),this.items=e.map(e=>e instanceof Ft?e:new Ft(e.column,e.value))}},re.kind=Symbol("SetClause"),re),Ft=(ae=class extends ge{constructor(e,t){if(super(),"object"==typeof e&&null!==e&&"column"in e){let t=e,i="string"==typeof t.column?new We(t.column):t.column;this.qualifiedName=new it(t.namespaces,i)}else{let t="string"==typeof e?new We(e):e;this.qualifiedName=new it(null,t)}this.value=t}get namespaces(){return this.qualifiedName.namespaces}get column(){return this.qualifiedName.name instanceof We?this.qualifiedName.name:new We(this.qualifiedName.name.value)}getFullName(){return this.qualifiedName.toString()}},ae.kind=Symbol("SetClauseItem"),ae),_t=((le=class extends ge{constructor(e){super(),this.source=e}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source.datasource instanceof wt?this.source.datasource.table.name:null}}).kind=Symbol("UpdateClause"),le),Rt=class extends ge{constructor(e,t){super(),this.source=e,this.columns=t.map(e=>new We(e))}},Bt=((et=Bt||{})[et.None=0]="None",et[et.Literal=1]="Literal",et[et.Operator=2]="Operator",et[et.OpenParen=4]="OpenParen",et[et.CloseParen=8]="CloseParen",et[et.Comma=16]="Comma",et[et.Dot=32]="Dot",et[et.Identifier=64]="Identifier",et[et.Command=128]="Command",et[et.Parameter=256]="Parameter",et[et.OpenBracket=512]="OpenBracket",et[et.CloseBracket=1024]="CloseBracket",et[et.Function=2048]="Function",et[et.StringSpecifier=4096]="StringSpecifier",et[et.Type=8192]="Type",et),Qt=class{static isWhitespace(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 32===t||9===t||10===t||13===t}static isDigit(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57}static isHexChar(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=97&&t<=102||t>=65&&t<=70}static isOperatorSymbol(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 43===t||45===t||42===t||47===t||37===t||126===t||64===t||35===t||94===t||38===t||58===t||33===t||60===t||62===t||61===t||124===t||63===t}static isDelimiter(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 46===t||44===t||40===t||41===t||91===t||93===t||123===t||125===t||59===t||32===t||9===t||10===t||13===t||(43===t||45===t||42===t||47===t||37===t||126===t||64===t||35===t||94===t||38===t||58===t||33===t||60===t||62===t||61===t||124===t||63===t)}static isNamedParameterPrefix(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 64===t||58===t||36===t}},qt=class e{static getDebugPositionInfo(e,t){let i=Math.max(0,t-5),n=Math.min(e.length,t+5);return`${e.slice(i,n)}\n${" ".repeat(t-i)+"^"}`}static skipWhiteSpace(e,t){let i=e.length;for(;t+4<=i&&"    "===e.slice(t,t+4);)t+=4;for(;t<i;){let i=e.charCodeAt(t);if(32!==i&&9!==i&&10!==i&&13!==i)break;t++}return t}static readLineComment(e,t){if(t+1>=e.length)return{newPosition:t,comment:null};if(45===e.charCodeAt(t)&&45===e.charCodeAt(t+1)){let i=t;for(t+=2;t<e.length&&10!==e.charCodeAt(t);)t++;return{newPosition:t,comment:e.slice(i+2,t).trim()}}return{newPosition:t,comment:null}}static readBlockComment(e,t){if(t+3>=e.length)return{newPosition:t,comments:null};if(47===e.charCodeAt(t)&&42===e.charCodeAt(t+1)&&43!==e.charCodeAt(t+2)){let i=t;for(t+=2;t+1<e.length;){if(42===e.charCodeAt(t)&&47===e.charCodeAt(t+1)){t+=2;let n=e.slice(i+2,t-2).replace(/\r/g,"").split("\n");for(let e=0;e<n.length;e++)n[e]=n[e].trim();for(;n.length>0&&""===n[0];)n.shift();for(;n.length>0&&""===n[n.length-1];)n.pop();return{newPosition:t,comments:n}}t++}throw new Error(`Block comment is not closed. position: ${t}`)}return{newPosition:t,comments:null}}static readWhiteSpaceAndComment(t,i){let n=[],s=t.length;for(;i<s;){let s=i;if((i=e.skipWhiteSpace(t,i))!==s)continue;let r=t.charCodeAt(i);if(45===r){let s=e.readLineComment(t,i);if(s.newPosition!==i){i=s.newPosition,s.comment&&n.push(s.comment.trim());continue}}else if(47===r){let s=e.readBlockComment(t,i);if(s.newPosition!==i){i=s.newPosition,s.comments&&n.push(...s.comments);continue}}break}return{position:i,lines:n}}static readRegularIdentifier(t,i){let n=this.tryReadRegularIdentifier(t,i);if(!n)throw new Error(`Unexpected character. position: ${i}\n${e.getDebugPositionInfo(t,i)}`);return n}static tryReadRegularIdentifier(e,t){let i=t;for(;t<e.length&&!Qt.isDelimiter(e[t]);)t++;if(i===t)return null;for(;t+1<e.length&&"["===e[t]&&"]"===e[t+1];){let n=e.slice(0,i).trim();if(""===n||/[)]$/.test(n)||/\b(select|from|where|and|or|set|values|insert|update|delete)\s*$/i.test(n))break;t+=2}return{identifier:e.slice(i,t),newPosition:t}}},Ut=class{constructor(e,t=0){this.input=e,this.position=t}getPosition(){return this.position}setPosition(e){this.position=e}isEndOfInput(e=0){return this.position+e>=this.input.length}canRead(e=0){return!this.isEndOfInput(e)}read(e){if(this.isEndOfInput())throw new Error(`Unexpected character. expect: ${e}, actual: EndOfInput, position: ${this.position}`);let t=this.input[this.position];if(t!==e)throw new Error(`Unexpected character. expect: ${e}, actual: ${t}, position: ${this.position}`);return this.position++,t}createLexeme(e,t,i=null,n,s){let r={type:e,value:128===e||2===e||2048===e?t.toLowerCase():t,comments:i};return void 0!==n&&void 0!==s&&(r.position={startPosition:n,endPosition:s}),r}createLexemeWithPosition(e,t,i,n=null){return this.createLexeme(e,t,n,i,i+t.length)}getDebugPositionInfo(e){return qt.getDebugPositionInfo(this.input,e)}},Wt=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if("*"===t)return this.position++,this.createLexeme(64,t);let i=qt.readRegularIdentifier(this.input,this.position);return this.position=i.newPosition,this.createLexeme(64,i.identifier)}},Vt=class{constructor(e){this.trie=e}isEndOfInput(e,t,i=0){return t+i>=e.length}canParse(e,t,i=0){return!this.isEndOfInput(e,t,i)}parse(e,t){if(this.isEndOfInput(e,t))return null;this.trie.reset();let i=qt.tryReadRegularIdentifier(e,t);if(null===i)return null;let n=this.trie.pushLexeme(i.identifier.toLowerCase());if(0===n)return null;if(3===n)return{keyword:i.identifier,newPosition:i.newPosition};let s=i.identifier;if(t=qt.readWhiteSpaceAndComment(e,i.newPosition).position,this.isEndOfInput(e,t))return 2===n?{keyword:s,newPosition:t}:null;for(;this.canParse(e,t);){let i=n,r=qt.tryReadRegularIdentifier(e,t);if(null===r){if(2===i)break;return null}if(n=this.trie.pushLexeme(r.identifier.toLowerCase()),0===n){if(2===i)break;return null}if(s+=" "+r.identifier,t=qt.readWhiteSpaceAndComment(e,r.newPosition).position,3===n)break}return{keyword:s,newPosition:t}}},Kt=class{constructor(e){this.root=new Map,this.hasEndProperty=!1,this.hasMoreProperties=!1;for(let t of e)this.addKeyword(t);this.currentNode=this.root}addKeyword(e){let t=this.root;for(let i of e)t.has(i)||t.set(i,new Map),t=t.get(i);t.set("__end__",!0)}reset(){this.currentNode=this.root,this.hasEndProperty=!1,this.hasMoreProperties=!1}pushLexeme(e){return this.currentNode.has(e)?(this.currentNode=this.currentNode.get(e),this.hasEndProperty=this.currentNode.has("__end__"),this.hasMoreProperties=this.currentNode.size>(this.hasEndProperty?1:0),this.hasEndProperty&&!this.hasMoreProperties?3:this.hasEndProperty&&this.hasMoreProperties?2:1):0}},jt=new Vt(new Kt([["null"],["true"],["false"],["current_date"],["current_time"],["current_timestamp"],["localtime"],["localtimestamp"],["unbounded"],["normalized"],["nfc","normalized"],["nfd","normalized"],["nfkc","normalized"],["nfkd","normalized"],["nfc"],["nfd"],["nfkc"],["nfkd"]])),Mt=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position],i=this.tryReadKeyword();if(i)return i;if("."===t&&this.canRead(1)&&Qt.isDigit(this.input[this.position+1]))return this.createLexeme(1,this.readDigit());if("'"===t){let e=this.readSingleQuotedString(!1);return this.createLexeme(1,e)}if(Qt.isDigit(t))return this.createLexeme(1,this.readDigit());if("$"===t&&this.isDollarQuotedString())return this.createLexeme(1,this.readDollarQuotedString());if("$"===t&&this.canRead(1)&&Qt.isDigit(this.input[this.position+1])){let e=this.position+1,t=!1;for(;e<this.input.length&&(Qt.isDigit(this.input[e])||","===this.input[e]||"."===this.input[e]);){if("."===this.input[e]||","===this.input[e]){t=!0;break}e++}if(t){this.position,this.position++;let e=this.readMoneyDigit();return this.createLexeme(1,"$"+e)}}if(("+"===t||"-"===t)&&"sign"===this.determineSignOrOperator(e)){let e=t;this.position++;let i=this.position;for(;this.canRead()&&Qt.isWhitespace(this.input[this.position]);)this.position++;if(this.canRead()&&(Qt.isDigit(this.input[this.position])||"."===this.input[this.position]&&this.canRead(1)&&Qt.isDigit(this.input[this.position+1])))return this.createLexeme(1,"-"===e?e+this.readDigit():this.readDigit());this.position=i-1}return null}tryReadKeyword(){let e=jt.parse(this.input,this.position);return e?(this.position=e.newPosition,this.createLexeme(1,e.keyword)):null}determineSignOrOperator(e){return null===e?"sign":1&e.type||64&e.type||256&e.type||8&e.type?"operator":"sign"}readDigit(){let e=this.position,t=!1,i=!1;if(this.canRead(1)&&"0"===this.input[this.position]&&"xbo".includes(this.input[this.position+1].toLowerCase())){let t=this.input[this.position+1].toLowerCase();this.position+=2;let i="x"===t;for(;this.canRead();){let e=this.input[this.position];if(!(Qt.isDigit(e)||i&&Qt.isHexChar(e)))break;this.position++}return this.input.slice(e,this.position)}for("."===this.input[e]&&(t=!0,this.position++);this.canRead();){let e=this.input[this.position];if("."!==e||t)if("e"!==e&&"E"!==e||i){if(!Qt.isDigit(e))break}else i=!0,this.canRead(1)&&("+"===this.input[this.position+1]||"-"===this.input[this.position+1])&&this.position++;else t=!0;this.position++}if(e===this.position)throw new Error(`Unexpected character. position: ${e}\n${this.getDebugPositionInfo(e)}`);return"."===this.input[e]?"0"+this.input.slice(e,this.position):this.input.slice(e,this.position)}readMoneyDigit(){let e=this.position,t=!1;for(;this.canRead();){let e=this.input[this.position];if("."!==e||t){if((","!==e||t)&&!Qt.isDigit(e))break}else t=!0;this.position++}if(e===this.position)throw new Error(`Unexpected character. position: ${e}\n${this.getDebugPositionInfo(e)}`);return this.input.slice(e,this.position)}readSingleQuotedString(e){let t=this.position,i=!1;for(this.read("'");this.canRead();){let e=this.input[this.position];if(this.position++,"\\"===e&&this.canRead(1))this.position++;else if("'"===e){i=!0;break}}if(!1===i)throw new Error(`Single quote is not closed. position: ${t}\n${this.getDebugPositionInfo(t)}`);return e?this.input.slice(t,this.position):this.input.slice(t+1,this.position-1)}isDollarQuotedString(){if(!this.canRead(1))return!1;if("$"===this.input[this.position+1])return!0;let e=this.position+1;for(;e<this.input.length;){let t=this.input[e];if("$"===t)return!0;if(!this.isAlphanumeric(t)&&"_"!==t)return!1;e++}return!1}readDollarQuotedString(){let e=this.position;this.position++;let t="";for(;this.canRead()&&"$"!==this.input[this.position];)t+=this.input[this.position],this.position++;if(!this.canRead())throw new Error(`Unexpected end of input while reading dollar-quoted string tag at position ${e}`);this.position++;let i="$"+t+"$",n=i,s="";for(;this.canRead();){if(this.input.substring(this.position,this.position+n.length)===n)return this.position+=n.length,i+s+n;s+=this.input[this.position],this.position++}throw new Error(`Unclosed dollar-quoted string starting at position ${e}. Expected closing tag: ${n}`)}isAlphanumeric(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122}},Dt=class extends Ut{constructor(e){super(e)}tryRead(e){if(this.isEndOfInput())return null;if(this.canRead(1)&&"$"===this.input[this.position]&&"{"===this.input[this.position+1]){this.position+=2;let e=this.position;for(;this.canRead()&&"}"!==this.input[this.position];)this.position++;if(this.isEndOfInput())throw new Error(`Unexpected end of input. Expected closing '}' for parameter at position ${e}`);let t=this.input.slice(e,this.position);if(0===t.length)throw new Error("Empty parameter name is not allowed: found ${} at position "+(e-2));return this.position++,this.createLexeme(256,"${"+t+"}")}let t=this.input[this.position];if(Qt.isNamedParameterPrefix(t)){if(this.canRead(1)&&Qt.isOperatorSymbol(this.input[this.position+1])||":"===t&&this.isInArraySliceContext()||"$"===t&&this.isDollarQuotedString())return null;if("$"===t&&this.canRead(1)&&Qt.isDigit(this.input[this.position+1])){let e=this.position+1,t=!1;for(;e<this.input.length&&(Qt.isDigit(this.input[e])||","===this.input[e]||"."===this.input[e]);){if("."===this.input[e]||","===this.input[e]){t=!0;break}e++}if(t)return null}this.position++;let e=this.position;for(;this.canRead()&&!Qt.isDelimiter(this.input[this.position]);)this.position++;let i=this.input.slice(e,this.position);return this.createLexeme(256,t+i)}if("?"===t){if(this.canRead(1)){let e=this.input[this.position+1];if("|"===e||"&"===e)return null}return e&&(64&e.type||1&e.type)?null:(this.position++,this.createLexeme(256,t))}return null}isInArraySliceContext(){let e=this.position-1,t=0;for(;e>=0;){let i=this.input[e];if("]"===i)t++;else if("["===i&&(t--,t<0)){if(e>0){let t=this.input[e-1];if(/[a-zA-Z0-9_)\]]/.test(t))return!0}if(0===e)return!1;break}e--}return!1}isDollarQuotedString(){if(!this.canRead(1))return!1;if("$"===this.input[this.position+1])return!0;let e=this.position+1;for(;e<this.input.length;){let t=this.input[e];if("$"===t)return!0;if(!this.isAlphanumeric(t)&&"_"!==t)return!1;e++}return!1}isAlphanumeric(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122}},zt=(oe=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];return t in oe.SPECIAL_SYMBOL_TOKENS?(this.position++,this.createLexeme(oe.SPECIAL_SYMBOL_TOKENS[t],t)):null}},oe.SPECIAL_SYMBOL_TOKENS={".":32,",":16,"(":4,")":8,"[":512,"]":1024},oe),Jt=class{constructor(e,t=0){this.cacheHits=0,this.cacheMisses=0,this.input=e,this.position=t,this.readers=[],this.tokenCache=new Map}register(e){return this.readers.push(e),this}registerAll(e){return e.forEach(e=>this.register(e)),this}setPosition(e){this.position=e;for(let t of this.readers)t.setPosition(e)}tryRead(e,t){if(this.tokenCache.has(e))return this.cacheHits++,this.tokenCache.get(e)||null;this.cacheMisses++,this.setPosition(e);let i=null;for(let n of this.readers)if(i=n.tryRead(t),i){this.position=n.getPosition();break}for(let n of this.readers)n.setPosition(this.position);return this.tokenCache.set(e,i),i}getMaxPosition(){let e=this.position;for(let t of this.readers){let i=t.getPosition();i>e&&(e=i)}return e}getInput(){return this.input}getCacheStats(){let e=this.cacheHits+this.cacheMisses,t=e>0?this.cacheHits/e:0;return{hits:this.cacheHits,misses:this.cacheMisses,ratio:t}}},Ht=new Kt([["and"],["or"],["is"],["is","not"],["is","distinct","from"],["is","not","distinct","from"],["like"],["ilike"],["in"],["exists"],["between"],["not","like"],["not","ilike"],["not","in"],["not","exists"],["not","between"],["escape"],["uescape"],["similar","to"],["not","similar","to"],["similar"],["placing"],["rlike"],["regexp"],["mod"],["xor"],["not"],["both"],["leading"],["trailing"],["both","from"],["leading","from"],["trailing","from"],["year","from"],["month","from"],["day","from"],["hour","from"],["minute","from"],["second","from"],["dow","from"],["doy","from"],["isodow","from"],["quarter","from"],["week","from"],["epoch","from"],["at","time","zone"]]),Gt=new Kt([["date"],["time"],["timestamp"],["timestamptz"],["timetz"],["interval"],["boolean"],["integer"],["bigint"],["smallint"],["numeric"],["decimal"],["real"],["double","precision"],["double","precision"],["character","varying"],["time","without","time","zone"],["time","with","time","zone"],["timestamp","without","time","zone"],["timestamp","with","time","zone"]]),Yt=new Vt(Ht),Xt=new Vt(Gt),Zt=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if(Qt.isOperatorSymbol(t)){let e=this.position;for(;this.canRead()&&Qt.isOperatorSymbol(this.input[this.position]);){if(this.canRead(1)){let e=this.input[this.position];if("-"===e&&"-"===this.input[this.position+1])break;if("/"===e&&"*"===this.input[this.position+1])break}this.position++}let t=this.input.slice(e,this.position);return this.createLexeme(2,t)}let i=Xt.parse(this.input,this.position);return null!==i?(this.position=i.newPosition,this.createLexeme(8258,i.keyword)):(i=Yt.parse(this.input,this.position),null!==i?(this.position=i.newPosition,this.createLexeme(2,i.keyword)):null)}},ei=new Kt([["join"],["inner","join"],["cross","join"],["left","join"],["left","outer","join"],["right","join"],["right","outer","join"],["full","join"],["full","outer","join"],["natural","join"],["natural","inner","join"],["natural","left","join"],["natural","left","outer","join"],["natural","right","join"],["natural","right","outer","join"],["natural","full","join"],["natural","full","outer","join"]]),ti=new Vt(new Kt([["with"],["recursive"],["materialized"],["not","materialized"],["select"],["from"],["distinct"],["distinct","on"],["where"],["group","by"],["having"],["order","by"],["limit"],["offset"],["fetch"],["first"],["next"],["row"],["row","only"],["rows","only"],["percent"],["percent","with","ties"],["for"],["update"],["share"],["key","share"],["no","key","update"],["union"],["union","all"],["intersect"],["intersect","all"],["except"],["except","all"],["beteen"],["window"],["over"],["partition","by"],["range"],["rows"],["groups"],["within","group"],["current","row"],["unbounded","preceding"],["unbounded","following"],["preceding"],["following"],["on"],["using"],["lateral"],["case"],["case","when"],["when"],["then"],["else"],["end"],["insert","into"],["update"],["delete","from"],["merge","into"],["matched"],["not","matched"],["update","set"],["do","nothing"],["values"],["set"],["returning"],["create","table"],["create","temporary","table"],["tablesample"],["as"],["asc"],["desc"],["nulls","first"],["nulls","last"]])),ii=new Vt(ei),ni=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=ii.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(128,t.keyword);let i=ti.parse(this.input,this.position);if(null!==i)return this.position=i.newPosition,this.createLexeme(128,i.keyword);if(this.canRead(2)&&"/"===this.input[this.position]&&"*"===this.input[this.position+1]&&"+"===this.input[this.position+2]){this.position+=3;let e=this.position;for(;this.position+1<this.input.length;){if("*"===this.input[this.position]&&"/"===this.input[this.position+1])return this.position+=2,this.createLexeme(128,"/*+ "+this.input.slice(e,this.position-2).trim()+" */");this.position++}throw new Error(`Block comment is not closed. position: ${this.position}`)}return null}},si=new Set(["e'","E'","x'","X'","b'","B'"]),ri=new Set(["u&'","U&'"]),ai=class extends Ut{tryRead(e){let t=this.position;return this.canRead(1)&&si.has(this.input.slice(t,t+2))?(this.position+=1,this.createLexeme(4096,this.input.slice(t,this.position))):this.canRead(2)&&ri.has(this.input.slice(t,t+3))?(this.position+=2,this.createLexeme(4096,this.input.slice(t,this.position))):null}},li=new Vt(new Kt([["grouping","sets"],["array"]])),oi=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=li.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(2048,t.keyword);let i=qt.tryReadRegularIdentifier(this.input,this.position);if(!i)return null;this.position=i.newPosition;var n=qt.readWhiteSpaceAndComment(this.input,this.position).position-this.position;return this.canRead(n)&&"("===this.input[this.position+n]?this.createLexeme(2048,i.identifier):null}},ui=new Vt(new Kt([["double","precision"],["character","varying"],["time","without","time","zone"],["time","with","time","zone"],["timestamp","without","time","zone"],["timestamp","with","time","zone"]])),hi=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=ui.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(8192,t.keyword);if(null===e)return null;let i=qt.tryReadRegularIdentifier(this.input,this.position);return i?(this.position=i.newPosition,128&e.type&&"as"===e.value?this.createLexeme(8256,i.identifier):2&e.type&&"::"===e.value?this.createLexeme(8192,i.identifier):null):null}},pi=class extends Ut{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if("`"===t){let e=this.readEscapedIdentifier("`");return this.createLexeme(64,e)}if('"'===t){let e=this.readEscapedIdentifier('"');return this.createLexeme(64,e)}if("["===t&&this.isSqlServerBracketIdentifier(e)){let e=this.readEscapedIdentifier("]");return this.createLexeme(64,e)}return null}isSqlServerBracketIdentifier(e){if("array"===(null==e?void 0:e.value))return!1;let t=this.position+1,i=t;for(;i<this.input.length&&"]"!==this.input[i];){let e=this.input[i];if(":"===e||","===e||"+"===e||"-"===e||"*"===e||"/"===e||"("===e||")"===e)return!1;i++}if(i>=this.input.length)return!1;let n=this.input.slice(t,i).trim();return""!==n&&/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*$/.test(n)}readEscapedIdentifier(e){let t=this.position;for(this.position++;this.canRead()&&this.input[this.position]!==e;)this.position++;if(t===this.position)throw new Error(`Closing delimiter is not found. position: ${t}, delimiter: ${e}\n${this.getDebugPositionInfo(t)}`);return this.position++,this.input.slice(t+1,this.position-1)}},ci=class{constructor(e){this.input=e,this.position=0,this.readerManager=new Jt(e).register(new pi(e)).register(new Dt(e)).register(new ai(e)).register(new Mt(e)).register(new zt(e)).register(new ni(e)).register(new Zt(e)).register(new hi(e)).register(new oi(e)).register(new Wt(e))}isEndOfInput(e=0){return this.position+e>=this.input.length}canRead(e=0){return!this.isEndOfInput(e)}readLexmes(){let e=Math.ceil(this.input.length/8),t=new Array(e),i=0,n=this.readComment(),s=n.lines;this.position=n.position;let r=null;for(;this.canRead()&&";"!==this.input[this.position];){let e=this.readerManager.tryRead(this.position,r);if(null===e)throw new Error(`Unexpected character. actual: ${this.input[this.position]}, position: ${this.position}\n${this.getDebugPositionInfo(this.position)}`);this.position=this.readerManager.getMaxPosition();let n=this.readComment();this.position=n.position,16&e.type||2&e.type?n.lines.length>0&&s.push(...n.lines):((s.length>0||n.lines.length>0)&&this.addCommentsToToken(e,s,n.lines),s=[]),t[i++]=e,r=e}if(s.length>0&&i>0){let e=t[i-1];null===e.comments&&(e.comments=[]),e.comments.push(...s)}return i===e?t:t.slice(0,i)}addPendingCommentsToLastToken(e,t){if(t.length>0&&e.length>0){let i=e[e.length-1];null===i.comments&&(i.comments=[]),i.comments.push(...t)}}addCommentsToToken(e,t,i){(t.length>0||i.length>0)&&(null===e.comments&&(e.comments=[]),t.length>0&&e.comments.unshift(...t),i.length>0&&e.comments.push(...i))}readComment(){return qt.readWhiteSpaceAndComment(this.input,this.position)}getDebugPositionInfo(e){return qt.getDebugPositionInfo(this.input,e)}},di=class e{static parseFromLexeme(t,i){let{identifiers:n,newIndex:s}=e.parseEscapedOrDotSeparatedIdentifiers(t,i),{namespaces:r,name:a}=e.extractNamespacesAndName(n),l=0;return s>i&&(l=t[s-1].type),{namespaces:r,name:new We(a),newIndex:s,lastTokenType:l}}static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The name is complete but additional tokens were found.`);return{namespaces:i.namespaces,name:i.name}}static parseEscapedOrDotSeparatedIdentifiers(e,t){let i=t,n=[];for(;i<e.length;){if(512&e[i].type){if(i++,i>=e.length||!(64&e[i].type||128&e[i].type))throw new Error(`Expected identifier after '[' at position ${i}`);if(n.push(e[i].value),i++,i>=e.length||"]"!==e[i].value)throw new Error(`Expected closing ']' after identifier at position ${i}`);i++}else if(64&e[i].type)n.push(e[i].value),i++;else if(2048&e[i].type)n.push(e[i].value),i++;else if(8192&e[i].type)n.push(e[i].value),i++;else if("*"===e[i].value){n.push(e[i].value),i++;break}if(!(i<e.length&&32&e[i].type))break;i++}return{identifiers:n,newIndex:i}}static extractNamespacesAndName(e){if(!e||0===e.length)throw new Error("Identifier list is empty");return 1===e.length?{namespaces:null,name:e[0]}:{namespaces:e.slice(0,-1),name:e[e.length-1]}}},mi=class{static parseFromLexeme(e,t){let{namespaces:i,name:n,newIndex:s}=di.parseFromLexeme(e,t);return{value:new be(i,n),newIndex:s}}},wi=class{static parseFromLexeme(e,t){let i,n=t,s=e[n].value,r=jt.parse(s.toLowerCase(),0);if(r){return n++,{value:new Ue(r.keyword),newIndex:n}}if(/^[+-]?\d+(\.\d+)?([eE][+-]?\d+)?$/.test(s))return i=Number(s),n++,{value:new Re(i),newIndex:n};{let e=/^\$[^$]*\$[\s\S]*\$[^$]*\$$/.test(s);return i=e?s:s.startsWith("'")&&s.endsWith("'")?s.slice(1,-1):s,n++,{value:new Re(i,e),newIndex:n}}}},fi=class{static parseFromLexeme(e,t){let i=t;if(i+1<e.length&&4&e[i].type&&("select"===e[i+1].value||"values"===e[i+1].value||"with"===e[i+1].value)){i+=1;let t=On.parseFromLexeme(e,i);if(i=t.newIndex,i>=e.length||8!==e[i].type)throw new Error(`Expected ')' at index ${i}, but found ${e[i].value}`);return i++,{value:new ke(t.value),newIndex:i}}{let n=Ni.parseArgument(4,8,e,t);return i=n.newIndex,{value:new Ve(n.value),newIndex:i}}}},yi=class{static parseFromLexeme(e,t){let i=t;if(i<e.length&&2&e[i].type){let t=e[i].value;if(i++,"*"===t)return{value:new be(null,"*"),newIndex:i};let n=Ni.parseFromLexeme(e,i);return i=n.newIndex,{value:new Fe(t,n.value),newIndex:i}}throw new Error(`Invalid unary expression at index ${t}: ${e[t].value}`)}},vi=class{static parseFromLexeme(e,t){let i=t,n=e[i].value;return n=n.startsWith("${")&&n.endsWith("}")?n.slice(2,-1):n.slice(1),i++,{value:new Be(n),newIndex:i}}},Ci=class{static parseFromLexeme(e,t){let i=t,n=e[i].value;if(i++,i>=e.length||1!==e[i].type)throw new Error(`Expected string literal after string specifier at index ${i}`);let s=e[i].value;return i++,{value:new Je(n,s),newIndex:i}}},xi=class{static parseFromLexeme(e,t){let i=t,n=e[i];return"case"===n.value?(i++,this.parseCaseExpression(e,i)):"case when"===n.value?(i++,this.parseCaseWhenExpression(e,i)):this.parseModifierUnaryExpression(e,i)}static parseModifierUnaryExpression(e,t){let i=t;if(i<e.length&&128&e[i].type){let t=e[i].value;i++;let n=Ni.parseFromLexeme(e,i);return{value:new Fe(t,n.value),newIndex:n.newIndex}}throw new Error(`Invalid modifier unary expression at index ${i}, Lexeme: ${e[i].value}`)}static parseCaseExpression(e,t){let i=t,n=Ni.parseFromLexeme(e,i);i=n.newIndex;let s=this.parseSwitchCaseArgument(e,i,[]);return i=s.newIndex,{value:new je(n.value,s.value),newIndex:i}}static parseCaseWhenExpression(e,t){let i=t,n=this.parseCaseConditionValuePair(e,i);i=n.newIndex;let s=[n.value],r=this.parseSwitchCaseArgument(e,i,s);return i=r.newIndex,{value:new je(null,r.value),newIndex:i}}static parseSwitchCaseArgument(e,t,i){let n=t,s=[...i],r=null;for(;n<e.length&&this.isCommandWithValue(e[n],"when");){n++;let t=this.parseCaseConditionValuePair(e,n);n=t.newIndex,s.push(t.value)}if(n<e.length&&this.isCommandWithValue(e[n],"else")){n++;let t=Ni.parseFromLexeme(e,n);r=t.value,n=t.newIndex}if(!(n<e.length&&this.isCommandWithValue(e[n],"end")))throw new Error(`The CASE expression requires 'end' keyword at the end (index ${n})`);if(n++,0===s.length)throw new Error(`The CASE expression requires at least one WHEN clause (index ${n})`);return{value:new Qe(s,r),newIndex:n}}static isCommandWithValue(e,t){return!!(128&e.type)&&e.value===t}static parseCaseConditionValuePair(e,t){let i=t,n=Ni.parseFromLexeme(e,i);if(i=n.newIndex,i>=e.length||!(128&e[i].type)||"then"!==e[i].value)throw new Error(`Expected 'then' after WHEN condition at index ${i}`);i++;let s=Ni.parseFromLexeme(e,i);return i=s.newIndex,{value:new qe(n.value,s.value),newIndex:i}}},Ei=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The ORDER BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("order by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'ORDER BY' keyword but found "${e[i].value}". ORDER BY clauses must start with the ORDER BY keywords.`);i++;let n=[],s=this.parseItem(e,i);for(n.push(s.value),i=s.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseItem(e,i);n.push(t.value),i=t.newIndex}if(0===n.length)throw new Error(`Syntax error at position ${t}: No ordering expressions found. The ORDER BY clause requires at least one expression to order by.`);return{value:new pt(n),newIndex:i}}static parseItem(e,t){let i=t,n=Ni.parseFromLexeme(e,i),s=n.value;if(i=n.newIndex,i>=e.length)return{value:s,newIndex:i};let r=i>=e.length?null:"asc"===e[i].value?(i++,"asc"):"desc"===e[i].value?(i++,"desc"):null,a=i>=e.length?null:"nulls first"===e[i].value?(i++,"first"):"nulls last"===e[i].value?(i++,"last"):null;return null===r&&null===a?{value:s,newIndex:i}:{value:new ct(s,r,a),newIndex:i}}},gi=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The PARTITION BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("partition by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'PARTITION BY' keyword but found "${e[i].value}". PARTITION BY clauses must start with the PARTITION BY keywords.`);i++;let n=[],s=Ni.parseFromLexeme(e,i);for(n.push(s.value),i=s.newIndex;i<e.length&&16&e[i].type;){i++;let t=Ni.parseFromLexeme(e,i);n.push(t.value),i=t.newIndex}if(0===n.length)throw new Error(`Syntax error at position ${t}: No partition expressions found. The PARTITION BY clause requires at least one expression to partition by.`);return 1===n.length?{value:new ot(n[0]),newIndex:i}:{value:new ot(new Te(n)),newIndex:i}}},Si=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The window frame expression is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if(4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected opening parenthesis '(' but found "${e[i].value}".`);i++;let n=null,s=null,r=null;if(i<e.length&&"partition by"===e[i].value){let t=gi.parseFromLexeme(e,i);n=t.value,i=t.newIndex}if(i<e.length&&"order by"===e[i].value){let t=Ei.parseFromLexeme(e,i);s=t.value,i=t.newIndex}if(i<e.length&&this.isFrameTypeKeyword(e[i].value)){let t=this.parseFrameSpec(e,i);r=t.value,i=t.newIndex}if(i>=e.length||8!==e[i].type)throw new Error(`Syntax error at position ${i}: Missing closing parenthesis ')' for window frame. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:new Le(n,s,r),newIndex:i}}static isFrameTypeKeyword(e){return"rows"===e||"range"===e||"groups"===e}static parseFrameSpec(e,t){let i,n=t;switch(e[n].value){case"rows":i="rows";break;case"range":i="range";break;case"groups":i="groups";break;default:throw new Error(`Syntax error at position ${n}: Invalid frame type "${e[n].value}". Expected one of: ROWS, RANGE, GROUPS.`)}if(n++,n<e.length&&"between"===e[n].value){n++;let t=this.parseFrameBoundary(e,n),s=t.value;if(n=t.newIndex,n>=e.length||"and"!==e[n].value)throw new Error(`Syntax error at position ${n}: Expected 'AND' keyword in BETWEEN clause.`);n++;let r=this.parseFrameBoundary(e,n),a=r.value;return n=r.newIndex,{value:new $e(i,s,a),newIndex:n}}{let t=this.parseFrameBoundary(e,n),s=t.value;return n=t.newIndex,{value:new $e(i,s,null),newIndex:n}}}static parseFrameBoundary(e,t){let i=t;if(i<e.length&&128&e[i].type){let t;switch(e[i].value){case"current row":t="current row";break;case"unbounded preceding":t="unbounded preceding";break;case"unbounded following":t="unbounded following";break;default:throw new Error(`Syntax error at position ${i}: Invalid frame type "${e[i].value}". Expected one of: ROWS, RANGE, GROUPS.`)}return{value:new Oe(t),newIndex:i+1}}if(i<e.length&&1&e[i].type){let t=Ni.parseFromLexeme(e,i);if(i=t.newIndex,i<e.length&&128&e[i].type){let n,s=e[i].value;if("preceding"===s)n=!1;else{if("following"!==s)throw new Error(`Syntax error at position ${i}: Expected 'preceding' or 'following' after numeric value in window frame boundary.`);n=!0}return i++,{value:new Pe(t.value,n),newIndex:i}}throw new Error(`Syntax error at position ${i}: Expected 'preceding' or 'following' after numeric value in window frame boundary.`)}throw new Error(`Syntax error at position ${i}: Expected a valid frame boundary component.`)}},ki=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The OVER expression is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("over"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'OVER' keyword but found "${e[i].value}". OVER expressions must start with the OVER keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'OVER' keyword. Expected either a window name or an opening parenthesis '('.");if(64&e[i].type){let t=e[i].value;return i++,{value:new We(t),newIndex:i}}if(4&e[i].type)return Si.parseFromLexeme(e,i);throw new Error(`Syntax error at position ${i}: Expected a window name or opening parenthesis '(' after OVER keyword, but found "${e[i].value}".`)}},Ti=class e extends Error{constructor(e,t,i){super(e),this.index=t,this.context=i,this.name="ParseError"}static fromUnparsedLexemes(t,i,n){let s=Math.max(0,i-2),r=Math.min(t.length,i+3),a=t.slice(s,r).map((e,t)=>{let n=t+s===i?">":" ",r=Bt[e.type]||e.type;return`${n} ${t+s}:${e.value} [${r}]`}).join("\n"),l=`${n} Unparsed lexeme remains at index ${i}: ${t[i].value}\nContext:\n${a}`;return new e(l,i,a)}},bi=class{static parseArrayExpression(e,t){let i=t;if(i+1<e.length&&512&e[i+1].type){i++;let t=Ni.parseArgument(512,1024,e,i);return i=t.newIndex,{value:new Me(t.value),newIndex:i}}if(i+1<e.length&&4&e[i+1].type){i++,i++;let t=On.parseFromLexeme(e,i);return i=t.newIndex,i++,{value:new De(t.value),newIndex:i}}throw new Error(`Invalid ARRAY syntax at index ${i}, expected ARRAY[... or ARRAY(...)`)}static parseFromLexeme(e,t){let i=t,n=e[i];return"array"===n.value?this.parseArrayExpression(e,i):"substring"===n.value||"overlay"===n.value?this.parseKeywordFunction(e,i,[{key:"from",required:!1},{key:"for",required:!1}]):"cast"===n.value?this.parseKeywordFunction(e,i,[{key:"as",required:!0}]):"trim"===n.value?this.parseKeywordFunction(e,i,[{key:"from",required:!1}]):this.parseFunctionCall(e,i)}static tryParseBinaryExpression(e,t,i,n=!0,s=!0){let r=t;if(r<e.length&&2&e[r].type){let t=e[r].value.toLowerCase();if(!n&&"and"===t||!s&&"or"===t)return null;if(r++,"between"===t)return this.parseBetweenExpression(e,r,i,!1);if("not between"===t)return this.parseBetweenExpression(e,r,i,!0);if("::"===t){let t=this.parseTypeValue(e,r);return r=t.newIndex,{value:new Ke(i,t.value),newIndex:r}}let a=Ni.parseFromLexeme(e,r);return r=a.newIndex,{value:new _e(i,t,a.value),newIndex:r}}return null}static parseBetweenExpression(e,t,i,n){let s=t,r=Ni.parseFromLexeme(e,s,!1);if(s=r.newIndex,s<e.length&&2&e[s].type&&"and"!==e[s].value)throw new Error(`Expected 'and' after 'between' at index ${s}`);s++;let a=this.parseBetweenUpperBound(e,s);return s=a.newIndex,{value:new ze(i,r.value,a.value,n),newIndex:s}}static parseBetweenUpperBound(e,t){return Ni.parseFromLexeme(e,t,!1,!1)}static parseFunctionCall(e,t){let i=t,n=di.parseFromLexeme(e,i),s=n.namespaces,r=n.name;if(i=n.newIndex,i<e.length&&4&e[i].type){let t=Ni.parseArgument(4,8,e,i);i=t.newIndex;let n=null;if(i<e.length&&"within group"===e[i].value){let t=this.parseWithinGroupClause(e,i);n=t.value,i=t.newIndex}if(i<e.length&&"over"===e[i].value){let a=ki.parseFromLexeme(e,i);return i=a.newIndex,{value:new Ie(s,r.name,t.value,a.value,n),newIndex:i}}return{value:new Ie(s,r.name,t.value,null,n),newIndex:i}}throw Ti.fromUnparsedLexemes(e,i,`Expected opening parenthesis after function name '${r.name}'.`)}static parseKeywordFunction(e,t,i){let n=t,s=di.parseFromLexeme(e,n),r=s.namespaces,a=s.name;if(n=s.newIndex,n<e.length&&4&e[n].type){n++;let s=Ni.parseFromLexeme(e,n),l=s.value;if(n=s.newIndex,n<e.length&&16&e[n].type)return this.parseFunctionCall(e,t);for(let{key:t,required:r}of i)if(n<e.length&&128&e[n].type&&e[n].value===t)if(n++,n<e.length&&8192&e[n].type){let i=this.parseTypeValue(e,n);l=new _e(l,t,i.value),n=i.newIndex}else{let i=Ni.parseFromLexeme(e,n);l=new _e(l,t,i.value),n=i.newIndex}else if(r)throw Ti.fromUnparsedLexemes(e,n,`Keyword '${t}' is required for ${a.name} function.`);if(n<e.length&&8&e[n].type){n++;let t=null;if(n<e.length&&"within group"===e[n].value){let i=this.parseWithinGroupClause(e,n);t=i.value,n=i.newIndex}if(n<e.length&&"over"===e[n].value){n++;let i=ki.parseFromLexeme(e,n);return n=i.newIndex,{value:new Ie(r,a.name,l,i.value,t),newIndex:n}}return{value:new Ie(r,a.name,l,null,t),newIndex:n}}throw Ti.fromUnparsedLexemes(e,n,`Missing closing parenthesis for function '${a.name}'.`)}throw Ti.fromUnparsedLexemes(e,n,`Missing opening parenthesis for function '${a.name}'.`)}static parseTypeValue(e,t){let i=t,{namespaces:n,name:s,newIndex:r}=di.parseFromLexeme(e,i);if(i=r,i<e.length&&4&e[i].type){let t=Ni.parseArgument(4,8,e,i);return i=t.newIndex,{value:new He(n,new Ue(s.name),t.value),newIndex:i}}return{value:new He(n,new Ue(s.name)),newIndex:i}}static parseWithinGroupClause(e,t){let i=t;if(i>=e.length||"within group"!==e[i].value)throw new Error(`Expected 'WITHIN GROUP' at index ${i}`);if(i++,i>=e.length||!(4&e[i].type))throw new Error(`Expected '(' after 'WITHIN GROUP' at index ${i}`);i++;let n=Ei.parseFromLexeme(e,i);if(i=n.newIndex,i>=e.length||!(8&e[i].type))throw new Error(`Expected ')' after WITHIN GROUP ORDER BY clause at index ${i}`);return i++,{value:n.value,newIndex:i}}},Ii=(ue=class{static getPrecedence(e){let t=this.precedenceMap[e.toLowerCase()];return void 0!==t?t:0}static hasHigherOrEqualPrecedence(e,t){return this.getPrecedence(e)>=this.getPrecedence(t)}static isLogicalOperator(e){let t=e.toLowerCase();return"and"===t||"or"===t}static isBetweenOperator(e){let t=e.toLowerCase();return"between"===t||"not between"===t}static isComparisonOperator(e){let t=e.toLowerCase();return["=","!=","<>","<",">","<=",">=","like","ilike","similar to","in","not in","->","->>","#>","#>>","@>","<@","?","?|","?&","~","~*","!~","!~*","rlike","regexp"].includes(t)}},ue.precedenceMap={or:1,and:2,"=":10,"!=":10,"<>":10,"<":10,"<=":10,">":10,">=":10,like:10,ilike:10,"not like":10,"not ilike":10,"similar to":10,"not similar to":10,in:10,"not in":10,is:10,"is not":10,"->":10,"->>":10,"#>":10,"#>>":10,"@>":10,"<@":10,"?":10,"?|":10,"?&":10,"~":10,"~*":10,"!~":10,"!~*":10,rlike:10,regexp:10,mod:30,xor:2,between:15,"not between":15,"+":20,"-":20,"*":30,"/":30,"%":30,"^":40,"::":50,"unary+":100,"unary-":100,not:100},ue),Ni=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw Ti.fromUnparsedLexemes(t,i.newIndex,"[ValueParser]");return i.value}static parseFromLexeme(e,t,i=!0,n=!0){return this.parseExpressionWithPrecedence(e,t,0,i,n)}static parseExpressionWithPrecedence(e,t,i,n=!0,s=!0){let r=t,a=e[r].comments,l=this.parseItem(e,r);l.value.comments=a,r=l.newIndex;let o=l.value,u=this.parseArrayAccess(e,r,o);for(o=u.value,r=u.newIndex;r<e.length&&2&e[r].type;){let t=e[r].value;if(!n&&"and"===t.toLowerCase()||!s&&"or"===t.toLowerCase())break;let a=Ii.getPrecedence(t);if(a<i)break;if(r++,Ii.isBetweenOperator(t)){let i=bi.parseBetweenExpression(e,r,o,t.toLowerCase().includes("not"));o=i.value,r=i.newIndex;continue}if("::"===t){let t=bi.parseTypeValue(e,r);o=new Ke(o,t.value),r=t.newIndex;continue}let l=a+1,u=this.parseExpressionWithPrecedence(e,r,l,n,s);r=u.newIndex,o=new _e(o,t,u.value)}return{value:o,newIndex:r}}static parseItem(e,t){let i=t;if(i>=e.length)throw new Error(`Unexpected end of lexemes at index ${t}`);let n=e[i];if(64&n.type&&2&n.type&&8192&n.type){if(i+1<e.length&&4&e[i+1].type){if(this.isTypeConstructor(e,i+1,n.value)){let t=bi.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return bi.parseFromLexeme(e,i)}let t=mi.parseFromLexeme(e,i);if(t.newIndex>=e.length)return t;if(1&e[t.newIndex].type){let n=wi.parseFromLexeme(e,t.newIndex);return{value:new Fe(e[i].value,n.value),newIndex:n.newIndex}}return t}if(64&n.type){let{namespaces:t,name:n,newIndex:s}=di.parseFromLexeme(e,i);if(2048&e[s-1].type)return bi.parseFromLexeme(e,i);if(8192&e[s-1].type){if(s<e.length&&4&e[s].type){if(this.isTypeConstructor(e,s,n.name)){let t=bi.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return bi.parseFromLexeme(e,i)}return{value:new He(t,n),newIndex:s}}return{value:new be(t,n),newIndex:s}}if(1&n.type)return wi.parseFromLexeme(e,i);if(4&n.type)return fi.parseFromLexeme(e,i);if(2048&n.type)return bi.parseFromLexeme(e,i);if(2&n.type)return yi.parseFromLexeme(e,i);if(256&n.type)return vi.parseFromLexeme(e,i);if(4096&n.type)return Ci.parseFromLexeme(e,i);if(128&n.type)return xi.parseFromLexeme(e,i);if(512&n.type){let{namespaces:t,name:n,newIndex:s}=di.parseFromLexeme(e,i);return{value:new be(t,n),newIndex:s}}if(8192&n.type){let{namespaces:t,name:n,newIndex:s}=di.parseFromLexeme(e,i);if(s<e.length&&4&e[s].type){if(this.isTypeConstructor(e,s,n.name)){let t=bi.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return bi.parseFromLexeme(e,i)}return{value:new He(t,n),newIndex:s}}throw Ti.fromUnparsedLexemes(e,i,"[ValueParser] Invalid lexeme.")}static parseArgument(e,t,i,n){let s=n,r=[];if(s<i.length&&i[s].type===e){if(s++,s<i.length&&i[s].type===t)return s++,{value:new Te([]),newIndex:s};if(s<i.length&&"*"===i[s].value){let e=new be(null,"*");if(s++,s<i.length&&i[s].type===t)return s++,{value:e,newIndex:s};throw Ti.fromUnparsedLexemes(i,s,"Expected closing parenthesis after wildcard '*'.")}let e=this.parseFromLexeme(i,s);for(s=e.newIndex,r.push(e.value);s<i.length&&16&i[s].type;){s++;let e=this.parseFromLexeme(i,s);s=e.newIndex,r.push(e.value)}if(s<i.length&&i[s].type===t)return s++,1===r.length?{value:r[0],newIndex:s}:{value:new Te(r),newIndex:s};throw Ti.fromUnparsedLexemes(i,s,"Missing closing parenthesis.")}throw Ti.fromUnparsedLexemes(i,n,"Expected opening parenthesis.")}static parseArrayAccess(e,t,i){let n=t,s=i;for(;n<e.length&&512&e[n].type&&!this.isSqlServerBracketIdentifier(e,n);){if(n++,n>=e.length)throw new Error("Expected array index or slice after '[' at index "+(n-1));if(1024&e[n].type)throw new Error(`Empty array access brackets not supported at index ${n}`);let t=null,i=!1;if(2&e[n].type&&":"===e[n].value)i=!0,n++;else{let s=Ii.getPrecedence(":"),r=this.parseExpressionWithPrecedence(e,n,s+1);t=r.value,n=r.newIndex,n<e.length&&2&e[n].type&&":"===e[n].value&&(i=!0,n++)}if(i){let i=null;if(n<e.length&&!(1024&e[n].type)){let t=Ii.getPrecedence(":"),s=this.parseExpressionWithPrecedence(e,n,t+1);i=s.value,n=s.newIndex}if(n>=e.length||!(1024&e[n].type))throw new Error(`Expected ']' after array slice at index ${n}`);n++,s=new Ye(s,t,i)}else{if(!t){let i=this.parseFromLexeme(e,n);t=i.value,n=i.newIndex}if(n>=e.length||!(1024&e[n].type))throw new Error(`Expected ']' after array index at index ${n}`);n++,s=new Xe(s,t)}}return{value:s,newIndex:n}}static isSqlServerBracketIdentifier(e,t){let i=t+1;if(i>=e.length)return!1;for(;i<e.length&&!(1024&e[i].type);){let t=e[i];if(!(64&t.type||2&t.type&&"."===t.value))return!1;i++}if(i>=e.length)return!1;let n=i;if(n+1<e.length){let t=e[n+1];if(2&t.type&&"."===t.value)return!0}i=t+1;let s=!0;for(;i<n;){let t=e[i];if(!(64&t.type||2&t.type&&"."===t.value)){s=!1;break}i++}return s}static isTypeConstructor(e,t,i){let n=i.toUpperCase();if(["NUMERIC","DECIMAL","VARCHAR","CHAR","CHARACTER","TIMESTAMP","TIME","INTERVAL"].includes(n))return!0;if("DATE"===n){let i=t+1;if(i<e.length){let t=e[i];return!(1&t.type&&"string"==typeof t.value&&isNaN(Number(t.value)))}}return!1}},Ai=class{constructor(){this.commonTables=[],this.visitedNodes=new Set,this.isRootVisit=!0,this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(hn.kind,e=>this.visitValuesQuery(e)),this.handlers.set(Tt.kind,e=>this.visitWithClause(e)),this.handlers.set(kt.kind,e=>this.visitCommonTable(e)),this.handlers.set(nt.kind,e=>this.visitSelectItem(e)),this.handlers.set(We.kind,e=>this.visitIdentifierString(e)),this.handlers.set(Ue.kind,e=>this.visitRawString(e)),this.handlers.set(be.kind,e=>this.visitColumnReference(e)),this.handlers.set(Be.kind,e=>this.visitParameterExpression(e)),this.handlers.set(Re.kind,e=>this.visitLiteralValue(e)),this.handlers.set(Ct.kind,e=>this.visitSourceExpression(e)),this.handlers.set(wt.kind,e=>this.visitTableSource(e)),this.handlers.set(ft.kind,e=>this.visitFunctionSource(e)),this.handlers.set(yt.kind,e=>this.visitParenSource(e)),this.handlers.set(vt.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(ke.kind,e=>this.visitInlineQuery(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e)),this.handlers.set(gt.kind,e=>this.visitJoinClause(e)),this.handlers.set(xt.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(Et.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(lt.kind,e=>this.visitWhereClause(e)),this.handlers.set(Ve.kind,e=>this.visitParenExpression(e)),this.handlers.set(_e.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(Fe.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(je.kind,e=>this.visitCaseExpression(e)),this.handlers.set(qe.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(Qe.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(ze.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(Ie.kind,e=>this.visitFunctionCall(e)),this.handlers.set(Me.kind,e=>this.visitArrayExpression(e)),this.handlers.set(De.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(Ge.kind,e=>this.visitTupleExpression(e)),this.handlers.set(Ke.kind,e=>this.visitCastExpression(e)),this.handlers.set(Le.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set($e.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(He.kind,e=>this.visitTypeValue(e)),this.handlers.set(Te.kind,e=>this.visitValueList(e)),this.handlers.set(Je.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(dt.kind,e=>this.visitGroupByClause(e)),this.handlers.set(mt.kind,e=>this.visitHavingClause(e)),this.handlers.set(pt.kind,e=>this.visitOrderByClause(e)),this.handlers.set(ut.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(bt.kind,e=>this.visitLimitClause(e)),this.handlers.set(Ot.kind,e=>this.visitForClause(e)),this.handlers.set(ct.kind,e=>this.visitOrderByItem(e)),this.handlers.set(ot.kind,e=>this.visitPartitionByClause(e))}getCommonTables(){return this.commonTables}reset(){this.commonTables=[],this.visitedNodes.clear()}collect(e){return this.visit(e),this.getCommonTables()}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){var t,i;if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let n=this.handlers.get(e.getKind());if(n)return void n(e);let s=(null==(t=e.getKind())?void 0:t.toString())||"unknown",r=(null==(i=e.constructor)?void 0:i.name)||"unknown";throw new Error(`[CTECollector] No handler for ${r} with kind ${s}.`)}visitSimpleSelectQuery(e){if(e.fromClause&&e.fromClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.orderByClause&&e.orderByClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.limitClause&&e.limitClause.accept(this),e.forClause&&e.forClause.accept(this),e.selectClause.accept(this),e.withClause&&e.withClause.accept(this)}visitBinarySelectQuery(e){e.left.accept(this),e.right.accept(this)}visitValuesQuery(e){for(let t of e.tuples)t.accept(this)}visitWithClause(e){for(let t=0;t<e.tables.length;t++)e.tables[t].accept(this)}visitCommonTable(e){e.query.accept(this),this.commonTables.push(e)}visitSelectClause(e){for(let t of e.items)t.accept(this)}visitSelectItem(e){e.value.accept(this)}visitFromClause(e){if(e.source.accept(this),e.joins)for(let t of e.joins)t.accept(this)}visitSourceExpression(e){e.datasource.accept(this)}visitTableSource(e){}visitFunctionSource(e){e.argument&&e.argument.accept(this)}visitParenSource(e){e.source.accept(this)}visitSubQuerySource(e){e.query.accept(this)}visitInlineQuery(e){e.selectQuery.accept(this)}visitJoinClause(e){e.source.accept(this),e.condition&&e.condition.accept(this)}visitJoinOnClause(e){e.condition.accept(this)}visitJoinUsingClause(e){e.condition.accept(this)}visitWhereClause(e){e.condition.accept(this)}visitGroupByClause(e){for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition.accept(this)}visitOrderByClause(e){for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitLimitClause(e){e.value.accept(this)}visitForClause(e){}visitOrderByItem(e){e.value.accept(this)}visitParenExpression(e){e.expression.accept(this)}visitBinaryExpression(e){e.left.accept(this),e.right.accept(this)}visitUnaryExpression(e){e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase.accept(this)}visitSwitchCaseArgument(e){for(let t of e.cases)t.accept(this);e.elseValue&&e.elseValue.accept(this)}visitCaseKeyValuePair(e){e.key.accept(this),e.value.accept(this)}visitBetweenExpression(e){e.expression.accept(this),e.lower.accept(this),e.upper.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitArrayExpression(e){e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitTupleExpression(e){for(let t of e.values)t.accept(this)}visitCastExpression(e){e.input.accept(this),e.castType.accept(this)}visitTypeValue(e){e.argument&&e.argument.accept(this)}visitWindowFrameExpression(e){e.partition&&e.partition.accept(this),e.order&&e.order.accept(this),e.frameSpec&&e.frameSpec.accept(this)}visitWindowFrameSpec(e){}visitIdentifierString(e){}visitRawString(e){}visitColumnReference(e){}visitParameterExpression(e){}visitLiteralValue(e){}visitPartitionByClause(e){}visitValueList(e){for(let t of e.values)t.accept(this)}visitStringSpecifierExpression(e){}},Oi=class{constructor(){this.visitedNodes=new Set,this.isRootVisit=!0,this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(hn.kind,e=>this.visitValuesQuery(e)),this.handlers.set(nt.kind,e=>this.visitSelectItem(e)),this.handlers.set(We.kind,e=>this.visitIdentifierString(e)),this.handlers.set(Ue.kind,e=>this.visitRawString(e)),this.handlers.set(be.kind,e=>this.visitColumnReference(e)),this.handlers.set(Be.kind,e=>this.visitParameterExpression(e)),this.handlers.set(Re.kind,e=>this.visitLiteralValue(e)),this.handlers.set(Ct.kind,e=>this.visitSourceExpression(e)),this.handlers.set(wt.kind,e=>this.visitTableSource(e)),this.handlers.set(yt.kind,e=>this.visitParenSource(e)),this.handlers.set(vt.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(ke.kind,e=>this.visitInlineQuery(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e)),this.handlers.set(gt.kind,e=>this.visitJoinClause(e)),this.handlers.set(xt.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(Et.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(lt.kind,e=>this.visitWhereClause(e)),this.handlers.set(Ve.kind,e=>this.visitParenExpression(e)),this.handlers.set(_e.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(Fe.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(je.kind,e=>this.visitCaseExpression(e)),this.handlers.set(qe.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(Qe.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(ze.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(Ie.kind,e=>this.visitFunctionCall(e)),this.handlers.set(Me.kind,e=>this.visitArrayExpression(e)),this.handlers.set(De.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(Ge.kind,e=>this.visitTupleExpression(e)),this.handlers.set(Ke.kind,e=>this.visitCastExpression(e)),this.handlers.set(Le.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set($e.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(He.kind,e=>this.visitTypeValue(e)),this.handlers.set(Te.kind,e=>this.visitValueList(e)),this.handlers.set(Ye.kind,e=>this.visitArraySliceExpression(e)),this.handlers.set(Xe.kind,e=>this.visitArrayIndexExpression(e)),this.handlers.set(Je.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(dt.kind,e=>this.visitGroupByClause(e)),this.handlers.set(mt.kind,e=>this.visitHavingClause(e)),this.handlers.set(pt.kind,e=>this.visitOrderByClause(e)),this.handlers.set(ut.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(bt.kind,e=>this.visitLimitClause(e)),this.handlers.set(Ot.kind,e=>this.visitForClause(e)),this.handlers.set(ct.kind,e=>this.visitOrderByItem(e)),this.handlers.set(ot.kind,e=>this.visitPartitionByClause(e))}reset(){this.visitedNodes.clear()}execute(e){return this.reset(),this.visit(e)}visit(e){if(!this.isRootVisit)return this.visitNode(e);this.reset(),this.isRootVisit=!1;try{return this.visitNode(e)}finally{this.isRootVisit=!0}}visitNode(e){var t,i;if(this.visitedNodes.has(e))return e;this.visitedNodes.add(e);let n=this.handlers.get(e.getKind());if(n)return n(e);let s=(null==(t=e.getKind())?void 0:t.toString())||"unknown",r=(null==(i=e.constructor)?void 0:i.name)||"unknown";throw new Error(`[CTEDisabler] No handler for ${r} with kind ${s}.`)}visitSimpleSelectQuery(e){return e.withClause&&e.withClause.tables.forEach(e=>{this.visit(e.query)}),e.withClause=null,e.selectClause=this.visit(e.selectClause),e.fromClause=e.fromClause?this.visit(e.fromClause):null,e.whereClause=e.whereClause?this.visit(e.whereClause):null,e.groupByClause=e.groupByClause?this.visit(e.groupByClause):null,e.havingClause=e.havingClause?this.visit(e.havingClause):null,e.orderByClause=e.orderByClause?this.visit(e.orderByClause):null,e.windowClause&&(e.windowClause=new ht(e.windowClause.windows.map(e=>this.visit(e)))),e.limitClause=e.limitClause?this.visit(e.limitClause):null,e.forClause=e.forClause?this.visit(e.forClause):null,e}visitBinarySelectQuery(e){return e.left=this.visit(e.left),e.right=this.visit(e.right),e}visitValuesQuery(e){let t=e.tuples.map(e=>this.visit(e));return new hn(t)}visitSelectClause(e){let t=e.items.map(e=>this.visit(e));return new st(t,e.distinct)}visitFromClause(e){let t=this.visit(e.source),i=e.joins?e.joins.map(e=>this.visit(e)):null;return new St(t,i)}visitSubQuerySource(e){let t=this.visit(e.query);return new vt(t)}visitInlineQuery(e){let t=this.visit(e.selectQuery);return new ke(t)}visitJoinClause(e){let t=this.visit(e.source),i=e.condition?this.visit(e.condition):null;return new gt(e.joinType.value,t,i,e.lateral)}visitJoinOnClause(e){let t=this.visit(e.condition);return new xt(t)}visitJoinUsingClause(e){let t=this.visit(e.condition);return new Et(t)}visitWhereClause(e){let t=this.visit(e.condition);return new lt(t)}visitGroupByClause(e){let t=e.grouping.map(e=>this.visit(e));return new dt(t)}visitHavingClause(e){let t=this.visit(e.condition);return new mt(t)}visitOrderByClause(e){let t=e.order.map(e=>this.visit(e));return new pt(t)}visitWindowFrameClause(e){let t=this.visit(e.expression);return new ut(e.name.name,t)}visitLimitClause(e){let t=this.visit(e.value);return new bt(t)}visitForClause(e){return new Ot(e.lockMode)}visitParenExpression(e){let t=this.visit(e.expression);return new Ve(t)}visitBinaryExpression(e){let t=this.visit(e.left),i=this.visit(e.right);return new _e(t,e.operator.value,i)}visitUnaryExpression(e){let t=this.visit(e.expression);return new Fe(e.operator.value,t)}visitCaseExpression(e){let t=e.condition?this.visit(e.condition):null,i=this.visit(e.switchCase);return new je(t,i)}visitSwitchCaseArgument(e){let t=e.cases.map(e=>this.visit(e)),i=e.elseValue?this.visit(e.elseValue):null;return new Qe(t,i)}visitCaseKeyValuePair(e){let t=this.visit(e.key),i=this.visit(e.value);return new qe(t,i)}visitBetweenExpression(e){let t=this.visit(e.expression),i=this.visit(e.lower),n=this.visit(e.upper);return new ze(t,i,n,e.negated)}visitFunctionCall(e){let t=e.argument?this.visit(e.argument):null,i=e.over?this.visit(e.over):null;return new Ie(e.namespaces,e.name,t,i)}visitArrayExpression(e){let t=this.visit(e.expression);return new Me(t)}visitArrayQueryExpression(e){let t=this.visit(e.query);return new De(t)}visitTupleExpression(e){let t=e.values.map(e=>this.visit(e));return new Ge(t)}visitCastExpression(e){let t=this.visit(e.input),i=this.visit(e.castType);return new Ke(t,i)}visitTypeValue(e){let t=e.argument?this.visit(e.argument):null;return new He(e.namespaces,e.name,t)}visitSelectItem(e){var t;let i=this.visit(e.value);return new nt(i,null==(t=e.identifier)?void 0:t.name)}visitIdentifierString(e){return e}visitRawString(e){return e}visitColumnReference(e){return e}visitSourceExpression(e){let t=this.visit(e.datasource),i=e.aliasExpression;return new Ct(t,i)}visitTableSource(e){return e}visitParenSource(e){let t=this.visit(e.source);return new yt(t)}visitParameterExpression(e){return e}visitWindowFrameExpression(e){let t=e.partition?this.visit(e.partition):null,i=e.order?this.visit(e.order):null,n=e.frameSpec?this.visit(e.frameSpec):null;return new Le(t,i,n)}visitWindowFrameSpec(e){return e}visitLiteralValue(e){return e}visitOrderByItem(e){let t=this.visit(e.value);return new ct(t,e.sortDirection,e.nullsPosition)}visitValueList(e){let t=e.values.map(e=>this.visit(e));return new Te(t)}visitArraySliceExpression(e){return e}visitArrayIndexExpression(e){return e}visitStringSpecifierExpression(e){return e}visitPartitionByClause(e){let t=this.visit(e.value);return new ot(t)}},Pi=class{constructor(e=!0){this.tableSources=[],this.visitedNodes=new Set,this.tableNameMap=new Map,this.cteNames=new Set,this.isRootVisit=!0,this.selectableOnly=e,this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(hn.kind,e=>this.visitValuesQuery(e)),this.handlers.set(Tt.kind,e=>this.visitWithClause(e)),this.handlers.set(kt.kind,e=>this.visitCommonTable(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e)),this.handlers.set(gt.kind,e=>this.visitJoinClause(e)),this.handlers.set(xt.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(Et.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(Ct.kind,e=>this.visitSourceExpression(e)),this.handlers.set(wt.kind,e=>this.visitTableSource(e)),this.handlers.set(ft.kind,e=>this.visitFunctionSource(e)),this.handlers.set(yt.kind,e=>this.visitParenSource(e)),this.handlers.set(vt.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(ke.kind,e=>this.visitInlineQuery(e)),e||(this.handlers.set(lt.kind,e=>this.visitWhereClause(e)),this.handlers.set(dt.kind,e=>this.visitGroupByClause(e)),this.handlers.set(mt.kind,e=>this.visitHavingClause(e)),this.handlers.set(pt.kind,e=>this.visitOrderByClause(e)),this.handlers.set(ut.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(bt.kind,e=>this.visitLimitClause(e)),this.handlers.set(It.kind,e=>this.visitOffsetClause(e)),this.handlers.set(Nt.kind,e=>this.visitFetchClause(e)),this.handlers.set(Ot.kind,e=>this.visitForClause(e)),this.handlers.set(ct.kind,e=>this.visitOrderByItem(e)),this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(nt.kind,e=>this.visitSelectItem(e)),this.handlers.set(Ve.kind,e=>this.visitParenExpression(e)),this.handlers.set(_e.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(Fe.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(je.kind,e=>this.visitCaseExpression(e)),this.handlers.set(qe.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(Qe.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(ze.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(Ie.kind,e=>this.visitFunctionCall(e)),this.handlers.set(Me.kind,e=>this.visitArrayExpression(e)),this.handlers.set(De.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(Ge.kind,e=>this.visitTupleExpression(e)),this.handlers.set(Ke.kind,e=>this.visitCastExpression(e)),this.handlers.set(Te.kind,e=>this.visitValueList(e)),this.handlers.set(Je.kind,e=>this.visitStringSpecifierExpression(e)))}getTableSources(){return this.tableSources}reset(){this.tableSources=[],this.tableNameMap.clear(),this.visitedNodes.clear(),this.cteNames.clear()}getTableIdentifier(e){return e.qualifiedName.namespaces&&e.qualifiedName.namespaces.length>0?e.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+(e.qualifiedName.name instanceof Ue?e.qualifiedName.name.value:e.qualifiedName.name.name):e.qualifiedName.name instanceof Ue?e.qualifiedName.name.value:e.qualifiedName.name.name}collect(e){return this.visit(e),this.getTableSources()}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.selectableOnly||this.collectCTEs(e),this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}collectCTEs(e){let t=new Ai;t.visit(e);let i=t.getCommonTables();for(let n of i)this.cteNames.add(n.aliasExpression.table.name)}visitSimpleSelectQuery(e){if(e.fromClause&&e.fromClause.accept(this),!this.selectableOnly){if(e.withClause&&e.withClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.orderByClause&&e.orderByClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.limitClause&&e.limitClause.accept(this),e.offsetClause&&e.offsetClause.accept(this),e.fetchClause&&e.fetchClause.accept(this),e.forClause&&e.forClause.accept(this),e.selectClause.accept(this)}}visitBinarySelectQuery(e){e.left.accept(this),e.right.accept(this)}visitValuesQuery(e){if(!this.selectableOnly)for(let t of e.tuples)t.accept(this)}visitWithClause(e){if(!this.selectableOnly)for(let t of e.tables)t.accept(this)}visitCommonTable(e){this.selectableOnly||e.query.accept(this)}visitFromClause(e){if(e.source.accept(this),e.joins)for(let t of e.joins)t.accept(this)}visitSourceExpression(e){e.datasource.accept(this)}visitTableSource(e){let t=this.getTableIdentifier(e);!this.tableNameMap.has(t)&&!this.isCTETable(e.table.name)&&(this.tableNameMap.set(t,!0),this.tableSources.push(e))}visitFunctionSource(e){e.argument&&this.visitValueComponent(e.argument)}visitValueComponent(e){e.accept(this)}isCTETable(e){return this.cteNames.has(e)}visitParenSource(e){e.source.accept(this)}visitSubQuerySource(e){this.selectableOnly||e.query.accept(this)}visitInlineQuery(e){this.selectableOnly||e.selectQuery.accept(this)}visitJoinClause(e){e.source.accept(this),!this.selectableOnly&&e.condition&&e.condition.accept(this)}visitJoinOnClause(e){this.selectableOnly||e.condition.accept(this)}visitJoinUsingClause(e){this.selectableOnly||e.condition.accept(this)}visitWhereClause(e){e.condition.accept(this)}visitGroupByClause(e){for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition.accept(this)}visitOrderByClause(e){for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitLimitClause(e){e.value.accept(this)}visitOffsetClause(e){e.value.accept(this)}visitFetchClause(e){e.expression.accept(this)}visitForClause(e){}visitOrderByItem(e){e.value.accept(this)}visitSelectClause(e){for(let t of e.items)t.accept(this)}visitSelectItem(e){e.value.accept(this)}visitParenExpression(e){e.expression.accept(this)}visitBinaryExpression(e){e.left.accept(this),e.right.accept(this)}visitUnaryExpression(e){e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase.accept(this)}visitSwitchCaseArgument(e){for(let t of e.cases)t.accept(this);e.elseValue&&e.elseValue.accept(this)}visitCaseKeyValuePair(e){e.key.accept(this),e.value.accept(this)}visitBetweenExpression(e){e.expression.accept(this),e.lower.accept(this),e.upper.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitArrayExpression(e){e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitTupleExpression(e){for(let t of e.values)t.accept(this)}visitCastExpression(e){e.input.accept(this),e.castType.accept(this)}visitValueList(e){for(let t of e.values)t.accept(this)}visitStringSpecifierExpression(e){}},$i=(he=class extends ge{constructor(e){super(),this.hintContent=e}getFullHint(){return"/*+ "+this.hintContent+" */"}static isHintClause(e){let t=e.trim();return t.length>=5&&"/*+"===t.substring(0,3)&&"*/"===t.substring(t.length-2)}static extractHintContent(e){let t=e.trim();if(!this.isHintClause(t))throw new Error("Not a valid hint clause: "+e);return t.slice(3,-2).trim()}},he.kind=Symbol("HintClause"),he),Li=class{constructor(e,t="",i=""){this.innerTokens=[],this.type=e,this.text=t,this.containerType=i}},Fi=class{static collect(e){let t=[];return function e(i){if(i&&"object"==typeof i){i.constructor&&i.constructor.kind===Be.kind&&t.push(i);for(let t of Object.keys(i)){let n=i[t];Array.isArray(n)?n.forEach(e):n&&"object"==typeof n&&n.constructor&&n.constructor.kind&&e(n)}}}(e),t}},_i=class{constructor(e){this.start=(null==e?void 0:e.start)??'"',this.end=(null==e?void 0:e.end)??'"'}decorate(e){return e=this.start+e+this.end}},Ri=class{constructor(e){this.prefix=(null==e?void 0:e.prefix)??":",this.suffix=(null==e?void 0:e.suffix)??"",this.style=(null==e?void 0:e.style)??"named"}decorate(e,t){let i="";return"anonymous"===this.style?i=this.prefix:"indexed"===this.style?i=this.prefix+t:"named"===this.style&&(i=this.prefix+e+this.suffix),e=i}},Bi=((pe=class extends ge{constructor(e){super(),this.withClause=e.withClause??null,this.updateClause=e.updateClause,this.setClause=e.setClause instanceof Lt?e.setClause:new Lt(e.setClause),this.whereClause=e.whereClause??null,this.fromClause=e.fromClause??null,this.returningClause=e.returning??null}}).kind=Symbol("UpdateQuery"),pe),Qi=class e{constructor(e=null,t=null){this.selectValues=[],this.visitedNodes=new Set,this.isRootVisit=!0,this.tableColumnResolver=e??null,this.commonTableCollector=new Ai,this.commonTables=[],this.initialCommonTables=t,this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(Ct.kind,e=>this.visitSourceExpression(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e))}getValues(){return this.selectValues}reset(){this.selectValues=[],this.visitedNodes.clear(),this.initialCommonTables?this.commonTables=this.initialCommonTables:this.commonTables=[]}collect(e){this.visit(e);let t=this.getValues();return this.reset(),t}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}visitSimpleSelectQuery(e){0===this.commonTables.length&&null===this.initialCommonTables&&(this.commonTables=this.commonTableCollector.collect(e)),e.selectClause&&e.selectClause.accept(this);let t=this.selectValues.filter(e=>"*"===e.name);if(0===t.length)return;if(this.selectValues.some(e=>e.value instanceof be&&null===e.value.namespaces))return e.fromClause&&this.processFromClause(e.fromClause,!0),void(this.selectValues=this.selectValues.filter(e=>"*"!==e.name));let i=t.filter(e=>e.value instanceof be&&e.value.namespaces).map(e=>e.value.getNamespace());if(e.fromClause){let t=e.fromClause.getSourceAliasName();if(t&&i.includes(t)&&this.processFromClause(e.fromClause,!1),e.fromClause.joins)for(let n of e.fromClause.joins){let e=n.getSourceAliasName();e&&i.includes(e)&&this.processJoinClause(n)}}this.selectValues=this.selectValues.filter(e=>"*"!==e.name)}processFromClause(e,t){if(e){let i=e.getSourceAliasName();if(this.processSourceExpression(i,e.source),e.joins&&t)for(let t of e.joins)this.processJoinClause(t)}}processJoinClause(e){let t=e.getSourceAliasName();this.processSourceExpression(t,e.source)}processSourceExpression(t,i){let n=this.commonTables.find(e=>e.aliasExpression.table.name===t);if(n){let i=this.commonTables.filter(e=>e.aliasExpression.table.name!==t);new e(this.tableColumnResolver,i).collect(n.query).forEach(e=>{this.addSelectValueAsUnique(e.name,new be(t?[t]:null,e.name))})}else new e(this.tableColumnResolver,this.commonTables).collect(i).forEach(e=>{this.addSelectValueAsUnique(e.name,new be(t?[t]:null,e.name))})}visitSelectClause(e){for(let t of e.items)this.processSelectItem(t)}processSelectItem(e){if(e.identifier)this.addSelectValueAsUnique(e.identifier.name,e.value);else if(e.value instanceof be){let t=e.value.column.name;"*"===t?this.selectValues.push({name:t,value:e.value}):this.addSelectValueAsUnique(t,e.value)}}visitSourceExpression(t){if(t.aliasExpression&&t.aliasExpression.columns){let e=t.getAliasName();return void t.aliasExpression.columns.forEach(t=>{this.addSelectValueAsUnique(t.name,new be(e?[e]:null,t.name))})}if(t.datasource instanceof wt){if(this.tableColumnResolver){let e=t.datasource.getSourceName();this.tableColumnResolver(e).forEach(t=>{this.addSelectValueAsUnique(t,new be([e],t))})}}else{if(t.datasource instanceof vt){let i=t.getAliasName();return void new e(this.tableColumnResolver,this.commonTables).collect(t.datasource.query).forEach(e=>{this.addSelectValueAsUnique(e.name,new be(i?[i]:null,e.name))})}if(t.datasource instanceof yt)return this.visit(t.datasource.source)}}visitFromClause(e){e&&this.processFromClause(e,!0)}addSelectValueAsUnique(e,t){this.selectValues.some(t=>t.name===e)||this.selectValues.push({name:e,value:t})}},qi=((ce=class extends ge{constructor(e){super(),this.tableName=new We(e.tableName),this.isTemporary=e.isTemporary??!1,this.asSelectQuery=e.asSelectQuery}getSelectQuery(){let e;return e=this.asSelectQuery?(new Qi).collect(this.asSelectQuery).map(e=>new nt(e.value,e.name)):[new nt(new Ue("*"))],new on({selectClause:new st(e),fromClause:new St(new Ct(new wt(null,this.tableName.name),null),null)})}getCountQuery(){return new on({selectClause:new st([new nt(new Ie(null,"count",new be(null,"*"),null))]),fromClause:new St(new Ct(new wt(null,this.tableName.name),null),null)})}}).kind=Symbol("CreateTableQuery"),ce),Ui={mysql:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},postgres:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},postgresWithNamedParams:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},sqlserver:{identifierEscape:{start:"[",end:"]"},parameterSymbol:"@",parameterStyle:"named"},sqlite:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},oracle:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},clickhouse:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},firebird:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},db2:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},snowflake:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},cloudspanner:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"@",parameterStyle:"named"},duckdb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},cockroachdb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},athena:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},bigquery:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"@",parameterStyle:"named"},hive:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},mariadb:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},redshift:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},flinksql:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},mongodb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"}},Wi=(de=class{constructor(e){var t,i,n;this.handlers=new Map,this.index=1,(null==e?void 0:e.preset)&&(e={...e.preset,...e}),this.parameterDecorator=new Ri({prefix:"string"==typeof(null==e?void 0:e.parameterSymbol)?e.parameterSymbol:(null==(t=null==e?void 0:e.parameterSymbol)?void 0:t.start)??":",suffix:"object"==typeof(null==e?void 0:e.parameterSymbol)?e.parameterSymbol.end:"",style:(null==e?void 0:e.parameterStyle)??"named"}),this.identifierDecorator=new _i({start:(null==(i=null==e?void 0:e.identifierEscape)?void 0:i.start)??'"',end:(null==(n=null==e?void 0:e.identifierEscape)?void 0:n.end)??'"'}),this.handlers.set(Te.kind,e=>this.visitValueList(e)),this.handlers.set(be.kind,e=>this.visitColumnReference(e)),this.handlers.set(it.kind,e=>this.visitQualifiedName(e)),this.handlers.set(Ie.kind,e=>this.visitFunctionCall(e)),this.handlers.set(Fe.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(_e.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(Re.kind,e=>this.visitLiteralValue(e)),this.handlers.set(Be.kind,e=>this.visitParameterExpression(e)),this.handlers.set(Qe.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(qe.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(Ue.kind,e=>this.visitRawString(e)),this.handlers.set(We.kind,e=>this.visitIdentifierString(e)),this.handlers.set(Ve.kind,e=>this.visitParenExpression(e)),this.handlers.set(Ke.kind,e=>this.visitCastExpression(e)),this.handlers.set(je.kind,e=>this.visitCaseExpression(e)),this.handlers.set(Me.kind,e=>this.visitArrayExpression(e)),this.handlers.set(De.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(Ye.kind,e=>this.visitArraySliceExpression(e)),this.handlers.set(Xe.kind,e=>this.visitArrayIndexExpression(e)),this.handlers.set(ze.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(Je.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(He.kind,e=>this.visitTypeValue(e)),this.handlers.set(Ge.kind,e=>this.visitTupleExpression(e)),this.handlers.set(ke.kind,e=>this.visitInlineQuery(e)),this.handlers.set(Le.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set($e.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(Oe.kind,e=>this.visitWindowFrameBoundStatic(e)),this.handlers.set(Pe.kind,e=>this.visitWindowFrameBoundaryValue(e)),this.handlers.set(ot.kind,e=>this.visitPartitionByClause(e)),this.handlers.set(pt.kind,e=>this.visitOrderByClause(e)),this.handlers.set(ct.kind,e=>this.visitOrderByItem(e)),this.handlers.set(nt.kind,e=>this.visitSelectItem(e)),this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(rt.kind,e=>this.visitDistinct(e)),this.handlers.set(at.kind,e=>this.visitDistinctOn(e)),this.handlers.set($i.kind,e=>this.visitHintClause(e)),this.handlers.set(wt.kind,e=>this.visitTableSource(e)),this.handlers.set(ft.kind,e=>this.visitFunctionSource(e)),this.handlers.set(Ct.kind,e=>this.visitSourceExpression(e)),this.handlers.set(Pt.kind,e=>this.visitSourceAliasExpression(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e)),this.handlers.set(gt.kind,e=>this.visitJoinClause(e)),this.handlers.set(xt.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(Et.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(lt.kind,e=>this.visitWhereClause(e)),this.handlers.set(dt.kind,e=>this.visitGroupByClause(e)),this.handlers.set(mt.kind,e=>this.visitHavingClause(e)),this.handlers.set(ht.kind,e=>this.visitWindowClause(e)),this.handlers.set(ut.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(bt.kind,e=>this.visitLimitClause(e)),this.handlers.set(It.kind,e=>this.visitOffsetClause(e)),this.handlers.set(Nt.kind,e=>this.visitFetchClause(e)),this.handlers.set(At.kind,e=>this.visitFetchExpression(e)),this.handlers.set(Ot.kind,e=>this.visitForClause(e)),this.handlers.set(Tt.kind,e=>this.visitWithClause(e)),this.handlers.set(kt.kind,e=>this.visitCommonTable(e)),this.handlers.set(on.kind,e=>this.visitSimpleQuery(e)),this.handlers.set(vt.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(hn.kind,e=>this.visitValuesQuery(e)),this.handlers.set(Ge.kind,e=>this.visitTupleExpression(e)),this.handlers.set(Se.kind,e=>this.visitInsertQuery(e)),this.handlers.set(Rt.kind,e=>this.visitInsertClause(e)),this.handlers.set(Bi.kind,e=>this.visitUpdateQuery(e)),this.handlers.set(_t.kind,e=>this.visitUpdateClause(e)),this.handlers.set(Lt.kind,e=>this.visitSetClause(e)),this.handlers.set(Ft.kind,e=>this.visitSetClauseItem(e)),this.handlers.set($t.kind,e=>this.visitReturningClause(e)),this.handlers.set(qi.kind,e=>this.visitCreateTableQuery(e))}visitBinarySelectQuery(e){let t=new Li(0,"");return t.innerTokens.push(this.visit(e.left)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,e.operator.value,"BinarySelectQueryOperator")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.right)),t}static commaSpaceTokens(){return[de.COMMA_TOKEN,de.SPACE_TOKEN]}static argumentCommaSpaceTokens(){return[de.ARGUMENT_SPLIT_COMMA_TOKEN,de.SPACE_TOKEN]}visitQualifiedName(e){let t=new Li(0,"","QualifiedName");if(e.namespaces)for(let i=0;i<e.namespaces.length;i++)t.innerTokens.push(e.namespaces[i].accept(this)),t.innerTokens.push(de.DOT_TOKEN);return t.innerTokens.push(e.name.accept(this)),t}visitPartitionByClause(e){let t=new Li(1,"partition by","PartitionByClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.value)),t}visitOrderByClause(e){let t=new Li(1,"order by","OrderByClause");t.innerTokens.push(de.SPACE_TOKEN);for(let i=0;i<e.order.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.order[i]));return t}visitOrderByItem(e){let t=new Li(0,"","OrderByItem");return t.innerTokens.push(this.visit(e.value)),e.sortDirection&&"asc"!==e.sortDirection&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"desc"))),e.nullsPosition&&("first"===e.nullsPosition?(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"nulls first"))):"last"===e.nullsPosition&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"nulls last")))),t}parse(e){this.index=1;let t=this.visit(e),i=Fi.collect(e).sort((e,t)=>(e.index??0)-(t.index??0)),n=this.parameterDecorator.style;if("named"===n){let e={};for(let t of i){let i=t.name.value;if(e.hasOwnProperty(i)){if(e[i]!==t.value)throw new Error(`Duplicate parameter name '${i}' with different values detected during query composition.`)}else e[i]=t.value}return{token:t,params:e}}if("indexed"===n){return{token:t,params:i.map(e=>e.value)}}if("anonymous"===n){return{token:t,params:i.map(e=>e.value)}}return{token:t,params:[]}}visit(e){let t=this.handlers.get(e.getKind());if(t){let i=t(e);return this.addCommentsToToken(i,e.comments),i}throw new Error(`[SqlPrintTokenParser] No handler for kind: ${e.getKind().toString()}`)}addCommentsToToken(e,t){if(!t||0===t.length)return;let i=this.createCommentBlocks(t);i.length>0&&this.insertCommentBlocksWithSpacing(e,i)}createCommentBlocks(e){let t=[];for(let i of e)i.trim()&&t.push(this.createSingleCommentBlock(i));return t}createSingleCommentBlock(e){let t=new Li(0,"","CommentBlock"),i=new Li(6,this.formatBlockComment(e));t.innerTokens.push(i);let n=new Li(12,"");t.innerTokens.push(n);let s=new Li(10," ");return t.innerTokens.push(s),t}insertCommentBlocksWithSpacing(e,t){if(e.innerTokens.unshift(...t),this.shouldAddSeparatorSpace(e.containerType)){let i=new Li(10," ");e.innerTokens.splice(t.length,0,i),e.innerTokens.length>t.length+1&&10===e.innerTokens[t.length+1].type&&e.innerTokens.splice(t.length+1,1)}else e.innerTokens.length>t.length&&10===e.innerTokens[t.length].type&&e.innerTokens.splice(t.length,1)}shouldAddSeparatorSpace(e){return this.isClauseLevelContainer(e)}isClauseLevelContainer(e){switch(e){case"SelectClause":case"FromClause":case"WhereClause":case"GroupByClause":case"HavingClause":case"OrderByClause":case"LimitClause":case"OffsetClause":case"WithClause":case"SimpleSelectQuery":return!0;default:return!1}}formatBlockComment(e){return`/* ${e} */`}visitValueList(e){let t=new Li(0,"","ValueList");for(let i=0;i<e.values.length;i++)i>0&&t.innerTokens.push(...de.argumentCommaSpaceTokens()),t.innerTokens.push(this.visit(e.values[i]));return t}visitColumnReference(e){let t=new Li(0,"","ColumnReference");return t.innerTokens.push(e.qualifiedName.accept(this)),t}visitFunctionCall(e){let t=new Li(0,"","FunctionCall");return t.innerTokens.push(e.qualifiedName.accept(this)),t.innerTokens.push(de.PAREN_OPEN_TOKEN),e.argument&&t.innerTokens.push(this.visit(e.argument)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),e.over&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"over")),e.over instanceof We?(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.over.accept(this))):(t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(this.visit(e.over)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN))),t}visitUnaryExpression(e){let t=new Li(0,"","UnaryExpression");return t.innerTokens.push(this.visit(e.operator)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.expression)),t}visitBinaryExpression(e){let t=new Li(0,"","BinaryExpression");return t.innerTokens.push(this.visit(e.left)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(5,e.operator.value)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.right)),t}visitLiteralValue(e){let t;return t="string"==typeof e.value?e.isDollarString?e.value:`'${e.value.replace(/'/g,"''")}'`:null===e.value?"null":e.value.toString(),new Li(2,t,"LiteralValue")}visitParameterExpression(e){e.index=this.index;let t=this.parameterDecorator.decorate(e.name.value,e.index),i=new Li(7,t);return this.index++,i}visitSwitchCaseArgument(e){let t=new Li(0,"","SwitchCaseArgument");for(let i of e.cases)t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(i.accept(this));return e.elseValue&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.createElseToken(e.elseValue))),t}createElseToken(e){let t=new Li(0,"","ElseClause");t.innerTokens.push(new Li(1,"else")),t.innerTokens.push(de.SPACE_TOKEN);let i=new Li(0,"","CaseElseValue");return i.innerTokens.push(this.visit(e)),t.innerTokens.push(i),t}visitCaseKeyValuePair(e){let t=new Li(0,"","CaseKeyValuePair");t.innerTokens.push(new Li(1,"when")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.key)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"then")),t.innerTokens.push(de.SPACE_TOKEN);let i=new Li(0,"","CaseThenValue");return i.innerTokens.push(this.visit(e.value)),t.innerTokens.push(i),t}visitRawString(e){return new Li(2,e.value,"RawString")}visitIdentifierString(e){let t="*"===e.name?e.name:this.identifierDecorator.decorate(e.name);return new Li(2,t,"IdentifierString")}visitParenExpression(e){let t=new Li(0,"","ParenExpression");return t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(this.visit(e.expression)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitCastExpression(e){let t=new Li(0,"","CastExpression");return t.innerTokens.push(this.visit(e.input)),t.innerTokens.push(new Li(5,"::")),t.innerTokens.push(this.visit(e.castType)),t}visitCaseExpression(e){let t=new Li(0,"","CaseExpression");return t.innerTokens.push(new Li(1,"case")),e.condition&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.condition))),t.innerTokens.push(this.visit(e.switchCase)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"end")),t}visitArrayExpression(e){let t=new Li(0,"","ArrayExpression");return t.innerTokens.push(new Li(1,"array")),t.innerTokens.push(new Li(4,"[")),t.innerTokens.push(this.visit(e.expression)),t.innerTokens.push(new Li(4,"]")),t}visitArrayQueryExpression(e){let t=new Li(0,"","ArrayExpression");return t.innerTokens.push(new Li(1,"array")),t.innerTokens.push(new Li(4,"(")),t.innerTokens.push(this.visit(e.query)),t.innerTokens.push(new Li(4,")")),t}visitArraySliceExpression(e){let t=new Li(0,"","ArrayExpression");return t.innerTokens.push(this.visit(e.array)),t.innerTokens.push(new Li(4,"[")),e.startIndex&&t.innerTokens.push(this.visit(e.startIndex)),t.innerTokens.push(new Li(5,":")),e.endIndex&&t.innerTokens.push(this.visit(e.endIndex)),t.innerTokens.push(new Li(4,"]")),t}visitArrayIndexExpression(e){let t=new Li(0,"","ArrayExpression");return t.innerTokens.push(this.visit(e.array)),t.innerTokens.push(new Li(4,"[")),t.innerTokens.push(this.visit(e.index)),t.innerTokens.push(new Li(4,"]")),t}visitBetweenExpression(e){let t=new Li(0,"","BetweenExpression");return t.innerTokens.push(this.visit(e.expression)),t.innerTokens.push(de.SPACE_TOKEN),e.negated&&(t.innerTokens.push(new Li(1,"not")),t.innerTokens.push(de.SPACE_TOKEN)),t.innerTokens.push(new Li(1,"between")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.lower)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"and")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.upper)),t}visitStringSpecifierExpression(e){let t=e.specifier.accept(this).text,i=e.value.accept(this).text;return new Li(2,t+i,"StringSpecifierExpression")}visitTypeValue(e){let t=new Li(0,"","TypeValue");return t.innerTokens.push(e.qualifiedName.accept(this)),e.argument&&(t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(this.visit(e.argument)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN)),t}visitTupleExpression(e){let t=new Li(0,"","TupleExpression");t.innerTokens.push(de.PAREN_OPEN_TOKEN);for(let i=0;i<e.values.length;i++)i>0&&t.innerTokens.push(...de.argumentCommaSpaceTokens()),t.innerTokens.push(this.visit(e.values[i]));return t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitWindowFrameExpression(e){let t=new Li(0,"","WindowFrameExpression"),i=!0;return e.partition&&(t.innerTokens.push(this.visit(e.partition)),i=!1),e.order&&(i?i=!1:t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.order))),e.frameSpec&&(i?i=!1:t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.frameSpec))),t}visitWindowFrameSpec(e){let t=new Li(0,"","WindowFrameSpec");return t.innerTokens.push(new Li(1,e.frameType)),null===e.endBound?(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.startBound.accept(this))):(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"between")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.startBound.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"and")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.endBound.accept(this))),t}visitWindowFrameBoundaryValue(e){let t=new Li(0,"","WindowFrameBoundaryValue");return t.innerTokens.push(e.value.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,e.isFollowing?"following":"preceding")),t}visitWindowFrameBoundStatic(e){return new Li(1,e.bound)}visitSelectItem(e){let t=new Li(0,"","SelectItem");if(t.innerTokens.push(this.visit(e.value)),!e.identifier)return t;if(e.value instanceof be){let i=e.value.column.name;if(e.identifier.name===i)return t}return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.identifier)),t}visitSelectClause(e){let t=new Li(1,"select","SelectClause"),i="select";for(let n of e.hints)i+=" "+this.visit(n).text;if(e.distinct){let t=e.distinct.accept(this);if(t.innerTokens&&t.innerTokens.length>0){let e=t.text;for(let i of t.innerTokens)e+=this.flattenTokenText(i);i+=" "+e}else i+=" "+t.text}t.text=i,t.innerTokens.push(de.SPACE_TOKEN);for(let n=0;n<e.items.length;n++)n>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.items[n]));return t}flattenTokenText(e){let t=e.text;if(e.innerTokens)for(let i of e.innerTokens)t+=this.flattenTokenText(i);return t}visitHintClause(e){return new Li(2,e.getFullHint())}visitDistinct(e){return new Li(1,"distinct")}visitDistinctOn(e){let t=new Li(0,"","DistinctOn");return t.innerTokens.push(new Li(1,"distinct on")),t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(e.value.accept(this)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitTableSource(e){let t="";Array.isArray(e.namespaces)&&e.namespaces.length>0&&(t=e.namespaces.map(e=>e.accept(this).text).join(".")+"."),t+=e.table.accept(this).text;let i=new Li(2,t);return e.identifier&&(e.identifier.name,e.table.name),i}visitSourceExpression(e){let t=new Li(0,"","SourceExpression");if(t.innerTokens.push(e.datasource.accept(this)),!e.aliasExpression)return t;if(e.datasource instanceof wt){let i=e.datasource.table.name;return e.aliasExpression.table.name===i||(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.aliasExpression.accept(this))),t}return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.aliasExpression.accept(this)),t}visitFromClause(e){let t=new Li(1,"from","FromClause");if(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.source)),e.joins)for(let i=0;i<e.joins.length;i++)t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.joins[i]));return t}visitJoinClause(e){let t=new Li(0,"","JoinClause");return t.innerTokens.push(new Li(1,e.joinType.value)),e.lateral&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"lateral"))),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.source)),e.condition&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.condition))),t}visitJoinOnClause(e){let t=new Li(0,"","JoinOnClause");return t.innerTokens.push(new Li(1,"on")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.condition)),t}visitJoinUsingClause(e){let t=new Li(0,"","JoinUsingClause");return t.innerTokens.push(new Li(1,"using")),t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(this.visit(e.condition)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitFunctionSource(e){let t=new Li(0,"","FunctionSource");return t.innerTokens.push(e.qualifiedName.accept(this)),t.innerTokens.push(de.PAREN_OPEN_TOKEN),e.argument&&t.innerTokens.push(this.visit(e.argument)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitSourceAliasExpression(e){let t=new Li(0,"","SourceAliasExpression");if(t.innerTokens.push(this.visit(e.table)),e.columns){t.innerTokens.push(de.PAREN_OPEN_TOKEN);for(let i=0;i<e.columns.length;i++)i>0&&t.innerTokens.push(...de.argumentCommaSpaceTokens()),t.innerTokens.push(this.visit(e.columns[i]));t.innerTokens.push(de.PAREN_CLOSE_TOKEN)}return t}visitWhereClause(e){let t=new Li(1,"where","WhereClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.condition)),t}visitGroupByClause(e){let t=new Li(1,"group by","GroupByClause");t.innerTokens.push(de.SPACE_TOKEN);for(let i=0;i<e.grouping.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.grouping[i]));return t}visitHavingClause(e){let t=new Li(1,"having","HavingClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.condition)),t}visitWindowClause(e){let t=new Li(1,"window","WindowClause");t.innerTokens.push(de.SPACE_TOKEN);for(let i=0;i<e.windows.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.windows[i]));return t}visitWindowFrameClause(e){let t=new Li(0,"","WindowFrameClause");return t.innerTokens.push(e.name.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(de.PAREN_OPEN_TOKEN),t.innerTokens.push(this.visit(e.expression)),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitLimitClause(e){let t=new Li(1,"limit","LimitClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.value)),t}visitOffsetClause(e){let t=new Li(1,"offset","OffsetClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.value)),t}visitFetchClause(e){let t=new Li(1,"fetch","FetchClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.expression)),t}visitFetchExpression(e){let t=new Li(0,"","FetchExpression");return t.innerTokens.push(new Li(1,e.type)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.count.accept(this)),e.unit&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,e.unit))),t}visitForClause(e){let t=new Li(1,"for","ForClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,e.lockMode)),t}visitWithClause(e){let t=new Li(1,"with","WithClause");t.innerTokens.push(de.SPACE_TOKEN),e.recursive&&(t.innerTokens.push(new Li(1,"recursive")),t.innerTokens.push(de.SPACE_TOKEN));for(let i=0;i<e.tables.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(e.tables[i].accept(this));return t.innerTokens.push(de.SPACE_TOKEN),t}visitCommonTable(e){let t=new Li(0,"","CommonTable");t.innerTokens.push(e.aliasExpression.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),null!==e.materialized&&(e.materialized?t.innerTokens.push(new Li(1,"materialized")):t.innerTokens.push(new Li(1,"not materialized")),t.innerTokens.push(de.SPACE_TOKEN)),t.innerTokens.push(de.PAREN_OPEN_TOKEN);let i=new Li(0,"","SubQuerySource");return i.innerTokens.push(e.query.accept(this)),t.innerTokens.push(i),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitSimpleQuery(e){let t=new Li(0,"","SimpleSelectQuery");return e.withClause&&t.innerTokens.push(e.withClause.accept(this)),t.innerTokens.push(e.selectClause.accept(this)),e.fromClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.fromClause.accept(this)),e.whereClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.whereClause.accept(this))),e.groupByClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.groupByClause.accept(this))),e.havingClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.havingClause.accept(this))),e.orderByClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.orderByClause.accept(this))),e.windowClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.windowClause.accept(this))),e.limitClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.limitClause.accept(this))),e.offsetClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.offsetClause.accept(this))),e.fetchClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.fetchClause.accept(this))),e.forClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.forClause.accept(this)))),t}visitSubQuerySource(e){let t=new Li(0,"");t.innerTokens.push(de.PAREN_OPEN_TOKEN);let i=new Li(0,"","SubQuerySource");return i.innerTokens.push(e.query.accept(this)),t.innerTokens.push(i),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitValuesQuery(e){let t=new Li(1,"values","ValuesQuery");t.innerTokens.push(de.SPACE_TOKEN);let i=new Li(0,"","Values");for(let n=0;n<e.tuples.length;n++)n>0&&i.innerTokens.push(...de.commaSpaceTokens()),i.innerTokens.push(e.tuples[n].accept(this));return t.innerTokens.push(i),t}visitInlineQuery(e){let t=new Li(0,"");t.innerTokens.push(de.PAREN_OPEN_TOKEN);let i=new Li(0,"","InlineQuery");return i.innerTokens.push(e.selectQuery.accept(this)),t.innerTokens.push(i),t.innerTokens.push(de.PAREN_CLOSE_TOKEN),t}visitInsertQuery(e){let t=new Li(0,"","InsertQuery");return t.innerTokens.push(this.visit(e.insertClause)),e.selectQuery&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(this.visit(e.selectQuery))),t}visitInsertClause(e){let t=new Li(0,"");if(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"insert into")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.source.accept(this)),e.columns.length>0){t.innerTokens.push(de.PAREN_OPEN_TOKEN);for(let i=0;i<e.columns.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(e.columns[i].accept(this));t.innerTokens.push(de.PAREN_CLOSE_TOKEN)}return t}visitUpdateQuery(e){let t=new Li(0,"","UpdateQuery");return e.withClause&&t.innerTokens.push(e.withClause.accept(this)),t.innerTokens.push(e.updateClause.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.setClause.accept(this)),e.fromClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.fromClause.accept(this))),e.whereClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.whereClause.accept(this))),e.returningClause&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.returningClause.accept(this))),t}visitUpdateClause(e){let t=new Li(1,"update","UpdateClause");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.source.accept(this)),t}visitSetClause(e){let t=new Li(1,"set","SelectClause");t.innerTokens.push(de.SPACE_TOKEN);for(let i=0;i<e.items.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.items[i]));return t}visitSetClauseItem(e){let t=new Li(0,"","SetClauseItem");return t.innerTokens.push(e.column.accept(this)),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(5,"=")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.value.accept(this)),t}visitReturningClause(e){let t=new Li(1,"returning","ReturningClause");t.innerTokens.push(de.SPACE_TOKEN);for(let i=0;i<e.columns.length;i++)i>0&&t.innerTokens.push(...de.commaSpaceTokens()),t.innerTokens.push(this.visit(e.columns[i]));return t}visitCreateTableQuery(e){let t=new Li(1,e.isTemporary?"create temporary table":"create table","CreateTableQuery");return t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.tableName.accept(this)),e.asSelectQuery&&(t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(new Li(1,"as")),t.innerTokens.push(de.SPACE_TOKEN),t.innerTokens.push(e.asSelectQuery.accept(this))),t}},de.SPACE_TOKEN=new Li(10," "),de.COMMA_TOKEN=new Li(3,","),de.ARGUMENT_SPLIT_COMMA_TOKEN=new Li(11,","),de.PAREN_OPEN_TOKEN=new Li(4,"("),de.PAREN_CLOSE_TOKEN=new Li(4,")"),de.DOT_TOKEN=new Li(8,"."),de),Vi=class{constructor(e=" ",t=0,i="\r\n"){this.indentChar=e,this.indentSize=t,this.newline=i,this.lines=[],this.appendNewline(0)}print(){let e="";for(let t of this.lines)""!==t.text&&(e+=this.indent(t.level)+t.text);return e.trimEnd()}indent(e){return this.indentChar.repeat(this.indentSize*e)}appendNewline(e){if(this.lines.length>0){let e=this.lines[this.lines.length-1];""!==e.text&&(e.text=e.text.trimEnd()+this.newline)}this.lines.push(new Ki(e,""))}appendText(e){if(!(this.lines.length>0))throw new Error("No tokens to append to.");{let t=this.lines.length-1,i=this.lines[t];" "===e&&""===i.text||(i.text+=e)}}getCurrentLine(){if(this.lines.length>0)return this.lines[this.lines.length-1];throw new Error("No tokens to get current line from.")}},Ki=class{constructor(e,t){this.level=e,this.text=t}},ji=class e{constructor(e){this.insideWithClause=!1,this.indentChar=(null==e?void 0:e.indentChar)??"",this.indentSize=(null==e?void 0:e.indentSize)??0,this.newline=(null==e?void 0:e.newline)??" ",this.commaBreak=(null==e?void 0:e.commaBreak)??"none",this.andBreak=(null==e?void 0:e.andBreak)??"none",this.keywordCase=(null==e?void 0:e.keywordCase)??"none",this.exportComment=(null==e?void 0:e.exportComment)??!1,this.strictCommentPlacement=(null==e?void 0:e.strictCommentPlacement)??!1,this.withClauseStyle=(null==e?void 0:e.withClauseStyle)??"standard",this.linePrinter=new Vi(this.indentChar,this.indentSize,this.newline),this.indentIncrementContainers=new Set((null==e?void 0:e.indentIncrementContainerTypes)??["SelectClause","FromClause","WhereClause","GroupByClause","HavingClause","WindowFrameExpression","PartitionByClause","OrderByClause","WindowClause","LimitClause","OffsetClause","SubQuerySource","BinarySelectQueryOperator","Values","WithClause","SwitchCaseArgument","CaseKeyValuePair","CaseThenValue","ElseClause","CaseElseValue","SimpleSelectQuery"])}print(e,t=0){return this.linePrinter=new Vi(this.indentChar,this.indentSize,this.newline),this.insideWithClause=!1,this.linePrinter.lines.length>0&&t!==this.linePrinter.lines[0].level&&(this.linePrinter.lines[0].level=t),this.appendToken(e,t,void 0),this.linePrinter.print()}appendToken(e,t,i){if(this.insideWithClause,"WithClause"===e.containerType&&"full-oneline"===this.withClauseStyle&&(this.insideWithClause=!0),this.shouldSkipToken(e))return;let n=this.linePrinter.getCurrentLine();if(1===e.type)this.handleKeywordToken(e,t);else if(3===e.type)this.handleCommaToken(e,t,i);else if(5===e.type&&"and"===e.text.toLowerCase())this.handleAndOperatorToken(e,t);else if("JoinClause"===e.containerType)this.handleJoinClauseToken(e,t);else if(6===e.type)this.exportComment&&this.linePrinter.appendText(e.text);else if(10===e.type)this.handleSpaceToken(e,i);else if(12===e.type)this.handleCommentNewlineToken(e,t);else{if("CommonTable"===e.containerType&&"cte-oneline"===this.withClauseStyle)return void this.handleCteOnelineToken(e,t);this.linePrinter.appendText(e.text)}if(e.keywordTokens&&e.keywordTokens.length>0)for(let r=0;r<e.keywordTokens.length;r++){let i=e.keywordTokens[r];this.appendToken(i,t,e.containerType)}let s=t;!this.isOnelineMode()&&""!==n.text&&this.indentIncrementContainers.has(e.containerType)&&(this.insideWithClause&&"full-oneline"===this.withClauseStyle||(s++,this.linePrinter.appendNewline(s)));for(let r=0;r<e.innerTokens.length;r++){let t=e.innerTokens[r];this.appendToken(t,s,e.containerType)}if("WithClause"===e.containerType&&"full-oneline"===this.withClauseStyle)return this.insideWithClause=!1,void this.linePrinter.appendNewline(t);s!==t&&(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t))}shouldSkipToken(e){return 12!==e.type&&((!e.innerTokens||0===e.innerTokens.length)&&""===e.text)}applyKeywordCase(e){return"upper"===this.keywordCase?e.toUpperCase():"lower"===this.keywordCase?e.toLowerCase():e}handleKeywordToken(e,t){let i=this.applyKeywordCase(e.text);this.linePrinter.appendText(i)}handleCommaToken(e,t,i){let n=e.text;this.insideWithClause&&"full-oneline"===this.withClauseStyle?this.linePrinter.appendText(n):"cte-oneline"===this.withClauseStyle&&"WithClause"===i?(this.linePrinter.appendText(n),this.linePrinter.appendNewline(t)):"before"===this.commaBreak?(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(n)):"after"===this.commaBreak?(this.linePrinter.appendText(n),this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t)):this.linePrinter.appendText(n)}handleAndOperatorToken(e,t){let i=this.applyKeywordCase(e.text);"before"===this.andBreak?(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(i)):"after"===this.andBreak?(this.linePrinter.appendText(i),this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t)):this.linePrinter.appendText(i)}handleJoinClauseToken(e,t){let i=this.applyKeywordCase(e.text);this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(i)}handleSpaceToken(e,t){this.shouldSkipCommentBlockSpace(t)||this.linePrinter.appendText(e.text)}shouldSkipCommentBlockSpace(e){return"CommentBlock"===e&&this.insideWithClause&&"full-oneline"===this.withClauseStyle}handleCommentNewlineToken(e,t){this.shouldSkipCommentNewline()||this.isOnelineMode()||this.linePrinter.appendNewline(t)}shouldSkipCommentNewline(){return this.insideWithClause&&"full-oneline"===this.withClauseStyle||"cte-oneline"===this.withClauseStyle}isOnelineMode(){return" "===this.newline}handleCteOnelineToken(e,t){let i=this.createCteOnelinePrinter().print(e,t),n=this.cleanDuplicateSpaces(i);this.linePrinter.appendText(n)}createCteOnelinePrinter(){return new e({indentChar:"",indentSize:0,newline:" ",commaBreak:this.commaBreak,andBreak:this.andBreak,keywordCase:this.keywordCase,exportComment:this.exportComment,strictCommentPlacement:this.strictCommentPlacement,withClauseStyle:"standard"})}cleanDuplicateSpaces(e){return e.replace(/\s{2,}/g," ")}},Mi=class{constructor(e={}){let t=e.preset?Ui[e.preset]:void 0;if(e.preset&&!t)throw new Error(`Invalid preset: ${e.preset}`);let i={...t,identifierEscape:e.identifierEscape??(null==t?void 0:t.identifierEscape),parameterSymbol:e.parameterSymbol??(null==t?void 0:t.parameterSymbol),parameterStyle:e.parameterStyle??(null==t?void 0:t.parameterStyle)};this.parser=new Wi(i),this.printer=new ji(e)}format(e){let{token:t,params:i}=this.parser.parse(e);return{formattedSql:this.printer.print(t),params:i}}},Di=class{constructor(){this.sqlFormatter=new Mi({identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"})}format(e,t=null){return t&&(this.sqlFormatter=new Mi(t)),this.sqlFormatter.format(e).formattedSql}formatWithParameters(e,t=null){t&&(this.sqlFormatter=new Mi(t));let i=this.sqlFormatter.format(e);return{sql:i.formattedSql,params:i.params}}visit(e){return this.format(e)}},zi=class{constructor(){this.sourceCollector=new Pi(!0),this.cteCollector=new Ai,this.formatter=new Di}build(e){if(0===e.length)return new Tt(!1,e);let t=this.resolveDuplicateNames(e),{tableMap:i,recursiveCTEs:n,dependencies:s}=this.buildDependencyGraph(t),r=this.sortCommonTables(t,i,n,s);return new Tt(n.size>0,r)}resolveDuplicateNames(e){let t=new Map;for(let n of e){let e=n.aliasExpression.table.name;t.has(e)||t.set(e,[]),t.get(e).push(n)}let i=[];for(let[n,s]of t.entries()){if(1===s.length){i.push(s[0]);continue}let e=s.map(e=>this.formatter.format(e.query));if(1!==new Set(e).size)throw new Error(`CTE name conflict detected: '${n}' has multiple different definitions`);i.push(s[0])}return i}buildDependencyGraph(e){let t=new Map;for(let r of e)t.set(r.aliasExpression.table.name,r);let i=new Set,n=new Map,s=new Map;for(let r of e){let e=r.aliasExpression.table.name,a=this.sourceCollector.collect(r.query);for(let t of a)if(t.table.name===e){i.add(e);break}n.has(e)||n.set(e,new Set);let l=this.cteCollector.collect(r.query);for(let i of l){let r=i.aliasExpression.table.name;t.has(r)&&(n.get(e).add(r),s.has(r)||s.set(r,new Set),s.get(r).add(e))}}return{tableMap:t,recursiveCTEs:i,dependencies:n}}sortCommonTables(e,t,i,n){let s=[],r=[],a=new Set,l=new Set,o=e=>{if(a.has(e))return;if(l.has(e))throw new Error(`Circular reference detected in CTE: ${e}`);l.add(e);let u=n.get(e)||new Set;for(let t of u)o(t);l.delete(e),a.add(e),i.has(e)?s.push(t.get(e)):r.push(t.get(e))};for(let u of e){let e=u.aliasExpression.table.name;a.has(e)||o(e)}return[...s,...r]}},Ji=class{constructor(){this.nameConflictResolver=new zi,this.cteCollector=new Ai}inject(e,t){if(0===t.length)return e;t.push(...this.cteCollector.collect(e));let i=this.nameConflictResolver.build(t);if(e instanceof on)return this.injectIntoSimpleQuery(e,i);if(e instanceof un)return this.injectIntoBinaryQuery(e,i);throw new Error("Unsupported query type")}injectIntoSimpleQuery(e,t){if(e.withClause)throw new Error("The query already has a WITH clause. Please remove it before injecting new CTEs.");return e.withClause=t,e}injectIntoBinaryQuery(e,t){if(e.left instanceof on)return this.injectIntoSimpleQuery(e.left,t),e;if(e.left instanceof un)return this.injectIntoBinaryQuery(e.left,t),e;throw new Error("Unsupported query type for BinarySelectQuery left side")}},Hi=class{constructor(){}static normalize(e){let t=(new Ai).collect(e);return 0===t.length?e:((new Oi).execute(e),(new Ji).inject(e,t))}},Gi=((tt=Gi||{}).ColumnNameOnly="columnNameOnly",tt.FullName="fullName",tt),Yi=class e{constructor(e,t=!1,i="columnNameOnly",n){this.selectValues=[],this.visitedNodes=new Set,this.uniqueKeys=new Set,this.isRootVisit=!0,this.tableColumnResolver=null,this.commonTables=[],this.initializeProperties(e,t,i,n),this.initializeHandlers()}initializeProperties(e,t,i,n){this.tableColumnResolver=e??null,this.includeWildCard=t,this.commonTableCollector=new Ai,this.commonTables=[],this.duplicateDetection=i,this.options=n||{}}initializeHandlers(){this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e)),this.initializeClauseHandlers(),this.initializeValueComponentHandlers()}initializeClauseHandlers(){this.handlers.set(st.kind,e=>this.visitSelectClause(e)),this.handlers.set(St.kind,e=>this.visitFromClause(e)),this.handlers.set(lt.kind,e=>this.visitWhereClause(e)),this.handlers.set(dt.kind,e=>this.visitGroupByClause(e)),this.handlers.set(mt.kind,e=>this.visitHavingClause(e)),this.handlers.set(pt.kind,e=>this.visitOrderByClause(e)),this.handlers.set(ut.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(bt.kind,e=>this.visitLimitClause(e)),this.handlers.set(It.kind,e=>this.offsetClause(e)),this.handlers.set(Nt.kind,e=>this.visitFetchClause(e)),this.handlers.set(xt.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(Et.kind,e=>this.visitJoinUsingClause(e))}initializeValueComponentHandlers(){this.handlers.set(be.kind,e=>this.visitColumnReference(e)),this.handlers.set(_e.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(Fe.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(Ie.kind,e=>this.visitFunctionCall(e)),this.handlers.set(Ve.kind,e=>this.visitParenExpression(e)),this.handlers.set(je.kind,e=>this.visitCaseExpression(e)),this.handlers.set(Ke.kind,e=>this.visitCastExpression(e)),this.handlers.set(ze.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(Me.kind,e=>this.visitArrayExpression(e)),this.handlers.set(De.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(Te.kind,e=>this.visitValueList(e)),this.handlers.set(Le.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set(ot.kind,e=>this.visitPartitionByClause(e))}getValues(){return this.selectValues}collect(e){if(!e)throw new Error("Input argument cannot be null or undefined");this.visit(e);let t=this.getValues();return this.reset(),t}reset(){this.selectValues=[],this.visitedNodes.clear(),this.uniqueKeys.clear(),this.commonTables=[]}addSelectValueAsUnique(e,t){let i=this.generateUniqueKey(e,t);this.uniqueKeys.has(i)||(this.uniqueKeys.add(i),this.selectValues.push({name:e,value:t}))}generateUniqueKey(e,t){if("columnNameOnly"===this.duplicateDetection)return this.normalizeColumnName(e);{let i="";t&&"function"==typeof t.getNamespace&&(i=t.getNamespace()||"");let n=i?i+"."+e:e;return this.normalizeColumnName(n)}}normalizeColumnName(e){if("string"!=typeof e)throw new Error("Column name must be a string");return this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e}visit(e){if(this.isRootVisit){if(!(e instanceof on||e instanceof un))throw new Error("Root visit requires a SimpleSelectQuery or BinarySelectQuery.");this.reset(),this.isRootVisit=!1,this.commonTables=this.commonTableCollector.collect(e);try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(!this.visitedNodes.has(e)){this.visitedNodes.add(e);try{let t=this.handlers.get(e.getKind());t&&t(e)}catch(tt){let i=tt instanceof Error?tt.message:String(tt);throw new Error(`Error processing SQL component of type ${e.getKind().toString()}: ${i}`)}}}visitSimpleSelectQuery(e){if(e.selectClause&&e.selectClause.accept(this),e.fromClause&&e.fromClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.orderByClause&&e.orderByClause.accept(this),e.limitClause&&e.limitClause.accept(this),e.offsetClause&&e.offsetClause.accept(this),e.fetchClause&&e.fetchClause.accept(this),e.forClause&&e.forClause.accept(this)}visitBinarySelectQuery(e){e.left instanceof on?this.visitSimpleSelectQuery(e.left):e.left instanceof un&&this.visitBinarySelectQuery(e.left),e.right instanceof on?this.visitSimpleSelectQuery(e.right):e.right instanceof un&&this.visitBinarySelectQuery(e.right)}visitSelectClause(e){for(let t of e.items)t.identifier&&this.addSelectValueAsUnique(t.identifier.name,t.value),t.value.accept(this)}visitFromClause(e){let t=new Qi(this.tableColumnResolver,this.commonTables).collect(e);for(let i of t)this.addSelectValueAsUnique(i.name,i.value);if(this.options.upstream&&this.collectUpstreamColumns(e),e.joins)for(let i of e.joins)i.condition&&i.condition.accept(this)}visitWhereClause(e){e.condition&&e.condition.accept(this)}visitGroupByClause(e){if(e.grouping)for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition&&e.condition.accept(this)}visitOrderByClause(e){if(e.order)for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitWindowFrameExpression(e){e.partition&&e.partition.accept(this),e.order&&e.order.accept(this),e.frameSpec&&e.frameSpec.accept(this)}visitLimitClause(e){e.value&&e.value.accept(this)}offsetClause(e){e.value&&e.value.accept(this)}visitFetchClause(e){e.expression&&e.expression.accept(this)}visitJoinOnClause(e){e.condition&&e.condition.accept(this)}visitJoinUsingClause(e){e.condition&&e.condition.accept(this)}visitColumnReference(e){if("*"!==e.column.name)this.addSelectValueAsUnique(e.column.name,e);else{if(!this.includeWildCard)return;this.addSelectValueAsUnique(e.column.name,e)}}visitBinaryExpression(e){e.left&&e.left.accept(this),e.right&&e.right.accept(this)}visitUnaryExpression(e){e.expression&&e.expression.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitParenExpression(e){e.expression&&e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase&&e.switchCase.accept(this)}visitCastExpression(e){e.input&&e.input.accept(this)}visitBetweenExpression(e){e.expression&&e.expression.accept(this),e.lower&&e.lower.accept(this),e.upper&&e.upper.accept(this)}visitArrayExpression(e){e.expression&&e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitValueList(e){if(e.values)for(let t of e.values)t.accept(this)}visitPartitionByClause(e){e.value.accept(this)}collectUpstreamColumns(e){if(this.collectUpstreamColumnsFromSource(e.source),e.joins)for(let t of e.joins)this.collectUpstreamColumnsFromSource(t.source)}collectUpstreamColumnsFromSource(e){if(e.datasource instanceof wt){let t=this.findCTEByName(e.datasource.table.name);t?this.collectUpstreamColumnsFromCTE(t):this.collectUpstreamColumnsFromTable(e.datasource)}else e.datasource instanceof vt?this.collectUpstreamColumnsFromSubquery(e.datasource):e.datasource instanceof yt&&this.collectUpstreamColumnsFromSource(new Ct(e.datasource.source,null))}collectUpstreamColumnsFromTable(e){if(this.tableColumnResolver){let t=e.table.name,i=this.tableColumnResolver(t);for(let n of i){let t=new be(e.table.name,n);this.addSelectValueAsUnique(n,t)}}}collectUpstreamColumnsFromSubquery(t){if(t.query instanceof on){let i=new e(this.tableColumnResolver,this.includeWildCard,this.duplicateDetection,{...this.options,upstream:!0}).collect(t.query);for(let e of i)this.addSelectValueAsUnique(e.name,e.value)}}collectUpstreamColumnsFromCTE(e){if(e.query instanceof on){let t=new Qi(this.tableColumnResolver,this.commonTables).collect(e.query.selectClause);for(let e of t)this.addSelectValueAsUnique(e.name,e.value)}}findCTEByName(e){return this.commonTables.find(t=>t.getSourceAliasName()===e)||null}},Xi=class e{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The source component is complete but there are additional tokens.`);return i.value}static parseTableSourceFromLexemes(e,t){let i=di.parseFromLexeme(e,t);return this.parseTableSource(i)}static parseFromLexeme(t,i){let n=i;if(n<t.length&&4&t[n].type)return this.parseParenSource(t,n);let s=di.parseFromLexeme(t,n);return 2048&s.lastTokenType?e.parseFunctionSource(t,s):e.parseTableSource(s)}static parseTableSource(e){let{namespaces:t,name:i,newIndex:n}=e;return{value:new wt(t,i.name),newIndex:n}}static parseFunctionSource(e,t){let i=t.newIndex,{namespaces:n,name:s}=t,r=Ni.parseArgument(4,8,e,i);i=r.newIndex;let a=s.name;return{value:new ft({namespaces:n,name:a},r.value),newIndex:i}}static parseParenSource(e,t){let i=t;if(i++,i>=e.length)throw new Error(`Syntax error: Unexpected end of input at position ${i}. Expected a subquery or nested expression after opening parenthesis.`);let n=e[i].value;if("select"===n||"values"===n||"with"===n){let t=this.parseSubQuerySource(e,i);if(i=t.newIndex,!(i<e.length&&8==e[i].type))throw new Error(`Syntax error at position ${i}: Missing closing parenthesis. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:t.value,newIndex:i}}if(4==e[i].type){let t=this.parseParenSource(e,i);if(i=t.newIndex,!(i<e.length&&8==e[i].type))throw new Error(`Syntax error at position ${i}: Missing closing parenthesis. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:t.value,newIndex:i}}throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword, 'VALUES' keyword, or opening parenthesis '(' but found "${e[i].value}".`)}static parseSubQuerySource(e,t){let i=t,{value:n,newIndex:s}=On.parseFromLexeme(e,i);return i=s,{value:new vt(n),newIndex:i}}},Zi=class extends Error{constructor(e){super(`CTE '${e}' already exists in the query`),this.cteName=e,this.name="DuplicateCTEError"}},en=class extends Error{constructor(e,t){super(`Invalid CTE name '${e}': ${t}`),this.cteName=e,this.name="InvalidCTENameError"}},tn=class extends Error{constructor(e){super(`CTE '${e}' not found in the query`),this.cteName=e,this.name="CTENotFoundError"}},nn=class{constructor(e,t){this.options=t||{},this.tableColumnResolver=e,this.columnCollector=new Yi(this.tableColumnResolver)}find(e,t){let i="string"==typeof t?[t]:t,n=(new Ai).collect(e),s=new Map;for(let r of n)s.set(r.getSourceAliasName(),r);return this.findUpstream(e,i,s)}handleTableSource(e,t,i){let n=i.get(e.table.name);if(n){let s=new Map(i);s.delete(e.table.name);let r=this.findUpstream(n.query,t,s);return 0===r.length?null:r}return null}handleSubQuerySource(e,t,i){let n=this.findUpstream(e.query,t,i);return 0===n.length?null:n}processFromClauseBranches(e,t,i){let n=e.getSources();if(0===n.length)return null;let s=[],r=!0,a=0;for(let l of n){let e=l.datasource,n=null;if(e instanceof wt)n=this.handleTableSource(e,t,i),a++;else{if(!(e instanceof vt)){if(e instanceof hn)continue;r=!1;break}n=this.handleSubQuerySource(e,t,i),a++}if(null===n){r=!1;break}s.push(n)}return r&&s.length===a?s.flat():null}findUpstream(e,t,i){if(e instanceof on){let n=e.fromClause;if(n){let e=this.processFromClauseBranches(n,t,i);if(e&&e.length>0)return e}let s=[...this.columnCollector.collect(e).map(e=>e.name),...this.collectCTEColumns(e,i)],r=e=>this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e;return t.every(e=>s.some(t=>r(t)===r(e)))?[e]:[]}if(e instanceof un){return[...this.findUpstream(e.left,t,i),...this.findUpstream(e.right,t,i)]}return[]}collectCTEColumns(e,t){let i=[];if(e.withClause)for(let n of e.withClause.tables){let e=this.collectColumnsFromSelectQuery(n.query);i.push(...e)}return i}collectColumnsFromSelectQuery(e){if(e instanceof on)try{return this.columnCollector.collect(e).map(e=>e.name)}catch(tt){return[]}else if(e instanceof un)return this.collectColumnsFromSelectQuery(e.left);return[]}},sn=class{static parseFromLexeme(e,t){var i;let n=t;if(n<e.length&&(64&e[n].type||2048&e[n].type)){let i=e[n].value;if(n++,n<e.length&&4&e[n].type){let s=[];for(n++;n<e.length&&64&e[n].type&&(s.push(e[n].value),n++,n<e.length&&16&e[n].type);)n++;if(!(8&e[n].type))throw new Error(`Syntax error at position ${n}: Missing closing parenthesis ')' for column alias list. Each opening parenthesis must have a matching closing parenthesis.`);if(n++,0===s.length)throw new Error(`Syntax error at position ${t}: No column aliases found. Column alias declarations must contain at least one column name.`);return{value:new Pt(i,s),newIndex:n}}return{value:new Pt(i,null),newIndex:n}}throw new Error(`Syntax error at position ${t}: Expected an identifier for table alias but found "${(null==(i=e[t])?void 0:i.value)||"end of input"}".`)}},rn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The source expression is complete but there are additional tokens.`);return i.value}static parseTableSourceFromLexemes(e,t){let i=Xi.parseTableSourceFromLexemes(e,t);return{value:new Ct(i.value,null),newIndex:i.newIndex}}static parseFromLexeme(e,t){let i=t,n=Xi.parseFromLexeme(e,i);if(i=n.newIndex,i<e.length){if("as"===e[i].value){i++;let t=sn.parseFromLexeme(e,i);return i=t.newIndex,{value:new Ct(n.value,t.value),newIndex:i}}if(i<e.length&&this.isTokenTypeAliasCandidate(e[i].type)){let t=sn.parseFromLexeme(e,i);return i=t.newIndex,{value:new Ct(n.value,t.value),newIndex:i}}}return{value:new Ct(n.value,null),newIndex:i}}static isTokenTypeAliasCandidate(e){return!!(64&e)||!!(2048&e)}},an=class e{static buildBinaryQuery(t,i){if(!t||0===t.length)throw new Error("No queries provided to combine.");if(1===t.length)throw new Error("At least two queries are required to create a BinarySelectQuery.");let n=t=>t instanceof hn?e.buildSimpleQuery(t):t,s=new un(n(t[0]),i,n(t[1]));Hi.normalize(s);for(let e=2;e<t.length;e++)s.appendSelectQuery(i,n(t[e]));return s}constructor(){}static buildSimpleQuery(t){if(t instanceof on)return t;if(t instanceof un)return e.buildSimpleBinaryQuery(t);if(t instanceof hn)return e.buildSimpleValuesQuery(t);throw new Error("Unsupported query type for buildSimpleQuery")}static buildSimpleBinaryQuery(t){let i=e.extractAndRemoveOrderByFromBinaryQuery(t),n=new vt(t),s=new Ct(n,new Pt("bq",null)),r=new St(s,null),a=e.createSelectAllClause(),l=new on({selectClause:a,fromClause:r,orderByClause:i});return Hi.normalize(l)}static extractAndRemoveOrderByFromBinaryQuery(t){return e.findAndRemoveRightmostOrderBy(t)}static findAndRemoveRightmostOrderBy(t){if(t instanceof un){return e.findAndRemoveRightmostOrderBy(t.right)||e.findAndRemoveRightmostOrderBy(t.left)}if(t instanceof on){let e=t.orderByClause;if(e)return t.orderByClause=null,e}return null}static buildSimpleValuesQuery(e){let t=e.tuples.length>0?e.tuples[0].values.length:0;if(0===e.tuples.length)throw new Error("Empty VALUES clause cannot be converted to a SimpleSelectQuery");if(!e.columnAliases)throw new Error("Column aliases are required to convert a VALUES clause to SimpleSelectQuery. Please specify column aliases.");if(e.columnAliases.length!==t)throw new Error(`The number of column aliases (${e.columnAliases.length}) does not match the number of columns in the first tuple (${t}).`);let i=new vt(e),n=new Ct(i,new Pt("vq",e.columnAliases)),s=new St(n,null),r=e.columnAliases.map(e=>new nt(new be("vq",e),e)),a=new st(r,null);return new on({selectClause:a,fromClause:s})}static createSelectAllClause(){let e=new be(null,"*"),t=new nt(e,"*");return new st([t],null)}static buildCreateTableQuery(e,t,i=!1){return new qi({tableName:t,isTemporary:i,asSelectQuery:e})}static buildInsertQuery(e,t){let i,n=e.selectClause.items.length;if(i=(new Qi).collect(e).map(e=>e.name),!i.length||n!==i.length)throw new Error(`Columns cannot be inferred from the selectQuery. Make sure you are not using wildcards or unnamed columns.\nSelect clause column count: ${n}, Columns with valid names: ${i.length}\nDetected column names: [${i.join(", ")}]`);let s=rn.parse(t);return new Se({insertClause:new Rt(s,i),selectQuery:e})}static buildUpdateQuery(e,t,i,n){let s=new _t(rn.parse(i)),r=Array.isArray(n)?n:[n],a=(new Qi).collect(e),l=(new Ai).collect(e);(new Oi).execute(e);for(let m of r)if(!a.some(e=>e.name===m))throw new Error(`Primary key column '${m}' is not present in selectQuery select list.`);let o=s.getSourceAliasName();if(!o)throw new Error("Source expression does not have an alias. Please provide an alias for the source expression.");let u=a.filter(e=>!r.includes(e.name)).map(e=>new Ft(e.name,new be(o,e.name))),h=new Lt(u),p=new St(e.toSource(t),null),c=null;for(let m of r){let e=new _e(new be(o,m),"=",new be(t,m));c=c?new _e(c,"and",e):e}let d=new lt(c);return new Bi({updateClause:s,setClause:h,fromClause:p,whereClause:d,withClause:l.length>0?new Tt(!1,l):void 0})}},ln=class{static set(e,t,i){let n=Fi.collect(e),s=!1;for(let r of n)r.name.value===t&&(r.value=i,s=!0);if(!s)throw new Error(`Parameter '${t}' not found in query.`)}},on=(me=class extends ge{constructor(e){super(),this.cteNameCache=new Set,this.withClause=e.withClause??null,this.selectClause=e.selectClause,this.fromClause=e.fromClause??null,this.whereClause=e.whereClause??null,this.groupByClause=e.groupByClause??null,this.havingClause=e.havingClause??null,this.orderByClause=e.orderByClause??null,this.windowClause=e.windowClause??null,this.limitClause=e.limitClause??null,this.offsetClause=e.offsetClause??null,this.fetchClause=e.fetchClause??null,this.forClause=e.forClause??null,this.initializeCTECache()}initializeCTECache(){var e;if(this.cteNameCache.clear(),null==(e=this.withClause)?void 0:e.tables)for(let t of this.withClause.tables)this.cteNameCache.add(t.aliasExpression.table.name)}toUnion(e){return this.toBinaryQuery("union",e)}toUnionAll(e){return this.toBinaryQuery("union all",e)}toIntersect(e){return this.toBinaryQuery("intersect",e)}toIntersectAll(e){return this.toBinaryQuery("intersect all",e)}toExcept(e){return this.toBinaryQuery("except",e)}toExceptAll(e){return this.toBinaryQuery("except all",e)}toBinaryQuery(e,t){return an.buildBinaryQuery([this,t],e)}appendWhereRaw(e){let t=Ni.parse(e);this.appendWhere(t)}appendWhere(e){this.whereClause?this.whereClause.condition=new _e(this.whereClause.condition,"and",e):this.whereClause=new lt(e)}appendHavingRaw(e){let t=Ni.parse(e);this.appendHaving(t)}appendHaving(e){this.havingClause?this.havingClause.condition=new _e(this.havingClause.condition,"and",e):this.havingClause=new mt(e)}innerJoinRaw(e,t,i,n=null){this.joinSourceRaw("inner join",e,t,i,n)}leftJoinRaw(e,t,i,n=null){this.joinSourceRaw("left join",e,t,i,n)}rightJoinRaw(e,t,i,n=null){this.joinSourceRaw("right join",e,t,i,n)}innerJoin(e,t,i=null){this.joinSource("inner join",e,t,i)}leftJoin(e,t,i=null){this.joinSource("left join",e,t,i)}rightJoin(e,t,i=null){this.joinSource("right join",e,t,i)}joinSourceRaw(e,t,i,n,s=null){let r=Xi.parse(t),a=new Ct(r,new Pt(i,null));this.joinSource(e,a,n,s)}joinSource(e,t,i,n=null){if(!this.fromClause)throw new Error("A FROM clause is required to add a JOIN condition.");let s=Array.isArray(i)?i:[i],r=new Yi(n).collect(this),a=null,l=0,o=t.getAliasName();if(!o)throw new Error("An alias is required for the source expression to add a JOIN condition.");for(let p of r)if(s.some(e=>e==p.name)){let e=new _e(p.value,"=",new be([o],p.name));a=a?new _e(a,"and",e):e,l++}if(!a||l!==s.length)throw new Error(`Invalid JOIN condition. The specified columns were not found: ${s.join(", ")}`);let u=new xt(a),h=new gt(e,t,u,!1);this.fromClause&&(this.fromClause.joins?this.fromClause.joins.push(h):this.fromClause.joins=[h]),Hi.normalize(this)}toSource(e){if(!e||""===e.trim())throw new Error("Alias is required for toSource(). Please specify a non-empty alias name.");return new Ct(new vt(this),new Pt(e,null))}appendWith(e){let t=Array.isArray(e)?e:[e];this.withClause?this.withClause.tables.push(...t):this.withClause=new Tt(!1,t),Hi.normalize(this)}appendWithRaw(e,t){let i=On.parse(e),n=new kt(i,t,null);this.appendWith(n)}overrideSelectItemExpr(e,t){let i=this.selectClause.items.filter(t=>{var i;return(null==(i=t.identifier)?void 0:i.name)===e});if(0===i.length)throw new Error(`Column ${e} not found in the query`);if(i.length>1)throw new Error(`Duplicate column name ${e} found in the query`);let n=i[0],s=t((new Di).visit(n.value));n.value=Ni.parse(s)}appendWhereExpr(e,t,i){if(i&&i.upstream){let i=(new nn).find(this,[e]),n=new Yi,s=new Di;for(let r of i){let i=n.collect(r).filter(t=>t.name===e).map(e=>e.value);if(1!==i.length)throw new Error(`Expected exactly one expression for column '${e}'`);let a=s.format(i[0]);r.appendWhereRaw(t(a))}}else{let i=new Yi,n=new Di,s=i.collect(this).filter(t=>t.name===e).map(e=>e.value);if(1!==s.length)throw new Error(`Expected exactly one expression for column '${e}'`);let r=n.format(s[0]);this.appendWhereRaw(t(r))}}setParameter(e,t){return ln.set(this,e,t),this}toSimpleQuery(){return this}addCTE(e,t,i){if(!e||""===e.trim())throw new en(e,"name cannot be empty or whitespace-only");if(this.hasCTE(e))throw new Zi(e);let n=(null==i?void 0:i.materialized)??null,s=new kt(t,e,n);return this.appendWith(s),this.cteNameCache.add(e),this}removeCTE(e){if(!this.hasCTE(e))throw new tn(e);return this.withClause&&(this.withClause.tables=this.withClause.tables.filter(t=>t.aliasExpression.table.name!==e),0===this.withClause.tables.length&&(this.withClause=null)),this.cteNameCache.delete(e),this}hasCTE(e){return this.cteNameCache.has(e)}getCTENames(){var e;return(null==(e=this.withClause)?void 0:e.tables.map(e=>e.aliasExpression.table.name))??[]}replaceCTE(e,t,i){if(!e||""===e.trim())throw new en(e,"name cannot be empty or whitespace-only");this.hasCTE(e)&&this.removeCTE(e);let n=(null==i?void 0:i.materialized)??null,s=new kt(t,e,n);return this.appendWith(s),this.cteNameCache.add(e),this}},me.kind=Symbol("SelectQuery"),me),un=(we=class extends ge{constructor(e,t,i){super(),this.left=e,this.operator=new Ue(t),this.right=i}union(e){return this.appendSelectQuery("union",e)}unionAll(e){return this.appendSelectQuery("union all",e)}intersect(e){return this.appendSelectQuery("intersect",e)}intersectAll(e){return this.appendSelectQuery("intersect all",e)}except(e){return this.appendSelectQuery("except",e)}exceptAll(e){return this.appendSelectQuery("except all",e)}appendSelectQuery(e,t){return this.left=new we(this.left,this.operator.value,this.right),this.operator=new Ue(e),this.right=t,Hi.normalize(this),this}unionRaw(e){let t=On.parse(e);return this.union(t)}unionAllRaw(e){let t=On.parse(e);return this.unionAll(t)}intersectRaw(e){let t=On.parse(e);return this.intersect(t)}intersectAllRaw(e){let t=On.parse(e);return this.intersectAll(t)}exceptRaw(e){let t=On.parse(e);return this.except(t)}exceptAllRaw(e){let t=On.parse(e);return this.exceptAll(t)}toSource(e="subq"){return new Ct(new vt(this),new Pt(e,null))}setParameter(e,t){return ln.set(this,e,t),this}toSimpleQuery(){return an.buildSimpleQuery(this)}},we.kind=Symbol("BinarySelectQuery"),we),hn=(fe=class extends ge{constructor(e,t=null){super(),this.tuples=e,this.columnAliases=t}toSimpleQuery(){return an.buildSimpleQuery(this)}setParameter(e,t){return ln.set(this,e,t),this}},fe.kind=Symbol("ValuesQuery"),fe),pn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The SELECT clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,n=null,s=i<e.length?e[i].comments:null;if("select"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword but found "${e[i].value}". SELECT clauses must start with the SELECT keyword.`);i++;let r=[];for(;i<e.length&&$i.isHintClause(e[i].value);){let t=$i.extractHintContent(e[i].value);r.push(new $i(t)),i++}if(i<e.length&&"distinct"===e[i].value)i++,n=new rt;else if(i<e.length&&"distinct on"===e[i].value){i++;let t=Ni.parseArgument(4,8,e,i);n=new at(t.value),i=t.newIndex}let a=[],l=cn.parseItem(e,i);for(a.push(l.value),i=l.newIndex;i<e.length&&16&e[i].type;){i++;let t=cn.parseItem(e,i);a.push(t.value),i=t.newIndex}if(0===a.length)throw new Error(`Syntax error at position ${t}: No select items found. The SELECT clause requires at least one expression to select.`);{let e=new st(a,n,r);return e.comments=s,{value:e,newIndex:i}}}},cn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseItem(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The select item is complete but there are additional tokens.`);return i.value}static parseItem(e,t){let i=t,n=Ni.parseFromLexeme(e,i),s=n.value;if(i=n.newIndex,i<e.length&&"as"===e[i].value&&i++,i<e.length&&64&e[i].type){let t=e[i].value;return i++,{value:new nt(s,t),newIndex:i}}return s instanceof be&&"*"!==s.column.name?{value:new nt(s,s.column.name),newIndex:i}:{value:new nt(s),newIndex:i}}},dn=class{static tryParse(e,t){let i=t;if(i<e.length&&"on"===e[i].value){i++;let t=Ni.parseFromLexeme(e,i);return i=t.newIndex,{value:new xt(t.value),newIndex:i}}return null}},mn=class{static tryParse(e,t){let i=t;if(i<e.length&&"using"===e[i].value){i++;let t=Ni.parseArgument(4,8,e,i),n=t.value;return i=t.newIndex,{value:new Et(n),newIndex:i}}return null}},wn=class{static tryParse(e,t){let i=t,n=[];for(;this.isJoinCommand(e,i);){let t=this.parseJoinClause(e,i);n.push(t.value),i=t.newIndex}return n.length>0?{value:n,newIndex:i}:null}static isJoinKeyword(e){return!!ii.parse(e,0)}static parseLateral(e,t){let i=t;return i<e.length&&"lateral"===e[i].value?(i++,{value:!0,newIndex:i}):{value:!1,newIndex:i}}static isJoinCommand(e,t){return!(t>=e.length)&&!!(16&e[t].type||!0===this.isJoinKeyword(e[t].value))}static parseJoinClause(e,t){let i=t,n=","===e[i].value?"cross join":e[i].value;i++;let s=this.parseLateral(e,i),r=s.value;i=s.newIndex;let a=rn.parseFromLexeme(e,i);if(i=a.newIndex,i<e.length){let t=dn.tryParse(e,i);if(t)return{value:new gt(n,a.value,t.value,r),newIndex:t.newIndex};let s=mn.tryParse(e,i);if(s)return{value:new gt(n,a.value,s.value,r),newIndex:s.newIndex}}return{value:new gt(n,a.value,null,r),newIndex:i}}},fn=class{static collectClauseComments(e,t,i){if(t>=e.length||e[t].value.toLowerCase()!==i.toLowerCase())return null;let n=[];e[t].comments&&n.push(...e[t].comments);let s=t-1;for(;s>=0;){let t=e[s];if(t.comments&&t.comments.length>0){let e=t.comments.filter(e=>{let t=e.toLowerCase();return t.includes(i.toLowerCase())||t.includes("")||t.includes("")});e.length>0&&(n.unshift(...e),t.comments=t.comments.filter(t=>!e.includes(t)),0===t.comments.length&&(t.comments=null));break}if(this.isSignificantSqlKeyword(t.value))break;s--}return n.length>0?n:null}static isSignificantSqlKeyword(e){return new Set(["select","from","where","group by","having","order by","limit","offset"]).has(e.toLowerCase())}},yn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The FROM clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,n=fn.collectClauseComments(e,i,"from");if("from"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'FROM' keyword but found "${e[i].value}". FROM clauses must start with the FROM keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FROM' keyword. The FROM clause requires a table reference.");let s=rn.parseFromLexeme(e,i);i=s.newIndex;let r=wn.tryParse(e,i);if(i=(null==r?void 0:r.newIndex)||i,null!==r){let e=new St(s.value,r.value);return e.comments=n,{value:e,newIndex:i}}{let e=new St(s.value,null);return e.comments=n,{value:e,newIndex:i}}}},vn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WHERE clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,n=fn.collectClauseComments(e,i,"where");if("where"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'WHERE' keyword but found "${e[i].value}". WHERE clauses must start with the WHERE keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'WHERE' keyword. The WHERE clause requires a condition expression.");let s=Ni.parseFromLexeme(e,i),r=new lt(s.value);return r.comments=n,{value:r,newIndex:s.newIndex}}},Cn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The GROUP BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("group by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'GROUP BY' keyword but found "${e[i].value}". GROUP BY clauses must start with the GROUP BY keywords.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'GROUP BY' keyword. The GROUP BY clause requires at least one expression to group by.");let n=[],s=this.parseItem(e,i);for(n.push(s.value),i=s.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseItem(e,i);n.push(t.value),i=t.newIndex}if(0===n.length)throw new Error(`Syntax error at position ${t}: No grouping expressions found. The GROUP BY clause requires at least one expression to group by.`);return{value:new dt(n),newIndex:i}}static parseItem(e,t){let i=t,n=Ni.parseFromLexeme(e,i),s=n.value;return i=n.newIndex,{value:s,newIndex:i}}},xn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The HAVING clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("having"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'HAVING' keyword but found "${e[i].value}". HAVING clauses must start with the HAVING keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'HAVING' keyword. The HAVING clause requires a condition expression.");let n=Ni.parseFromLexeme(e,i);return{value:new mt(n.value),newIndex:n.newIndex}}},En=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WINDOW clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("window"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'WINDOW' keyword but found "${e[i].value}". WINDOW clauses must start with the WINDOW keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'WINDOW' keyword. The WINDOW clause requires at least one window definition.");let n=[];for(;i<e.length;){if(i>=e.length||64!==e[i].type)throw new Error("Syntax error: Expected window name after 'WINDOW' keyword.");let t=e[i].value;if(i++,i>=e.length||"as"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'AS' keyword after window name.`);i++;let s=Si.parseFromLexeme(e,i);if(i=s.newIndex,n.push(new ut(t,s.value)),!(i<e.length&&16&e[i].type))break;i++}if(0===n.length)throw new Error("At least one WINDOW clause is required after WINDOW keyword.");return{value:new ht(n),newIndex:i}}},gn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The LIMIT clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("limit"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'LIMIT' keyword but found "${e[i].value}". LIMIT clauses must start with the LIMIT keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'LIMIT' keyword. The LIMIT clause requires a numeric expression.");let n=Ni.parseFromLexeme(e,i);return i=n.newIndex,{value:new bt(n.value),newIndex:i}}},Sn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The FOR clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("for"!==e[i].value.toLowerCase())throw new Error(`Syntax error at position ${i}: Expected 'FOR' keyword but found "${e[i].value}". FOR clauses must start with the FOR keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FOR' keyword. The FOR clause requires a lock mode specification.");let n,s=e[i].value;switch(s){case"update":n="update",i++;break;case"share":n="share",i++;break;case"key share":n="key share",i++;break;case"no key update":n="no key update",i++;break;default:throw new Error(`Syntax error at position ${i}: Invalid lock mode "${s}". Valid lock modes are: UPDATE, SHARE, KEY SHARE, NO KEY UPDATE.`)}return{value:new Ot(n),newIndex:i}}},kn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The CommonTable definition is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,n=i<e.length?e[i].comments:null,s=sn.parseFromLexeme(e,i);if(i=s.newIndex,i<e.length&&"as"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'AS' keyword after CTE name but found "${e[i].value}".`);i++;let r=null;if(i<e.length){let t=e[i].value;"materialized"===t?(r=!0,i++):"not materialized"===t&&(r=!1,i++)}if(i<e.length&&4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected '(' after CTE name but found "${e[i].value}".`);let a=e[i].comments;i++;let l=On.parseFromLexeme(e,i);if(i=l.newIndex,a&&a.length>0&&(l.value.comments?l.value.comments=[...a,...l.value.comments]:l.value.comments=a),i<e.length&&8!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected ')' after CTE query but found "${e[i].value}".`);i++;let o=new kt(l.value,s.value,r);return o.comments=n,{value:o,newIndex:i}}},Tn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WITH clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,n=i<e.length?e[i].comments:null;if(!(i<e.length&&"with"===e[i].value.toLowerCase()))throw new Error(`Syntax error at position ${i}: Expected WITH keyword.`);i++;let s=i<e.length&&"recursive"===e[i].value.toLowerCase();s&&i++;let r=[],a=kn.parseFromLexeme(e,i);for(r.push(a.value),i=a.newIndex;i<e.length&&16&e[i].type;){i++;let t=kn.parseFromLexeme(e,i);r.push(t.value),i=t.newIndex}let l=new Tt(s,r);return l.comments=n,{value:l,newIndex:i}}},bn=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The VALUES clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("values"!==e[i].value.toLowerCase())throw new Error(`Syntax error at position ${i}: Expected 'VALUES' keyword but found "${e[i].value}". VALUES clauses must start with the VALUES keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'VALUES' keyword. The VALUES clause requires at least one tuple expression.");let n=[],s=this.parseTuple(e,i);for(n.push(s.value),i=s.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseTuple(e,i);n.push(t.value),i=t.newIndex}return{value:new hn(n),newIndex:i}}static parseTuple(e,t){let i=t;if(i>=e.length||4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected opening parenthesis but found "${i<e.length?e[i].value:"end of input"}". Tuple expressions in VALUES clause must be enclosed in parentheses.`);i++;let n=[];if(i>=e.length)throw new Error("Syntax error: Unexpected end of input after opening parenthesis in tuple expression.");if(8&e[i].type)return i++,{value:new Ge([]),newIndex:i};let s=Ni.parseFromLexeme(e,i);for(n.push(s.value),i=s.newIndex;i<e.length&&16&e[i].type;){if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after comma in tuple expression.");let t=Ni.parseFromLexeme(e,i);n.push(t.value),i=t.newIndex}if(i>=e.length||8!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected closing parenthesis but found "${i<e.length?e[i].value:"end of input"}". Tuple expressions in VALUES clause must be enclosed in parentheses.`);return i++,{value:new Ge(n),newIndex:i}}},In=class{static parseFromLexeme(e,t){let i=t;if("fetch"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'FETCH' keyword but found "${e[i].value}".`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH' keyword.");let n=Nn.parseFromLexeme(e,i),s=n.value;return i=n.newIndex,{value:new Nt(s),newIndex:i}}},Nn=class{static parseFromLexeme(e,t){let i,n=t,s=e[n].value;if("first"===s)i="first";else{if("next"!==s)throw new Error(`Syntax error at position ${n}: Expected 'FIRST' or 'NEXT' after 'FETCH' but found "${e[n].value}".`);i="next"}if(n++,n>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH FIRST|NEXT'.");let r=null,a=null;if("row only"===e[n].value||"rows only"===e[n].value)return r=new Re(1),a="rows only",n++,{value:new At(i,r,a),newIndex:n};let l=Ni.parseFromLexeme(e,n);if(r=l.value,n=l.newIndex,n>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH FIRST|NEXT <count>'.");if("rows only"===e[n].value?(a="rows only",n++):"percent"===e[n].value?(a="percent",n++):"percent with ties"===e[n].value&&(a="percent with ties",n++),!a)throw new Error("Syntax error: Expected 'ROWS ONLY', 'PERCENT', or 'PERCENT WITH TIES' after 'FETCH FIRST|NEXT <count>'.");return{value:new At(i,r,a),newIndex:n}}},An=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The OFFSET clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("offset"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'OFFSET' keyword but found "${e[i].value}". OFFSET clauses must start with the OFFSET keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'OFFSET' keyword. The OFFSET clause requires a numeric expression.");let n=Ni.parseFromLexeme(e,i);return i=n.newIndex,i<e.length&&("row"===e[i].value||"rows"===e[i].value)&&i++,{value:new It(n.value),newIndex:i}}},On=(ye=class{static parse(e){let t=new ci(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`[SelectQueryParser] Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The SELECT query is complete but there are additional tokens.`);return i.value}static calculateCharacterPosition(e,t,i){var n;if(i>=t.length)return e.length;let s=t[i];if(void 0!==(null==(n=s.position)?void 0:n.startPosition))return s.position.startPosition;let r=0;for(let o=0;o<i;o++){let i=t[o].value,n=e.indexOf(i,r);-1!==n&&(r=n+i.length)}let a=t[i].value,l=e.indexOf(a,r);return-1!==l?l:r}static analyze(e){let t=[];try{t=new ci(e).readLexmes();let i=this.parseFromLexeme(t,0);if(i.newIndex<t.length){let n=t.slice(i.newIndex).map(e=>e.value),s=t[i.newIndex],r=this.calculateCharacterPosition(e,t,i.newIndex);return{success:!1,query:i.value,error:`Syntax error: Unexpected token "${s.value}" at character position ${r}. The SELECT query is complete but there are additional tokens.`,errorPosition:r,remainingTokens:n}}return{success:!0,query:i.value}}catch(Ee){let n,s=Ee instanceof Error?Ee.message:String(Ee),r=s.match(/position (\d+)/);if(r){let i=parseInt(r[1],10);n=this.calculateCharacterPosition(e,t,i)}return{success:!1,error:s,errorPosition:n}}}static async parseAsync(e){return Promise.resolve(this.parse(e))}static parseFromLexeme(e,t){let i=t;if(i>=e.length)throw new Error(`Syntax error: Unexpected end of input at position ${t}.`);let n=e[i].value;if(!this.selectCommandSet.has(n)&&"values"!==n)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' or 'VALUES' keyword but found "${e[i].value}".`);let s=this.selectCommandSet.has(n)?this.parseSimpleSelectQuery(e,i):this.parseValuesQuery(e,i),r=s.value;for(i=s.newIndex;i<e.length&&this.unionCommandSet.has(e[i].value.toLowerCase());){let t=e[i].value.toLowerCase();if(i++,i>=e.length)throw new Error(`Syntax error at position ${i}: Expected a query after '${t.toUpperCase()}' but found end of input.`);let n=e[i].value.toLowerCase();if(this.selectCommandSet.has(n)){let n=this.parseSimpleSelectQuery(e,i);r=new un(r,t,n.value),i=n.newIndex}else{if("values"!==n)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' or 'VALUES' after '${t.toUpperCase()}' but found "${e[i].value}".`);{let n=this.parseValuesQuery(e,i);r=new un(r,t,n.value),i=n.newIndex}}}return{value:r,newIndex:i}}static parseSimpleSelectQuery(e,t){let i=t,n=null;i<e.length&&"with"===e[i].value&&(n=Tn.parseFromLexeme(e,i),i=n.newIndex);let s=i<e.length?e[i].comments:null;if(i>=e.length||"select"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword but found "${i<e.length?e[i].value:"end of input"}". SELECT queries must start with the SELECT keyword.`);let r=pn.parseFromLexeme(e,i);i=r.newIndex,s&&r.value.comments&&JSON.stringify(s)===JSON.stringify(r.value.comments)&&(r.value.comments=null);let a=null;i<e.length&&"from"===e[i].value&&(a=yn.parseFromLexeme(e,i),i=a.newIndex);let l=null;i<e.length&&"where"===e[i].value&&(l=vn.parseFromLexeme(e,i),i=l.newIndex);let o=null;i<e.length&&"group by"===e[i].value&&(o=Cn.parseFromLexeme(e,i),i=o.newIndex);let u=null;i<e.length&&"having"===e[i].value&&(u=xn.parseFromLexeme(e,i),i=u.newIndex);let h=null;i<e.length&&"window"===e[i].value&&(h=En.parseFromLexeme(e,i),i=h.newIndex);let p=null;i<e.length&&"order by"===e[i].value&&(p=Ei.parseFromLexeme(e,i),i=p.newIndex);let c=null;i<e.length&&"limit"===e[i].value&&(c=gn.parseFromLexeme(e,i),i=c.newIndex);let d=null;i<e.length&&"offset"===e[i].value&&(d=An.parseFromLexeme(e,i),i=d.newIndex);let m=null;i<e.length&&"fetch"===e[i].value&&(m=In.parseFromLexeme(e,i),i=m.newIndex);let w=null;i<e.length&&"for"===e[i].value.toLowerCase()&&(w=Sn.parseFromLexeme(e,i),i=w.newIndex);let f=new on({withClause:n?n.value:null,selectClause:r.value,fromClause:a?a.value:null,whereClause:l?l.value:null,groupByClause:o?o.value:null,havingClause:u?u.value:null,orderByClause:p?p.value:null,windowClause:h?h.value:null,limitClause:c?c.value:null,offsetClause:d?d.value:null,fetchClause:m?m.value:null,forClause:w?w.value:null});return f.comments=s,{value:f,newIndex:i}}static parseValuesQuery(e,t){let i=bn.parseFromLexeme(e,t);return{value:i.value,newIndex:i.newIndex}}},ye.unionCommandSet=new Set(["union","union all","intersect","intersect all","except","except all"]),ye.selectCommandSet=new Set(["with","select"]),ye),Pn=(ve=class{constructor(){this.dependencyGraph=null,this.cteMap=new Map,this.sourceCollector=new Pi(!0),this.cteCollector=new Ai}analyzeDependencies(e){let t=this.cteCollector.collect(e);return this.buildCTEMap(t),this.dependencyGraph=this.buildDependencyGraph(t,e),this.dependencyGraph}getDependencies(e){this.ensureAnalyzed();let t=this.findNodeByName(e);return t?[...t.dependencies]:[]}getDependents(e){this.ensureAnalyzed();let t=this.findNodeByName(e);return t?[...t.dependents]:[]}getMainQueryDependencies(){this.ensureAnalyzed();let e=this.findNodeByName(ve.MAIN_QUERY_NAME);return e?[...e.dependencies]:[]}getNodesByType(e){return this.ensureAnalyzed(),this.dependencyGraph.nodes.filter(t=>t.type===e)}getMainQueryNode(){return this.ensureAnalyzed(),this.findNodeByName(ve.MAIN_QUERY_NAME)}hasCircularDependency(){this.ensureAnalyzed();try{return this.getExecutionOrder(),!1}catch(e){if(e instanceof Error&&e.message.includes(ve.ERROR_MESSAGES.CIRCULAR_REFERENCE))return!0;throw e}}getExecutionOrder(){this.ensureAnalyzed();let e=new Set,t=new Set,i=[],n=new Map;for(let r of this.dependencyGraph.nodes)n.set(r.name,new Set(r.dependencies));let s=r=>{if(e.has(r))return;if(t.has(r))throw new Error(`${ve.ERROR_MESSAGES.CIRCULAR_REFERENCE}: ${r}`);t.add(r);let a=n.get(r)||new Set;for(let e of a)s(e);t.delete(r),e.add(r),i.push(r)};for(let r of this.dependencyGraph.nodes)e.has(r.name)||s(r.name);return i}buildDependencyGraph(e,t){let i=[],n=[],s=new Map,r=new Map;for(let l of e){let e=ve.getCTEName(l);s.set(e,new Set),r.set(e,new Set)}s.set(ve.MAIN_QUERY_NAME,new Set),r.set(ve.MAIN_QUERY_NAME,new Set);for(let l of e){let e=ve.getCTEName(l),t=this.sourceCollector.collect(l.query);for(let i of t){let t=i.table.name;this.cteMap.has(t)&&t!==e&&(s.get(e).add(t),r.get(t).add(e),n.push({from:e,to:t}))}}let a=this.getMainQueryWithoutCTE(t);if(a){let e=this.sourceCollector.collect(a);for(let t of e){let e=t.table.name;this.cteMap.has(e)&&(s.get(ve.MAIN_QUERY_NAME).add(e),r.get(e).add(ve.MAIN_QUERY_NAME),n.push({from:ve.MAIN_QUERY_NAME,to:e}))}}for(let l of e){let e=ve.getCTEName(l);i.push({name:e,type:"CTE",cte:l,dependencies:Array.from(s.get(e)||new Set),dependents:Array.from(r.get(e)||new Set)})}return i.push({name:ve.MAIN_QUERY_NAME,type:"ROOT",cte:null,dependencies:Array.from(s.get(ve.MAIN_QUERY_NAME)||new Set),dependents:Array.from(r.get(ve.MAIN_QUERY_NAME)||new Set)}),{nodes:i,edges:n}}ensureAnalyzed(){if(!this.dependencyGraph)throw new Error(ve.ERROR_MESSAGES.NOT_ANALYZED)}buildCTEMap(e){this.cteMap.clear();for(let t of e){let e=ve.getCTEName(t);this.cteMap.set(e,t)}}findNodeByName(e){var t;return null==(t=this.dependencyGraph)?void 0:t.nodes.find(t=>t.name===e)}getMainQueryWithoutCTE(e){return e.withClause?new on({selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:e.orderByClause,limitClause:e.limitClause,offsetClause:e.offsetClause,fetchClause:e.fetchClause,forClause:e.forClause,windowClause:e.windowClause}):e}static getCTEName(e){return e.aliasExpression.table.name}},ve.ERROR_MESSAGES={NOT_ANALYZED:"Must call analyzeDependencies first",CIRCULAR_REFERENCE:"Circular reference detected in CTE"},ve.MAIN_QUERY_NAME="MAIN_QUERY",ve),$n=class{constructor(e,t){this.name=e,this.columns=t}},Ln=class{constructor(e=null,t=!1){this.tableColumnResolver=e,this.allowWildcardWithoutResolver=t,this.tableSchemas=[],this.visitedNodes=new Set,this.commonTables=[],this.running=!1,this.unresolvedColumns=[],this.analysisError=void 0,this.isAnalyzeMode=!1,this.handlers=new Map,this.handlers.set(on.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(un.kind,e=>this.visitBinarySelectQuery(e))}collect(e){return this.visit(e),this.tableSchemas}analyze(e){this.isAnalyzeMode=!0;try{return this.visit(e),{success:0===this.unresolvedColumns.length&&!this.analysisError,schemas:this.tableSchemas,unresolvedColumns:this.unresolvedColumns,error:this.analysisError}}finally{this.isAnalyzeMode=!1}}visit(e){if(this.running)this.visitNode(e);else{this.reset(),this.running=!0;try{if(!(e instanceof on||e instanceof un))throw new Error(`Unsupported SQL component type for schema collection. Received: ${e.constructor.name}. Expected: SimpleSelectQuery or BinarySelectQuery.`);let t=new Ai;this.commonTables=t.collect(e),this.visitNode(e),this.consolidateTableSchemas()}finally{this.running=!1}}}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}reset(){this.tableSchemas=[],this.visitedNodes=new Set,this.commonTables=[],this.unresolvedColumns=[],this.analysisError=void 0}consolidateTableSchemas(){let e=new Map;for(let t of this.tableSchemas)if(e.has(t.name)){let i=e.get(t.name);t.columns.forEach(e=>null==i?void 0:i.add(e))}else e.set(t.name,new Set(t.columns));this.tableSchemas=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>new $n(e,Array.from(t).sort()))}handleTableSource(e,t,i){if(!(e.datasource instanceof wt))throw new Error("Datasource is not an instance of TableSource");{let n=e.datasource.getSourceName(),s=this.commonTables.filter(e=>e.getSourceAliasName()===n);if(s.length>0)s[0].query.accept(this);else{let s=e.getAliasName()??n;this.processCollectTableSchema(n,s,t,i)}}}visitSimpleSelectQuery(e){var t;if(null===e.fromClause)return;let i,n=new Yi(this.tableColumnResolver,!0,"fullName").collect(e);if(this.allowWildcardWithoutResolver){let t=this.getSelectClauseColumns(e);i=n.filter(e=>e.value instanceof be).map(e=>e.value).filter(e=>{let i=e.getNamespace(),n=e.column.name;return t.some(e=>{if(e.value instanceof be){let t=e.value.getNamespace(),s=e.value.column.name;if(t===i&&s===n)return!0;if("*"===s){if(this.allowWildcardWithoutResolver&&null===this.tableColumnResolver)return!1;if(""===t||t===i)return!0}}return!1})}).map(e=>({table:e.getNamespace(),column:e.column.name}))}else i=n.filter(e=>e.value instanceof be).map(e=>e.value).map(e=>({table:e.getNamespace(),column:e.column.name}));if(null!==e.fromClause.joins&&e.fromClause.joins.length>0){let e=i.filter(e=>""===e.table).map(e=>e.column);if(e.length>0){if(!this.isAnalyzeMode)throw new Error(`Column reference(s) without table name found in query: ${e.join(", ")}`);this.unresolvedColumns.push(...e),this.analysisError=`Column reference(s) without table name found in query: ${e.join(", ")}`}}if(e.fromClause.source.datasource instanceof wt?this.handleTableSource(e.fromClause.source,i,!0):e.fromClause.source.datasource instanceof vt&&e.fromClause.source.datasource.query.accept(this),null==(t=e.fromClause)?void 0:t.joins)for(let s of e.fromClause.joins)s.source.datasource instanceof wt?this.handleTableSource(s.source,i,!1):s.source.datasource instanceof vt&&s.source.datasource.query.accept(this)}visitBinarySelectQuery(e){this.visitNode(e.left),this.visitNode(e.right)}getSelectClauseColumns(e){if(!e.selectClause)return[];let t=[];for(let i of e.selectClause.items)if(i.value instanceof be){let e=i.value.column.name;t.push({name:e,value:i.value})}return t}processCollectTableSchema(e,t,i,n=!1){if(null===this.tableColumnResolver&&i.filter(e=>e.table===t||n&&""===e.table).filter(e=>"*"===e.column).length>0&&!this.allowWildcardWithoutResolver){let s=e?`Wildcard (*) is used. A TableColumnResolver is required to resolve wildcards. Target table: ${e}`:"Wildcard (*) is used. A TableColumnResolver is required to resolve wildcards.";if(!this.isAnalyzeMode)throw new Error(s);{this.analysisError=s;let e=i.filter(e=>e.table===t||n&&""===e.table).filter(e=>"*"===e.column).map(e=>e.table?`${e.table}.*`:"*");this.unresolvedColumns.push(...e)}}let s=i.filter(e=>"*"!==e.column).filter(e=>e.table===t||n&&""===e.table).map(e=>e.column),r=new $n(e,s);this.tableSchemas.push(r)}},Fn=(Ce=class{constructor(){this.jsonColumnCounter=0,this.entityToJsonColumnMap=new Map,this.columnMappings=[]}buildObjectEntityCtes(e,t,i){this.jsonColumnCounter=0,this.entityToJsonColumnMap.clear(),this.columnMappings=[];let n=[e],s=e.aliasExpression.table.name,r=this.collectAndSortObjectEntities(i,t),a=this.groupEntitiesByDepth(r),l=Array.from(a.keys()).sort((e,t)=>t-e);for(let o of l){let e=a.get(o),r=`${Ce.CTE_OBJECT_PREFIX}${o}`,l=this.buildDepthCte(e,s,r,i,t);n.push(l),s=r}return{ctes:n,lastCteAlias:s,columnMappings:this.columnMappings}}generateUniqueJsonColumnName(e,t,i){this.jsonColumnCounter++;let n=`${e.toLowerCase()}_json_${this.jsonColumnCounter}`;return this.columnMappings.push({entityId:t,entityName:e,generatedColumnName:n,depth:i}),n}collectAndSortObjectEntities(e,t){let i=[],n=i=>{let n=t.get(i);if(!n)throw new Error(`Entity ${i} not found for depth calculation.`);if(n.isRoot)return 0;if(!n.parentId)return 1;let s=n.parentId,r=0,a=new Set;for(a.add(i);s;){if(a.has(s))throw new Error(`Circular dependency detected: ${s} already visited in path for ${i}`);a.add(s);let n=t.get(s);if(!n)throw new Error(`Parent entity ${s} not found during depth calculation for ${i}`);let l=!1;if(n.isRoot)l=!0;else{let t=e.nestedEntities.find(e=>e.id===s);if(!t)throw new Error(`Parent entity ${s} (ancestor of ${i}) has no definition in mapping.nestedEntities and is not root.`);"object"===t.relationshipType&&(l=!0)}if(l&&r++,n.isRoot)break;s=n.parentId}return r};return e.nestedEntities.forEach(e=>{if("object"===e.relationshipType){let s=t.get(e.id);s&&!s.isRoot&&i.push({entity:s,depth:n(e.id)})}}),i}groupEntitiesByDepth(e){let t=new Map;return e.forEach(e=>{let i=e.depth;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}buildDepthCte(e,t,i,n,s){let r=[new nt(new be(null,new We(Ce.WILDCARD_COLUMN)))];for(let{entity:l}of e){let e=this.buildEntityJsonColumn(l,n,s);r.push(e)}let a=new on({selectClause:new st(r),fromClause:new St(new Ct(new wt(null,new We(t)),null),null)});return new kt(a,new Pt(i,null),null)}buildEntityJsonColumn(e,t,i){let{jsonObjectArgs:n,nullChecks:s}=this.prepareEntityColumns(e);this.addChildObjectRelationships(e,n,t,i);let r=this.createJsonObject(n),a=this.buildNullCondition(s),l=this.createCaseExpression(a,r),o=this.calculateApproximateDepth(e,t),u=this.generateUniqueJsonColumnName(e.name,e.id,o);return this.entityToJsonColumnMap.set(e.id,u),new nt(l,u)}calculateApproximateDepth(e,t){if(e.isRoot)return 0;if(!e.parentId)return 1;let i=1,n=e.parentId;for(;n&&n!==t.rootEntity.id;){let e=t.nestedEntities.find(e=>e.id===n);if(!e)break;i++,n=e.parentId}return i}prepareEntityColumns(e){let t=[],i=[];return Object.entries(e.columns).forEach(([e,n])=>{t.push(new Re(e)),t.push(new be(null,new We(n))),i.push(new _e(new be(null,new We(n)),"is",new Re(null)))}),{jsonObjectArgs:t,nullChecks:i}}addChildObjectRelationships(e,t,i,n){i.nestedEntities.filter(t=>t.parentId===e.id&&"object"===t.relationshipType).forEach(e=>{let i=n.get(e.id);if(i){t.push(new Re(e.propertyName));let n=this.entityToJsonColumnMap.get(i.id);if(!n)throw new Error(`JSON column name not found for child entity: ${i.id}`);t.push(new be(null,new We(n)))}})}createJsonObject(e){return new Ie(null,new Ue("jsonb_build_object"),new Te(e),null)}buildNullCondition(e){return e.reduce((e,t)=>e?new _e(e,"and",t):t)}createCaseExpression(e,t){return new je(null,new Qe([new qe(e,new Re(null))],t))}},Ce.CTE_OBJECT_PREFIX="cte_object_depth_",Ce.WILDCARD_COLUMN="*",Ce),_n=(xe=class{buildArrayEntityCtes(e,t,i,n,s){let r=[...e],a=t,l=this.collectAndSortArrayEntities(n,i);if(0===l.length)return{updatedCtes:r,lastCteAlias:a};let o=this.groupEntitiesByDepth(l),u=Array.from(o.keys()).sort((e,t)=>t-e);for(let h of u){let e=o.get(h),{cte:t,newCteAlias:i}=this.buildDepthCte(e,a,r,h,n,s);r.push(t),a=i}return{updatedCtes:r,lastCteAlias:a}}collectAndSortArrayEntities(e,t){let i=[],n=e=>{let i=t.get(e);return!i||i.isRoot?0:i.parentId?1+n(i.parentId):1};return e.nestedEntities.forEach(e=>{if("array"===e.relationshipType){let s=t.get(e.id),r=t.get(e.parentId);if(!s||!r)throw new Error(`Configuration error: Array entity '${e.id}' or its parent '${e.parentId}' not found.`);let a=Object.values(r.columns);if(0===a.length)throw new Error(`Configuration error: Parent entity '${r.name}' (ID: ${r.id}) must have at least one column defined to serve as a linking key for child array '${e.name}'.`);let l=a[0];i.push({entity:s,parentEntity:r,parentIdColumnSqlName:l,depth:n(e.id)})}}),i.sort((e,t)=>t.depth-e.depth),i}groupEntitiesByDepth(e){let t=new Map;return e.forEach(e=>{let i=e.depth;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}buildDepthCte(e,t,i,n,s,r){var a;let l=new Set;e.forEach(e=>{Object.values(e.entity.columns).forEach(e=>l.add(e));let t=e=>{s.nestedEntities.filter(t=>t.parentId===e).forEach(e=>{Object.values(e.columns).forEach(e=>{let t="string"==typeof e?e:e.column;l.add(t)}),t(e.id)})};t(e.entity.id)});let o=null==(a=i.find(e=>e.aliasExpression.table.name===t))?void 0:a.query;if(!o)throw new Error(`CTE not found: ${t}`);let u=new Qi(null,i).collect(o),h=[],p=[],c=new Set;e.forEach(e=>{Object.values(e.entity.columns).forEach(e=>c.add(e))});let d=this.collectArrayEntityColumnsByDepth(s,n),m=new Set;r&&e.forEach(e=>{s.nestedEntities.filter(t=>t.parentId===e.entity.id&&"object"===t.relationshipType).forEach(e=>{let t=r.find(t=>t.entityId===e.id);t&&m.add(t.generatedColumnName)})}),this.processSelectVariablesForGroupBy(u,l,d,n,p,h,m);for(let y of e){let e=this.buildAggregationDetailsForArrayEntity(y.entity,s.nestedEntities,new Map,r);p.push(new nt(e.jsonAgg,y.entity.propertyName))}let w=`${xe.CTE_ARRAY_PREFIX}${n}`,f=new on({selectClause:new st(p),fromClause:new St(new Ct(new wt(null,new We(t)),null),null),groupByClause:h.length>0?new dt(h):null});return{cte:new kt(f,new Pt(w,null),null),newCteAlias:w}}buildAggregationDetailsForArrayEntity(e,t,i,n){let s=xe.JSON_FUNCTIONS.BUILD_OBJECT,r=[];Object.entries(e.columns).forEach(([e,t])=>{r.push(new Re(e)),r.push(new be(null,new We(t)))}),t.filter(t=>t.parentId===e.id).forEach(e=>{let t=e.originalPropertyName||e.propertyName;if(r.push(new Re(t)),"object"===e.relationshipType){if(!n)throw new Error(` PostgresArrayEntityCteBuilder Error: Column mappings not provided\n\n Details:\n  - Entity ID: ${e.id}\n  - Entity Name: ${e.name||"unknown"}\n  - Property Name: ${e.propertyName}\n  - Relationship Type: ${e.relationshipType}\n\n Solution:\n  Column mappings are required for hybrid JSON column naming.\n  This error indicates that PostgresObjectEntityCteBuilder did not\n  pass column mappings to PostgresArrayEntityCteBuilder.\n\n Check:\n  1. Ensure PostgresJsonQueryBuilder.buildJsonWithCteStrategy() passes columnMappings\n  2. Verify PostgresObjectEntityCteBuilder.buildObjectEntityCtes() returns columnMappings\n  3. Check that Model-driven mapping conversion generates unique entity IDs`);let t=n.find(t=>t.entityId===e.id);if(!t){let t=n.map(e=>`${e.entityId}  ${e.generatedColumnName}`).join(", ");throw new Error(` PostgresArrayEntityCteBuilder Error: Column mapping not found\n\n Details:\n  - Looking for Entity ID: ${e.id}\n  - Entity Name: ${e.name||"unknown"}\n  - Property Name: ${e.propertyName}\n  - Relationship Type: ${e.relationshipType}\n\n Available Mappings:\n  ${t||"None"}\n\n Solution:\n  Entity IDs must match between mapping generation and usage.\n  This suggests a mismatch in entity ID generation or processing.\n\n Check:\n  1. Model-driven mapping conversion generates consistent entity IDs\n  2. PostgresObjectEntityCteBuilder processes all entities correctly\n  3. Entity hierarchy and parentId relationships are correct`)}r.push(new be(null,new We(t.generatedColumnName)))}else"array"===e.relationshipType&&r.push(new be(null,new We(e.propertyName)))});let a=new Ie(null,new Ue(s),new Te(r),null),l=xe.JSON_FUNCTIONS.AGGREGATE;return Object.values(e.columns)[0],{jsonAgg:new Ie(null,new Ue(l),new Te([a]),null)}}collectArrayEntityColumnsByDepth(e,t){let i=new Map,n=Math.max(t+3,5);for(let s=t;s<=n;s++)i.set(s,new Set);return e.nestedEntities.filter(e=>"array"===e.relationshipType).forEach(t=>{let n=this.calculateEntityDepth(t,e);i.has(n)||i.set(n,new Set),this.addEntityColumnsToDepthSet(t,n,i),this.collectDescendantColumns(t.id,n,e,i)}),i}calculateEntityDepth(e,t){let i=0,n=e;for(;n.parentId&&n.parentId!==t.rootEntity.id;)i++,n=t.nestedEntities.find(e=>e.id===n.parentId)||n;return i}addEntityColumnsToDepthSet(e,t,i){Object.values(e.columns).forEach(e=>{let n="string"==typeof e?e:e.column;i.get(t).add(n)})}collectDescendantColumns(e,t,i,n){i.nestedEntities.filter(t=>t.parentId===e).forEach(e=>{this.addEntityColumnsToDepthSet(e,t,n),this.collectDescendantColumns(e.id,t,i,n)})}processSelectVariablesForGroupBy(e,t,i,n,s,r,a){e.forEach(e=>{if(!t.has(e.name)){if(a&&a.has(e.name))return;this.shouldIncludeColumnInGroupBy(e.name,i,n)&&(s.push(new nt(new be(null,new We(e.name)),e.name)),e.name.endsWith("_json")||r.push(new be(null,new We(e.name))))}})}shouldIncludeColumnInGroupBy(e,t,i){let n=e.endsWith("_json"),s=!0;for(let[r,a]of t.entries())if(r>=i&&a.has(e)){s=!1;break}return n&&e.startsWith("entity_")&&(s=this.shouldIncludeJsonColumn(e,i)),s}shouldIncludeJsonColumn(e,t){let i=e.match(/entity_(\d+)_json/);return!(i&&t>0)||parseInt(i[1])<=2}},xe.CTE_ARRAY_PREFIX="cte_array_depth_",xe.JSON_FUNCTIONS={BUILD_OBJECT:"jsonb_build_object",AGGREGATE:"jsonb_agg"},xe),Rn=class{constructor(){this.selectValueCollector=new Qi(null),this.objectEntityCteBuilder=new Fn,this.arrayEntityCteBuilder=new _n}validateMapping(e,t){var i,n;let s=(new Qi).collect(e),r=new Set(s.map(e=>e.name));for(let u in t.rootEntity.columns){let e=t.rootEntity.columns[u],i="string"==typeof e?e:e.column;if(!r.has(i))throw new Error(`Validation Error: Column "${i}" for JSON key "${u}" in root entity "${t.rootEntity.name}" not found in the query's select list.`)}let a=new Set([t.rootEntity.id]),l=new Map;t.nestedEntities.forEach(e=>{a.add(e.id),l.has(e.parentId)||l.set(e.parentId,[]),l.get(e.parentId).push(e.id)});for(let u of t.nestedEntities){if(!a.has(u.parentId))throw new Error(`Validation Error: Parent entity with ID "${u.parentId}" for nested entity "${u.name}" (ID: ${u.id}) not found.`);for(let e in u.columns){let t=u.columns[e],i="string"==typeof t?t:t.column;if(!r.has(i))throw new Error(`Validation Error: Column "${i}" for JSON key "${e}" in nested entity "${u.name}" (ID: ${u.id}) not found in the query's select list.`)}}let o=new Set([t.rootEntity.id,...t.nestedEntities.map(e=>e.parentId)]);for(let u of o){let e=t.nestedEntities.filter(e=>e.parentId===u);if(e.filter(e=>"array"===e.relationshipType).length>1){let e=u===t.rootEntity.id?t.rootEntity.name:null==(i=t.nestedEntities.find(e=>e.id===u))?void 0:i.name;throw new Error(`Validation Error: Parent entity "${e}" (ID: ${u}) has multiple direct array children. This is not supported.`)}let s=new Set;for(let i of e){if(s.has(i.propertyName)){let e=u===t.rootEntity.id?t.rootEntity.name:null==(n=t.nestedEntities.find(e=>e.id===u))?void 0:n.name;throw new Error(`Validation Error: Parent entity "${e}" (ID: ${u}) has duplicate property name "${i.propertyName}" for its children.`)}s.add(i.propertyName)}}}buildJsonQuery(e,t,i){if(!1===(null==i?void 0:i.jsonb))throw new Error("JSONB must be enabled for PostgreSQL GROUP BY compatibility. JSON type cannot be used in GROUP BY clauses. Please set jsonb: true or omit the jsonb option (defaults to true).");let n=e instanceof on?e:an.buildSimpleQuery(e);return this.buildJsonWithCteStrategy(n,t)}buildJson(e,t){return this.buildJsonQuery(e,t)}buildJsonWithCteStrategy(e,t){this.validateMapping(e,t);let{initialCte:i,initialCteAlias:n}=this.createInitialCte(e),s=[i],r=n,a=new Map;a.set(t.rootEntity.id,{...t.rootEntity,isRoot:!0,propertyName:t.rootName}),t.nestedEntities.forEach(e=>a.set(e.id,{...e,isRoot:!1,propertyName:e.propertyName}));let l=this.objectEntityCteBuilder.buildObjectEntityCtes(i,a,t);s=l.ctes,r=l.lastCteAlias;let o=l.columnMappings,u=this.arrayEntityCteBuilder.buildArrayEntityCtes(s,r,a,t,o);return s=u.updatedCtes,r=u.lastCteAlias,this.buildFinalSelectQuery(s,r,a,t,o)}createInitialCte(e){let t="origin_query";return{initialCte:new kt(e,new Pt(t,null),null),initialCteAlias:t}}buildFinalSelectQuery(e,t,i,n,s){let r=[...e],a=`cte_root_${n.rootName.toLowerCase().replace(/[^a-z0-9_]/g,"_")}`,l=i.get(n.rootEntity.id);if(!l)throw new Error(`Root entity ${n.rootEntity.id} not found`);if("array"!==n.resultFormat&&n.resultFormat){let e=this.buildEntityJsonObject(l,null,n.nestedEntities,i,s),o=new nt(e,n.rootName),u=new kt(new on({selectClause:new st([o]),fromClause:new St(new Ct(new wt(null,new We(t)),null),null)}),new Pt(a,null),null);return r.push(u),new on({withClause:new Tt(!1,r),selectClause:new st([new nt(new be(null,new We(n.rootName)),n.rootName)]),fromClause:new St(new Ct(new wt(null,new We(a)),null),null),limitClause:new bt(new Re(1))})}{let e=this.buildEntityJsonObject(l,null,n.nestedEntities,i,s),o=new nt(e,n.rootName),u=new kt(new on({selectClause:new st([o]),fromClause:new St(new Ct(new wt(null,new We(t)),null),null)}),new Pt(a,null),null);r.push(u);let h=new Ie(null,new Ue("jsonb_agg"),new Te([new be(null,new We(n.rootName))]),null);return new on({withClause:new Tt(!1,r),selectClause:new st([new nt(h,`${n.rootName}_array`)]),fromClause:new St(new Ct(new wt(null,new We(a)),null),null)})}}buildEntityJsonObject(e,t,i,n,s){let r=[];return Object.entries(e.columns).forEach(([e,t])=>{let i="string"==typeof t?t:t.column;r.push(new Re(e)),r.push(new be(null,new We(i)))}),i.filter(t=>t.parentId===e.id).forEach(e=>{let t=n.get(e.id);if(t)if(r.push(new Re(e.propertyName)),"object"===e.relationshipType){let e=s.find(e=>e.entityId===t.id);if(!e)throw new Error(`Column mapping not found for entity: ${t.id}`);r.push(new be(null,new We(e.generatedColumnName)))}else"array"===e.relationshipType&&r.push(new be(null,new We(e.propertyName)))}),new Ie(null,new Ue("jsonb_build_object"),new Te(r),null)}},Bn=class{constructor(e,t){"function"==typeof e?(this.tableColumnResolver=e,this.options=t||{}):(this.tableColumnResolver=void 0,this.options=e||{})}inject(e,t){"string"==typeof e&&(e=On.parse(e));let i=new nn(this.tableColumnResolver,this.options),n=new Yi(this.tableColumnResolver),s=e=>this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e,r=["min","max","like","ilike","in","any","=","<",">","!=","<>","<=",">=","or","and","column"],a=Object.values(t);if(a.length>0&&a.every(e=>void 0===e)&&!this.options.allowAllUndefined)throw new Error("All parameters are undefined. This would result in fetching all records. Use allowAllUndefined: true option to explicitly allow this behavior.");for(let[c,d]of Object.entries(t))void 0!==d&&this.processStateParameter(c,d,e,i,n,s,r,o,l,h,p,u);function l(e,t,i,n,s,r){for(let a=0;a<i.length;a++){let r=i[a],l=r.column||t,o=s.find(e=>n(e.name)===n(l));if(!o)throw new Error(`Column '${l}' not found in query for AND condition`);let u=o.value;if("="in r&&void 0!==r["="]){let i=new Be(`${t}_and_${a}_eq`,r["="]);e.appendWhere(new _e(u,"=",i))}if("min"in r&&void 0!==r.min){let i=new Be(`${t}_and_${a}_min`,r.min);e.appendWhere(new _e(u,">=",i))}if("max"in r&&void 0!==r.max){let i=new Be(`${t}_and_${a}_max`,r.max);e.appendWhere(new _e(u,"<=",i))}if("like"in r&&void 0!==r.like){let i=new Be(`${t}_and_${a}_like`,r.like);e.appendWhere(new _e(u,"like",i))}if("ilike"in r&&void 0!==r.ilike){let i=new Be(`${t}_and_${a}_ilike`,r.ilike);e.appendWhere(new _e(u,"ilike",i))}if("in"in r&&void 0!==r.in){let i=r.in.map((e,i)=>new Be(`${t}_and_${a}_in_${i}`,e));e.appendWhere(new _e(u,"in",new Ve(new Te(i))))}if("any"in r&&void 0!==r.any){let i=new Be(`${t}_and_${a}_any`,r.any);e.appendWhere(new _e(u,"=",new Ie(null,"any",i,null)))}if("<"in r&&void 0!==r["<"]){let i=new Be(`${t}_and_${a}_lt`,r["<"]);e.appendWhere(new _e(u,"<",i))}if(">"in r&&void 0!==r[">"]){let i=new Be(`${t}_and_${a}_gt`,r[">"]);e.appendWhere(new _e(u,">",i))}if("!="in r&&void 0!==r["!="]){let i=new Be(`${t}_and_${a}_neq`,r["!="]);e.appendWhere(new _e(u,"!=",i))}if("<>"in r&&void 0!==r["<>"]){let i=new Be(`${t}_and_${a}_ne`,r["<>"]);e.appendWhere(new _e(u,"<>",i))}if("<="in r&&void 0!==r["<="]){let i=new Be(`${t}_and_${a}_le`,r["<="]);e.appendWhere(new _e(u,"<=",i))}if(">="in r&&void 0!==r[">="]){let i=new Be(`${t}_and_${a}_ge`,r[">="]);e.appendWhere(new _e(u,">=",i))}}}function o(e,t,i,n,s,r){let a=[];for(let l=0;l<i.length;l++){let e=i[l],r=e.column||t,o=s.find(e=>n(e.name)===n(r));if(!o)throw new Error(`Column '${r}' not found in query for OR condition`);let u=o.value,h=[];if("="in e&&void 0!==e["="]){let i=new Be(`${t}_or_${l}_eq`,e["="]);h.push(new _e(u,"=",i))}if("min"in e&&void 0!==e.min){let i=new Be(`${t}_or_${l}_min`,e.min);h.push(new _e(u,">=",i))}if("max"in e&&void 0!==e.max){let i=new Be(`${t}_or_${l}_max`,e.max);h.push(new _e(u,"<=",i))}if("like"in e&&void 0!==e.like){let i=new Be(`${t}_or_${l}_like`,e.like);h.push(new _e(u,"like",i))}if("ilike"in e&&void 0!==e.ilike){let i=new Be(`${t}_or_${l}_ilike`,e.ilike);h.push(new _e(u,"ilike",i))}if("in"in e&&void 0!==e.in){let i=e.in.map((e,i)=>new Be(`${t}_or_${l}_in_${i}`,e));h.push(new _e(u,"in",new Ve(new Te(i))))}if("any"in e&&void 0!==e.any){let i=new Be(`${t}_or_${l}_any`,e.any);h.push(new _e(u,"=",new Ie(null,"any",i,null)))}if("<"in e&&void 0!==e["<"]){let i=new Be(`${t}_or_${l}_lt`,e["<"]);h.push(new _e(u,"<",i))}if(">"in e&&void 0!==e[">"]){let i=new Be(`${t}_or_${l}_gt`,e[">"]);h.push(new _e(u,">",i))}if("!="in e&&void 0!==e["!="]){let i=new Be(`${t}_or_${l}_neq`,e["!="]);h.push(new _e(u,"!=",i))}if("<>"in e&&void 0!==e["<>"]){let i=new Be(`${t}_or_${l}_ne`,e["<>"]);h.push(new _e(u,"<>",i))}if("<="in e&&void 0!==e["<="]){let i=new Be(`${t}_or_${l}_le`,e["<="]);h.push(new _e(u,"<=",i))}if(">="in e&&void 0!==e[">="]){let i=new Be(`${t}_or_${l}_ge`,e[">="]);h.push(new _e(u,">=",i))}if(h.length>0){let e=h[0];for(let t=1;t<h.length;t++)e=new _e(e,"and",h[t]);h.length>1?a.push(new Ve(e)):a.push(e)}}if(a.length>0){let t=a[0];for(let e=1;e<a.length;e++)t=new _e(t,"or",a[e]);e.appendWhere(new Ve(t))}}function u(e,t,i){Object.keys(e).forEach(e=>{if(!t.includes(e))throw new Error(`Unsupported operator '${e}' for state key '${i}'`)})}function h(e,t,i,n){let s=new Be(i,n);e.appendWhere(new _e(t,"=",s))}function p(e,t,i,n){let s=[];if("="in n){let e=new Be(i,n["="]);s.push(new _e(t,"=",e))}if("min"in n){let e=new Be(i+"_min",n.min);s.push(new _e(t,">=",e))}if("max"in n){let e=new Be(i+"_max",n.max);s.push(new _e(t,"<=",e))}if("like"in n){let e=new Be(i+"_like",n.like);s.push(new _e(t,"like",e))}if("ilike"in n){let e=new Be(i+"_ilike",n.ilike);s.push(new _e(t,"ilike",e))}if("in"in n){let e=n.in.map((e,t)=>new Be(`${i}_in_${t}`,e));s.push(new _e(t,"in",new Ve(new Te(e))))}if("any"in n){let e=new Be(i+"_any",n.any);s.push(new _e(t,"=",new Ie(null,"any",e,null)))}if("<"in n){let e=new Be(i+"_lt",n["<"]);s.push(new _e(t,"<",e))}if(">"in n){let e=new Be(i+"_gt",n[">"]);s.push(new _e(t,">",e))}if("!="in n){let e=new Be(i+"_neq",n["!="]);s.push(new _e(t,"!=",e))}if("<>"in n){let e=new Be(i+"_ne",n["<>"]);s.push(new _e(t,"<>",e))}if("<="in n){let e=new Be(i+"_le",n["<="]);s.push(new _e(t,"<=",e))}if(">="in n){let e=new Be(i+"_ge",n[">="]);s.push(new _e(t,">=",e))}if(1===s.length)e.appendWhere(s[0]);else if(s.length>1){let t=s[0];for(let e=1;e<s.length;e++)t=new _e(t,"and",s[e]);e.appendWhere(new Ve(t))}}return e}isOrCondition(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"or"in e}isAndCondition(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"and"in e}isExplicitColumnMapping(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"column"in e&&!("or"in e)}isValidatableObject(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&Object.getPrototypeOf(e)===Object.prototype}hasColumnMapping(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"column"in e}isSimpleValue(e){return null===e||"object"!=typeof e||Array.isArray(e)||e instanceof Date}processStateParameter(e,t,i,n,s,r,a,l,o,u,h,p){if(this.isOrCondition(t)){let a=t.or;if(a&&a.length>0){let t=this.findTargetQueryForLogicalCondition(n,i,e,a),o=this.getAllAvailableColumns(t,s);return void l(t,e,a,r,o,s)}}if(this.isAndCondition(t)){let a=t.and;if(a&&a.length>0){let t=this.findTargetQueryForLogicalCondition(n,i,e,a),l=this.getAllAvailableColumns(t,s);return void o(t,e,a,r,l,s)}}if(this.isExplicitColumnMapping(t)){let l=t.column;if(l){let o=n.find(i,l);if(0===o.length)throw new Error(`Explicit column '${l}' not found in query`);for(let i of o){let n=this.getAllAvailableColumns(i,s).find(e=>r(e.name)===r(l));if(!n)throw new Error(`Explicit column '${l}' not found in query`);this.isValidatableObject(t)&&p(t,a,e),h(i,n.value,e,t)}return}}this.processRegularColumnCondition(e,t,i,n,s,r,a,u,h,p)}processRegularColumnCondition(e,t,i,n,s,r,a,l,o,u){let h=n.find(i,e);if(0===h.length){if(this.options.ignoreNonExistentColumns)return;throw new Error(`Column '${e}' not found in query`)}for(let p of h){let i=this.getAllAvailableColumns(p,s),n=i.find(t=>r(t.name)===r(e));if(!n)throw new Error(`Column '${e}' not found in query`);let h=n.value;this.isValidatableObject(t)&&u(t,a,e);let c=h,d=e;if(this.hasColumnMapping(t)){let e=t.column;if(e){let t=i.find(t=>r(t.name)===r(e));t&&(c=t.value,d=e)}}this.isSimpleValue(t)?l(p,c,d,t):o(p,c,d,t)}}findTargetQueryForLogicalCondition(e,t,i,n){let s=n.map(e=>e.column||i).filter((e,t,i)=>i.indexOf(e)===t);for(let a of s){let i=e.find(t,a);if(i.length>0)return i[0]}let r=n===n.or?"OR":"AND";throw new Error(`None of the ${r} condition columns [${s.join(", ")}] found in query`)}getAllAvailableColumns(e,t){return[...t.collect(e),...this.collectCTEColumns(e)]}collectCTEColumns(e){let t=[];if(e.withClause)for(let n of e.withClause.tables)try{let e=this.collectColumnsFromSelectQuery(n.query);t.push(...e)}catch(i){}return t}collectColumnsFromSelectQuery(e){return e instanceof on?new Yi(this.tableColumnResolver).collect(e):e instanceof un?this.collectColumnsFromSelectQuery(e.left):[]}},Qn=class{constructor(e){this.tableColumnResolver=e}static removeOrderBy(e){if("string"==typeof e&&(e=On.parse(e)),!(e instanceof on))throw new Error("Complex queries are not supported for ORDER BY removal");return new on({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:null,windowClause:e.windowClause,limitClause:e.limitClause,offsetClause:e.offsetClause,fetchClause:e.fetchClause,forClause:e.forClause})}inject(e,t){if("string"==typeof e&&(e=On.parse(e)),!(e instanceof on))throw new Error("Complex queries are not supported for sorting");let i=new Yi(this.tableColumnResolver).collect(e);for(let a of Object.keys(t))if(!i.find(e=>e.name===a))throw new Error(`Column or alias '${a}' not found in current query`);let n=[];for(let[a,l]of Object.entries(t)){let e=i.find(e=>e.name===a);if(!e)continue;let t,s=e.value;this.validateSortCondition(a,l),t=l.desc?"desc":"asc";let r=null;l.nullsFirst?r="first":l.nullsLast&&(r="last");let o=new ct(s,t,r);n.push(o)}let s=[];s=e.orderByClause?[...e.orderByClause.order,...n]:n;let r=s.length>0?new pt(s):null;return new on({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:r,windowClause:e.windowClause,limitClause:e.limitClause,offsetClause:e.offsetClause,fetchClause:e.fetchClause,forClause:e.forClause})}validateSortCondition(e,t){if(t.asc&&t.desc)throw new Error(`Conflicting sort directions for column '${e}': both asc and desc specified`);if(t.nullsFirst&&t.nullsLast)throw new Error(`Conflicting nulls positions for column '${e}': both nullsFirst and nullsLast specified`);if(!(t.asc||t.desc||t.nullsFirst||t.nullsLast))throw new Error(`Empty sort condition for column '${e}': at least one sort option must be specified`)}},qn=class{inject(e,t){if(this.validatePaginationOptions(t),"string"==typeof e&&(e=On.parse(e)),!(e instanceof on))throw new Error("Complex queries are not supported for pagination");if(e.limitClause||e.offsetClause)throw new Error("Query already contains LIMIT or OFFSET clause. Use removePagination() first if you want to override existing pagination.");let i=(t.page-1)*t.pageSize,n=new bt(new Be("paging_limit",t.pageSize)),s=new It(new Be("paging_offset",i));return new on({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:e.orderByClause,windowClause:e.windowClause,limitClause:n,offsetClause:s,fetchClause:e.fetchClause,forClause:e.forClause})}static removePagination(e){if("string"==typeof e&&(e=On.parse(e)),!(e instanceof on))throw new Error("Complex queries are not supported for pagination removal");return new on({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:e.orderByClause,windowClause:e.windowClause,limitClause:null,offsetClause:null,fetchClause:e.fetchClause,forClause:e.forClause})}validatePaginationOptions(e){if(!e)throw new Error("Pagination options are required");if("number"!=typeof e.page||e.page<1)throw new Error("Page number must be a positive integer (1 or greater)");if("number"!=typeof e.pageSize||e.pageSize<1)throw new Error("Page size must be a positive integer (1 or greater)");if(e.pageSize>1e3)throw new Error("Page size cannot exceed 1000 items")}},Un=class{static extractParameterNames(e){return Fi.collect(e).map(e=>e.name.value)}static hasParameter(e,t){return this.extractParameterNames(e).includes(t)}static separateFilters(e,t){let i=this.extractParameterNames(e),n={},s={};for(let[r,a]of Object.entries(t))i.includes(r)?n[r]=a:s[r]=a;return{hardcodedParams:n,dynamicFilters:s}}},Wn=class{constructor(e={}){this.options={requireAllParameters:!0,...e}}bind(e,t){let i=e,n=Un.extractParameterNames(i);if(this.options.requireAllParameters){let e=n.filter(e=>!(e in t)||void 0===t[e]);if(e.length>0)throw new Error(`Missing values for required parameters: ${e.join(", ")}`)}for(let[r,a]of Object.entries(t))if(n.includes(r))try{ln.set(i,r,a)}catch(s){throw new Error(`Failed to bind parameter '${r}': ${s instanceof Error?s.message:"Unknown error"}`)}return i}bindToSimpleQuery(e,t){return this.bind(e,t)}},Vn=class{constructor(e){this.tableColumnResolver=e}buildQuery(e,t={}){let i;try{i=On.parse(e)}catch(s){throw new Error(`Failed to parse SQL: ${s instanceof Error?s.message:"Unknown error"}`)}let n=i;if(t.filter&&Object.keys(t.filter).length>0){let{hardcodedParams:e,dynamicFilters:i}=Un.separateFilters(n,t.filter);if(Object.keys(e).length>0&&(n=new Wn({requireAllParameters:!1}).bind(n,e)),Object.keys(i).length>0){let e=new Bn(this.tableColumnResolver),t=an.buildSimpleQuery(n);n=e.inject(t,i)}}if(t.sort&&Object.keys(t.sort).length>0){let e=new Qn(this.tableColumnResolver),i=an.buildSimpleQuery(n);n=e.inject(i,t.sort)}if(t.paging){let{page:e=1,pageSize:i}=t.paging;if(void 0!==i){let t=new qn,s={page:e,pageSize:i},r=an.buildSimpleQuery(n);n=t.inject(r,s)}}if(t.serialize&&"object"==typeof t.serialize){let e=new Rn,i=an.buildSimpleQuery(n);n=e.buildJsonQuery(i,t.serialize)}return n}buildFilteredQuery(e,t){return this.buildQuery(e,{filter:t})}buildSortedQuery(e,t){return this.buildQuery(e,{sort:t})}buildPaginatedQuery(e,t){return this.buildQuery(e,{paging:t})}buildSerializedQuery(e,t){return this.buildQuery(e,{serialize:t})}validateSql(e){try{return On.parse(e),!0}catch(tt){throw new Error(`Invalid SQL: ${tt instanceof Error?tt.message:"Unknown error"}`)}}};export{Me as ArrayExpression,Xe as ArrayIndexExpression,De as ArrayQueryExpression,Ye as ArraySliceExpression,ze as BetweenExpression,_e as BinaryExpression,un as BinarySelectQuery,Ai as CTECollector,Pn as CTEDependencyAnalyzer,Oi as CTEDisabler,Hi as CTENormalizer,tn as CTENotFoundError,je as CaseExpression,qe as CaseKeyValuePair,Ke as CastExpression,be as ColumnReference,Zi as DuplicateCTEError,Gi as DuplicateDetectionMode,Vn as DynamicQueryBuilder,Di as Formatter,Ie as FunctionCall,We as IdentifierString,ke as InlineQuery,Se as InsertQuery,en as InvalidCTENameError,Re as LiteralValue,Be as ParameterExpression,Ve as ParenExpression,Rn as PostgresJsonQueryBuilder,it as QualifiedName,an as QueryBuilder,Ue as RawString,Ln as SchemaCollector,On as SelectQueryParser,Qi as SelectValueCollector,Yi as SelectableColumnCollector,on as SimpleSelectQuery,ge as SqlComponent,Mi as SqlFormatter,qn as SqlPaginationInjector,Bn as SqlParamInjector,Qn as SqlSortInjector,Je as StringSpecifierExpression,Qe as SwitchCaseArgument,$n as TableSchema,Pi as TableSourceCollector,Bt as TokenType,Ge as TupleExpression,He as TypeValue,Fe as UnaryExpression,nn as UpstreamSelectQueryFinder,Te as ValueList,hn as ValuesQuery,Ae as WindowFrameBound,Oe as WindowFrameBoundStatic,Pe as WindowFrameBoundaryValue,Le as WindowFrameExpression,$e as WindowFrameSpec,Ne as WindowFrameType,Tn as WithClauseParser};
