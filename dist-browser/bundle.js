(()=>{"use strict";var e,t,r={},s={};function a(e){var t=s[e];if(void 0!==t)return t.exports;var o=s[e]={exports:{}};return r[e](o,o.exports,a),o.exports}a.m=r,a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce((t,r)=>(a.f[r](e,t),t),[])),a.u=e=>e+".bundle.js",a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="zosql:",a.l=(r,s,o,n)=>{if(e[r])e[r].push(s);else{var i,c;if(void 0!==o)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var u=l[d];if(u.getAttribute("src")==r||u.getAttribute("data-webpack")==t+o){i=u;break}}i||(c=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,a.nc&&i.setAttribute("nonce",a.nc),i.setAttribute("data-webpack",t+o),i.src=r),e[r]=[s];var p=(t,s)=>{i.onerror=i.onload=null,clearTimeout(h);var a=e[r];if(delete e[r],i.parentNode&&i.parentNode.removeChild(i),a&&a.forEach(e=>e(s)),t)return t(s)},h=setTimeout(p.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=p.bind(null,i.onerror),i.onload=p.bind(null,i.onload),c&&document.head.appendChild(i)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;a.g.importScripts&&(e=a.g.location+"");var t=a.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var s=r.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=r[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),a.p=e})(),(()=>{var e={792:0};a.f.j=(t,r)=>{var s=a.o(e,t)?e[t]:void 0;if(0!==s)if(s)r.push(s[2]);else{var o=new Promise((r,a)=>s=e[t]=[r,a]);r.push(s[2]=o);var n=a.p+a.u(t),i=new Error;a.l(n,r=>{if(a.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var o=r&&("load"===r.type?"missing":r.type),n=r&&r.target&&r.target.src;i.message="Loading chunk "+t+" failed.\n("+o+": "+n+")",i.name="ChunkLoadError",i.type=o,i.request=n,s[1](i)}},"chunk-"+t,t)}};var t=(t,r)=>{var s,o,[n,i,c]=r,l=0;if(n.some(t=>0!==e[t])){for(s in i)a.o(i,s)&&(a.m[s]=i[s]);c&&c(a)}for(t&&t(r);l<n.length;l++)o=n[l],a.o(e,o)&&e[o]&&e[o][0](),e[o]=0},r=self.webpackChunkzosql=self.webpackChunkzosql||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();class o{constructor(){this.schema=null,this.STORAGE_KEY="zosql_schema"}async initialize(){await this.loadSchema()}async getSchema(){return this.schema||await this.loadSchema(),{success:!0,schema:this.schema,tableCount:this.schema?Object.keys(this.schema).length:0}}async reloadSchema(){try{return await this.loadSchema(),{success:!0,message:"Schema reloaded successfully",tableCount:this.schema?Object.keys(this.schema).length:0}}catch(e){return console.error("[SchemaParser] Error reloading schema:",e),{success:!1,error:e.message||"Failed to reload schema"}}}async loadSchema(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e)return void(this.schema=JSON.parse(e));try{const e=await fetch("/static/zosql.schema.json");if(e.ok)return this.schema=await e.json(),void localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.schema))}catch(e){console.warn("[SchemaParser] Failed to fetch schema file:",e)}this.schema=this.getDefaultSchema()}catch(e){console.error("[SchemaParser] Error loading schema:",e),this.schema=this.getDefaultSchema()}}getDefaultSchema(){return{users:{user_id:{type:"integer",nullable:!1},username:{type:"varchar",nullable:!1},email:{type:"varchar",nullable:!1},created_at:{type:"timestamp",nullable:!1},updated_at:{type:"timestamp",nullable:!1}},orders:{order_id:{type:"integer",nullable:!1},user_id:{type:"integer",nullable:!1},product_id:{type:"integer",nullable:!1},quantity:{type:"integer",nullable:!1},total_amount:{type:"numeric",nullable:!1},order_date:{type:"timestamp",nullable:!1},status:{type:"varchar",nullable:!1}},products:{product_id:{type:"integer",nullable:!1},name:{type:"varchar",nullable:!1},description:{type:"text",nullable:!0},price:{type:"numeric",nullable:!1},stock_quantity:{type:"integer",nullable:!1},category:{type:"varchar",nullable:!0},created_at:{type:"timestamp",nullable:!1}},categories:{category_id:{type:"integer",nullable:!1},name:{type:"varchar",nullable:!1},description:{type:"text",nullable:!0},parent_category_id:{type:"integer",nullable:!0}}}}async setSchema(e){try{return this.schema=e,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),{success:!0,message:"Schema updated successfully",tableCount:Object.keys(e).length}}catch(e){return console.error("[SchemaParser] Error setting schema:",e),{success:!1,error:e.message||"Failed to set schema"}}}async clearSchema(){try{return localStorage.removeItem(this.STORAGE_KEY),this.schema=this.getDefaultSchema(),{success:!0,message:"Schema cleared, using default schema"}}catch(e){return console.error("[SchemaParser] Error clearing schema:",e),{success:!1,error:e.message||"Failed to clear schema"}}}}class n{static rawsqlModule=null;static async initialize(){try{const e=await a.e(442).then(a.bind(a,442));return this.rawsqlModule={SelectQueryParser:e.SelectQueryParser,SqlFormatter:e.SqlFormatter,QueryFlowDiagramGenerator:e.QueryFlowDiagramGenerator,CTEComposer:e.CTEComposer,SchemaCollector:e.SchemaCollector},window.rawsqlTs=this.rawsqlModule,console.log("[RawSqlBrowser] rawsql-ts module loaded successfully"),this.rawsqlModule}catch(e){throw console.error("[RawSqlBrowser] Failed to load rawsql-ts:",e),this.rawsqlModule=this.createFallbackModule(),window.rawsqlTs=this.rawsqlModule,new Error("rawsql-ts initialization failed, using fallback mode")}}static createFallbackModule(){return{SelectQueryParser:{parse:e=>(console.warn("[RawSqlBrowser] Using fallback parser"),{toSimpleQuery:()=>({type:"select",sql:e,tables:[],columns:[]}),withClause:null})},SqlFormatter:class{constructor(e){this.config=e||{}}format(e){return console.warn("[RawSqlBrowser] Using fallback formatter"),"string"==typeof e?e:e.sql||""}},QueryFlowDiagramGenerator:class{generateMermaidFlow(e,t){return console.warn("[RawSqlBrowser] Using fallback diagram generator"),"graph TD\n    A[Query] --\x3e B[Result]"}},CTEComposer:class{constructor(e){this.config=e||{}}compose(e,t){return console.warn("[RawSqlBrowser] Using fallback CTE composer"),e&&0!==e.length?`WITH ${e.map(e=>`${e.name} AS (\n${e.query}\n)`).join(",\n")}\n${t}`:t}}}}static getParser(){if(!this.rawsqlModule)throw new Error("RawSqlBrowser not initialized");return this.rawsqlModule.SelectQueryParser}static getFormatter(e){if(!this.rawsqlModule)throw new Error("RawSqlBrowser not initialized");return new this.rawsqlModule.SqlFormatter(e)}static getCTEComposer(e){if(!this.rawsqlModule)throw new Error("RawSqlBrowser not initialized");return new this.rawsqlModule.CTEComposer(e)}static getFlowDiagramGenerator(){if(!this.rawsqlModule)throw new Error("RawSqlBrowser not initialized");return new this.rawsqlModule.QueryFlowDiagramGenerator}static getSchemaCollector(){if(!this.rawsqlModule)throw new Error("RawSqlBrowser not initialized");return new this.rawsqlModule.SchemaCollector}}class i{constructor(){this.formatterConfig=this.getDefaultFormatterConfig(),this.parseCache=new Map}async initialize(){if(!n.rawsqlModule)throw new Error("RawSqlBrowser not initialized")}async parseSql(e){const{sql:t,options:r={}}=e;if(!t)return{success:!1,error:"SQL is required"};const s=this.getCacheKey(t,r);if(this.parseCache.has(s))return this.parseCache.get(s);try{const e=n.getParser().parse(t),r={success:!0,query:this.serializeQuery(e),type:e.constructor.name,hasCTE:!!(e.withClause&&e.withClause.tables.length>0)};return this.parseCache.set(s,r),r}catch(e){return console.error("[SqlParserService] Parse error:",e),{success:!1,error:e.message||"Failed to parse SQL"}}}async validateSql(e){const{sql:t}=e;if(!t)return{success:!1,isValid:!1,error:"SQL is required"};try{return n.getParser().parse(t),{success:!0,isValid:!0,message:"SQL is valid"}}catch(e){return console.error("[SqlParserService] Validation error:",e),{success:!0,isValid:!1,error:e.message||"Invalid SQL syntax",details:e.stack}}}async formatSql(e){const{sql:t,config:r}=e;if(!t)return{success:!1,error:"SQL is required"};try{const e=n.getFormatter(r||this.formatterConfig),s=n.getParser().parse(t),a=e.format(s);return{success:!0,formattedSql:"string"==typeof a?a:a.formattedSql,originalSql:t}}catch(e){return console.error("[SqlParserService] Format error:",e),{success:!1,error:e.message||"Failed to format SQL",originalSql:t}}}async analyzeCTEDependencies(e){const{sql:t}=e;if(!t)return{success:!1,error:"SQL is required"};try{const e=n.getParser().parse(t).toSimpleQuery(),r={};return e.withClause&&e.withClause.tables&&e.withClause.tables.forEach(e=>{const t=e.aliasExpression?.table?.name||"unknown";r[t]={name:t,dependencies:this.extractCTEDependencies(e),query:this.extractCTEQuery(e)}}),{success:!0,dependencies:r,mainQuery:this.extractMainQuery(e),cteCount:Object.keys(r).length}}catch(e){return console.error("[SqlParserService] CTE analysis error:",e),{success:!1,error:e.message||"Failed to analyze CTE dependencies"}}}getDefaultFormatterConfig(){return{identifierEscape:{start:"",end:""},parameterSymbol:":",parameterStyle:"named",indentSize:4,indentChar:" ",newline:"\n",keywordCase:"lower",commaBreak:"before",andBreak:"before",withClauseStyle:"full-oneline",preserveComments:!0}}getCacheKey(e,t){return`${e.trim()}_${JSON.stringify(t)}`}serializeQuery(e){return{type:e.constructor.name,sql:e.sql||"",hasCTE:!!(e.withClause&&e.withClause.tables.length>0)}}extractCTEDependencies(e){const t=[];if(e.query&&"string"==typeof e.query){const r=e.query.match(/\b(?:FROM|JOIN)\s+(\w+)/gi);r&&r.forEach(e=>{const r=e.replace(/^(?:FROM|JOIN)\s+/i,"");t.push(r)})}return[...new Set(t)]}extractCTEQuery(e){return e.query&&"string"==typeof e.query?e.query:""}extractMainQuery(e){if(e.sql){const t=e.sql,r=t.match(/^WITH\s+.*?\s+SELECT/is);if(r)return t.substring(r[0].lastIndexOf("SELECT"))}return e.sql||""}async extractSchema(e){const{sql:t}=e;if(!t)return{success:!1,error:"SQL is required"};try{const e=n.getParser().parse(t),r=n.getSchemaCollector().collect(e).map(e=>({name:e.name,columns:e.columns}));return{success:!0,tables:r,message:`Extracted schema from ${r.length} table(s)`}}catch(e){return console.error("[SqlParserService] Schema extraction error:",e),{success:!1,error:e.message||"Failed to extract schema from SQL"}}}}class c{constructor(){this.STORAGE_KEY="zosql_workspace",this.VERSION="1.0.0",this.workspace=null}async initialize(){this.loadWorkspace()}async getWorkspace(){return{success:!0,workspace:this.workspace?this.workspace.workspaceInfo:null,hasWorkspace:!!this.workspace}}async decomposeQuery(e){const{sql:t,queryName:r,originalFilePath:s}=e;if(!t)return{success:!1,error:"SQL is required"};try{console.log("[WorkspaceService] Decomposing query:",r||"unnamed");const{privateCtes:e,decomposedQuery:a,flowDiagram:o}=await this.extractCTEsAndDecomposeQuery(t),n={name:r||"decomposed_query",originalQuery:t,originalFilePath:s||"",decomposedQuery:a,privateCtes:e,created:(new Date).toISOString(),lastModified:(new Date).toISOString()};return this.saveWorkspace(n),{success:!0,workspace:n,privateCteCount:Object.keys(e).length,decomposedQuery:a,flowDiagram:o,message:"Query decomposed successfully"}}catch(e){return console.error("[WorkspaceService] Error decomposing query:",e),{success:!1,error:e.message||"Failed to decompose query"}}}async composeQuery(e){const{decomposedQuery:t}=e;if(!this.workspace)return{success:!1,error:"No active workspace found"};try{const e=this.workspace.privateCtes||{};return{success:!0,composedQuery:this.composeQueryWithCTEs(t||this.workspace.workspaceInfo.decomposedQuery,e),originalFilePath:this.workspace.workspaceInfo.originalFilePath,message:"Query composed successfully"}}catch(e){return console.error("[WorkspaceService] Error composing query:",e),{success:!1,error:e.message||"Failed to compose query"}}}async clearWorkspace(){try{return localStorage.removeItem(this.STORAGE_KEY),this.workspace=null,{success:!0,message:"Workspace cleared successfully"}}catch(e){return console.error("[WorkspaceService] Error clearing workspace:",e),{success:!1,error:e.message||"Failed to clear workspace"}}}async getPrivateCtes(){const e=this.workspace?.privateCtes||{};return{success:!0,privateCtes:e,count:Object.keys(e).length}}async getSinglePrivateCte(e){if(!e)return{success:!1,error:"CTE name is required"};const t=(this.workspace?.privateCtes||{})[e];return t?{success:!0,cte:t,message:`Private CTE ${e} retrieved successfully`}:{success:!1,error:`Private CTE not found: ${e}`}}async updatePrivateCte(e,t){const{query:r,description:s}=t;if(!e||!r)return{success:!1,error:"CTE name and query are required"};if(!this.workspace)return{success:!1,error:"No active workspace found"};try{return this.workspace.privateCtes[e]={name:e,query:r,description:s||this.workspace.privateCtes[e]?.description||"",dependencies:this.workspace.privateCtes[e]?.dependencies||[],columns:[]},this.workspace.workspaceInfo.privateCtes=this.workspace.privateCtes,this.workspace.workspaceInfo.lastModified=(new Date).toISOString(),this.saveWorkspace(this.workspace.workspaceInfo),{success:!0,message:`Private CTE ${e} updated successfully`}}catch(e){return console.error("[WorkspaceService] Error updating CTE:",e),{success:!1,error:e.message||"Failed to update CTE"}}}async getWorkspaceFile(e,t){try{let r="";if("main"===e)r=this.workspace?.mainQuery||this.workspace?.workspaceInfo?.decomposedQuery||"";else if("cte"===e){const e=t.replace(".cte","").replace(".sql",""),s=this.workspace?.privateCtes?.[e];r=s?.query||""}return r?{success:!0,content:r,fileName:t,type:e}:{success:!1,error:`File not found: ${t}`,fileName:t,type:e}}catch(e){return console.error("[WorkspaceService] Error getting workspace file:",e),{success:!1,error:e.message||"Failed to get workspace file"}}}async validateWorkspace(){if(!this.workspace)return{success:!1,error:"No active workspace found"};const e=[],t=this.workspace.workspaceInfo.decomposedQuery;if(t){const r=await this.validateSingleQuery("main","main_query",t);e.push(r)}const r=this.workspace.privateCtes||{};for(const[t,s]of Object.entries(r)){const r=await this.validateSingleQuery("cte",t,s.query);e.push(r)}return{success:!0,results:e,summary:{total:e.length,valid:e.filter(e=>e.isValid).length,invalid:e.filter(e=>!e.isValid).length}}}async validateSingleQuery(e,t,r){try{return n.getParser().parse(r),{type:e,name:t,isValid:!0,error:null}}catch(r){return{type:e,name:t,isValid:!1,error:r.message||"Invalid SQL syntax"}}}async extractCTEsAndDecomposeQuery(e){const t={};let r=e,s="";try{const a=n.getParser().parse(e).toSimpleQuery();a.withClause&&a.withClause.tables&&a.withClause.tables.forEach(e=>{const r=e.aliasExpression?.table?.name||"unknown";t[r]={name:r,query:this.extractCTEQuery(e),description:`Extracted CTE: ${r}`,dependencies:this.extractCTEDependencies(e),columns:[]}});const o=n.getFormatter(this.getDefaultFormatterConfig()).format(a);r="string"==typeof o?o:o.formattedSql;try{s=n.getFlowDiagramGenerator().generateMermaidFlow(e,{direction:"TD",title:"Query Flow Diagram"})}catch(e){console.warn("[WorkspaceService] Failed to generate flow diagram:",e)}}catch(e){console.error("[WorkspaceService] CTE extraction error:",e)}return{privateCtes:t,decomposedQuery:r,flowDiagram:s}}composeQueryWithCTEs(e,t){if(!t||0===Object.keys(t).length)return e;try{const r=n.getCTEComposer({preset:"postgres",withClauseStyle:"full-oneline"}),s=Object.values(t).map(e=>({name:e.name,query:e.query}));return r.compose(s,e)}catch(t){return console.error("[WorkspaceService] CTE composition error:",t),e}}loadWorkspace(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return void(this.workspace=null);const t=JSON.parse(e);if(t.version!==this.VERSION)return console.warn("[WorkspaceService] Version mismatch, clearing workspace"),void this.clearWorkspace();this.workspace=t}catch(e){console.error("[WorkspaceService] Error loading workspace:",e),this.workspace=null}}saveWorkspace(e){try{this.workspace={version:this.VERSION,workspaceInfo:e,privateCtes:e.privateCtes||{},mainQuery:e.decomposedQuery||"",lastSaved:(new Date).toISOString()},localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.workspace)),console.log("[WorkspaceService] Workspace saved to localStorage")}catch(e){throw console.error("[WorkspaceService] Error saving workspace:",e),e}}getDefaultFormatterConfig(){return{identifierEscape:{start:"",end:""},parameterSymbol:":",parameterStyle:"named",indentSize:4,indentChar:" ",newline:"\n",keywordCase:"lower",commaBreak:"before",andBreak:"before",withClauseStyle:"full-oneline",preserveComments:!0}}extractCTEQuery(e){if(!e||!e.query)return"";try{const t=n.getFormatter(this.getDefaultFormatterConfig()).format(e.query);return("string"==typeof t?t:t.formattedSql)||""}catch(t){return console.error("[WorkspaceService] Error extracting CTE query:",t),console.error("[WorkspaceService] CTE object:",e),""}}extractCTEDependencies(e){const t=[];if(!e||!e.query)return t;try{const r=n.getFormatter(this.getDefaultFormatterConfig()).format(e.query),s="string"==typeof r?r:r.formattedSql;if(s){const e=s.match(/\b(?:FROM|JOIN)\s+([a-zA-Z][a-zA-Z0-9_]*)/gi);e&&e.forEach(e=>{const r=e.replace(/^(?:FROM|JOIN)\s+/i,"").trim();r&&/^[a-zA-Z][a-zA-Z0-9_]*$/.test(r)&&t.push(r)})}}catch(e){console.error("[WorkspaceService] Error extracting CTE dependencies:",e)}return[...new Set(t)]}}class l{constructor(){this.fileCache=new Map}async readSqlFile(e){const{filePath:t}=e;if(!t)return{success:!1,error:"File path is required"};try{if(this.fileCache.has(t)){const e=this.fileCache.get(t);return{success:!0,content:e,filePath:t,size:e.length}}const e=await this.readFileContent(t);return this.fileCache.set(t,e),{success:!0,content:e,filePath:t,size:e.length}}catch(e){return console.error("[FileService] Error reading file:",e),{success:!1,error:`File not found: ${t}`}}}async readFileContent(e){try{const t=await fetch(`/static/sql-examples/${e}`);if(t.ok)return await t.text()}catch(e){console.warn("[FileService] Failed to fetch file:",e)}const t=`zosql_file_${e}`;return localStorage.getItem(t)||this.getDemoFile(e)}getDemoFile(e){return{"example.sql":"-- Example SQL Query\nWITH user_orders AS (\n    SELECT \n        u.user_id,\n        u.username,\n        COUNT(o.order_id) as order_count,\n        SUM(o.total_amount) as total_spent\n    FROM users u\n    LEFT JOIN orders o ON u.user_id = o.user_id\n    GROUP BY u.user_id, u.username\n),\nhigh_value_customers AS (\n    SELECT *\n    FROM user_orders\n    WHERE total_spent > 1000\n)\nSELECT \n    hvc.*,\n    RANK() OVER (ORDER BY total_spent DESC) as spending_rank\nFROM high_value_customers hvc\nORDER BY total_spent DESC","analytics.sql":"-- Analytics Query\nWITH daily_sales AS (\n    SELECT \n        DATE(order_date) as sale_date,\n        COUNT(*) as order_count,\n        SUM(total_amount) as daily_total\n    FROM orders\n    WHERE status = 'completed'\n    GROUP BY DATE(order_date)\n),\nmoving_average AS (\n    SELECT \n        sale_date,\n        order_count,\n        daily_total,\n        AVG(daily_total) OVER (\n            ORDER BY sale_date \n            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n        ) as seven_day_avg\n    FROM daily_sales\n)\nSELECT * FROM moving_average\nORDER BY sale_date DESC\nLIMIT 30"}[e]||`-- File not found: ${e}`}async saveFile(e,t){try{const r=`zosql_file_${e}`;return localStorage.setItem(r,t),this.fileCache.set(e,t),{success:!0,message:`File saved: ${e}`}}catch(e){return console.error("[FileService] Error saving file:",e),{success:!1,error:e.message||"Failed to save file"}}}downloadFile(e,t){try{const r=new Blob([t],{type:"text/plain"}),s=URL.createObjectURL(r),a=document.createElement("a");return a.href=s,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),{success:!0,message:`File downloaded: ${e}`}}catch(e){return console.error("[FileService] Error downloading file:",e),{success:!1,error:e.message||"Failed to download file"}}}async handleFileUpload(e){return new Promise((t,r)=>{const s=new FileReader;s.onload=r=>{const s=r.target.result;this.saveFile(e.name,s),t({success:!0,filename:e.name,content:s,size:s.length})},s.onerror=e=>{r({success:!1,error:"Failed to read file"})},s.readAsText(e)})}}class d{constructor(){this.schemaParser=new o,this.sqlParser=new i,this.workspace=new c,this.fileService=new l,this.endpoints=new Map,this.setupEndpoints()}async initialize(){await this.schemaParser.initialize(),await this.sqlParser.initialize(),await this.workspace.initialize(),this.setupFetchInterceptor(),console.log("[BrowserApiAdapter] Initialized")}setupEndpoints(){this.endpoints.set("GET /api/schema",()=>this.schemaParser.getSchema()),this.endpoints.set("POST /api/schema/reload",()=>this.schemaParser.reloadSchema()),this.endpoints.set("POST /api/parse-sql",e=>this.sqlParser.parseSql(e)),this.endpoints.set("POST /api/validate-sql",e=>this.sqlParser.validateSql(e)),this.endpoints.set("POST /api/format-sql",e=>this.sqlParser.formatSql(e)),this.endpoints.set("POST /api/analyze-cte-dependencies",e=>this.sqlParser.analyzeCTEDependencies(e)),this.endpoints.set("POST /api/extract-schema",e=>this.sqlParser.extractSchema(e)),this.endpoints.set("GET /api/workspace",()=>this.workspace.getWorkspace()),this.endpoints.set("POST /api/workspace/decompose",e=>this.workspace.decomposeQuery(e)),this.endpoints.set("POST /api/workspace/compose",e=>this.workspace.composeQuery(e)),this.endpoints.set("DELETE /api/workspace/clear",()=>this.workspace.clearWorkspace()),this.endpoints.set("GET /api/workspace/private-ctes",()=>this.workspace.getPrivateCtes()),this.endpoints.set("GET /api/workspace/cte/:name",(e,t)=>this.workspace.getSinglePrivateCte(t.name)),this.endpoints.set("PUT /api/workspace/cte/:name",(e,t)=>this.workspace.updatePrivateCte(t.name,e)),this.endpoints.set("GET /api/validate-workspace",()=>this.workspace.validateWorkspace()),this.endpoints.set("POST /api/read-sql-file",e=>this.fileService.readSqlFile(e)),this.endpoints.set("GET /api/workspace/:type/:fileName",(e,t)=>this.workspace.getWorkspaceFile(t.type,t.fileName)),this.endpoints.set("POST /api/debug/write",e=>this.handleDebugWrite(e)),this.endpoints.set("GET /api/logs",()=>this.getLogs()),this.endpoints.set("GET /api/ui-template",()=>this.getUITemplate()),this.endpoints.set("POST /api/toast",e=>this.handleToast(e))}setupFetchInterceptor(){const e=window.fetch,t=this;window.fetch=async function(r,s={}){return"string"==typeof r&&r.startsWith("/api/")?t.handleApiRequest(r,s):e.call(this,r,s)}}async handleApiRequest(e,t){const r=t.method||"GET",s=e.replace(/^\/api/,"/api"),a=new URL(e,window.location.origin),o=this.extractParams(s,a),n=`${r} ${this.normalizeEndpoint(s)}`,i=this.endpoints.get(n);if(!i)return console.warn(`[BrowserApiAdapter] No handler for: ${n}`),new Response(JSON.stringify({error:"Not found"}),{status:404,headers:{"Content-Type":"application/json"}});try{let e=null;t.body&&(e=JSON.parse(t.body));const r=await i(e,o);return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}catch(e){return console.error(`[BrowserApiAdapter] Error handling ${n}:`,e),new Response(JSON.stringify({error:e.message||"Internal error",success:!1}),{status:500,headers:{"Content-Type":"application/json"}})}}normalizeEndpoint(e){return e.replace(/\/cte\/[^\/]+/,"/cte/:name").replace(/\/workspace\/[^\/]+\/[^\/]+/,"/workspace/:type/:fileName")}extractParams(e,t){const r={},s=e.split("/");if(e.includes("/cte/")){const e=s.indexOf("cte");-1!==e&&s[e+1]&&(r.name=decodeURIComponent(s[e+1]))}return e.includes("/workspace/")&&s.length>3&&(r.type=s[s.length-2],r.fileName=decodeURIComponent(s[s.length-1])),t.searchParams.forEach((e,t)=>{r[t]=e}),r}async handleDebugWrite(e){const{filename:t,content:r}=e;return console.log(`[Debug] ${t}:`,r),{success:!0,message:"Debug message logged to console"}}async getLogs(){return{success:!0,logs:{general:["See browser console for logs"],error:[],intellisense:[],query:[]}}}async getUITemplate(){return(await fetch("/static/ui-template.html")).text()}async handleToast(e){const{message:t,type:r="info",title:s="",duration:a=4e3}=e;if(!t)return{success:!1,error:"Message is required"};try{let e=0;for(;"function"!=typeof window.showToast&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;return"function"==typeof window.showToast?{success:!0,toastId:window.showToast(t,r,s,a),message:"Toast notification shown"}:(console.log(`[TOAST ${r.toUpperCase()}] ${t}`),{success:!0,message:"Toast logged to console (fallback)"})}catch(e){return console.error("[BrowserApiAdapter] Error showing toast:",e),{success:!1,error:e.message||"Failed to show toast"}}}}class u{async loadExistingUI(){try{const e=await fetch("./static/index.html");if(!e.ok)throw new Error(`Failed to fetch static HTML: ${e.status}`);const t=await e.text(),r=(new DOMParser).parseFromString(t,"text/html").body.innerHTML;document.getElementById("app").innerHTML=r,await this.loadExistingStyles(),await this.loadWebComponents(),await this.loadEssentialModules(),console.log("[UILoader] UI loaded successfully")}catch(e){console.error("[UILoader] Failed to load UI:",e),await this.loadStaticUI()}}async loadStaticUI(){document.getElementById("app").innerHTML='\n            \x3c!-- Shadow DOM版 Header --\x3e\n            <header-shadow id="header-shadow" title="zosql Browser" show-logo show-open show-sidebar-toggles></header-shadow>\n            \n            <div class="main-container" style="display: flex; height: calc(100vh - 60px);">\n                \x3c!-- Shadow DOM版 Left Sidebar --\x3e\n                <div class="sidebar" id="left-sidebar" style="width: 280px; min-width: 200px; max-width: 500px; background: #f9fafb; border-right: 1px solid #e5e7eb; padding: 12px; overflow-y: auto; position: relative; flex-shrink: 0;">\n                    <workspace-panel-shadow id="workspace-panel-shadow"></workspace-panel-shadow>\n                    <div class="resize-handle" id="left-resize-handle"></div>\n                </div>\n                \n                \x3c!-- Left-Center Splitter --\x3e\n                <div class="splitter" id="left-center-splitter" style="width: 4px; background: transparent; cursor: col-resize; flex-shrink: 0;"></div>\n                \n                \x3c!-- Shadow DOM版 中央パネル --\x3e\n                <center-panel-shadow id="center-panel-shadow" style="flex: 1; min-width: 0; background: #ffffff; display: flex; flex-direction: column;"></center-panel-shadow>\n                \n                \x3c!-- Center-Right Splitter --\x3e\n                <div class="splitter" id="center-right-splitter" style="width: 4px; background: transparent; cursor: col-resize; flex-shrink: 0;"></div>\n                \n                \x3c!-- Shadow DOM版 Right Panel --\x3e\n                <right-panel-shadow id="right-panel-shadow" title="Context Panel" collapsible resizable style="width: 300px; min-width: 200px; max-width: 500px; flex-shrink: 0;"></right-panel-shadow>\n            </div>\n        ',await this.loadWebComponents()}async loadExistingScripts(){const e=["/static/js/modules/monaco-loader.js","/static/js/modules/sidebar-manager.js","/static/js/components/workspace-panel-shadow.js","/static/js/components/center-panel-shadow.js","/static/js/components/context-panel-shadow.js","/static/js/file-model-system/file-model-manager.js","/static/js/file-model-system/file-model.js"];for(const t of e)await this.loadScript(t)}async loadWebComponents(){try{const e=["./static/js/components/workspace-panel-shadow.js","./static/js/components/right-panel-shadow.js","./static/js/components/header-shadow.js","./static/js/components/center-panel-shadow.js","./static/js/components/monaco-editor-shadow.js"];await Promise.all(e.map(e=>this.loadScript(e))),console.log("[UILoader] Web Components loaded")}catch(e){console.error("[UILoader] Failed to load Web Components:",e)}}async loadExistingStyles(){const e=document.createElement("link");e.rel="stylesheet",e.href="https://cdn.jsdelivr.net/npm/monaco-editor@0.36.1/min/vs/editor/editor.main.css",document.head.appendChild(e),console.log("[UILoader] Additional styles loaded")}async loadEssentialModules(){try{await this.loadScript("./static/js/modules/toast.js");const e=["./static/js/modules/logger.js","./static/js/modules/events.js","./static/js/modules/shortcuts.js"];await Promise.allSettled(e.map(e=>this.loadScript(e))),await this.loadScript("./static/js/modules/sidebar-manager.js"),await this.loadScript("./static/js/modules/splitter-manager.js"),setTimeout(()=>{this.initializeSidebarManager()},500),console.log("[UILoader] Essential modules loaded")}catch(e){console.warn("[UILoader] Some essential modules failed to load:",e)}}initializeSidebarManager(){try{"function"==typeof window.SidebarManager?(window.sidebarManager=new window.SidebarManager,console.log("[UILoader] SidebarManager initialized")):console.warn("[UILoader] SidebarManager class not found in global scope")}catch(e){console.warn("[UILoader] Error initializing SidebarManager:",e)}}loadScript(e){return new Promise((t,r)=>{const s=document.createElement("script");s.type="module",s.src=e,s.onload=t,s.onerror=r,document.body.appendChild(s)})}}async function p(){try{console.log("[zosql] Initializing browser version..."),await n.initialize(),console.log("[zosql] rawsql-ts browser initialized");const e=new d;await e.initialize(),console.log("[zosql] API adapter initialized");const t=new u;await t.loadExistingUI(),console.log("[zosql] UI loaded successfully"),window.zosqlAPI=e,document.addEventListener("header-open-file",h),document.addEventListener("center-panel-file-content-changed",m),console.log("[zosql] Event handlers setup complete"),window.dispatchEvent(new CustomEvent("zosql-ready",{detail:{version:"1.0.0-browser"}})),console.log("[zosql] Browser initialization complete")}catch(e){console.error("[zosql] Initialization error:",e),function(e){document.getElementById("app").innerHTML=`\n        <div style="display: flex; justify-content: center; align-items: center; height: 100vh; padding: 20px;">\n            <div style="max-width: 600px; text-align: center;">\n                <h2 style="color: #ef4444; margin-bottom: 16px;">Initialization Error</h2>\n                <p style="color: #6b7280; margin-bottom: 8px;">Failed to initialize zosql browser version.</p>\n                <pre style="background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: left; overflow-x: auto;">\n${e.stack||e.message||e}\n                </pre>\n                <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">\n                    Reload Page\n                </button>\n            </div>\n        </div>\n    `}(e)}}async function h(e){const{fileName:t,content:r}=e.detail;try{console.log(`[zosql] Opening file: ${t}`);const e=document.getElementById("center-panel-shadow");if(e&&e.createOrReuseTabForFile&&e.createOrReuseTabForFile(t,r,{type:"sql",source:"file-open"}),t.toLowerCase().endsWith(".sql")&&r.trim())try{const e=await fetch("/api/workspace/decompose",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sql:r,queryName:t.replace(/\.sql$/i,""),originalFilePath:t})});if(e.ok){const t=await e.json();console.log("[zosql] SQL decomposed successfully:",t);const r=document.getElementById("workspace-panel-shadow");r&&r.updateCTEDependencies&&r.updateCTEDependencies(t.workspace)}}catch(e){console.warn("[zosql] Failed to decompose SQL:",e)}}catch(e){console.error("[zosql] Error handling file open:",e)}}function m(e){const{fileName:t,content:r}=e.detail;console.log(`[zosql] File content changed: ${t}`)}window.addEventListener("error",e=>{console.error("Global error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p()})();