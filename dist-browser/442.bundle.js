"use strict";(self.webpackChunkzosql=self.webpackChunkzosql||[]).push([[442],{442:(e,t,i)=>{i.r(t),i.d(t,{ArrayExpression:()=>N,ArrayIndexExpression:()=>L,ArrayQueryExpression:()=>I,ArraySliceExpression:()=>F,BetweenExpression:()=>A,BinaryExpression:()=>y,BinarySelectQuery:()=>Mt,CTECollector:()=>ct,CTEComposer:()=>vi,CTEDependencyAnalyzer:()=>mi,CTEDisabler:()=>pt,CTENormalizer:()=>$t,CTENotFoundError:()=>jt,CTEQueryDecomposer:()=>gi,CTERenamer:()=>ki,CaseExpression:()=>b,CaseKeyValuePair:()=>E,CastExpression:()=>k,ColumnReference:()=>l,ColumnReferenceCollector:()=>Ei,CommentEditor:()=>fi,DuplicateCTEError:()=>_t,DuplicateDetectionMode:()=>Ft,DynamicQueryBuilder:()=>ms,Formatter:()=>At,FunctionCall:()=>u,IdentifierString:()=>S,InlineQuery:()=>a,InsertQuery:()=>r,InsertQueryParser:()=>di,InvalidCTENameError:()=>Bt,JsonMappingConverter:()=>qi,JsonSchemaValidator:()=>fs,LexemeCursor:()=>gs,LiteralValue:()=>C,ParameterExpression:()=>v,ParenExpression:()=>T,PostgresJsonQueryBuilder:()=>Ii,QualifiedName:()=>j,QueryBuilder:()=>Vt,QueryFlowDiagramGenerator:()=>ls,RawString:()=>x,SchemaCollector:()=>yi,SchemaManager:()=>ws,SelectQueryParser:()=>pi,SelectValueCollector:()=>gt,SelectableColumnCollector:()=>Lt,SimpleSelectQuery:()=>Dt,SqlFormatter:()=>It,SqlPaginationInjector:()=>cs,SqlParamInjector:()=>us,SqlSchemaValidator:()=>Ci,SqlSortInjector:()=>hs,StringSpecifierExpression:()=>O,SwitchCaseArgument:()=>g,TableSchema:()=>wi,TableSourceCollector:()=>dt,TokenType:()=>ve,TupleExpression:()=>$,TypeTransformationPostProcessor:()=>Ji,TypeTransformers:()=>zi,TypeValue:()=>P,UnaryExpression:()=>w,UpstreamSelectQueryFinder:()=>qt,VALID_PRESETS:()=>Nt,ValueList:()=>o,ValuesQuery:()=>Kt,WindowFrameBound:()=>c,WindowFrameBoundStatic:()=>p,WindowFrameBoundaryValue:()=>d,WindowFrameExpression:()=>f,WindowFrameSpec:()=>m,WindowFrameType:()=>h,WithClauseParser:()=>oi,convertColumnsToLegacy:()=>Pi,convertModelDrivenMapping:()=>Ai,convertToLegacyJsonMapping:()=>$i,createJsonMappingFromSchema:()=>vs,createSchemaManager:()=>ys,createTableColumnResolver:()=>Cs,extractTypeProtection:()=>Li,isLegacyFormat:()=>Ki,isModelDrivenFormat:()=>Di,isUnifiedFormat:()=>Mi,processJsonMapping:()=>Vi,toLegacyMapping:()=>Fi,transformDatabaseResult:()=>Hi,unifyJsonMapping:()=>Wi,validateModelDrivenMapping:()=>Oi});var s,n=class{constructor(){this.comments=null}getKind(){return this.constructor.kind}accept(e){return e.visit(this)}toSqlString(e){return this.accept(e)}},r=class extends n{static{this.kind=Symbol("InsertQuery")}constructor(e){super(),this.insertClause=e.insertClause,this.selectQuery=e.selectQuery??null}},a=class extends n{static{this.kind=Symbol("InlineQuery")}constructor(e){super(),this.selectQuery=e}},o=class extends n{static{this.kind=Symbol("ValueList")}constructor(e){super(),this.values=e}},l=class extends n{get namespaces(){return this.qualifiedName.namespaces}get column(){return this.qualifiedName.name instanceof S?this.qualifiedName.name:new S(this.qualifiedName.name.value)}static{this.kind=Symbol("ColumnReference")}constructor(e,t){super();let i="string"==typeof t?new S(t):t;this.qualifiedName=new j(R(e),i)}toString(){return this.qualifiedName.toString()}getNamespace(){return this.qualifiedName.namespaces?this.qualifiedName.namespaces.map(e=>e.name).join("."):""}},u=class extends n{static{this.kind=Symbol("FunctionCall")}constructor(e,t,i,s,n=null){super(),this.qualifiedName=new j(e,t),this.argument=i,this.over=s,this.withinGroup=n}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}},h=((s=h||{}).Rows="rows",s.Range="range",s.Groups="groups",s),c=(e=>(e.UnboundedPreceding="unbounded preceding",e.UnboundedFollowing="unbounded following",e.CurrentRow="current row",e))(c||{}),p=class extends n{static{this.kind=Symbol("WindowFrameStaticBound")}constructor(e){super(),this.bound=e}},d=class extends n{static{this.kind=Symbol("WindowFrameBoundary")}constructor(e,t){super(),this.value=e,this.isFollowing=t}},m=class extends n{static{this.kind=Symbol("WindowFrameSpec")}constructor(e,t,i){super(),this.frameType=e,this.startBound=t,this.endBound=i}},f=class extends n{static{this.kind=Symbol("WindowFrameExpression")}constructor(e,t,i=null){super(),this.partition=e,this.order=t,this.frameSpec=i}},w=class extends n{static{this.kind=Symbol("UnaryExpression")}constructor(e,t){super(),this.operator=new x(e),this.expression=t}},y=class extends n{static{this.kind=Symbol("BinaryExpression")}constructor(e,t,i){super(),this.left=e,this.operator=new x(t),this.right=i}},C=class extends n{static{this.kind=Symbol("LiteralExpression")}constructor(e,t){super(),this.value=e,this.isDollarString=t}},v=class extends n{static{this.kind=Symbol("ParameterExpression")}constructor(e,t=null){super(),this.name=new x(e),this.value=t,this.index=null}},g=class extends n{static{this.kind=Symbol("SwitchCaseArgument")}constructor(e,t=null){super(),this.cases=e,this.elseValue=t}},E=class extends n{static{this.kind=Symbol("CaseKeyValuePair")}constructor(e,t){super(),this.key=e,this.value=t}},x=class extends n{static{this.kind=Symbol("RawString")}constructor(e){super(),this.value=e}},S=class extends n{static{this.kind=Symbol("IdentifierString")}constructor(e){super(),this.name=e}},T=class extends n{static{this.kind=Symbol("ParenExpression")}constructor(e){super(),this.expression=e}},k=class extends n{static{this.kind=Symbol("CastExpression")}constructor(e,t){super(),this.input=e,this.castType=t}},b=class extends n{static{this.kind=Symbol("CaseExpression")}constructor(e,t){super(),this.condition=e,this.switchCase=t}},N=class extends n{static{this.kind=Symbol("ArrayExpression")}constructor(e){super(),this.expression=e}},I=class extends n{static{this.kind=Symbol("ArrayQueryExpression")}constructor(e){super(),this.query=e}},A=class extends n{static{this.kind=Symbol("BetweenExpression")}constructor(e,t,i,s){super(),this.expression=e,this.lower=t,this.upper=i,this.negated=s}},O=class extends n{static{this.kind=Symbol("StringSpecifierExpression")}constructor(e,t){super(),this.specifier=new x(e),this.value=new C(t)}},P=class extends n{static{this.kind=Symbol("TypeValue")}constructor(e,t,i=null){super(),this.qualifiedName=new j(e,t),this.argument=i}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}getTypeName(){let e=this.qualifiedName.name instanceof x?this.qualifiedName.name.value:this.qualifiedName.name.name;return this.qualifiedName.namespaces&&this.qualifiedName.namespaces.length>0?this.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+e:e}},$=class extends n{static{this.kind=Symbol("TupleExpression")}constructor(e){super(),this.values=e}},F=class extends n{static{this.kind=Symbol("ArraySliceExpression")}constructor(e,t,i){super(),this.array=e,this.startIndex=t,this.endIndex=i}},L=class extends n{static{this.kind=Symbol("ArrayIndexExpression")}constructor(e,t){super(),this.array=e,this.index=t}};function R(e){if(null==e)return null;if("string"==typeof e)return""===e.trim()?null:[new S(e)];if(Array.isArray(e)){if(0===e.length)return null;if("string"==typeof e[0]){let t=e.filter(e=>""!==e.trim());return 0===t.length?null:t.map(e=>new S(e))}{let t=e.filter(e=>""!==e.name.trim());return 0===t.length?null:t}}return null}var _,B,j=class extends n{static{this.kind=Symbol("QualifiedName")}constructor(e,t){super(),this.namespaces=R(e),this.name="string"==typeof t?new x(t):t}toString(){let e=this.name instanceof x?this.name.value:this.name.name;return this.namespaces&&this.namespaces.length>0?this.namespaces.map(e=>e.name).join(".")+"."+e:e}},q=class extends n{static{this.kind=Symbol("SelectItem")}constructor(e,t=null){super(),this.value=e,this.identifier=t?new S(t):null}},Q=class extends n{static{this.kind=Symbol("SelectClause")}constructor(e,t=null,i=[]){super(),this.items=e,this.distinct=t,this.hints=i}},U=class extends n{static{this.kind=Symbol("Distinct")}constructor(){super()}},V=class extends n{static{this.kind=Symbol("DistinctOn")}constructor(e){super(),this.value=e}},W=class extends n{static{this.kind=Symbol("WhereClause")}constructor(e){super(),this.condition=e}},D=class extends n{static{this.kind=Symbol("PartitionByClause")}constructor(e){super(),this.value=e}},M=class extends n{static{this.kind=Symbol("WindowFrameClause")}constructor(e,t){super(),this.name=new S(e),this.expression=t}},K=class extends n{static{this.kind=Symbol("WindowsClause")}constructor(e){super(),this.windows=e}},J=class extends n{static{this.kind=Symbol("OrderByClause")}constructor(e){super(),this.order=e}},H=class extends n{static{this.kind=Symbol("OrderByItem")}constructor(e,t,i){super(),this.value=e,this.sortDirection=null===t?"asc":t,this.nullsPosition=i}},z=class extends n{static{this.kind=Symbol("GroupByClause")}constructor(e){super(),this.grouping=e}},G=class extends n{static{this.kind=Symbol("HavingClause")}constructor(e){super(),this.condition=e}},Y=class extends n{static{this.kind=Symbol("TableSource")}get namespaces(){return this.qualifiedName.namespaces}get table(){return this.qualifiedName.name instanceof S?this.qualifiedName.name:new S(this.qualifiedName.name.value)}get identifier(){return this.table}constructor(e,t){super();let i="string"==typeof t?new S(t):t;this.qualifiedName=new j(e,i)}getSourceName(){return this.qualifiedName.namespaces&&this.qualifiedName.namespaces.length>0?this.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+(this.qualifiedName.name instanceof x?this.qualifiedName.name.value:this.qualifiedName.name.name):this.qualifiedName.name instanceof x?this.qualifiedName.name.value:this.qualifiedName.name.name}},X=class extends n{static{this.kind=Symbol("FunctionSource")}constructor(e,t){if(super(),"object"==typeof e&&null!==e&&"name"in e){let t=e;this.qualifiedName=new j(t.namespaces,t.name)}else this.qualifiedName=new j(null,e);this.argument=t}get namespaces(){return this.qualifiedName.namespaces}get name(){return this.qualifiedName.name}},Z=class extends n{static{this.kind=Symbol("ParenSource")}constructor(e){super(),this.source=e}},ee=class extends n{static{this.kind=Symbol("SubQuerySource")}constructor(e){super(),this.query=e}},te=class extends n{static{this.kind=Symbol("SourceExpression")}constructor(e,t){super(),this.datasource=e,this.aliasExpression=t}getAliasName(){return this.aliasExpression?this.aliasExpression.table.name:this.datasource instanceof Y?this.datasource.getSourceName():null}},ie=class extends n{static{this.kind=Symbol("JoinOnClause")}constructor(e){super(),this.condition=e}},se=class extends n{static{this.kind=Symbol("JoinUsingClause")}constructor(e){super(),this.condition=e}},ne=class extends n{static{this.kind=Symbol("JoinItem")}constructor(e,t,i,s){super(),this.joinType=new x(e),this.source=t,this.condition=i,this.lateral=s}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source instanceof Y?this.source.table.name:null}},re=class extends n{static{this.kind=Symbol("FromClause")}constructor(e,t){super(),this.source=e,this.joins=t}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source.datasource instanceof Y?this.source.datasource.table.name:null}getSources(){let e=[this.source];if(this.joins)for(let t of this.joins)e.push(t.source);return e}},ae=class extends n{static{this.kind=Symbol("CommonTable")}constructor(e,t,i){super(),this.query=e,this.materialized=i,this.aliasExpression="string"==typeof t?new de(t,null):t}getSourceAliasName(){return this.aliasExpression.table.name}},oe=class extends n{static{this.kind=Symbol("WithClause")}constructor(e,t){super(),this.recursive=e,this.tables=t}},le=class extends n{static{this.kind=Symbol("LimitClause")}constructor(e){super(),this.value=e}},ue=class extends n{static{this.kind=Symbol("OffsetClause")}constructor(e){super(),this.value=e}},he=class extends n{static{this.kind=Symbol("FetchClause")}constructor(e){super(),this.expression=e}},ce=class extends n{static{this.kind=Symbol("FetchExpression")}constructor(e,t,i){super(),this.type=e,this.count=t,this.unit=i}},pe=class extends n{static{this.kind=Symbol("ForClause")}constructor(e){super(),this.lockMode=e}},de=class extends n{static{this.kind=Symbol("SourceAliasExpression")}constructor(e,t){super(),this.table=new S(e),this.columns=null!==t?t.map(e=>new S(e)):null}},me=class extends n{static{this.kind=Symbol("ReturningClause")}constructor(e){super(),this.columns=e.map(e=>"string"==typeof e?new S(e):e)}},fe=class extends n{static{this.kind=Symbol("SetClause")}constructor(e){super(),this.items=e.map(e=>e instanceof we?e:new we(e.column,e.value))}},we=class extends n{static{this.kind=Symbol("SetClauseItem")}constructor(e,t){if(super(),"object"==typeof e&&null!==e&&"column"in e){let t=e,i="string"==typeof t.column?new S(t.column):t.column;this.qualifiedName=new j(t.namespaces,i)}else{let t="string"==typeof e?new S(e):e;this.qualifiedName=new j(null,t)}this.value=t}get namespaces(){return this.qualifiedName.namespaces}get column(){return this.qualifiedName.name instanceof S?this.qualifiedName.name:new S(this.qualifiedName.name.value)}getFullName(){return this.qualifiedName.toString()}},ye=class extends n{static{this.kind=Symbol("UpdateClause")}constructor(e){super(),this.source=e}getSourceAliasName(){return this.source.aliasExpression?this.source.aliasExpression.table.name:this.source.datasource instanceof Y?this.source.datasource.table.name:null}},Ce=class extends n{constructor(e,t){super(),this.source=e,this.columns=t.map(e=>new S(e))}},ve=((_=ve||{})[_.None=0]="None",_[_.Literal=1]="Literal",_[_.Operator=2]="Operator",_[_.OpenParen=4]="OpenParen",_[_.CloseParen=8]="CloseParen",_[_.Comma=16]="Comma",_[_.Dot=32]="Dot",_[_.Identifier=64]="Identifier",_[_.Command=128]="Command",_[_.Parameter=256]="Parameter",_[_.OpenBracket=512]="OpenBracket",_[_.CloseBracket=1024]="CloseBracket",_[_.Function=2048]="Function",_[_.StringSpecifier=4096]="StringSpecifier",_[_.Type=8192]="Type",_),ge=class{static isWhitespace(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 32===t||9===t||10===t||13===t}static isDigit(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57}static isHexChar(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=97&&t<=102||t>=65&&t<=70}static isOperatorSymbol(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 43===t||45===t||42===t||47===t||37===t||126===t||64===t||35===t||94===t||38===t||58===t||33===t||60===t||62===t||61===t||124===t||63===t}static isDelimiter(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 46===t||44===t||40===t||41===t||91===t||93===t||123===t||125===t||59===t||32===t||9===t||10===t||13===t||43===t||45===t||42===t||47===t||37===t||126===t||64===t||35===t||94===t||38===t||58===t||33===t||60===t||62===t||61===t||124===t||63===t}static isNamedParameterPrefix(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return 64===t||58===t||36===t}},Ee=class e{static getDebugPositionInfo(e,t){let i=Math.max(0,t-5),s=Math.min(e.length,t+5);return`${e.slice(i,s)}\n${" ".repeat(t-i)+"^"}`}static skipWhiteSpace(e,t){let i=e.length;for(;t+4<=i&&"    "===e.slice(t,t+4);)t+=4;for(;t<i;){let i=e.charCodeAt(t);if(32!==i&&9!==i&&10!==i&&13!==i)break;t++}return t}static readLineComment(e,t){if(t+1>=e.length)return{newPosition:t,comment:null};if(45===e.charCodeAt(t)&&45===e.charCodeAt(t+1)){let i=t;for(t+=2;t<e.length&&10!==e.charCodeAt(t);)t++;return{newPosition:t,comment:e.slice(i+2,t).trim()}}return{newPosition:t,comment:null}}static readBlockComment(e,t){if(t+3>=e.length)return{newPosition:t,comments:null};if(47===e.charCodeAt(t)&&42===e.charCodeAt(t+1)&&43!==e.charCodeAt(t+2)){let i=t;for(t+=2;t+1<e.length;){if(42===e.charCodeAt(t)&&47===e.charCodeAt(t+1)){t+=2;let s=e.slice(i+2,t-2).replace(/\r/g,"").split("\n");for(let e=0;e<s.length;e++)s[e]=s[e].trim();for(;s.length>0&&""===s[0];)s.shift();for(;s.length>0&&""===s[s.length-1];)s.pop();return{newPosition:t,comments:s}}t++}throw new Error(`Block comment is not closed. position: ${t}`)}return{newPosition:t,comments:null}}static readWhiteSpaceAndComment(t,i){let s=[],n=t.length;for(;i<n;){let n=i;if((i=e.skipWhiteSpace(t,i))!==n)continue;let r=t.charCodeAt(i);if(45===r){let n=e.readLineComment(t,i);if(n.newPosition!==i){i=n.newPosition,n.comment&&s.push(n.comment.trim());continue}}else if(47===r){let n=e.readBlockComment(t,i);if(n.newPosition!==i){i=n.newPosition,n.comments&&s.push(...n.comments);continue}}break}return{position:i,lines:s}}static readRegularIdentifier(t,i){let s=this.tryReadRegularIdentifier(t,i);if(!s)throw new Error(`Unexpected character. position: ${i}\n${e.getDebugPositionInfo(t,i)}`);return s}static tryReadRegularIdentifier(e,t){let i=t;for(;t<e.length&&!ge.isDelimiter(e[t]);)t++;if(i===t)return null;for(;t+1<e.length&&"["===e[t]&&"]"===e[t+1];){let s=e.slice(0,i).trim();if(""===s||/[)]$/.test(s)||/\b(select|from|where|and|or|set|values|insert|update|delete)\s*$/i.test(s))break;t+=2}return{identifier:e.slice(i,t),newPosition:t}}},xe=class{constructor(e,t=0){this.input=e,this.position=t}getPosition(){return this.position}setPosition(e){this.position=e}isEndOfInput(e=0){return this.position+e>=this.input.length}canRead(e=0){return!this.isEndOfInput(e)}read(e){if(this.isEndOfInput())throw new Error(`Unexpected character. expect: ${e}, actual: EndOfInput, position: ${this.position}`);let t=this.input[this.position];if(t!==e)throw new Error(`Unexpected character. expect: ${e}, actual: ${t}, position: ${this.position}`);return this.position++,t}createLexeme(e,t,i=null,s,n){let r={type:e,value:128===e||2===e||2048===e?t.toLowerCase():t,comments:i};return void 0!==s&&void 0!==n&&(r.position={startPosition:s,endPosition:n}),r}createLexemeWithPosition(e,t,i,s=null){return this.createLexeme(e,t,s,i,i+t.length)}getDebugPositionInfo(e){return Ee.getDebugPositionInfo(this.input,e)}},Se=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if("*"===t)return this.position++,this.createLexeme(64,t);let i=Ee.readRegularIdentifier(this.input,this.position);return this.position=i.newPosition,this.createLexeme(64,i.identifier)}},Te=class{constructor(e){this.trie=e}isEndOfInput(e,t,i=0){return t+i>=e.length}canParse(e,t,i=0){return!this.isEndOfInput(e,t,i)}parse(e,t){if(this.isEndOfInput(e,t))return null;this.trie.reset();let i=Ee.tryReadRegularIdentifier(e,t);if(null===i)return null;let s=this.trie.pushLexeme(i.identifier.toLowerCase());if(0===s)return null;if(3===s)return{keyword:i.identifier,newPosition:i.newPosition};let n=i.identifier;if(t=Ee.readWhiteSpaceAndComment(e,i.newPosition).position,this.isEndOfInput(e,t))return 2===s?{keyword:n,newPosition:t}:null;for(;this.canParse(e,t);){let i=s,r=Ee.tryReadRegularIdentifier(e,t);if(null===r){if(2===i)break;return null}if(s=this.trie.pushLexeme(r.identifier.toLowerCase()),0===s){if(2===i)break;return null}if(n+=" "+r.identifier,t=Ee.readWhiteSpaceAndComment(e,r.newPosition).position,3===s)break}return{keyword:n,newPosition:t}}},ke=class{constructor(e){this.root=new Map,this.hasEndProperty=!1,this.hasMoreProperties=!1;for(let t of e)this.addKeyword(t);this.currentNode=this.root}addKeyword(e){let t=this.root;for(let i of e)t.has(i)||t.set(i,new Map),t=t.get(i);t.set("__end__",!0)}reset(){this.currentNode=this.root,this.hasEndProperty=!1,this.hasMoreProperties=!1}pushLexeme(e){return this.currentNode.has(e)?(this.currentNode=this.currentNode.get(e),this.hasEndProperty=this.currentNode.has("__end__"),this.hasMoreProperties=this.currentNode.size>(this.hasEndProperty?1:0),this.hasEndProperty&&!this.hasMoreProperties?3:this.hasEndProperty&&this.hasMoreProperties?2:1):0}},be=new Te(new ke([["null"],["true"],["false"],["current_date"],["current_time"],["current_timestamp"],["localtime"],["localtimestamp"],["unbounded"],["normalized"],["nfc","normalized"],["nfd","normalized"],["nfkc","normalized"],["nfkd","normalized"],["nfc"],["nfd"],["nfkc"],["nfkd"]])),Ne=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position],i=this.tryReadKeyword();if(i)return i;if("."===t&&this.canRead(1)&&ge.isDigit(this.input[this.position+1]))return this.createLexeme(1,this.readDigit());if("'"===t){let e=this.readSingleQuotedString(!1);return this.createLexeme(1,e)}if(ge.isDigit(t))return this.createLexeme(1,this.readDigit());if("$"===t&&this.isDollarQuotedString())return this.createLexeme(1,this.readDollarQuotedString());if("$"===t&&this.canRead(1)&&ge.isDigit(this.input[this.position+1])){let e=this.position+1,t=!1;for(;e<this.input.length&&(ge.isDigit(this.input[e])||","===this.input[e]||"."===this.input[e]);){if("."===this.input[e]||","===this.input[e]){t=!0;break}e++}if(t){this.position,this.position++;let e=this.readMoneyDigit();return this.createLexeme(1,"$"+e)}}if(("+"===t||"-"===t)&&"sign"===this.determineSignOrOperator(e)){let e=t;this.position++;let i=this.position;for(;this.canRead()&&ge.isWhitespace(this.input[this.position]);)this.position++;if(this.canRead()&&(ge.isDigit(this.input[this.position])||"."===this.input[this.position]&&this.canRead(1)&&ge.isDigit(this.input[this.position+1])))return this.createLexeme(1,"-"===e?e+this.readDigit():this.readDigit());this.position=i-1}return null}tryReadKeyword(){let e=be.parse(this.input,this.position);return e?(this.position=e.newPosition,this.createLexeme(1,e.keyword)):null}determineSignOrOperator(e){return null===e?"sign":1&e.type||64&e.type||256&e.type||8&e.type?"operator":"sign"}readDigit(){let e=this.position,t=!1,i=!1;if(this.canRead(1)&&"0"===this.input[this.position]&&"xbo".includes(this.input[this.position+1].toLowerCase())){let t=this.input[this.position+1].toLowerCase();this.position+=2;let i="x"===t;for(;this.canRead();){let e=this.input[this.position];if(!(ge.isDigit(e)||i&&ge.isHexChar(e)))break;this.position++}return this.input.slice(e,this.position)}for("."===this.input[e]&&(t=!0,this.position++);this.canRead();){let e=this.input[this.position];if("."!==e||t)if("e"!==e&&"E"!==e||i){if(!ge.isDigit(e))break}else i=!0,this.canRead(1)&&("+"===this.input[this.position+1]||"-"===this.input[this.position+1])&&this.position++;else t=!0;this.position++}if(e===this.position)throw new Error(`Unexpected character. position: ${e}\n${this.getDebugPositionInfo(e)}`);return"."===this.input[e]?"0"+this.input.slice(e,this.position):this.input.slice(e,this.position)}readMoneyDigit(){let e=this.position,t=!1;for(;this.canRead();){let e=this.input[this.position];if("."!==e||t){if((","!==e||t)&&!ge.isDigit(e))break}else t=!0;this.position++}if(e===this.position)throw new Error(`Unexpected character. position: ${e}\n${this.getDebugPositionInfo(e)}`);return this.input.slice(e,this.position)}readSingleQuotedString(e){let t=this.position,i=!1;for(this.read("'");this.canRead();){let e=this.input[this.position];if(this.position++,"\\"===e&&this.canRead(1))this.position++;else if("'"===e){i=!0;break}}if(!1===i)throw new Error(`Single quote is not closed. position: ${t}\n${this.getDebugPositionInfo(t)}`);return e?this.input.slice(t,this.position):this.input.slice(t+1,this.position-1)}isDollarQuotedString(){if(!this.canRead(1))return!1;if("$"===this.input[this.position+1])return!0;let e=this.position+1;for(;e<this.input.length;){let t=this.input[e];if("$"===t)return!0;if(!this.isAlphanumeric(t)&&"_"!==t)return!1;e++}return!1}readDollarQuotedString(){let e=this.position;this.position++;let t="";for(;this.canRead()&&"$"!==this.input[this.position];)t+=this.input[this.position],this.position++;if(!this.canRead())throw new Error(`Unexpected end of input while reading dollar-quoted string tag at position ${e}`);this.position++;let i="$"+t+"$",s=i,n="";for(;this.canRead();){if(this.input.substring(this.position,this.position+s.length)===s)return this.position+=s.length,i+n+s;n+=this.input[this.position],this.position++}throw new Error(`Unclosed dollar-quoted string starting at position ${e}. Expected closing tag: ${s}`)}isAlphanumeric(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122}},Ie=class extends xe{constructor(e){super(e)}tryRead(e){if(this.isEndOfInput())return null;if(this.canRead(1)&&"$"===this.input[this.position]&&"{"===this.input[this.position+1]){this.position+=2;let e=this.position;for(;this.canRead()&&"}"!==this.input[this.position];)this.position++;if(this.isEndOfInput())throw new Error(`Unexpected end of input. Expected closing '}' for parameter at position ${e}`);let t=this.input.slice(e,this.position);if(0===t.length)throw new Error("Empty parameter name is not allowed: found ${} at position "+(e-2));return this.position++,this.createLexeme(256,"${"+t+"}")}let t=this.input[this.position];if(ge.isNamedParameterPrefix(t)){if(this.canRead(1)&&ge.isOperatorSymbol(this.input[this.position+1])||":"===t&&this.isInArraySliceContext()||"$"===t&&this.isDollarQuotedString())return null;if("$"===t&&this.canRead(1)&&ge.isDigit(this.input[this.position+1])){let e=this.position+1,t=!1;for(;e<this.input.length&&(ge.isDigit(this.input[e])||","===this.input[e]||"."===this.input[e]);){if("."===this.input[e]||","===this.input[e]){t=!0;break}e++}if(t)return null}this.position++;let e=this.position;for(;this.canRead()&&!ge.isDelimiter(this.input[this.position]);)this.position++;let i=this.input.slice(e,this.position);return this.createLexeme(256,t+i)}if("?"===t){if(this.canRead(1)){let e=this.input[this.position+1];if("|"===e||"&"===e)return null}return e&&(64&e.type||1&e.type)?null:(this.position++,this.createLexeme(256,t))}return null}isInArraySliceContext(){let e=this.position-1,t=0;for(;e>=0;){let i=this.input[e];if("]"===i)t++;else if("["===i&&(t--,t<0)){if(e>0){let t=this.input[e-1];if(/[a-zA-Z0-9_)\]]/.test(t))return!0}if(0===e)return!1;break}e--}return!1}isDollarQuotedString(){if(!this.canRead(1))return!1;if("$"===this.input[this.position+1])return!0;let e=this.position+1;for(;e<this.input.length;){let t=this.input[e];if("$"===t)return!0;if(!this.isAlphanumeric(t)&&"_"!==t)return!1;e++}return!1}isAlphanumeric(e){if(1!==e.length)return!1;let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122}},Ae=class e extends xe{static{this.SPECIAL_SYMBOL_TOKENS={".":32,",":16,"(":4,")":8,"[":512,"]":1024}}tryRead(t){if(this.isEndOfInput())return null;let i=this.input[this.position];return i in e.SPECIAL_SYMBOL_TOKENS?(this.position++,this.createLexeme(e.SPECIAL_SYMBOL_TOKENS[i],i)):null}},Oe=class{constructor(e,t=0){this.cacheHits=0,this.cacheMisses=0,this.input=e,this.position=t,this.readers=[],this.tokenCache=new Map}register(e){return this.readers.push(e),this}registerAll(e){return e.forEach(e=>this.register(e)),this}setPosition(e){this.position=e;for(let t of this.readers)t.setPosition(e)}tryRead(e,t){if(this.tokenCache.has(e))return this.cacheHits++,this.tokenCache.get(e)||null;this.cacheMisses++,this.setPosition(e);let i=null;for(let e of this.readers)if(i=e.tryRead(t),i){this.position=e.getPosition();break}for(let e of this.readers)e.setPosition(this.position);return this.tokenCache.set(e,i),i}getMaxPosition(){let e=this.position;for(let t of this.readers){let i=t.getPosition();i>e&&(e=i)}return e}getInput(){return this.input}getCacheStats(){let e=this.cacheHits+this.cacheMisses,t=e>0?this.cacheHits/e:0;return{hits:this.cacheHits,misses:this.cacheMisses,ratio:t}}},Pe=new ke([["and"],["or"],["is"],["is","not"],["is","distinct","from"],["is","not","distinct","from"],["like"],["ilike"],["in"],["exists"],["between"],["not","like"],["not","ilike"],["not","in"],["not","exists"],["not","between"],["escape"],["uescape"],["similar","to"],["not","similar","to"],["similar"],["placing"],["rlike"],["regexp"],["mod"],["xor"],["not"],["both"],["leading"],["trailing"],["both","from"],["leading","from"],["trailing","from"],["year","from"],["month","from"],["day","from"],["hour","from"],["minute","from"],["second","from"],["dow","from"],["doy","from"],["isodow","from"],["quarter","from"],["week","from"],["epoch","from"],["at","time","zone"]]),$e=new ke([["date"],["time"],["timestamp"],["timestamptz"],["timetz"],["interval"],["boolean"],["integer"],["bigint"],["smallint"],["numeric"],["decimal"],["real"],["double","precision"],["double","precision"],["character","varying"],["time","without","time","zone"],["time","with","time","zone"],["timestamp","without","time","zone"],["timestamp","with","time","zone"]]),Fe=new Te(Pe),Le=new Te($e),Re=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if(ge.isOperatorSymbol(t)){let e=this.position;for(;this.canRead()&&ge.isOperatorSymbol(this.input[this.position]);){if(this.canRead(1)){let e=this.input[this.position];if("-"===e&&"-"===this.input[this.position+1])break;if("/"===e&&"*"===this.input[this.position+1])break}this.position++}let t=this.input.slice(e,this.position);return this.createLexeme(2,t)}let i=Le.parse(this.input,this.position);return null!==i?(this.position=i.newPosition,this.createLexeme(8258,i.keyword)):(i=Fe.parse(this.input,this.position),null!==i?(this.position=i.newPosition,this.createLexeme(2,i.keyword)):null)}},_e=new ke([["join"],["inner","join"],["cross","join"],["left","join"],["left","outer","join"],["right","join"],["right","outer","join"],["full","join"],["full","outer","join"],["natural","join"],["natural","inner","join"],["natural","left","join"],["natural","left","outer","join"],["natural","right","join"],["natural","right","outer","join"],["natural","full","join"],["natural","full","outer","join"]]),Be=new Te(new ke([["with"],["recursive"],["materialized"],["not","materialized"],["select"],["from"],["distinct"],["distinct","on"],["where"],["group","by"],["having"],["order","by"],["limit"],["offset"],["fetch"],["first"],["next"],["row"],["row","only"],["rows","only"],["percent"],["percent","with","ties"],["for"],["update"],["share"],["key","share"],["no","key","update"],["union"],["union","all"],["intersect"],["intersect","all"],["except"],["except","all"],["beteen"],["window"],["over"],["partition","by"],["range"],["rows"],["groups"],["within","group"],["current","row"],["unbounded","preceding"],["unbounded","following"],["preceding"],["following"],["on"],["using"],["lateral"],["case"],["case","when"],["when"],["then"],["else"],["end"],["insert","into"],["update"],["delete","from"],["merge","into"],["matched"],["not","matched"],["update","set"],["do","nothing"],["values"],["set"],["returning"],["create","table"],["create","temporary","table"],["tablesample"],["as"],["asc"],["desc"],["nulls","first"],["nulls","last"]])),je=new Te(_e),qe=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=je.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(128,t.keyword);let i=Be.parse(this.input,this.position);if(null!==i)return this.position=i.newPosition,this.createLexeme(128,i.keyword);if(this.canRead(2)&&"/"===this.input[this.position]&&"*"===this.input[this.position+1]&&"+"===this.input[this.position+2]){this.position+=3;let e=this.position;for(;this.position+1<this.input.length;){if("*"===this.input[this.position]&&"/"===this.input[this.position+1])return this.position+=2,this.createLexeme(128,"/*+ "+this.input.slice(e,this.position-2).trim()+" */");this.position++}throw new Error(`Block comment is not closed. position: ${this.position}`)}return null}},Qe=new Set(["e'","E'","x'","X'","b'","B'"]),Ue=new Set(["u&'","U&'"]),Ve=class extends xe{tryRead(e){let t=this.position;return this.canRead(1)&&Qe.has(this.input.slice(t,t+2))?(this.position+=1,this.createLexeme(4096,this.input.slice(t,this.position))):this.canRead(2)&&Ue.has(this.input.slice(t,t+3))?(this.position+=2,this.createLexeme(4096,this.input.slice(t,this.position))):null}},We=new Te(new ke([["grouping","sets"],["array"]])),De=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=We.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(2048,t.keyword);let i=Ee.tryReadRegularIdentifier(this.input,this.position);if(!i)return null;this.position=i.newPosition;var s=Ee.readWhiteSpaceAndComment(this.input,this.position).position-this.position;return this.canRead(s)&&"("===this.input[this.position+s]?this.createLexeme(2048,i.identifier):null}},Me=new Te(new ke([["double","precision"],["character","varying"],["time","without","time","zone"],["time","with","time","zone"],["timestamp","without","time","zone"],["timestamp","with","time","zone"]])),Ke=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=Me.parse(this.input,this.position);if(null!==t)return this.position=t.newPosition,this.createLexeme(8192,t.keyword);if(null===e)return null;let i=Ee.tryReadRegularIdentifier(this.input,this.position);return i?(this.position=i.newPosition,128&e.type&&"as"===e.value?this.createLexeme(8256,i.identifier):2&e.type&&"::"===e.value?this.createLexeme(8192,i.identifier):null):null}},Je=class extends xe{tryRead(e){if(this.isEndOfInput())return null;let t=this.input[this.position];if("`"===t){let e=this.readEscapedIdentifier("`");return this.createLexeme(64,e)}if('"'===t){let e=this.readEscapedIdentifier('"');return this.createLexeme(64,e)}if("["===t&&this.isSqlServerBracketIdentifier(e)){let e=this.readEscapedIdentifier("]");return this.createLexeme(64,e)}return null}isSqlServerBracketIdentifier(e){if("array"===e?.value)return!1;let t=this.position+1,i=t;for(;i<this.input.length&&"]"!==this.input[i];){let e=this.input[i];if(":"===e||","===e||"+"===e||"-"===e||"*"===e||"/"===e||"("===e||")"===e)return!1;i++}if(i>=this.input.length)return!1;let s=this.input.slice(t,i).trim();return""!==s&&/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*$/.test(s)}readEscapedIdentifier(e){let t=this.position;for(this.position++;this.canRead()&&this.input[this.position]!==e;)this.position++;if(t===this.position)throw new Error(`Closing delimiter is not found. position: ${t}, delimiter: ${e}\n${this.getDebugPositionInfo(t)}`);return this.position++,this.input.slice(t+1,this.position-1)}},He=class{constructor(e){this.input=e,this.position=0,this.readerManager=new Oe(e).register(new Je(e)).register(new Ie(e)).register(new Ve(e)).register(new Ne(e)).register(new Ae(e)).register(new qe(e)).register(new Re(e)).register(new Ke(e)).register(new De(e)).register(new Se(e))}isEndOfInput(e=0){return this.position+e>=this.input.length}canRead(e=0){return!this.isEndOfInput(e)}readLexmes(){let e=Math.ceil(this.input.length/8),t=new Array(e),i=0,s=this.readComment(),n=s.lines;this.position=s.position;let r=null;for(;this.canRead()&&";"!==this.input[this.position];){let e=this.readerManager.tryRead(this.position,r);if(null===e)throw new Error(`Unexpected character. actual: ${this.input[this.position]}, position: ${this.position}\n${this.getDebugPositionInfo(this.position)}`);this.position=this.readerManager.getMaxPosition();let s=this.readComment();this.position=s.position,16&e.type||2&e.type?s.lines.length>0&&n.push(...s.lines):((n.length>0||s.lines.length>0)&&this.addCommentsToToken(e,n,s.lines),n=[]),t[i++]=e,r=e}if(n.length>0&&i>0){let e=t[i-1];null===e.comments&&(e.comments=[]),e.comments.push(...n)}return i===e?t:t.slice(0,i)}addPendingCommentsToLastToken(e,t){if(t.length>0&&e.length>0){let i=e[e.length-1];null===i.comments&&(i.comments=[]),i.comments.push(...t)}}addCommentsToToken(e,t,i){(t.length>0||i.length>0)&&(null===e.comments&&(e.comments=[]),t.length>0&&e.comments.unshift(...t),i.length>0&&e.comments.push(...i))}readComment(){return Ee.readWhiteSpaceAndComment(this.input,this.position)}getDebugPositionInfo(e){return Ee.getDebugPositionInfo(this.input,e)}},ze=class e{static parseFromLexeme(t,i){let{identifiers:s,newIndex:n}=e.parseEscapedOrDotSeparatedIdentifiers(t,i),{namespaces:r,name:a}=e.extractNamespacesAndName(s),o=0;return n>i&&(o=t[n-1].type),{namespaces:r,name:new S(a),newIndex:n,lastTokenType:o}}static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The name is complete but additional tokens were found.`);return{namespaces:i.namespaces,name:i.name}}static parseEscapedOrDotSeparatedIdentifiers(e,t){let i=t,s=[];for(;i<e.length;){if(512&e[i].type){if(i++,i>=e.length||!(64&e[i].type||128&e[i].type))throw new Error(`Expected identifier after '[' at position ${i}`);if(s.push(e[i].value),i++,i>=e.length||"]"!==e[i].value)throw new Error(`Expected closing ']' after identifier at position ${i}`);i++}else if(64&e[i].type)s.push(e[i].value),i++;else if(2048&e[i].type)s.push(e[i].value),i++;else if(8192&e[i].type)s.push(e[i].value),i++;else if("*"===e[i].value){s.push(e[i].value),i++;break}if(!(i<e.length&&32&e[i].type))break;i++}return{identifiers:s,newIndex:i}}static extractNamespacesAndName(e){if(!e||0===e.length)throw new Error("Identifier list is empty");return 1===e.length?{namespaces:null,name:e[0]}:{namespaces:e.slice(0,-1),name:e[e.length-1]}}},Ge=class{static parseFromLexeme(e,t){let{namespaces:i,name:s,newIndex:n}=ze.parseFromLexeme(e,t);return{value:new l(i,s),newIndex:n}}},Ye=class{static parseFromLexeme(e,t){let i,s=t,n=e[s].value,r=be.parse(n.toLowerCase(),0);if(r)return s++,{value:new x(r.keyword),newIndex:s};if(/^[+-]?\d+(\.\d+)?([eE][+-]?\d+)?$/.test(n))return i=Number(n),s++,{value:new C(i),newIndex:s};{let e=/^\$[^$]*\$[\s\S]*\$[^$]*\$$/.test(n);return i=e?n:n.startsWith("'")&&n.endsWith("'")?n.slice(1,-1):n,s++,{value:new C(i,e),newIndex:s}}}},Xe=class{static parseFromLexeme(e,t){let i=t;if(i+1<e.length&&4&e[i].type&&("select"===e[i+1].value||"values"===e[i+1].value||"with"===e[i+1].value)){i+=1;let t=pi.parseFromLexeme(e,i);if(i=t.newIndex,i>=e.length||8!==e[i].type)throw new Error(`Expected ')' at index ${i}, but found ${e[i].value}`);return i++,{value:new a(t.value),newIndex:i}}{let s=ht.parseArgument(4,8,e,t);return i=s.newIndex,{value:new T(s.value),newIndex:i}}}},Ze=class{static parseFromLexeme(e,t){let i=t;if(i<e.length&&2&e[i].type){let t=e[i].value;if(i++,"*"===t)return{value:new l(null,"*"),newIndex:i};let s=ht.parseFromLexeme(e,i);return i=s.newIndex,{value:new w(t,s.value),newIndex:i}}throw new Error(`Invalid unary expression at index ${t}: ${e[t].value}`)}},et=class{static parseFromLexeme(e,t){let i=t,s=e[i].value;return s=s.startsWith("${")&&s.endsWith("}")?s.slice(2,-1):s.slice(1),i++,{value:new v(s),newIndex:i}}},tt=class{static parseFromLexeme(e,t){let i=t,s=e[i].value;if(i++,i>=e.length||1!==e[i].type)throw new Error(`Expected string literal after string specifier at index ${i}`);let n=e[i].value;return i++,{value:new O(s,n),newIndex:i}}},it=class{static parseFromLexeme(e,t){let i=t,s=e[i];return"case"===s.value?(i++,this.parseCaseExpression(e,i)):"case when"===s.value?(i++,this.parseCaseWhenExpression(e,i)):this.parseModifierUnaryExpression(e,i)}static parseModifierUnaryExpression(e,t){let i=t;if(i<e.length&&128&e[i].type){let t=e[i].value;i++;let s=ht.parseFromLexeme(e,i);return{value:new w(t,s.value),newIndex:s.newIndex}}throw new Error(`Invalid modifier unary expression at index ${i}, Lexeme: ${e[i].value}`)}static parseCaseExpression(e,t){let i=t,s=ht.parseFromLexeme(e,i);i=s.newIndex;let n=this.parseSwitchCaseArgument(e,i,[]);return i=n.newIndex,{value:new b(s.value,n.value),newIndex:i}}static parseCaseWhenExpression(e,t){let i=t,s=this.parseCaseConditionValuePair(e,i);i=s.newIndex;let n=[s.value],r=this.parseSwitchCaseArgument(e,i,n);return i=r.newIndex,{value:new b(null,r.value),newIndex:i}}static parseSwitchCaseArgument(e,t,i){let s=t,n=[...i],r=null;for(;s<e.length&&this.isCommandWithValue(e[s],"when");){s++;let t=this.parseCaseConditionValuePair(e,s);s=t.newIndex,n.push(t.value)}if(s<e.length&&this.isCommandWithValue(e[s],"else")){s++;let t=ht.parseFromLexeme(e,s);r=t.value,s=t.newIndex}if(!(s<e.length&&this.isCommandWithValue(e[s],"end")))throw new Error(`The CASE expression requires 'end' keyword at the end (index ${s})`);if(s++,0===n.length)throw new Error(`The CASE expression requires at least one WHEN clause (index ${s})`);return{value:new g(n,r),newIndex:s}}static isCommandWithValue(e,t){return!!(128&e.type)&&e.value===t}static parseCaseConditionValuePair(e,t){let i=t,s=ht.parseFromLexeme(e,i);if(i=s.newIndex,i>=e.length||!(128&e[i].type)||"then"!==e[i].value)throw new Error(`Expected 'then' after WHEN condition at index ${i}`);i++;let n=ht.parseFromLexeme(e,i);return i=n.newIndex,{value:new E(s.value,n.value),newIndex:i}}},st=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The ORDER BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("order by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'ORDER BY' keyword but found "${e[i].value}". ORDER BY clauses must start with the ORDER BY keywords.`);i++;let s=[],n=this.parseItem(e,i);for(s.push(n.value),i=n.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseItem(e,i);s.push(t.value),i=t.newIndex}if(0===s.length)throw new Error(`Syntax error at position ${t}: No ordering expressions found. The ORDER BY clause requires at least one expression to order by.`);return{value:new J(s),newIndex:i}}static parseItem(e,t){let i=t,s=ht.parseFromLexeme(e,i),n=s.value;if(i=s.newIndex,i>=e.length)return{value:n,newIndex:i};let r=i>=e.length?null:"asc"===e[i].value?(i++,"asc"):"desc"===e[i].value?(i++,"desc"):null,a=i>=e.length?null:"nulls first"===e[i].value?(i++,"first"):"nulls last"===e[i].value?(i++,"last"):null;return null===r&&null===a?{value:n,newIndex:i}:{value:new H(n,r,a),newIndex:i}}},nt=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The PARTITION BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("partition by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'PARTITION BY' keyword but found "${e[i].value}". PARTITION BY clauses must start with the PARTITION BY keywords.`);i++;let s=[],n=ht.parseFromLexeme(e,i);for(s.push(n.value),i=n.newIndex;i<e.length&&16&e[i].type;){i++;let t=ht.parseFromLexeme(e,i);s.push(t.value),i=t.newIndex}if(0===s.length)throw new Error(`Syntax error at position ${t}: No partition expressions found. The PARTITION BY clause requires at least one expression to partition by.`);return 1===s.length?{value:new D(s[0]),newIndex:i}:{value:new D(new o(s)),newIndex:i}}},rt=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The window frame expression is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if(4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected opening parenthesis '(' but found "${e[i].value}".`);i++;let s=null,n=null,r=null;if(i<e.length&&"partition by"===e[i].value){let t=nt.parseFromLexeme(e,i);s=t.value,i=t.newIndex}if(i<e.length&&"order by"===e[i].value){let t=st.parseFromLexeme(e,i);n=t.value,i=t.newIndex}if(i<e.length&&this.isFrameTypeKeyword(e[i].value)){let t=this.parseFrameSpec(e,i);r=t.value,i=t.newIndex}if(i>=e.length||8!==e[i].type)throw new Error(`Syntax error at position ${i}: Missing closing parenthesis ')' for window frame. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:new f(s,n,r),newIndex:i}}static isFrameTypeKeyword(e){return"rows"===e||"range"===e||"groups"===e}static parseFrameSpec(e,t){let i,s=t;switch(e[s].value){case"rows":i="rows";break;case"range":i="range";break;case"groups":i="groups";break;default:throw new Error(`Syntax error at position ${s}: Invalid frame type "${e[s].value}". Expected one of: ROWS, RANGE, GROUPS.`)}if(s++,s<e.length&&"between"===e[s].value){s++;let t=this.parseFrameBoundary(e,s),n=t.value;if(s=t.newIndex,s>=e.length||"and"!==e[s].value)throw new Error(`Syntax error at position ${s}: Expected 'AND' keyword in BETWEEN clause.`);s++;let r=this.parseFrameBoundary(e,s),a=r.value;return s=r.newIndex,{value:new m(i,n,a),newIndex:s}}{let t=this.parseFrameBoundary(e,s),n=t.value;return s=t.newIndex,{value:new m(i,n,null),newIndex:s}}}static parseFrameBoundary(e,t){let i=t;if(i<e.length&&128&e[i].type){let t;switch(e[i].value){case"current row":t="current row";break;case"unbounded preceding":t="unbounded preceding";break;case"unbounded following":t="unbounded following";break;default:throw new Error(`Syntax error at position ${i}: Invalid frame type "${e[i].value}". Expected one of: ROWS, RANGE, GROUPS.`)}return{value:new p(t),newIndex:i+1}}if(i<e.length&&1&e[i].type){let t=ht.parseFromLexeme(e,i);if(i=t.newIndex,i<e.length&&128&e[i].type){let s,n=e[i].value;if("preceding"===n)s=!1;else{if("following"!==n)throw new Error(`Syntax error at position ${i}: Expected 'preceding' or 'following' after numeric value in window frame boundary.`);s=!0}return i++,{value:new d(t.value,s),newIndex:i}}throw new Error(`Syntax error at position ${i}: Expected 'preceding' or 'following' after numeric value in window frame boundary.`)}throw new Error(`Syntax error at position ${i}: Expected a valid frame boundary component.`)}},at=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The OVER expression is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("over"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'OVER' keyword but found "${e[i].value}". OVER expressions must start with the OVER keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'OVER' keyword. Expected either a window name or an opening parenthesis '('.");if(64&e[i].type){let t=e[i].value;return i++,{value:new S(t),newIndex:i}}if(4&e[i].type)return rt.parseFromLexeme(e,i);throw new Error(`Syntax error at position ${i}: Expected a window name or opening parenthesis '(' after OVER keyword, but found "${e[i].value}".`)}},ot=class e extends Error{constructor(e,t,i){super(e),this.index=t,this.context=i,this.name="ParseError"}static fromUnparsedLexemes(t,i,s){let n=Math.max(0,i-2),r=Math.min(t.length,i+3),a=t.slice(n,r).map((e,t)=>{let s=t+n===i?">":" ",r=ve[e.type]||e.type;return`${s} ${t+n}:${e.value} [${r}]`}).join("\n"),o=`${s} Unparsed lexeme remains at index ${i}: ${t[i].value}\nContext:\n${a}`;return new e(o,i,a)}},lt=class{static parseArrayExpression(e,t){let i=t;if(i+1<e.length&&512&e[i+1].type){i++;let t=ht.parseArgument(512,1024,e,i);return i=t.newIndex,{value:new N(t.value),newIndex:i}}if(i+1<e.length&&4&e[i+1].type){i++,i++;let t=pi.parseFromLexeme(e,i);return i=t.newIndex,i++,{value:new I(t.value),newIndex:i}}throw new Error(`Invalid ARRAY syntax at index ${i}, expected ARRAY[... or ARRAY(...)`)}static parseFromLexeme(e,t){let i=t,s=e[i];return"array"===s.value?this.parseArrayExpression(e,i):"substring"===s.value||"overlay"===s.value?this.parseKeywordFunction(e,i,[{key:"from",required:!1},{key:"for",required:!1}]):"cast"===s.value?this.parseKeywordFunction(e,i,[{key:"as",required:!0}]):"trim"===s.value?this.parseKeywordFunction(e,i,[{key:"from",required:!1}]):this.parseFunctionCall(e,i)}static tryParseBinaryExpression(e,t,i,s=!0,n=!0){let r=t;if(r<e.length&&2&e[r].type){let t=e[r].value.toLowerCase();if(!s&&"and"===t||!n&&"or"===t)return null;if(r++,"between"===t)return this.parseBetweenExpression(e,r,i,!1);if("not between"===t)return this.parseBetweenExpression(e,r,i,!0);if("::"===t){let t=this.parseTypeValue(e,r);return r=t.newIndex,{value:new k(i,t.value),newIndex:r}}let a=ht.parseFromLexeme(e,r);return r=a.newIndex,{value:new y(i,t,a.value),newIndex:r}}return null}static parseBetweenExpression(e,t,i,s){let n=t,r=ht.parseFromLexeme(e,n,!1);if(n=r.newIndex,n<e.length&&2&e[n].type&&"and"!==e[n].value)throw new Error(`Expected 'and' after 'between' at index ${n}`);n++;let a=this.parseBetweenUpperBound(e,n);return n=a.newIndex,{value:new A(i,r.value,a.value,s),newIndex:n}}static parseBetweenUpperBound(e,t){return ht.parseFromLexeme(e,t,!1,!1)}static parseFunctionCall(e,t){let i=t,s=ze.parseFromLexeme(e,i),n=s.namespaces,r=s.name;if(i=s.newIndex,i<e.length&&4&e[i].type){let t=ht.parseArgument(4,8,e,i);i=t.newIndex;let s=null;if(i<e.length&&"within group"===e[i].value){let t=this.parseWithinGroupClause(e,i);s=t.value,i=t.newIndex}if(i<e.length&&"over"===e[i].value){let a=at.parseFromLexeme(e,i);return i=a.newIndex,{value:new u(n,r.name,t.value,a.value,s),newIndex:i}}return{value:new u(n,r.name,t.value,null,s),newIndex:i}}throw ot.fromUnparsedLexemes(e,i,`Expected opening parenthesis after function name '${r.name}'.`)}static parseKeywordFunction(e,t,i){let s=t,n=ze.parseFromLexeme(e,s),r=n.namespaces,a=n.name;if(s=n.newIndex,s<e.length&&4&e[s].type){s++;let n=ht.parseFromLexeme(e,s),o=n.value;if(s=n.newIndex,s<e.length&&16&e[s].type)return this.parseFunctionCall(e,t);for(let{key:t,required:n}of i)if(s<e.length&&128&e[s].type&&e[s].value===t)if(s++,s<e.length&&8192&e[s].type){let i=this.parseTypeValue(e,s);o=new y(o,t,i.value),s=i.newIndex}else{let i=ht.parseFromLexeme(e,s);o=new y(o,t,i.value),s=i.newIndex}else if(n)throw ot.fromUnparsedLexemes(e,s,`Keyword '${t}' is required for ${a.name} function.`);if(s<e.length&&8&e[s].type){s++;let t=null;if(s<e.length&&"within group"===e[s].value){let i=this.parseWithinGroupClause(e,s);t=i.value,s=i.newIndex}if(s<e.length&&"over"===e[s].value){s++;let i=at.parseFromLexeme(e,s);return s=i.newIndex,{value:new u(r,a.name,o,i.value,t),newIndex:s}}return{value:new u(r,a.name,o,null,t),newIndex:s}}throw ot.fromUnparsedLexemes(e,s,`Missing closing parenthesis for function '${a.name}'.`)}throw ot.fromUnparsedLexemes(e,s,`Missing opening parenthesis for function '${a.name}'.`)}static parseTypeValue(e,t){let i=t,{namespaces:s,name:n,newIndex:r}=ze.parseFromLexeme(e,i);if(i=r,i<e.length&&4&e[i].type){let t=ht.parseArgument(4,8,e,i);return i=t.newIndex,{value:new P(s,new x(n.name),t.value),newIndex:i}}return{value:new P(s,new x(n.name)),newIndex:i}}static parseWithinGroupClause(e,t){let i=t;if(i>=e.length||"within group"!==e[i].value)throw new Error(`Expected 'WITHIN GROUP' at index ${i}`);if(i++,i>=e.length||!(4&e[i].type))throw new Error(`Expected '(' after 'WITHIN GROUP' at index ${i}`);i++;let s=st.parseFromLexeme(e,i);if(i=s.newIndex,i>=e.length||!(8&e[i].type))throw new Error(`Expected ')' after WITHIN GROUP ORDER BY clause at index ${i}`);return i++,{value:s.value,newIndex:i}}},ut=class{static{this.precedenceMap={or:1,and:2,"=":10,"!=":10,"<>":10,"<":10,"<=":10,">":10,">=":10,like:10,ilike:10,"not like":10,"not ilike":10,"similar to":10,"not similar to":10,in:10,"not in":10,is:10,"is not":10,"->":10,"->>":10,"#>":10,"#>>":10,"@>":10,"<@":10,"?":10,"?|":10,"?&":10,"~":10,"~*":10,"!~":10,"!~*":10,rlike:10,regexp:10,mod:30,xor:2,between:15,"not between":15,"+":20,"-":20,"*":30,"/":30,"%":30,"^":40,"::":50,"unary+":100,"unary-":100,not:100}}static getPrecedence(e){let t=this.precedenceMap[e.toLowerCase()];return void 0!==t?t:0}static hasHigherOrEqualPrecedence(e,t){return this.getPrecedence(e)>=this.getPrecedence(t)}static isLogicalOperator(e){let t=e.toLowerCase();return"and"===t||"or"===t}static isBetweenOperator(e){let t=e.toLowerCase();return"between"===t||"not between"===t}static isComparisonOperator(e){let t=e.toLowerCase();return["=","!=","<>","<",">","<=",">=","like","ilike","similar to","in","not in","->","->>","#>","#>>","@>","<@","?","?|","?&","~","~*","!~","!~*","rlike","regexp"].includes(t)}},ht=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw ot.fromUnparsedLexemes(t,i.newIndex,"[ValueParser]");return i.value}static parseFromLexeme(e,t,i=!0,s=!0){return this.parseExpressionWithPrecedence(e,t,0,i,s)}static parseExpressionWithPrecedence(e,t,i,s=!0,n=!0){let r=t,a=e[r].comments,o=this.parseItem(e,r);o.value.comments=a,r=o.newIndex;let l=o.value,u=this.parseArrayAccess(e,r,l);for(l=u.value,r=u.newIndex;r<e.length&&2&e[r].type;){let t=e[r].value;if(!s&&"and"===t.toLowerCase()||!n&&"or"===t.toLowerCase())break;let a=ut.getPrecedence(t);if(a<i)break;if(r++,ut.isBetweenOperator(t)){let i=lt.parseBetweenExpression(e,r,l,t.toLowerCase().includes("not"));l=i.value,r=i.newIndex;continue}if("::"===t){let t=lt.parseTypeValue(e,r);l=new k(l,t.value),r=t.newIndex;continue}let o=a+1,u=this.parseExpressionWithPrecedence(e,r,o,s,n);r=u.newIndex,l=new y(l,t,u.value)}return{value:l,newIndex:r}}static parseItem(e,t){let i=t;if(i>=e.length)throw new Error(`Unexpected end of lexemes at index ${t}`);let s=e[i];if(64&s.type&&2&s.type&&8192&s.type){if(i+1<e.length&&4&e[i+1].type){if(this.isTypeConstructor(e,i+1,s.value)){let t=lt.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return lt.parseFromLexeme(e,i)}let t=Ge.parseFromLexeme(e,i);if(t.newIndex>=e.length)return t;if(1&e[t.newIndex].type){let s=Ye.parseFromLexeme(e,t.newIndex);return{value:new w(e[i].value,s.value),newIndex:s.newIndex}}return t}if(64&s.type){let{namespaces:t,name:s,newIndex:n}=ze.parseFromLexeme(e,i);if(2048&e[n-1].type)return lt.parseFromLexeme(e,i);if(8192&e[n-1].type){if(n<e.length&&4&e[n].type){if(this.isTypeConstructor(e,n,s.name)){let t=lt.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return lt.parseFromLexeme(e,i)}return{value:new P(t,s),newIndex:n}}return{value:new l(t,s),newIndex:n}}if(1&s.type)return Ye.parseFromLexeme(e,i);if(4&s.type)return Xe.parseFromLexeme(e,i);if(2048&s.type)return lt.parseFromLexeme(e,i);if(2&s.type)return Ze.parseFromLexeme(e,i);if(256&s.type)return et.parseFromLexeme(e,i);if(4096&s.type)return tt.parseFromLexeme(e,i);if(128&s.type)return it.parseFromLexeme(e,i);if(512&s.type){let{namespaces:t,name:s,newIndex:n}=ze.parseFromLexeme(e,i);return{value:new l(t,s),newIndex:n}}if(8192&s.type){let{namespaces:t,name:s,newIndex:n}=ze.parseFromLexeme(e,i);if(n<e.length&&4&e[n].type){if(this.isTypeConstructor(e,n,s.name)){let t=lt.parseTypeValue(e,i);return{value:t.value,newIndex:t.newIndex}}return lt.parseFromLexeme(e,i)}return{value:new P(t,s),newIndex:n}}throw ot.fromUnparsedLexemes(e,i,"[ValueParser] Invalid lexeme.")}static parseArgument(e,t,i,s){let n=s,r=[];if(n<i.length&&i[n].type===e){if(n++,n<i.length&&i[n].type===t)return n++,{value:new o([]),newIndex:n};if(n<i.length&&"*"===i[n].value){let e=new l(null,"*");if(n++,n<i.length&&i[n].type===t)return n++,{value:e,newIndex:n};throw ot.fromUnparsedLexemes(i,n,"Expected closing parenthesis after wildcard '*'.")}let e=this.parseFromLexeme(i,n);for(n=e.newIndex,r.push(e.value);n<i.length&&16&i[n].type;){n++;let e=this.parseFromLexeme(i,n);n=e.newIndex,r.push(e.value)}if(n<i.length&&i[n].type===t)return n++,1===r.length?{value:r[0],newIndex:n}:{value:new o(r),newIndex:n};throw ot.fromUnparsedLexemes(i,n,"Missing closing parenthesis.")}throw ot.fromUnparsedLexemes(i,s,"Expected opening parenthesis.")}static parseArrayAccess(e,t,i){let s=t,n=i;for(;s<e.length&&512&e[s].type&&!this.isSqlServerBracketIdentifier(e,s);){if(s++,s>=e.length)throw new Error("Expected array index or slice after '[' at index "+(s-1));if(1024&e[s].type)throw new Error(`Empty array access brackets not supported at index ${s}`);let t=null,i=!1;if(2&e[s].type&&":"===e[s].value)i=!0,s++;else{let n=ut.getPrecedence(":"),r=this.parseExpressionWithPrecedence(e,s,n+1);t=r.value,s=r.newIndex,s<e.length&&2&e[s].type&&":"===e[s].value&&(i=!0,s++)}if(i){let i=null;if(s<e.length&&!(1024&e[s].type)){let t=ut.getPrecedence(":"),n=this.parseExpressionWithPrecedence(e,s,t+1);i=n.value,s=n.newIndex}if(s>=e.length||!(1024&e[s].type))throw new Error(`Expected ']' after array slice at index ${s}`);s++,n=new F(n,t,i)}else{if(!t){let i=this.parseFromLexeme(e,s);t=i.value,s=i.newIndex}if(s>=e.length||!(1024&e[s].type))throw new Error(`Expected ']' after array index at index ${s}`);s++,n=new L(n,t)}}return{value:n,newIndex:s}}static isSqlServerBracketIdentifier(e,t){let i=t+1;if(i>=e.length)return!1;for(;i<e.length&&!(1024&e[i].type);){let t=e[i];if(!(64&t.type||2&t.type&&"."===t.value))return!1;i++}if(i>=e.length)return!1;let s=i;if(s+1<e.length){let t=e[s+1];if(2&t.type&&"."===t.value)return!0}i=t+1;let n=!0;for(;i<s;){let t=e[i];if(!(64&t.type||2&t.type&&"."===t.value)){n=!1;break}i++}return n}static isTypeConstructor(e,t,i){let s=i.toUpperCase();if(["NUMERIC","DECIMAL","VARCHAR","CHAR","CHARACTER","TIMESTAMP","TIME","INTERVAL"].includes(s))return!0;if("DATE"===s){let i=t+1;if(i<e.length){let t=e[i];return!(1&t.type&&"string"==typeof t.value&&isNaN(Number(t.value)))}}return!1}},ct=class{constructor(){this.commonTables=[],this.visitedNodes=new Set,this.isRootVisit=!0,this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(Kt.kind,e=>this.visitValuesQuery(e)),this.handlers.set(oe.kind,e=>this.visitWithClause(e)),this.handlers.set(ae.kind,e=>this.visitCommonTable(e)),this.handlers.set(q.kind,e=>this.visitSelectItem(e)),this.handlers.set(S.kind,e=>this.visitIdentifierString(e)),this.handlers.set(x.kind,e=>this.visitRawString(e)),this.handlers.set(l.kind,e=>this.visitColumnReference(e)),this.handlers.set(v.kind,e=>this.visitParameterExpression(e)),this.handlers.set(C.kind,e=>this.visitLiteralValue(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(Y.kind,e=>this.visitTableSource(e)),this.handlers.set(X.kind,e=>this.visitFunctionSource(e)),this.handlers.set(Z.kind,e=>this.visitParenSource(e)),this.handlers.set(ee.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(a.kind,e=>this.visitInlineQuery(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(ne.kind,e=>this.visitJoinClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(E.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(g.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set($.kind,e=>this.visitTupleExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(f.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set(m.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(P.kind,e=>this.visitTypeValue(e)),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(O.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(M.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(pe.kind,e=>this.visitForClause(e)),this.handlers.set(H.kind,e=>this.visitOrderByItem(e)),this.handlers.set(D.kind,e=>this.visitPartitionByClause(e))}getCommonTables(){return this.commonTables}reset(){this.commonTables=[],this.visitedNodes.clear()}collect(e){return this.visit(e),this.getCommonTables()}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());if(t)return void t(e);let i=e.getKind()?.toString()||"unknown",s=e.constructor?.name||"unknown";throw new Error(`[CTECollector] No handler for ${s} with kind ${i}.`)}visitSimpleSelectQuery(e){if(e.fromClause&&e.fromClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.orderByClause&&e.orderByClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.limitClause&&e.limitClause.accept(this),e.forClause&&e.forClause.accept(this),e.selectClause.accept(this),e.withClause&&e.withClause.accept(this)}visitBinarySelectQuery(e){e.left.accept(this),e.right.accept(this)}visitValuesQuery(e){for(let t of e.tuples)t.accept(this)}visitWithClause(e){for(let t=0;t<e.tables.length;t++)e.tables[t].accept(this)}visitCommonTable(e){e.query.accept(this),this.commonTables.push(e)}visitSelectClause(e){for(let t of e.items)t.accept(this)}visitSelectItem(e){e.value.accept(this)}visitFromClause(e){if(e.source.accept(this),e.joins)for(let t of e.joins)t.accept(this)}visitSourceExpression(e){e.datasource.accept(this)}visitTableSource(e){}visitFunctionSource(e){e.argument&&e.argument.accept(this)}visitParenSource(e){e.source.accept(this)}visitSubQuerySource(e){e.query.accept(this)}visitInlineQuery(e){e.selectQuery.accept(this)}visitJoinClause(e){e.source.accept(this),e.condition&&e.condition.accept(this)}visitJoinOnClause(e){e.condition.accept(this)}visitJoinUsingClause(e){e.condition.accept(this)}visitWhereClause(e){e.condition.accept(this)}visitGroupByClause(e){for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition.accept(this)}visitOrderByClause(e){for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitLimitClause(e){e.value.accept(this)}visitForClause(e){}visitOrderByItem(e){e.value.accept(this)}visitParenExpression(e){e.expression.accept(this)}visitBinaryExpression(e){e.left.accept(this),e.right.accept(this)}visitUnaryExpression(e){e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase.accept(this)}visitSwitchCaseArgument(e){for(let t of e.cases)t.accept(this);e.elseValue&&e.elseValue.accept(this)}visitCaseKeyValuePair(e){e.key.accept(this),e.value.accept(this)}visitBetweenExpression(e){e.expression.accept(this),e.lower.accept(this),e.upper.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitArrayExpression(e){e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitTupleExpression(e){for(let t of e.values)t.accept(this)}visitCastExpression(e){e.input.accept(this),e.castType.accept(this)}visitTypeValue(e){e.argument&&e.argument.accept(this)}visitWindowFrameExpression(e){e.partition&&e.partition.accept(this),e.order&&e.order.accept(this),e.frameSpec&&e.frameSpec.accept(this)}visitWindowFrameSpec(e){}visitIdentifierString(e){}visitRawString(e){}visitColumnReference(e){}visitParameterExpression(e){}visitLiteralValue(e){}visitPartitionByClause(e){}visitValueList(e){for(let t of e.values)t.accept(this)}visitStringSpecifierExpression(e){}},pt=class{constructor(){this.visitedNodes=new Set,this.isRootVisit=!0,this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(Kt.kind,e=>this.visitValuesQuery(e)),this.handlers.set(q.kind,e=>this.visitSelectItem(e)),this.handlers.set(S.kind,e=>this.visitIdentifierString(e)),this.handlers.set(x.kind,e=>this.visitRawString(e)),this.handlers.set(l.kind,e=>this.visitColumnReference(e)),this.handlers.set(v.kind,e=>this.visitParameterExpression(e)),this.handlers.set(C.kind,e=>this.visitLiteralValue(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(Y.kind,e=>this.visitTableSource(e)),this.handlers.set(Z.kind,e=>this.visitParenSource(e)),this.handlers.set(ee.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(a.kind,e=>this.visitInlineQuery(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(ne.kind,e=>this.visitJoinClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(E.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(g.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set($.kind,e=>this.visitTupleExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(f.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set(m.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(P.kind,e=>this.visitTypeValue(e)),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(F.kind,e=>this.visitArraySliceExpression(e)),this.handlers.set(L.kind,e=>this.visitArrayIndexExpression(e)),this.handlers.set(O.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(M.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(pe.kind,e=>this.visitForClause(e)),this.handlers.set(H.kind,e=>this.visitOrderByItem(e)),this.handlers.set(D.kind,e=>this.visitPartitionByClause(e))}reset(){this.visitedNodes.clear()}execute(e){return this.reset(),this.visit(e)}visit(e){if(!this.isRootVisit)return this.visitNode(e);this.reset(),this.isRootVisit=!1;try{return this.visitNode(e)}finally{this.isRootVisit=!0}}visitNode(e){if(this.visitedNodes.has(e))return e;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());if(t)return t(e);let i=e.getKind()?.toString()||"unknown",s=e.constructor?.name||"unknown";throw new Error(`[CTEDisabler] No handler for ${s} with kind ${i}.`)}visitSimpleSelectQuery(e){return e.withClause&&e.withClause.tables.forEach(e=>{this.visit(e.query)}),e.withClause=null,e.selectClause=this.visit(e.selectClause),e.fromClause=e.fromClause?this.visit(e.fromClause):null,e.whereClause=e.whereClause?this.visit(e.whereClause):null,e.groupByClause=e.groupByClause?this.visit(e.groupByClause):null,e.havingClause=e.havingClause?this.visit(e.havingClause):null,e.orderByClause=e.orderByClause?this.visit(e.orderByClause):null,e.windowClause&&(e.windowClause=new K(e.windowClause.windows.map(e=>this.visit(e)))),e.limitClause=e.limitClause?this.visit(e.limitClause):null,e.forClause=e.forClause?this.visit(e.forClause):null,e}visitBinarySelectQuery(e){return e.left=this.visit(e.left),e.right=this.visit(e.right),e}visitValuesQuery(e){let t=e.tuples.map(e=>this.visit(e));return new Kt(t)}visitSelectClause(e){let t=e.items.map(e=>this.visit(e));return new Q(t,e.distinct)}visitFromClause(e){let t=this.visit(e.source),i=e.joins?e.joins.map(e=>this.visit(e)):null;return new re(t,i)}visitSubQuerySource(e){let t=this.visit(e.query);return new ee(t)}visitInlineQuery(e){let t=this.visit(e.selectQuery);return new a(t)}visitJoinClause(e){let t=this.visit(e.source),i=e.condition?this.visit(e.condition):null;return new ne(e.joinType.value,t,i,e.lateral)}visitJoinOnClause(e){let t=this.visit(e.condition);return new ie(t)}visitJoinUsingClause(e){let t=this.visit(e.condition);return new se(t)}visitWhereClause(e){let t=this.visit(e.condition);return new W(t)}visitGroupByClause(e){let t=e.grouping.map(e=>this.visit(e));return new z(t)}visitHavingClause(e){let t=this.visit(e.condition);return new G(t)}visitOrderByClause(e){let t=e.order.map(e=>this.visit(e));return new J(t)}visitWindowFrameClause(e){let t=this.visit(e.expression);return new M(e.name.name,t)}visitLimitClause(e){let t=this.visit(e.value);return new le(t)}visitForClause(e){return new pe(e.lockMode)}visitParenExpression(e){let t=this.visit(e.expression);return new T(t)}visitBinaryExpression(e){let t=this.visit(e.left),i=this.visit(e.right);return new y(t,e.operator.value,i)}visitUnaryExpression(e){let t=this.visit(e.expression);return new w(e.operator.value,t)}visitCaseExpression(e){let t=e.condition?this.visit(e.condition):null,i=this.visit(e.switchCase);return new b(t,i)}visitSwitchCaseArgument(e){let t=e.cases.map(e=>this.visit(e)),i=e.elseValue?this.visit(e.elseValue):null;return new g(t,i)}visitCaseKeyValuePair(e){let t=this.visit(e.key),i=this.visit(e.value);return new E(t,i)}visitBetweenExpression(e){let t=this.visit(e.expression),i=this.visit(e.lower),s=this.visit(e.upper);return new A(t,i,s,e.negated)}visitFunctionCall(e){let t=e.argument?this.visit(e.argument):null,i=e.over?this.visit(e.over):null;return new u(e.namespaces,e.name,t,i)}visitArrayExpression(e){let t=this.visit(e.expression);return new N(t)}visitArrayQueryExpression(e){let t=this.visit(e.query);return new I(t)}visitTupleExpression(e){let t=e.values.map(e=>this.visit(e));return new $(t)}visitCastExpression(e){let t=this.visit(e.input),i=this.visit(e.castType);return new k(t,i)}visitTypeValue(e){let t=e.argument?this.visit(e.argument):null;return new P(e.namespaces,e.name,t)}visitSelectItem(e){let t=this.visit(e.value);return new q(t,e.identifier?.name)}visitIdentifierString(e){return e}visitRawString(e){return e}visitColumnReference(e){return e}visitSourceExpression(e){let t=this.visit(e.datasource),i=e.aliasExpression;return new te(t,i)}visitTableSource(e){return e}visitParenSource(e){let t=this.visit(e.source);return new Z(t)}visitParameterExpression(e){return e}visitWindowFrameExpression(e){let t=e.partition?this.visit(e.partition):null,i=e.order?this.visit(e.order):null,s=e.frameSpec?this.visit(e.frameSpec):null;return new f(t,i,s)}visitWindowFrameSpec(e){return e}visitLiteralValue(e){return e}visitOrderByItem(e){let t=this.visit(e.value);return new H(t,e.sortDirection,e.nullsPosition)}visitValueList(e){let t=e.values.map(e=>this.visit(e));return new o(t)}visitArraySliceExpression(e){return e}visitArrayIndexExpression(e){return e}visitStringSpecifierExpression(e){return e}visitPartitionByClause(e){let t=this.visit(e.value);return new D(t)}},dt=class{constructor(e=!0){this.tableSources=[],this.visitedNodes=new Set,this.tableNameMap=new Map,this.cteNames=new Set,this.isRootVisit=!0,this.selectableOnly=e,this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(Kt.kind,e=>this.visitValuesQuery(e)),this.handlers.set(oe.kind,e=>this.visitWithClause(e)),this.handlers.set(ae.kind,e=>this.visitCommonTable(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(ne.kind,e=>this.visitJoinClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(Y.kind,e=>this.visitTableSource(e)),this.handlers.set(X.kind,e=>this.visitFunctionSource(e)),this.handlers.set(Z.kind,e=>this.visitParenSource(e)),this.handlers.set(ee.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(a.kind,e=>this.visitInlineQuery(e)),e||(this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(M.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(ue.kind,e=>this.visitOffsetClause(e)),this.handlers.set(he.kind,e=>this.visitFetchClause(e)),this.handlers.set(pe.kind,e=>this.visitForClause(e)),this.handlers.set(H.kind,e=>this.visitOrderByItem(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(q.kind,e=>this.visitSelectItem(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(E.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(g.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set($.kind,e=>this.visitTupleExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(O.kind,e=>this.visitStringSpecifierExpression(e)))}getTableSources(){return this.tableSources}reset(){this.tableSources=[],this.tableNameMap.clear(),this.visitedNodes.clear(),this.cteNames.clear()}getTableIdentifier(e){return e.qualifiedName.namespaces&&e.qualifiedName.namespaces.length>0?e.qualifiedName.namespaces.map(e=>e.name).join(".")+"."+(e.qualifiedName.name instanceof x?e.qualifiedName.name.value:e.qualifiedName.name.name):e.qualifiedName.name instanceof x?e.qualifiedName.name.value:e.qualifiedName.name.name}collect(e){return this.visit(e),this.getTableSources()}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.selectableOnly||this.collectCTEs(e),this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}collectCTEs(e){let t=new ct;t.visit(e);let i=t.getCommonTables();for(let e of i)this.cteNames.add(e.aliasExpression.table.name)}visitSimpleSelectQuery(e){if(e.fromClause&&e.fromClause.accept(this),!this.selectableOnly){if(e.withClause&&e.withClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.orderByClause&&e.orderByClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.limitClause&&e.limitClause.accept(this),e.offsetClause&&e.offsetClause.accept(this),e.fetchClause&&e.fetchClause.accept(this),e.forClause&&e.forClause.accept(this),e.selectClause.accept(this)}}visitBinarySelectQuery(e){e.left.accept(this),e.right.accept(this)}visitValuesQuery(e){if(!this.selectableOnly)for(let t of e.tuples)t.accept(this)}visitWithClause(e){if(!this.selectableOnly)for(let t of e.tables)t.accept(this)}visitCommonTable(e){this.selectableOnly||e.query.accept(this)}visitFromClause(e){if(e.source.accept(this),e.joins)for(let t of e.joins)t.accept(this)}visitSourceExpression(e){e.datasource.accept(this)}visitTableSource(e){let t=this.getTableIdentifier(e);!this.tableNameMap.has(t)&&!this.isCTETable(e.table.name)&&(this.tableNameMap.set(t,!0),this.tableSources.push(e))}visitFunctionSource(e){e.argument&&this.visitValueComponent(e.argument)}visitValueComponent(e){e.accept(this)}isCTETable(e){return this.cteNames.has(e)}visitParenSource(e){e.source.accept(this)}visitSubQuerySource(e){this.selectableOnly||e.query.accept(this)}visitInlineQuery(e){this.selectableOnly||e.selectQuery.accept(this)}visitJoinClause(e){e.source.accept(this),!this.selectableOnly&&e.condition&&e.condition.accept(this)}visitJoinOnClause(e){this.selectableOnly||e.condition.accept(this)}visitJoinUsingClause(e){this.selectableOnly||e.condition.accept(this)}visitWhereClause(e){e.condition.accept(this)}visitGroupByClause(e){for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition.accept(this)}visitOrderByClause(e){for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitLimitClause(e){e.value.accept(this)}visitOffsetClause(e){e.value.accept(this)}visitFetchClause(e){e.expression.accept(this)}visitForClause(e){}visitOrderByItem(e){e.value.accept(this)}visitSelectClause(e){for(let t of e.items)t.accept(this)}visitSelectItem(e){e.value.accept(this)}visitParenExpression(e){e.expression.accept(this)}visitBinaryExpression(e){e.left.accept(this),e.right.accept(this)}visitUnaryExpression(e){e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase.accept(this)}visitSwitchCaseArgument(e){for(let t of e.cases)t.accept(this);e.elseValue&&e.elseValue.accept(this)}visitCaseKeyValuePair(e){e.key.accept(this),e.value.accept(this)}visitBetweenExpression(e){e.expression.accept(this),e.lower.accept(this),e.upper.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitArrayExpression(e){e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitTupleExpression(e){for(let t of e.values)t.accept(this)}visitCastExpression(e){e.input.accept(this),e.castType.accept(this)}visitValueList(e){for(let t of e.values)t.accept(this)}visitStringSpecifierExpression(e){}},mt=class extends n{static{this.kind=Symbol("HintClause")}constructor(e){super(),this.hintContent=e}getFullHint(){return"/*+ "+this.hintContent+" */"}static isHintClause(e){let t=e.trim();return t.length>=5&&"/*+"===t.substring(0,3)&&"*/"===t.substring(t.length-2)}static extractHintContent(e){let t=e.trim();if(!this.isHintClause(t))throw new Error("Not a valid hint clause: "+e);return t.slice(3,-2).trim()}},ft=class{constructor(e,t="",i=""){this.innerTokens=[],this.type=e,this.text=t,this.containerType=i}},wt=class{static collect(e){let t=[];return function e(i){if(i&&"object"==typeof i){i.constructor&&i.constructor.kind===v.kind&&t.push(i);for(let t of Object.keys(i)){let s=i[t];Array.isArray(s)?s.forEach(e):s&&"object"==typeof s&&s.constructor&&s.constructor.kind&&e(s)}}}(e),t}},yt=class{constructor(e){this.start=e?.start??'"',this.end=e?.end??'"'}decorate(e){return this.start+e+this.end}},Ct=class{constructor(e){this.prefix=e?.prefix??":",this.suffix=e?.suffix??"",this.style=e?.style??"named"}decorate(e,t){let i="";return"anonymous"===this.style?i=this.prefix:"indexed"===this.style?i=this.prefix+t:"named"===this.style&&(i=this.prefix+e+this.suffix),i}},vt=class extends n{static{this.kind=Symbol("UpdateQuery")}constructor(e){super(),this.withClause=e.withClause??null,this.updateClause=e.updateClause,this.setClause=e.setClause instanceof fe?e.setClause:new fe(e.setClause),this.whereClause=e.whereClause??null,this.fromClause=e.fromClause??null,this.returningClause=e.returning??null}},gt=class e{constructor(e=null,t=null){this.selectValues=[],this.visitedNodes=new Set,this.isRootVisit=!0,this.tableColumnResolver=e??null,this.commonTableCollector=new ct,this.commonTables=[],this.initialCommonTables=t,this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e))}getValues(){return this.selectValues}reset(){this.selectValues=[],this.visitedNodes.clear(),this.initialCommonTables?this.commonTables=this.initialCommonTables:this.commonTables=[]}collect(e){this.visit(e);let t=this.getValues();return this.reset(),t}visit(e){if(this.isRootVisit){this.reset(),this.isRootVisit=!1;try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}visitSimpleSelectQuery(e){0===this.commonTables.length&&null===this.initialCommonTables&&(this.commonTables=this.commonTableCollector.collect(e)),e.selectClause&&e.selectClause.accept(this);let t=this.selectValues.filter(e=>"*"===e.name);if(0===t.length)return;if(this.selectValues.some(e=>e.value instanceof l&&null===e.value.namespaces))return e.fromClause&&this.processFromClause(e.fromClause,!0),void(this.selectValues=this.selectValues.filter(e=>"*"!==e.name));let i=t.filter(e=>e.value instanceof l&&e.value.namespaces).map(e=>e.value.getNamespace());if(e.fromClause){let t=e.fromClause.getSourceAliasName();if(t&&i.includes(t)&&this.processFromClause(e.fromClause,!1),e.fromClause.joins)for(let t of e.fromClause.joins){let e=t.getSourceAliasName();e&&i.includes(e)&&this.processJoinClause(t)}}this.selectValues=this.selectValues.filter(e=>"*"!==e.name)}processFromClause(e,t){if(e){let i=e.getSourceAliasName();if(this.processSourceExpression(i,e.source),e.joins&&t)for(let t of e.joins)this.processJoinClause(t)}}processJoinClause(e){let t=e.getSourceAliasName();this.processSourceExpression(t,e.source)}processSourceExpression(t,i){let s=this.commonTables.find(e=>e.aliasExpression.table.name===t);if(s){let i=this.commonTables.filter(e=>e.aliasExpression.table.name!==t);new e(this.tableColumnResolver,i).collect(s.query).forEach(e=>{this.addSelectValueAsUnique(e.name,new l(t?[t]:null,e.name))})}else new e(this.tableColumnResolver,this.commonTables).collect(i).forEach(e=>{this.addSelectValueAsUnique(e.name,new l(t?[t]:null,e.name))})}visitSelectClause(e){for(let t of e.items)this.processSelectItem(t)}processSelectItem(e){if(e.identifier)this.addSelectValueAsUnique(e.identifier.name,e.value);else if(e.value instanceof l){let t=e.value.column.name;"*"===t?this.selectValues.push({name:t,value:e.value}):this.addSelectValueAsUnique(t,e.value)}}visitSourceExpression(t){if(t.aliasExpression&&t.aliasExpression.columns){let e=t.getAliasName();return void t.aliasExpression.columns.forEach(t=>{this.addSelectValueAsUnique(t.name,new l(e?[e]:null,t.name))})}if(t.datasource instanceof Y){if(this.tableColumnResolver){let e=t.datasource.getSourceName();this.tableColumnResolver(e).forEach(t=>{this.addSelectValueAsUnique(t,new l([e],t))})}}else{if(t.datasource instanceof ee){let i=t.getAliasName();return void new e(this.tableColumnResolver,this.commonTables).collect(t.datasource.query).forEach(e=>{this.addSelectValueAsUnique(e.name,new l(i?[i]:null,e.name))})}if(t.datasource instanceof Z)return this.visit(t.datasource.source)}}visitFromClause(e){e&&this.processFromClause(e,!0)}addSelectValueAsUnique(e,t){this.selectValues.some(t=>t.name===e)||this.selectValues.push({name:e,value:t})}},Et=class extends n{static{this.kind=Symbol("CreateTableQuery")}constructor(e){super(),this.tableName=new S(e.tableName),this.isTemporary=e.isTemporary??!1,this.asSelectQuery=e.asSelectQuery}getSelectQuery(){let e;return e=this.asSelectQuery?(new gt).collect(this.asSelectQuery).map(e=>new q(e.value,e.name)):[new q(new x("*"))],new Dt({selectClause:new Q(e),fromClause:new re(new te(new Y(null,this.tableName.name),null),null)})}getCountQuery(){return new Dt({selectClause:new Q([new q(new u(null,"count",new l(null,"*"),null))]),fromClause:new re(new te(new Y(null,this.tableName.name),null),null)})}},xt={mysql:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},postgres:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},postgresWithNamedParams:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},sqlserver:{identifierEscape:{start:"[",end:"]"},parameterSymbol:"@",parameterStyle:"named"},sqlite:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},oracle:{identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"},clickhouse:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},firebird:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},db2:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},snowflake:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},cloudspanner:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"@",parameterStyle:"named"},duckdb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},cockroachdb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},athena:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"},bigquery:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"@",parameterStyle:"named"},hive:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},mariadb:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},redshift:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"$",parameterStyle:"indexed"},flinksql:{identifierEscape:{start:"`",end:"`"},parameterSymbol:"?",parameterStyle:"anonymous"},mongodb:{identifierEscape:{start:'"',end:'"'},parameterSymbol:"?",parameterStyle:"anonymous"}},St=class e{constructor(e){this.handlers=new Map,this.index=1,e?.preset&&(e={...e.preset,...e}),this.parameterDecorator=new Ct({prefix:"string"==typeof e?.parameterSymbol?e.parameterSymbol:e?.parameterSymbol?.start??":",suffix:"object"==typeof e?.parameterSymbol?e.parameterSymbol.end:"",style:e?.parameterStyle??"named"}),this.identifierDecorator=new yt({start:e?.identifierEscape?.start??'"',end:e?.identifierEscape?.end??'"'}),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(l.kind,e=>this.visitColumnReference(e)),this.handlers.set(j.kind,e=>this.visitQualifiedName(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(C.kind,e=>this.visitLiteralValue(e)),this.handlers.set(v.kind,e=>this.visitParameterExpression(e)),this.handlers.set(g.kind,e=>this.visitSwitchCaseArgument(e)),this.handlers.set(E.kind,e=>this.visitCaseKeyValuePair(e)),this.handlers.set(x.kind,e=>this.visitRawString(e)),this.handlers.set(S.kind,e=>this.visitIdentifierString(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(F.kind,e=>this.visitArraySliceExpression(e)),this.handlers.set(L.kind,e=>this.visitArrayIndexExpression(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(O.kind,e=>this.visitStringSpecifierExpression(e)),this.handlers.set(P.kind,e=>this.visitTypeValue(e)),this.handlers.set($.kind,e=>this.visitTupleExpression(e)),this.handlers.set(a.kind,e=>this.visitInlineQuery(e)),this.handlers.set(f.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set(m.kind,e=>this.visitWindowFrameSpec(e)),this.handlers.set(p.kind,e=>this.visitWindowFrameBoundStatic(e)),this.handlers.set(d.kind,e=>this.visitWindowFrameBoundaryValue(e)),this.handlers.set(D.kind,e=>this.visitPartitionByClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(H.kind,e=>this.visitOrderByItem(e)),this.handlers.set(q.kind,e=>this.visitSelectItem(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(U.kind,e=>this.visitDistinct(e)),this.handlers.set(V.kind,e=>this.visitDistinctOn(e)),this.handlers.set(mt.kind,e=>this.visitHintClause(e)),this.handlers.set(Y.kind,e=>this.visitTableSource(e)),this.handlers.set(X.kind,e=>this.visitFunctionSource(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(de.kind,e=>this.visitSourceAliasExpression(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(ne.kind,e=>this.visitJoinClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(K.kind,e=>this.visitWindowClause(e)),this.handlers.set(M.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(ue.kind,e=>this.visitOffsetClause(e)),this.handlers.set(he.kind,e=>this.visitFetchClause(e)),this.handlers.set(ce.kind,e=>this.visitFetchExpression(e)),this.handlers.set(pe.kind,e=>this.visitForClause(e)),this.handlers.set(oe.kind,e=>this.visitWithClause(e)),this.handlers.set(ae.kind,e=>this.visitCommonTable(e)),this.handlers.set(Dt.kind,e=>this.visitSimpleQuery(e)),this.handlers.set(ee.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e)),this.handlers.set(Kt.kind,e=>this.visitValuesQuery(e)),this.handlers.set($.kind,e=>this.visitTupleExpression(e)),this.handlers.set(r.kind,e=>this.visitInsertQuery(e)),this.handlers.set(Ce.kind,e=>this.visitInsertClause(e)),this.handlers.set(vt.kind,e=>this.visitUpdateQuery(e)),this.handlers.set(ye.kind,e=>this.visitUpdateClause(e)),this.handlers.set(fe.kind,e=>this.visitSetClause(e)),this.handlers.set(we.kind,e=>this.visitSetClauseItem(e)),this.handlers.set(me.kind,e=>this.visitReturningClause(e)),this.handlers.set(Et.kind,e=>this.visitCreateTableQuery(e))}static{this.SPACE_TOKEN=new ft(10," ")}static{this.COMMA_TOKEN=new ft(3,",")}static{this.ARGUMENT_SPLIT_COMMA_TOKEN=new ft(11,",")}static{this.PAREN_OPEN_TOKEN=new ft(4,"(")}static{this.PAREN_CLOSE_TOKEN=new ft(4,")")}static{this.DOT_TOKEN=new ft(8,".")}visitBinarySelectQuery(t){let i=new ft(0,"");return i.innerTokens.push(this.visit(t.left)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,t.operator.value,"BinarySelectQueryOperator")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.right)),i}static commaSpaceTokens(){return[e.COMMA_TOKEN,e.SPACE_TOKEN]}static argumentCommaSpaceTokens(){return[e.ARGUMENT_SPLIT_COMMA_TOKEN,e.SPACE_TOKEN]}visitQualifiedName(t){let i=new ft(0,"","QualifiedName");if(t.namespaces)for(let s=0;s<t.namespaces.length;s++)i.innerTokens.push(t.namespaces[s].accept(this)),i.innerTokens.push(e.DOT_TOKEN);return i.innerTokens.push(t.name.accept(this)),i}visitPartitionByClause(t){let i=new ft(1,"partition by","PartitionByClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.value)),i}visitOrderByClause(t){let i=new ft(1,"order by","OrderByClause");i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.order.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.order[s]));return i}visitOrderByItem(t){let i=new ft(0,"","OrderByItem");return i.innerTokens.push(this.visit(t.value)),t.sortDirection&&"asc"!==t.sortDirection&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"desc"))),t.nullsPosition&&("first"===t.nullsPosition?(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"nulls first"))):"last"===t.nullsPosition&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"nulls last")))),i}parse(e){this.index=1;let t=this.visit(e),i=wt.collect(e).sort((e,t)=>(e.index??0)-(t.index??0)),s=this.parameterDecorator.style;if("named"===s){let e={};for(let t of i){let i=t.name.value;if(e.hasOwnProperty(i)){if(e[i]!==t.value)throw new Error(`Duplicate parameter name '${i}' with different values detected during query composition.`)}else e[i]=t.value}return{token:t,params:e}}return"indexed"===s||"anonymous"===s?{token:t,params:i.map(e=>e.value)}:{token:t,params:[]}}visit(e){let t=this.handlers.get(e.getKind());if(t){let i=t(e);return this.addCommentsToToken(i,e.comments),i}throw new Error(`[SqlPrintTokenParser] No handler for kind: ${e.getKind().toString()}`)}addCommentsToToken(e,t){if(!t||0===t.length)return;let i=this.createCommentBlocks(t);i.length>0&&this.insertCommentBlocksWithSpacing(e,i)}createCommentBlocks(e){let t=[];for(let i of e)i.trim()&&t.push(this.createSingleCommentBlock(i));return t}createSingleCommentBlock(e){let t=new ft(0,"","CommentBlock"),i=new ft(6,this.formatBlockComment(e));t.innerTokens.push(i);let s=new ft(12,"");t.innerTokens.push(s);let n=new ft(10," ");return t.innerTokens.push(n),t}insertCommentBlocksWithSpacing(e,t){if(e.innerTokens.unshift(...t),this.shouldAddSeparatorSpace(e.containerType)){let i=new ft(10," ");e.innerTokens.splice(t.length,0,i),e.innerTokens.length>t.length+1&&10===e.innerTokens[t.length+1].type&&e.innerTokens.splice(t.length+1,1)}else e.innerTokens.length>t.length&&10===e.innerTokens[t.length].type&&e.innerTokens.splice(t.length,1)}shouldAddSeparatorSpace(e){return this.isClauseLevelContainer(e)}isClauseLevelContainer(e){switch(e){case"SelectClause":case"FromClause":case"WhereClause":case"GroupByClause":case"HavingClause":case"OrderByClause":case"LimitClause":case"OffsetClause":case"WithClause":case"SimpleSelectQuery":return!0;default:return!1}}formatBlockComment(e){return`/* ${e} */`}visitValueList(t){let i=new ft(0,"","ValueList");for(let s=0;s<t.values.length;s++)s>0&&i.innerTokens.push(...e.argumentCommaSpaceTokens()),i.innerTokens.push(this.visit(t.values[s]));return i}visitColumnReference(e){let t=new ft(0,"","ColumnReference");return t.innerTokens.push(e.qualifiedName.accept(this)),t}visitFunctionCall(t){let i=new ft(0,"","FunctionCall");return i.innerTokens.push(t.qualifiedName.accept(this)),i.innerTokens.push(e.PAREN_OPEN_TOKEN),t.argument&&i.innerTokens.push(this.visit(t.argument)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),t.over&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"over")),t.over instanceof S?(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.over.accept(this))):(i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(this.visit(t.over)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN))),i}visitUnaryExpression(t){let i=new ft(0,"","UnaryExpression");return i.innerTokens.push(this.visit(t.operator)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.expression)),i}visitBinaryExpression(t){let i=new ft(0,"","BinaryExpression");return i.innerTokens.push(this.visit(t.left)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(5,t.operator.value)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.right)),i}visitLiteralValue(e){let t;return t="string"==typeof e.value?e.isDollarString?e.value:`'${e.value.replace(/'/g,"''")}'`:null===e.value?"null":e.value.toString(),new ft(2,t,"LiteralValue")}visitParameterExpression(e){e.index=this.index;let t=this.parameterDecorator.decorate(e.name.value,e.index),i=new ft(7,t);return this.index++,i}visitSwitchCaseArgument(t){let i=new ft(0,"","SwitchCaseArgument");for(let s of t.cases)i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(s.accept(this));return t.elseValue&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.createElseToken(t.elseValue))),i}createElseToken(t){let i=new ft(0,"","ElseClause");i.innerTokens.push(new ft(1,"else")),i.innerTokens.push(e.SPACE_TOKEN);let s=new ft(0,"","CaseElseValue");return s.innerTokens.push(this.visit(t)),i.innerTokens.push(s),i}visitCaseKeyValuePair(t){let i=new ft(0,"","CaseKeyValuePair");i.innerTokens.push(new ft(1,"when")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.key)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"then")),i.innerTokens.push(e.SPACE_TOKEN);let s=new ft(0,"","CaseThenValue");return s.innerTokens.push(this.visit(t.value)),i.innerTokens.push(s),i}visitRawString(e){return new ft(2,e.value,"RawString")}visitIdentifierString(e){let t="*"===e.name?e.name:this.identifierDecorator.decorate(e.name);return new ft(2,t,"IdentifierString")}visitParenExpression(t){let i=new ft(0,"","ParenExpression");return i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(this.visit(t.expression)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitCastExpression(e){let t=new ft(0,"","CastExpression");return t.innerTokens.push(this.visit(e.input)),t.innerTokens.push(new ft(5,"::")),t.innerTokens.push(this.visit(e.castType)),t}visitCaseExpression(t){let i=new ft(0,"","CaseExpression");return i.innerTokens.push(new ft(1,"case")),t.condition&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.condition))),i.innerTokens.push(this.visit(t.switchCase)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"end")),i}visitArrayExpression(e){let t=new ft(0,"","ArrayExpression");return t.innerTokens.push(new ft(1,"array")),t.innerTokens.push(new ft(4,"[")),t.innerTokens.push(this.visit(e.expression)),t.innerTokens.push(new ft(4,"]")),t}visitArrayQueryExpression(e){let t=new ft(0,"","ArrayExpression");return t.innerTokens.push(new ft(1,"array")),t.innerTokens.push(new ft(4,"(")),t.innerTokens.push(this.visit(e.query)),t.innerTokens.push(new ft(4,")")),t}visitArraySliceExpression(e){let t=new ft(0,"","ArrayExpression");return t.innerTokens.push(this.visit(e.array)),t.innerTokens.push(new ft(4,"[")),e.startIndex&&t.innerTokens.push(this.visit(e.startIndex)),t.innerTokens.push(new ft(5,":")),e.endIndex&&t.innerTokens.push(this.visit(e.endIndex)),t.innerTokens.push(new ft(4,"]")),t}visitArrayIndexExpression(e){let t=new ft(0,"","ArrayExpression");return t.innerTokens.push(this.visit(e.array)),t.innerTokens.push(new ft(4,"[")),t.innerTokens.push(this.visit(e.index)),t.innerTokens.push(new ft(4,"]")),t}visitBetweenExpression(t){let i=new ft(0,"","BetweenExpression");return i.innerTokens.push(this.visit(t.expression)),i.innerTokens.push(e.SPACE_TOKEN),t.negated&&(i.innerTokens.push(new ft(1,"not")),i.innerTokens.push(e.SPACE_TOKEN)),i.innerTokens.push(new ft(1,"between")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.lower)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"and")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.upper)),i}visitStringSpecifierExpression(e){let t=e.specifier.accept(this).text,i=e.value.accept(this).text;return new ft(2,t+i,"StringSpecifierExpression")}visitTypeValue(t){let i=new ft(0,"","TypeValue");return i.innerTokens.push(t.qualifiedName.accept(this)),t.argument&&(i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(this.visit(t.argument)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN)),i}visitTupleExpression(t){let i=new ft(0,"","TupleExpression");i.innerTokens.push(e.PAREN_OPEN_TOKEN);for(let s=0;s<t.values.length;s++)s>0&&i.innerTokens.push(...e.argumentCommaSpaceTokens()),i.innerTokens.push(this.visit(t.values[s]));return i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitWindowFrameExpression(t){let i=new ft(0,"","WindowFrameExpression"),s=!0;return t.partition&&(i.innerTokens.push(this.visit(t.partition)),s=!1),t.order&&(s?s=!1:i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.order))),t.frameSpec&&(s?s=!1:i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.frameSpec))),i}visitWindowFrameSpec(t){let i=new ft(0,"","WindowFrameSpec");return i.innerTokens.push(new ft(1,t.frameType)),null===t.endBound?(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.startBound.accept(this))):(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"between")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.startBound.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"and")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.endBound.accept(this))),i}visitWindowFrameBoundaryValue(t){let i=new ft(0,"","WindowFrameBoundaryValue");return i.innerTokens.push(t.value.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,t.isFollowing?"following":"preceding")),i}visitWindowFrameBoundStatic(e){return new ft(1,e.bound)}visitSelectItem(t){let i=new ft(0,"","SelectItem");if(i.innerTokens.push(this.visit(t.value)),!t.identifier)return i;if(t.value instanceof l){let e=t.value.column.name;if(t.identifier.name===e)return i}return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.identifier)),i}visitSelectClause(t){let i=new ft(1,"select","SelectClause"),s="select";for(let e of t.hints)s+=" "+this.visit(e).text;if(t.distinct){let e=t.distinct.accept(this);if(e.innerTokens&&e.innerTokens.length>0){let t=e.text;for(let i of e.innerTokens)t+=this.flattenTokenText(i);s+=" "+t}else s+=" "+e.text}i.text=s,i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.items.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.items[s]));return i}flattenTokenText(e){let t=e.text;if(e.innerTokens)for(let i of e.innerTokens)t+=this.flattenTokenText(i);return t}visitHintClause(e){return new ft(2,e.getFullHint())}visitDistinct(e){return new ft(1,"distinct")}visitDistinctOn(t){let i=new ft(0,"","DistinctOn");return i.innerTokens.push(new ft(1,"distinct on")),i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(t.value.accept(this)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitTableSource(e){let t="";Array.isArray(e.namespaces)&&e.namespaces.length>0&&(t=e.namespaces.map(e=>e.accept(this).text).join(".")+"."),t+=e.table.accept(this).text;let i=new ft(2,t);return e.identifier&&(e.identifier.name,e.table.name),i}visitSourceExpression(t){let i=new ft(0,"","SourceExpression");if(i.innerTokens.push(t.datasource.accept(this)),!t.aliasExpression)return i;if(t.datasource instanceof Y){let s=t.datasource.table.name;return t.aliasExpression.table.name===s||(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.aliasExpression.accept(this))),i}return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.aliasExpression.accept(this)),i}visitFromClause(t){let i=new ft(1,"from","FromClause");if(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.source)),t.joins)for(let s=0;s<t.joins.length;s++)i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.joins[s]));return i}visitJoinClause(t){let i=new ft(0,"","JoinClause");return i.innerTokens.push(new ft(1,t.joinType.value)),t.lateral&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"lateral"))),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.source)),t.condition&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.condition))),i}visitJoinOnClause(t){let i=new ft(0,"","JoinOnClause");return i.innerTokens.push(new ft(1,"on")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.condition)),i}visitJoinUsingClause(t){let i=new ft(0,"","JoinUsingClause");return i.innerTokens.push(new ft(1,"using")),i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(this.visit(t.condition)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitFunctionSource(t){let i=new ft(0,"","FunctionSource");return i.innerTokens.push(t.qualifiedName.accept(this)),i.innerTokens.push(e.PAREN_OPEN_TOKEN),t.argument&&i.innerTokens.push(this.visit(t.argument)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitSourceAliasExpression(t){let i=new ft(0,"","SourceAliasExpression");if(i.innerTokens.push(this.visit(t.table)),t.columns){i.innerTokens.push(e.PAREN_OPEN_TOKEN);for(let s=0;s<t.columns.length;s++)s>0&&i.innerTokens.push(...e.argumentCommaSpaceTokens()),i.innerTokens.push(this.visit(t.columns[s]));i.innerTokens.push(e.PAREN_CLOSE_TOKEN)}return i}visitWhereClause(t){let i=new ft(1,"where","WhereClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.condition)),i}visitGroupByClause(t){let i=new ft(1,"group by","GroupByClause");i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.grouping.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.grouping[s]));return i}visitHavingClause(t){let i=new ft(1,"having","HavingClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.condition)),i}visitWindowClause(t){let i=new ft(1,"window","WindowClause");i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.windows.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.windows[s]));return i}visitWindowFrameClause(t){let i=new ft(0,"","WindowFrameClause");return i.innerTokens.push(t.name.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(e.PAREN_OPEN_TOKEN),i.innerTokens.push(this.visit(t.expression)),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitLimitClause(t){let i=new ft(1,"limit","LimitClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.value)),i}visitOffsetClause(t){let i=new ft(1,"offset","OffsetClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.value)),i}visitFetchClause(t){let i=new ft(1,"fetch","FetchClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.expression)),i}visitFetchExpression(t){let i=new ft(0,"","FetchExpression");return i.innerTokens.push(new ft(1,t.type)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.count.accept(this)),t.unit&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,t.unit))),i}visitForClause(t){let i=new ft(1,"for","ForClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,t.lockMode)),i}visitWithClause(t){let i=new ft(1,"with","WithClause");i.innerTokens.push(e.SPACE_TOKEN),t.recursive&&(i.innerTokens.push(new ft(1,"recursive")),i.innerTokens.push(e.SPACE_TOKEN));for(let s=0;s<t.tables.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(t.tables[s].accept(this));return i.innerTokens.push(e.SPACE_TOKEN),i}visitCommonTable(t){let i=new ft(0,"","CommonTable");i.innerTokens.push(t.aliasExpression.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),null!==t.materialized&&(t.materialized?i.innerTokens.push(new ft(1,"materialized")):i.innerTokens.push(new ft(1,"not materialized")),i.innerTokens.push(e.SPACE_TOKEN)),i.innerTokens.push(e.PAREN_OPEN_TOKEN);let s=new ft(0,"","SubQuerySource");return s.innerTokens.push(t.query.accept(this)),i.innerTokens.push(s),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitSimpleQuery(t){let i=new ft(0,"","SimpleSelectQuery");return t.withClause&&i.innerTokens.push(t.withClause.accept(this)),i.innerTokens.push(t.selectClause.accept(this)),t.fromClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.fromClause.accept(this)),t.whereClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.whereClause.accept(this))),t.groupByClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.groupByClause.accept(this))),t.havingClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.havingClause.accept(this))),t.orderByClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.orderByClause.accept(this))),t.windowClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.windowClause.accept(this))),t.limitClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.limitClause.accept(this))),t.offsetClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.offsetClause.accept(this))),t.fetchClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.fetchClause.accept(this))),t.forClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.forClause.accept(this)))),i}visitSubQuerySource(t){let i=new ft(0,"");i.innerTokens.push(e.PAREN_OPEN_TOKEN);let s=new ft(0,"","SubQuerySource");return s.innerTokens.push(t.query.accept(this)),i.innerTokens.push(s),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitValuesQuery(t){let i=new ft(1,"values","ValuesQuery");i.innerTokens.push(e.SPACE_TOKEN);let s=new ft(0,"","Values");for(let i=0;i<t.tuples.length;i++)i>0&&s.innerTokens.push(...e.commaSpaceTokens()),s.innerTokens.push(t.tuples[i].accept(this));return i.innerTokens.push(s),i}visitInlineQuery(t){let i=new ft(0,"");i.innerTokens.push(e.PAREN_OPEN_TOKEN);let s=new ft(0,"","InlineQuery");return s.innerTokens.push(t.selectQuery.accept(this)),i.innerTokens.push(s),i.innerTokens.push(e.PAREN_CLOSE_TOKEN),i}visitInsertQuery(t){let i=new ft(0,"","InsertQuery");return i.innerTokens.push(this.visit(t.insertClause)),t.selectQuery&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(this.visit(t.selectQuery))),i}visitInsertClause(t){let i=new ft(0,"");if(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"insert into")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.source.accept(this)),t.columns.length>0){i.innerTokens.push(e.PAREN_OPEN_TOKEN);for(let s=0;s<t.columns.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(t.columns[s].accept(this));i.innerTokens.push(e.PAREN_CLOSE_TOKEN)}return i}visitUpdateQuery(t){let i=new ft(0,"","UpdateQuery");return t.withClause&&i.innerTokens.push(t.withClause.accept(this)),i.innerTokens.push(t.updateClause.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.setClause.accept(this)),t.fromClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.fromClause.accept(this))),t.whereClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.whereClause.accept(this))),t.returningClause&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.returningClause.accept(this))),i}visitUpdateClause(t){let i=new ft(1,"update","UpdateClause");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.source.accept(this)),i}visitSetClause(t){let i=new ft(1,"set","SelectClause");i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.items.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.items[s]));return i}visitSetClauseItem(t){let i=new ft(0,"","SetClauseItem");return i.innerTokens.push(t.column.accept(this)),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(5,"=")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.value.accept(this)),i}visitReturningClause(t){let i=new ft(1,"returning","ReturningClause");i.innerTokens.push(e.SPACE_TOKEN);for(let s=0;s<t.columns.length;s++)s>0&&i.innerTokens.push(...e.commaSpaceTokens()),i.innerTokens.push(this.visit(t.columns[s]));return i}visitCreateTableQuery(t){let i=new ft(1,t.isTemporary?"create temporary table":"create table","CreateTableQuery");return i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.tableName.accept(this)),t.asSelectQuery&&(i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(new ft(1,"as")),i.innerTokens.push(e.SPACE_TOKEN),i.innerTokens.push(t.asSelectQuery.accept(this))),i}},Tt=class{constructor(e=" ",t=0,i="\r\n"){this.indentChar=e,this.indentSize=t,this.newline=i,this.lines=[],this.appendNewline(0)}print(){let e="";for(let t of this.lines)""!==t.text&&(e+=this.indent(t.level)+t.text);return e.trimEnd()}indent(e){return this.indentChar.repeat(this.indentSize*e)}appendNewline(e){if(this.lines.length>0){let e=this.lines[this.lines.length-1];""!==e.text&&(e.text=e.text.trimEnd()+this.newline)}this.lines.push(new kt(e,""))}appendText(e){if(!(this.lines.length>0))throw new Error("No tokens to append to.");{let t=this.lines.length-1,i=this.lines[t];" "===e&&""===i.text||(i.text+=e)}}getCurrentLine(){if(this.lines.length>0)return this.lines[this.lines.length-1];throw new Error("No tokens to get current line from.")}},kt=class{constructor(e,t){this.level=e,this.text=t}},bt=class e{constructor(e){this.insideWithClause=!1,this.indentChar=e?.indentChar??"",this.indentSize=e?.indentSize??0,this.newline=e?.newline??" ",this.commaBreak=e?.commaBreak??"none",this.andBreak=e?.andBreak??"none",this.keywordCase=e?.keywordCase??"none",this.exportComment=e?.exportComment??!1,this.strictCommentPlacement=e?.strictCommentPlacement??!1,this.withClauseStyle=e?.withClauseStyle??"standard",this.linePrinter=new Tt(this.indentChar,this.indentSize,this.newline),this.indentIncrementContainers=new Set(e?.indentIncrementContainerTypes??["SelectClause","FromClause","WhereClause","GroupByClause","HavingClause","WindowFrameExpression","PartitionByClause","OrderByClause","WindowClause","LimitClause","OffsetClause","SubQuerySource","BinarySelectQueryOperator","Values","WithClause","SwitchCaseArgument","CaseKeyValuePair","CaseThenValue","ElseClause","CaseElseValue","SimpleSelectQuery"])}print(e,t=0){return this.linePrinter=new Tt(this.indentChar,this.indentSize,this.newline),this.insideWithClause=!1,this.linePrinter.lines.length>0&&t!==this.linePrinter.lines[0].level&&(this.linePrinter.lines[0].level=t),this.appendToken(e,t,void 0),this.linePrinter.print()}appendToken(e,t,i){if(this.insideWithClause,"WithClause"===e.containerType&&"full-oneline"===this.withClauseStyle&&(this.insideWithClause=!0),this.shouldSkipToken(e))return;let s=this.linePrinter.getCurrentLine();if(1===e.type)this.handleKeywordToken(e,t);else if(3===e.type)this.handleCommaToken(e,t,i);else if(5===e.type&&"and"===e.text.toLowerCase())this.handleAndOperatorToken(e,t);else if("JoinClause"===e.containerType)this.handleJoinClauseToken(e,t);else if(6===e.type)this.exportComment&&this.linePrinter.appendText(e.text);else if(10===e.type)this.handleSpaceToken(e,i);else if(12===e.type)this.handleCommentNewlineToken(e,t);else{if("CommonTable"===e.containerType&&"cte-oneline"===this.withClauseStyle)return void this.handleCteOnelineToken(e,t);this.linePrinter.appendText(e.text)}if(e.keywordTokens&&e.keywordTokens.length>0)for(let i=0;i<e.keywordTokens.length;i++){let s=e.keywordTokens[i];this.appendToken(s,t,e.containerType)}let n=t;!this.isOnelineMode()&&""!==s.text&&this.indentIncrementContainers.has(e.containerType)&&(this.insideWithClause&&"full-oneline"===this.withClauseStyle||(n++,this.linePrinter.appendNewline(n)));for(let t=0;t<e.innerTokens.length;t++){let i=e.innerTokens[t];this.appendToken(i,n,e.containerType)}if("WithClause"===e.containerType&&"full-oneline"===this.withClauseStyle)return this.insideWithClause=!1,void this.linePrinter.appendNewline(t);n!==t&&(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t))}shouldSkipToken(e){return 12!==e.type&&(!e.innerTokens||0===e.innerTokens.length)&&""===e.text}applyKeywordCase(e){return"upper"===this.keywordCase?e.toUpperCase():"lower"===this.keywordCase?e.toLowerCase():e}handleKeywordToken(e,t){let i=this.applyKeywordCase(e.text);this.linePrinter.appendText(i)}handleCommaToken(e,t,i){let s=e.text;this.insideWithClause&&"full-oneline"===this.withClauseStyle?this.linePrinter.appendText(s):"cte-oneline"===this.withClauseStyle&&"WithClause"===i?(this.linePrinter.appendText(s),this.linePrinter.appendNewline(t)):"before"===this.commaBreak?(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(s)):"after"===this.commaBreak?(this.linePrinter.appendText(s),this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t)):this.linePrinter.appendText(s)}handleAndOperatorToken(e,t){let i=this.applyKeywordCase(e.text);"before"===this.andBreak?(this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(i)):"after"===this.andBreak?(this.linePrinter.appendText(i),this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t)):this.linePrinter.appendText(i)}handleJoinClauseToken(e,t){let i=this.applyKeywordCase(e.text);this.insideWithClause&&"full-oneline"===this.withClauseStyle||this.linePrinter.appendNewline(t),this.linePrinter.appendText(i)}handleSpaceToken(e,t){this.shouldSkipCommentBlockSpace(t)||this.linePrinter.appendText(e.text)}shouldSkipCommentBlockSpace(e){return"CommentBlock"===e&&this.insideWithClause&&"full-oneline"===this.withClauseStyle}handleCommentNewlineToken(e,t){this.shouldSkipCommentNewline()||this.isOnelineMode()||this.linePrinter.appendNewline(t)}shouldSkipCommentNewline(){return this.insideWithClause&&"full-oneline"===this.withClauseStyle||"cte-oneline"===this.withClauseStyle}isOnelineMode(){return" "===this.newline}handleCteOnelineToken(e,t){let i=this.createCteOnelinePrinter().print(e,t),s=this.cleanDuplicateSpaces(i);this.linePrinter.appendText(s)}createCteOnelinePrinter(){return new e({indentChar:"",indentSize:0,newline:" ",commaBreak:this.commaBreak,andBreak:this.andBreak,keywordCase:this.keywordCase,exportComment:this.exportComment,strictCommentPlacement:this.strictCommentPlacement,withClauseStyle:"standard"})}cleanDuplicateSpaces(e){return e.replace(/\s{2,}/g," ")}},Nt=["mysql","postgres","sqlserver","sqlite"],It=class{constructor(e={}){let t=e.preset?xt[e.preset]:void 0;if(e.preset&&!t)throw new Error(`Invalid preset: ${e.preset}`);let i={...t,identifierEscape:e.identifierEscape??t?.identifierEscape,parameterSymbol:e.parameterSymbol??t?.parameterSymbol,parameterStyle:e.parameterStyle??t?.parameterStyle};this.parser=new St(i),this.printer=new bt(e)}format(e){let{token:t,params:i}=this.parser.parse(e);return{formattedSql:this.printer.print(t),params:i}}},At=class{constructor(){this.sqlFormatter=new It({identifierEscape:{start:'"',end:'"'},parameterSymbol:":",parameterStyle:"named"})}format(e,t=null){return t&&(this.sqlFormatter=new It(t)),this.sqlFormatter.format(e).formattedSql}formatWithParameters(e,t=null){t&&(this.sqlFormatter=new It(t));let i=this.sqlFormatter.format(e);return{sql:i.formattedSql,params:i.params}}visit(e){return this.format(e)}},Ot=class{constructor(){this.sourceCollector=new dt(!0),this.cteCollector=new ct,this.formatter=new At}build(e){if(0===e.length)return new oe(!1,e);let t=this.resolveDuplicateNames(e),{tableMap:i,recursiveCTEs:s,dependencies:n}=this.buildDependencyGraph(t),r=this.sortCommonTables(t,i,s,n);return new oe(s.size>0,r)}resolveDuplicateNames(e){let t=new Map;for(let i of e){let e=i.aliasExpression.table.name;t.has(e)||t.set(e,[]),t.get(e).push(i)}let i=[];for(let[e,s]of t.entries()){if(1===s.length){i.push(s[0]);continue}let t=s.map(e=>this.formatter.format(e.query));if(1!==new Set(t).size)throw new Error(`CTE name conflict detected: '${e}' has multiple different definitions`);i.push(s[0])}return i}buildDependencyGraph(e){let t=new Map;for(let i of e)t.set(i.aliasExpression.table.name,i);let i=new Set,s=new Map,n=new Map;for(let r of e){let e=r.aliasExpression.table.name,a=this.sourceCollector.collect(r.query);for(let t of a)if(t.table.name===e){i.add(e);break}s.has(e)||s.set(e,new Set);let o=this.cteCollector.collect(r.query);for(let i of o){let r=i.aliasExpression.table.name;t.has(r)&&(s.get(e).add(r),n.has(r)||n.set(r,new Set),n.get(r).add(e))}}return{tableMap:t,recursiveCTEs:i,dependencies:s}}sortCommonTables(e,t,i,s){let n=[],r=[],a=new Set,o=new Set,l=e=>{if(a.has(e))return;if(o.has(e))throw new Error(`Circular reference detected in CTE: ${e}`);o.add(e);let u=s.get(e)||new Set;for(let e of u)l(e);o.delete(e),a.add(e),i.has(e)?n.push(t.get(e)):r.push(t.get(e))};for(let t of e){let e=t.aliasExpression.table.name;a.has(e)||l(e)}return[...n,...r]}},Pt=class{constructor(){this.nameConflictResolver=new Ot,this.cteCollector=new ct}inject(e,t){if(0===t.length)return e;t.push(...this.cteCollector.collect(e));let i=this.nameConflictResolver.build(t);if(e instanceof Dt)return this.injectIntoSimpleQuery(e,i);if(e instanceof Mt)return this.injectIntoBinaryQuery(e,i);throw new Error("Unsupported query type")}injectIntoSimpleQuery(e,t){if(e.withClause)throw new Error("The query already has a WITH clause. Please remove it before injecting new CTEs.");return e.withClause=t,e}injectIntoBinaryQuery(e,t){if(e.left instanceof Dt)return this.injectIntoSimpleQuery(e.left,t),e;if(e.left instanceof Mt)return this.injectIntoBinaryQuery(e.left,t),e;throw new Error("Unsupported query type for BinarySelectQuery left side")}},$t=class{constructor(){}static normalize(e){let t=(new ct).collect(e);return 0===t.length?e:((new pt).execute(e),(new Pt).inject(e,t))}},Ft=((B=Ft||{}).ColumnNameOnly="columnNameOnly",B.FullName="fullName",B),Lt=class e{constructor(e,t=!1,i="columnNameOnly",s){this.selectValues=[],this.visitedNodes=new Set,this.uniqueKeys=new Set,this.isRootVisit=!0,this.tableColumnResolver=null,this.commonTables=[],this.initializeProperties(e,t,i,s),this.initializeHandlers()}initializeProperties(e,t,i,s){this.tableColumnResolver=e??null,this.includeWildCard=t,this.commonTableCollector=new ct,this.commonTables=[],this.duplicateDetection=i,this.options=s||{}}initializeHandlers(){this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e)),this.initializeClauseHandlers(),this.initializeValueComponentHandlers()}initializeClauseHandlers(){this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(M.kind,e=>this.visitWindowFrameClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(ue.kind,e=>this.offsetClause(e)),this.handlers.set(he.kind,e=>this.visitFetchClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e))}initializeValueComponentHandlers(){this.handlers.set(l.kind,e=>this.visitColumnReference(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(f.kind,e=>this.visitWindowFrameExpression(e)),this.handlers.set(D.kind,e=>this.visitPartitionByClause(e))}getValues(){return this.selectValues}collect(e){if(!e)throw new Error("Input argument cannot be null or undefined");this.visit(e);let t=this.getValues();return this.reset(),t}reset(){this.selectValues=[],this.visitedNodes.clear(),this.uniqueKeys.clear(),this.commonTables=[]}addSelectValueAsUnique(e,t){let i=this.generateUniqueKey(e,t);this.uniqueKeys.has(i)||(this.uniqueKeys.add(i),this.selectValues.push({name:e,value:t}))}generateUniqueKey(e,t){if("columnNameOnly"===this.duplicateDetection)return this.normalizeColumnName(e);{let i="";t&&"function"==typeof t.getNamespace&&(i=t.getNamespace()||"");let s=i?i+"."+e:e;return this.normalizeColumnName(s)}}normalizeColumnName(e){if("string"!=typeof e)throw new Error("Column name must be a string");return this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e}visit(e){if(this.isRootVisit){if(!(e instanceof Dt||e instanceof Mt))throw new Error("Root visit requires a SimpleSelectQuery or BinarySelectQuery.");this.reset(),this.isRootVisit=!1,this.commonTables=this.commonTableCollector.collect(e);try{this.visitNode(e)}finally{this.isRootVisit=!0}}else this.visitNode(e)}visitNode(e){if(!this.visitedNodes.has(e)){this.visitedNodes.add(e);try{let t=this.handlers.get(e.getKind());t&&t(e)}catch(t){let i=t instanceof Error?t.message:String(t);throw new Error(`Error processing SQL component of type ${e.getKind().toString()}: ${i}`)}}}visitSimpleSelectQuery(e){if(e.selectClause&&e.selectClause.accept(this),e.fromClause&&e.fromClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.windowClause)for(let t of e.windowClause.windows)t.accept(this);e.orderByClause&&e.orderByClause.accept(this),e.limitClause&&e.limitClause.accept(this),e.offsetClause&&e.offsetClause.accept(this),e.fetchClause&&e.fetchClause.accept(this),e.forClause&&e.forClause.accept(this)}visitBinarySelectQuery(e){e.left instanceof Dt?this.visitSimpleSelectQuery(e.left):e.left instanceof Mt&&this.visitBinarySelectQuery(e.left),e.right instanceof Dt?this.visitSimpleSelectQuery(e.right):e.right instanceof Mt&&this.visitBinarySelectQuery(e.right)}visitSelectClause(e){for(let t of e.items)t.identifier&&this.addSelectValueAsUnique(t.identifier.name,t.value),t.value.accept(this)}visitFromClause(e){let t=new gt(this.tableColumnResolver,this.commonTables).collect(e);for(let e of t)this.addSelectValueAsUnique(e.name,e.value);if(this.options.upstream&&this.collectUpstreamColumns(e),e.joins)for(let t of e.joins)t.condition&&t.condition.accept(this)}visitWhereClause(e){e.condition&&e.condition.accept(this)}visitGroupByClause(e){if(e.grouping)for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition&&e.condition.accept(this)}visitOrderByClause(e){if(e.order)for(let t of e.order)t.accept(this)}visitWindowFrameClause(e){e.expression.accept(this)}visitWindowFrameExpression(e){e.partition&&e.partition.accept(this),e.order&&e.order.accept(this),e.frameSpec&&e.frameSpec.accept(this)}visitLimitClause(e){e.value&&e.value.accept(this)}offsetClause(e){e.value&&e.value.accept(this)}visitFetchClause(e){e.expression&&e.expression.accept(this)}visitJoinOnClause(e){e.condition&&e.condition.accept(this)}visitJoinUsingClause(e){e.condition&&e.condition.accept(this)}visitColumnReference(e){if("*"!==e.column.name)this.addSelectValueAsUnique(e.column.name,e);else{if(!this.includeWildCard)return;this.addSelectValueAsUnique(e.column.name,e)}}visitBinaryExpression(e){e.left&&e.left.accept(this),e.right&&e.right.accept(this)}visitUnaryExpression(e){e.expression&&e.expression.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this),e.over&&e.over.accept(this)}visitParenExpression(e){e.expression&&e.expression.accept(this)}visitCaseExpression(e){e.condition&&e.condition.accept(this),e.switchCase&&e.switchCase.accept(this)}visitCastExpression(e){e.input&&e.input.accept(this)}visitBetweenExpression(e){e.expression&&e.expression.accept(this),e.lower&&e.lower.accept(this),e.upper&&e.upper.accept(this)}visitArrayExpression(e){e.expression&&e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitValueList(e){if(e.values)for(let t of e.values)t.accept(this)}visitPartitionByClause(e){e.value.accept(this)}collectUpstreamColumns(e){if(this.collectUpstreamColumnsFromSource(e.source),e.joins)for(let t of e.joins)this.collectUpstreamColumnsFromSource(t.source)}collectUpstreamColumnsFromSource(e){if(e.datasource instanceof Y){let t=this.findCTEByName(e.datasource.table.name);t?this.collectUpstreamColumnsFromCTE(t):this.collectUpstreamColumnsFromTable(e.datasource)}else e.datasource instanceof ee?this.collectUpstreamColumnsFromSubquery(e.datasource):e.datasource instanceof Z&&this.collectUpstreamColumnsFromSource(new te(e.datasource.source,null))}collectUpstreamColumnsFromTable(e){if(this.tableColumnResolver){let t=e.table.name,i=this.tableColumnResolver(t);for(let t of i){let i=new l(e.table.name,t);this.addSelectValueAsUnique(t,i)}}}collectUpstreamColumnsFromSubquery(t){if(t.query instanceof Dt){let i=new e(this.tableColumnResolver,this.includeWildCard,this.duplicateDetection,{...this.options,upstream:!0}).collect(t.query);for(let e of i)this.addSelectValueAsUnique(e.name,e.value)}}collectUpstreamColumnsFromCTE(e){if(e.query instanceof Dt){let t=new gt(this.tableColumnResolver,this.commonTables).collect(e.query.selectClause);for(let e of t)this.addSelectValueAsUnique(e.name,e.value)}}findCTEByName(e){return this.commonTables.find(t=>t.getSourceAliasName()===e)||null}},Rt=class e{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The source component is complete but there are additional tokens.`);return i.value}static parseTableSourceFromLexemes(e,t){let i=ze.parseFromLexeme(e,t);return this.parseTableSource(i)}static parseFromLexeme(t,i){let s=i;if(s<t.length&&4&t[s].type)return this.parseParenSource(t,s);let n=ze.parseFromLexeme(t,s);return 2048&n.lastTokenType?e.parseFunctionSource(t,n):e.parseTableSource(n)}static parseTableSource(e){let{namespaces:t,name:i,newIndex:s}=e;return{value:new Y(t,i.name),newIndex:s}}static parseFunctionSource(e,t){let i=t.newIndex,{namespaces:s,name:n}=t,r=ht.parseArgument(4,8,e,i);i=r.newIndex;let a=n.name;return{value:new X({namespaces:s,name:a},r.value),newIndex:i}}static parseParenSource(e,t){let i=t;if(i++,i>=e.length)throw new Error(`Syntax error: Unexpected end of input at position ${i}. Expected a subquery or nested expression after opening parenthesis.`);let s=e[i].value;if("select"===s||"values"===s||"with"===s){let t=this.parseSubQuerySource(e,i);if(i=t.newIndex,!(i<e.length&&8==e[i].type))throw new Error(`Syntax error at position ${i}: Missing closing parenthesis. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:t.value,newIndex:i}}if(4==e[i].type){let t=this.parseParenSource(e,i);if(i=t.newIndex,!(i<e.length&&8==e[i].type))throw new Error(`Syntax error at position ${i}: Missing closing parenthesis. Each opening parenthesis must have a matching closing parenthesis.`);return i++,{value:t.value,newIndex:i}}throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword, 'VALUES' keyword, or opening parenthesis '(' but found "${e[i].value}".`)}static parseSubQuerySource(e,t){let i=t,{value:s,newIndex:n}=pi.parseFromLexeme(e,i);return i=n,{value:new ee(s),newIndex:i}}},_t=class extends Error{constructor(e){super(`CTE '${e}' already exists in the query`),this.cteName=e,this.name="DuplicateCTEError"}},Bt=class extends Error{constructor(e,t){super(`Invalid CTE name '${e}': ${t}`),this.cteName=e,this.name="InvalidCTENameError"}},jt=class extends Error{constructor(e){super(`CTE '${e}' not found in the query`),this.cteName=e,this.name="CTENotFoundError"}},qt=class{constructor(e,t){this.options=t||{},this.tableColumnResolver=e,this.columnCollector=new Lt(this.tableColumnResolver)}find(e,t){let i="string"==typeof t?[t]:t,s=(new ct).collect(e),n=new Map;for(let e of s)n.set(e.getSourceAliasName(),e);return this.findUpstream(e,i,n)}handleTableSource(e,t,i){let s=i.get(e.table.name);if(s){let n=new Map(i);n.delete(e.table.name);let r=this.findUpstream(s.query,t,n);return 0===r.length?null:r}return null}handleSubQuerySource(e,t,i){let s=this.findUpstream(e.query,t,i);return 0===s.length?null:s}processFromClauseBranches(e,t,i){let s=e.getSources();if(0===s.length)return null;let n=[],r=!0,a=0;for(let e of s){let s=e.datasource,o=null;if(s instanceof Y)o=this.handleTableSource(s,t,i),a++;else{if(!(s instanceof ee)){if(s instanceof Kt)continue;r=!1;break}o=this.handleSubQuerySource(s,t,i),a++}if(null===o){r=!1;break}n.push(o)}return r&&n.length===a?n.flat():null}findUpstream(e,t,i){if(e instanceof Dt){let s=e.fromClause;if(s){let e=this.processFromClauseBranches(s,t,i);if(e&&e.length>0)return e}let n=[...this.columnCollector.collect(e).map(e=>e.name),...this.collectCTEColumns(e,i)],r=e=>this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e;return t.every(e=>n.some(t=>r(t)===r(e)))?[e]:[]}return e instanceof Mt?[...this.findUpstream(e.left,t,i),...this.findUpstream(e.right,t,i)]:[]}collectCTEColumns(e,t){let i=[];if(e.withClause)for(let t of e.withClause.tables){let e=this.collectColumnsFromSelectQuery(t.query);i.push(...e)}return i}collectColumnsFromSelectQuery(e){if(e instanceof Dt)try{return this.columnCollector.collect(e).map(e=>e.name)}catch(e){return console.warn("Failed to collect columns from SimpleSelectQuery:",e),[]}else if(e instanceof Mt)return this.collectColumnsFromSelectQuery(e.left);return[]}},Qt=class{static parseFromLexeme(e,t){let i=t;if(i<e.length&&(64&e[i].type||2048&e[i].type)){let s=e[i].value;if(i++,i<e.length&&4&e[i].type){let n=[];for(i++;i<e.length&&64&e[i].type&&(n.push(e[i].value),i++,i<e.length&&16&e[i].type);)i++;if(!(8&e[i].type))throw new Error(`Syntax error at position ${i}: Missing closing parenthesis ')' for column alias list. Each opening parenthesis must have a matching closing parenthesis.`);if(i++,0===n.length)throw new Error(`Syntax error at position ${t}: No column aliases found. Column alias declarations must contain at least one column name.`);return{value:new de(s,n),newIndex:i}}return{value:new de(s,null),newIndex:i}}throw new Error(`Syntax error at position ${t}: Expected an identifier for table alias but found "${e[t]?.value||"end of input"}".`)}},Ut=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The source expression is complete but there are additional tokens.`);return i.value}static parseTableSourceFromLexemes(e,t){let i=Rt.parseTableSourceFromLexemes(e,t);return{value:new te(i.value,null),newIndex:i.newIndex}}static parseFromLexeme(e,t){let i=t,s=Rt.parseFromLexeme(e,i);if(i=s.newIndex,i<e.length){if("as"===e[i].value){i++;let t=Qt.parseFromLexeme(e,i);return i=t.newIndex,{value:new te(s.value,t.value),newIndex:i}}if(i<e.length&&this.isTokenTypeAliasCandidate(e[i].type)){let t=Qt.parseFromLexeme(e,i);return i=t.newIndex,{value:new te(s.value,t.value),newIndex:i}}}return{value:new te(s.value,null),newIndex:i}}static isTokenTypeAliasCandidate(e){return!!(64&e)||!!(2048&e)}},Vt=class e{static buildBinaryQuery(t,i){if(!t||0===t.length)throw new Error("No queries provided to combine.");if(1===t.length)throw new Error("At least two queries are required to create a BinarySelectQuery.");let s=t=>t instanceof Kt?e.buildSimpleQuery(t):t,n=new Mt(s(t[0]),i,s(t[1]));$t.normalize(n);for(let e=2;e<t.length;e++)n.appendSelectQuery(i,s(t[e]));return n}constructor(){}static buildSimpleQuery(t){if(t instanceof Dt)return t;if(t instanceof Mt)return e.buildSimpleBinaryQuery(t);if(t instanceof Kt)return e.buildSimpleValuesQuery(t);throw new Error("Unsupported query type for buildSimpleQuery")}static buildSimpleBinaryQuery(t){let i=new ee(t),s=new te(i,new de("bq",null)),n=new re(s,null),r=e.createSelectAllClause(),a=new Dt({selectClause:r,fromClause:n});return $t.normalize(a)}static buildSimpleValuesQuery(e){let t=e.tuples.length>0?e.tuples[0].values.length:0;if(0===e.tuples.length)throw new Error("Empty VALUES clause cannot be converted to a SimpleSelectQuery");if(!e.columnAliases)throw new Error("Column aliases are required to convert a VALUES clause to SimpleSelectQuery. Please specify column aliases.");if(e.columnAliases.length!==t)throw new Error(`The number of column aliases (${e.columnAliases.length}) does not match the number of columns in the first tuple (${t}).`);let i=new ee(e),s=new te(i,new de("vq",e.columnAliases)),n=new re(s,null),r=e.columnAliases.map(e=>new q(new l("vq",e),e)),a=new Q(r,null);return new Dt({selectClause:a,fromClause:n})}static createSelectAllClause(){let e=new l(null,"*"),t=new q(e,"*");return new Q([t],null)}static buildCreateTableQuery(e,t,i=!1){return new Et({tableName:t,isTemporary:i,asSelectQuery:e})}static buildInsertQuery(e,t){let i,s=e.selectClause.items.length;if(i=(new gt).collect(e).map(e=>e.name),!i.length||s!==i.length)throw new Error(`Columns cannot be inferred from the selectQuery. Make sure you are not using wildcards or unnamed columns.\nSelect clause column count: ${s}, Columns with valid names: ${i.length}\nDetected column names: [${i.join(", ")}]`);let n=Ut.parse(t);return new r({insertClause:new Ce(n,i),selectQuery:e})}static buildUpdateQuery(e,t,i,s){let n=new ye(Ut.parse(i)),r=Array.isArray(s)?s:[s],a=(new gt).collect(e),o=(new ct).collect(e);(new pt).execute(e);for(let e of r)if(!a.some(t=>t.name===e))throw new Error(`Primary key column '${e}' is not present in selectQuery select list.`);let u=n.getSourceAliasName();if(!u)throw new Error("Source expression does not have an alias. Please provide an alias for the source expression.");let h=a.filter(e=>!r.includes(e.name)).map(e=>new we(e.name,new l(u,e.name))),c=new fe(h),p=new re(e.toSource(t),null),d=null;for(let e of r){let i=new y(new l(u,e),"=",new l(t,e));d=d?new y(d,"and",i):i}let m=new W(d);return new vt({updateClause:n,setClause:c,fromClause:p,whereClause:m,withClause:o.length>0?new oe(!1,o):void 0})}},Wt=class{static set(e,t,i){let s=wt.collect(e),n=!1;for(let e of s)e.name.value===t&&(e.value=i,n=!0);if(!n)throw new Error(`Parameter '${t}' not found in query.`)}},Dt=class extends n{constructor(e){super(),this.cteNameCache=new Set,this.withClause=e.withClause??null,this.selectClause=e.selectClause,this.fromClause=e.fromClause??null,this.whereClause=e.whereClause??null,this.groupByClause=e.groupByClause??null,this.havingClause=e.havingClause??null,this.orderByClause=e.orderByClause??null,this.windowClause=e.windowClause??null,this.limitClause=e.limitClause??null,this.offsetClause=e.offsetClause??null,this.fetchClause=e.fetchClause??null,this.forClause=e.forClause??null,this.initializeCTECache()}static{this.kind=Symbol("SelectQuery")}initializeCTECache(){if(this.cteNameCache.clear(),this.withClause?.tables)for(let e of this.withClause.tables)this.cteNameCache.add(e.aliasExpression.table.name)}toUnion(e){return this.toBinaryQuery("union",e)}toUnionAll(e){return this.toBinaryQuery("union all",e)}toIntersect(e){return this.toBinaryQuery("intersect",e)}toIntersectAll(e){return this.toBinaryQuery("intersect all",e)}toExcept(e){return this.toBinaryQuery("except",e)}toExceptAll(e){return this.toBinaryQuery("except all",e)}toBinaryQuery(e,t){return Vt.buildBinaryQuery([this,t],e)}appendWhereRaw(e){let t=ht.parse(e);this.appendWhere(t)}appendWhere(e){this.whereClause?this.whereClause.condition=new y(this.whereClause.condition,"and",e):this.whereClause=new W(e)}appendHavingRaw(e){let t=ht.parse(e);this.appendHaving(t)}appendHaving(e){this.havingClause?this.havingClause.condition=new y(this.havingClause.condition,"and",e):this.havingClause=new G(e)}innerJoinRaw(e,t,i,s=null){this.joinSourceRaw("inner join",e,t,i,s)}leftJoinRaw(e,t,i,s=null){this.joinSourceRaw("left join",e,t,i,s)}rightJoinRaw(e,t,i,s=null){this.joinSourceRaw("right join",e,t,i,s)}innerJoin(e,t,i=null){this.joinSource("inner join",e,t,i)}leftJoin(e,t,i=null){this.joinSource("left join",e,t,i)}rightJoin(e,t,i=null){this.joinSource("right join",e,t,i)}joinSourceRaw(e,t,i,s,n=null){let r=Rt.parse(t),a=new te(r,new de(i,null));this.joinSource(e,a,s,n)}joinSource(e,t,i,s=null){if(!this.fromClause)throw new Error("A FROM clause is required to add a JOIN condition.");let n=Array.isArray(i)?i:[i],r=new Lt(s).collect(this),a=null,o=0,u=t.getAliasName();if(!u)throw new Error("An alias is required for the source expression to add a JOIN condition.");for(let e of r)if(n.some(t=>t==e.name)){let t=new y(e.value,"=",new l([u],e.name));a=a?new y(a,"and",t):t,o++}if(!a||o!==n.length)throw new Error(`Invalid JOIN condition. The specified columns were not found: ${n.join(", ")}`);let h=new ie(a),c=new ne(e,t,h,!1);this.fromClause&&(this.fromClause.joins?this.fromClause.joins.push(c):this.fromClause.joins=[c]),$t.normalize(this)}toSource(e){if(!e||""===e.trim())throw new Error("Alias is required for toSource(). Please specify a non-empty alias name.");return new te(new ee(this),new de(e,null))}appendWith(e){let t=Array.isArray(e)?e:[e];this.withClause?this.withClause.tables.push(...t):this.withClause=new oe(!1,t),$t.normalize(this)}appendWithRaw(e,t){let i=pi.parse(e),s=new ae(i,t,null);this.appendWith(s)}overrideSelectItemExpr(e,t){let i=this.selectClause.items.filter(t=>t.identifier?.name===e);if(0===i.length)throw new Error(`Column ${e} not found in the query`);if(i.length>1)throw new Error(`Duplicate column name ${e} found in the query`);let s=i[0],n=t((new At).visit(s.value));s.value=ht.parse(n)}appendWhereExpr(e,t,i){if(i&&i.upstream){let i=(new qt).find(this,[e]),s=new Lt,n=new At;for(let r of i){let i=s.collect(r).filter(t=>t.name===e).map(e=>e.value);if(1!==i.length)throw new Error(`Expected exactly one expression for column '${e}'`);let a=n.format(i[0]);r.appendWhereRaw(t(a))}}else{let i=new Lt,s=new At,n=i.collect(this).filter(t=>t.name===e).map(e=>e.value);if(1!==n.length)throw new Error(`Expected exactly one expression for column '${e}'`);let r=s.format(n[0]);this.appendWhereRaw(t(r))}}setParameter(e,t){return Wt.set(this,e,t),this}toSimpleQuery(){return this}addCTE(e,t,i){if(!e||""===e.trim())throw new Bt(e,"name cannot be empty or whitespace-only");if(this.hasCTE(e))throw new _t(e);let s=new ae(t,e,i?.materialized??null);return this.appendWith(s),this.cteNameCache.add(e),this}removeCTE(e){if(!this.hasCTE(e))throw new jt(e);return this.withClause&&(this.withClause.tables=this.withClause.tables.filter(t=>t.aliasExpression.table.name!==e),0===this.withClause.tables.length&&(this.withClause=null)),this.cteNameCache.delete(e),this}hasCTE(e){return this.cteNameCache.has(e)}getCTENames(){return this.withClause?.tables.map(e=>e.aliasExpression.table.name)??[]}replaceCTE(e,t,i){if(!e||""===e.trim())throw new Bt(e,"name cannot be empty or whitespace-only");this.hasCTE(e)&&this.removeCTE(e);let s=new ae(t,e,i?.materialized??null);return this.appendWith(s),this.cteNameCache.add(e),this}},Mt=class e extends n{static{this.kind=Symbol("BinarySelectQuery")}constructor(e,t,i){super(),this.left=e,this.operator=new x(t),this.right=i}union(e){return this.appendSelectQuery("union",e)}unionAll(e){return this.appendSelectQuery("union all",e)}intersect(e){return this.appendSelectQuery("intersect",e)}intersectAll(e){return this.appendSelectQuery("intersect all",e)}except(e){return this.appendSelectQuery("except",e)}exceptAll(e){return this.appendSelectQuery("except all",e)}appendSelectQuery(t,i){return this.left=new e(this.left,this.operator.value,this.right),this.operator=new x(t),this.right=i,$t.normalize(this),this}unionRaw(e){let t=pi.parse(e);return this.union(t)}unionAllRaw(e){let t=pi.parse(e);return this.unionAll(t)}intersectRaw(e){let t=pi.parse(e);return this.intersect(t)}intersectAllRaw(e){let t=pi.parse(e);return this.intersectAll(t)}exceptRaw(e){let t=pi.parse(e);return this.except(t)}exceptAllRaw(e){let t=pi.parse(e);return this.exceptAll(t)}toSource(e="subq"){return new te(new ee(this),new de(e,null))}setParameter(e,t){return Wt.set(this,e,t),this}toSimpleQuery(){return Vt.buildSimpleQuery(this)}},Kt=class extends n{static{this.kind=Symbol("ValuesQuery")}constructor(e,t=null){super(),this.tuples=e,this.columnAliases=t}toSimpleQuery(){return Vt.buildSimpleQuery(this)}setParameter(e,t){return Wt.set(this,e,t),this}},Jt=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The SELECT clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=null,n=i<e.length?e[i].comments:null;if("select"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword but found "${e[i].value}". SELECT clauses must start with the SELECT keyword.`);i++;let r=[];for(;i<e.length&&mt.isHintClause(e[i].value);){let t=mt.extractHintContent(e[i].value);r.push(new mt(t)),i++}if(i<e.length&&"distinct"===e[i].value)i++,s=new U;else if(i<e.length&&"distinct on"===e[i].value){i++;let t=ht.parseArgument(4,8,e,i);s=new V(t.value),i=t.newIndex}let a=[],o=Ht.parseItem(e,i);for(a.push(o.value),i=o.newIndex;i<e.length&&16&e[i].type;){i++;let t=Ht.parseItem(e,i);a.push(t.value),i=t.newIndex}if(0===a.length)throw new Error(`Syntax error at position ${t}: No select items found. The SELECT clause requires at least one expression to select.`);{let e=new Q(a,s,r);return e.comments=n,{value:e,newIndex:i}}}},Ht=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseItem(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The select item is complete but there are additional tokens.`);return i.value}static parseItem(e,t){let i=t,s=ht.parseFromLexeme(e,i),n=s.value;if(i=s.newIndex,i<e.length&&"as"===e[i].value&&i++,i<e.length&&64&e[i].type){let t=e[i].value;return i++,{value:new q(n,t),newIndex:i}}return n instanceof l&&"*"!==n.column.name?{value:new q(n,n.column.name),newIndex:i}:{value:new q(n),newIndex:i}}},zt=class{static tryParse(e,t){let i=t;if(i<e.length&&"on"===e[i].value){i++;let t=ht.parseFromLexeme(e,i);return i=t.newIndex,{value:new ie(t.value),newIndex:i}}return null}},Gt=class{static tryParse(e,t){let i=t;if(i<e.length&&"using"===e[i].value){i++;let t=ht.parseArgument(4,8,e,i),s=t.value;return i=t.newIndex,{value:new se(s),newIndex:i}}return null}},Yt=class{static tryParse(e,t){let i=t,s=[];for(;this.isJoinCommand(e,i);){let t=this.parseJoinClause(e,i);s.push(t.value),i=t.newIndex}return s.length>0?{value:s,newIndex:i}:null}static isJoinKeyword(e){return!!je.parse(e,0)}static parseLateral(e,t){let i=t;return i<e.length&&"lateral"===e[i].value?(i++,{value:!0,newIndex:i}):{value:!1,newIndex:i}}static isJoinCommand(e,t){return!(t>=e.length||!(16&e[t].type||!0===this.isJoinKeyword(e[t].value)))}static parseJoinClause(e,t){let i=t,s=","===e[i].value?"cross join":e[i].value;i++;let n=this.parseLateral(e,i),r=n.value;i=n.newIndex;let a=Ut.parseFromLexeme(e,i);if(i=a.newIndex,i<e.length){let t=zt.tryParse(e,i);if(t)return{value:new ne(s,a.value,t.value,r),newIndex:t.newIndex};let n=Gt.tryParse(e,i);if(n)return{value:new ne(s,a.value,n.value,r),newIndex:n.newIndex}}return{value:new ne(s,a.value,null,r),newIndex:i}}},Xt=class{static collectClauseComments(e,t,i){if(t>=e.length||e[t].value.toLowerCase()!==i.toLowerCase())return null;let s=[];e[t].comments&&s.push(...e[t].comments);let n=t-1;for(;n>=0;){let t=e[n];if(t.comments&&t.comments.length>0){let e=t.comments.filter(e=>{let t=e.toLowerCase();return t.includes(i.toLowerCase())||t.includes("")||t.includes("")});e.length>0&&(s.unshift(...e),t.comments=t.comments.filter(t=>!e.includes(t)),0===t.comments.length&&(t.comments=null));break}if(this.isSignificantSqlKeyword(t.value))break;n--}return s.length>0?s:null}static isSignificantSqlKeyword(e){return new Set(["select","from","where","group by","having","order by","limit","offset"]).has(e.toLowerCase())}},Zt=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The FROM clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=Xt.collectClauseComments(e,i,"from");if("from"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'FROM' keyword but found "${e[i].value}". FROM clauses must start with the FROM keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FROM' keyword. The FROM clause requires a table reference.");let n=Ut.parseFromLexeme(e,i);i=n.newIndex;let r=Yt.tryParse(e,i);if(i=r?.newIndex||i,null!==r){let e=new re(n.value,r.value);return e.comments=s,{value:e,newIndex:i}}{let e=new re(n.value,null);return e.comments=s,{value:e,newIndex:i}}}},ei=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WHERE clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=Xt.collectClauseComments(e,i,"where");if("where"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'WHERE' keyword but found "${e[i].value}". WHERE clauses must start with the WHERE keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'WHERE' keyword. The WHERE clause requires a condition expression.");let n=ht.parseFromLexeme(e,i),r=new W(n.value);return r.comments=s,{value:r,newIndex:n.newIndex}}},ti=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The GROUP BY clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("group by"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'GROUP BY' keyword but found "${e[i].value}". GROUP BY clauses must start with the GROUP BY keywords.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'GROUP BY' keyword. The GROUP BY clause requires at least one expression to group by.");let s=[],n=this.parseItem(e,i);for(s.push(n.value),i=n.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseItem(e,i);s.push(t.value),i=t.newIndex}if(0===s.length)throw new Error(`Syntax error at position ${t}: No grouping expressions found. The GROUP BY clause requires at least one expression to group by.`);return{value:new z(s),newIndex:i}}static parseItem(e,t){let i=t,s=ht.parseFromLexeme(e,i),n=s.value;return i=s.newIndex,{value:n,newIndex:i}}},ii=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The HAVING clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("having"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'HAVING' keyword but found "${e[i].value}". HAVING clauses must start with the HAVING keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'HAVING' keyword. The HAVING clause requires a condition expression.");let s=ht.parseFromLexeme(e,i);return{value:new G(s.value),newIndex:s.newIndex}}},si=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WINDOW clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("window"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'WINDOW' keyword but found "${e[i].value}". WINDOW clauses must start with the WINDOW keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'WINDOW' keyword. The WINDOW clause requires at least one window definition.");let s=[];for(;i<e.length;){if(i>=e.length||64!==e[i].type)throw new Error("Syntax error: Expected window name after 'WINDOW' keyword.");let t=e[i].value;if(i++,i>=e.length||"as"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'AS' keyword after window name.`);i++;let n=rt.parseFromLexeme(e,i);if(i=n.newIndex,s.push(new M(t,n.value)),!(i<e.length&&16&e[i].type))break;i++}if(0===s.length)throw new Error("At least one WINDOW clause is required after WINDOW keyword.");return{value:new K(s),newIndex:i}}},ni=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The LIMIT clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("limit"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'LIMIT' keyword but found "${e[i].value}". LIMIT clauses must start with the LIMIT keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'LIMIT' keyword. The LIMIT clause requires a numeric expression.");let s=ht.parseFromLexeme(e,i);return i=s.newIndex,{value:new le(s.value),newIndex:i}}},ri=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The FOR clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("for"!==e[i].value.toLowerCase())throw new Error(`Syntax error at position ${i}: Expected 'FOR' keyword but found "${e[i].value}". FOR clauses must start with the FOR keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FOR' keyword. The FOR clause requires a lock mode specification.");let s,n=e[i].value;switch(n){case"update":s="update",i++;break;case"share":s="share",i++;break;case"key share":s="key share",i++;break;case"no key update":s="no key update",i++;break;default:throw new Error(`Syntax error at position ${i}: Invalid lock mode "${n}". Valid lock modes are: UPDATE, SHARE, KEY SHARE, NO KEY UPDATE.`)}return{value:new pe(s),newIndex:i}}},ai=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The CommonTable definition is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=i<e.length?e[i].comments:null,n=Qt.parseFromLexeme(e,i);if(i=n.newIndex,i<e.length&&"as"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'AS' keyword after CTE name but found "${e[i].value}".`);i++;let r=null;if(i<e.length){let t=e[i].value;"materialized"===t?(r=!0,i++):"not materialized"===t&&(r=!1,i++)}if(i<e.length&&4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected '(' after CTE name but found "${e[i].value}".`);let a=e[i].comments;i++;let o=pi.parseFromLexeme(e,i);if(i=o.newIndex,a&&a.length>0&&(o.value.comments?o.value.comments=[...a,...o.value.comments]:o.value.comments=a),i<e.length&&8!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected ')' after CTE query but found "${e[i].value}".`);i++;let l=new ae(o.value,n.value,r);return l.comments=s,{value:l,newIndex:i}}},oi=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The WITH clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=i<e.length?e[i].comments:null;if(!(i<e.length&&"with"===e[i].value.toLowerCase()))throw new Error(`Syntax error at position ${i}: Expected WITH keyword.`);i++;let n=i<e.length&&"recursive"===e[i].value.toLowerCase();n&&i++;let r=[],a=ai.parseFromLexeme(e,i);for(r.push(a.value),i=a.newIndex;i<e.length&&16&e[i].type;){i++;let t=ai.parseFromLexeme(e,i);r.push(t.value),i=t.newIndex}let o=new oe(n,r);return o.comments=s,{value:o,newIndex:i}}},li=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The VALUES clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("values"!==e[i].value.toLowerCase())throw new Error(`Syntax error at position ${i}: Expected 'VALUES' keyword but found "${e[i].value}". VALUES clauses must start with the VALUES keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'VALUES' keyword. The VALUES clause requires at least one tuple expression.");let s=[],n=this.parseTuple(e,i);for(s.push(n.value),i=n.newIndex;i<e.length&&16&e[i].type;){i++;let t=this.parseTuple(e,i);s.push(t.value),i=t.newIndex}return{value:new Kt(s),newIndex:i}}static parseTuple(e,t){let i=t;if(i>=e.length||4!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected opening parenthesis but found "${i<e.length?e[i].value:"end of input"}". Tuple expressions in VALUES clause must be enclosed in parentheses.`);i++;let s=[];if(i>=e.length)throw new Error("Syntax error: Unexpected end of input after opening parenthesis in tuple expression.");if(8&e[i].type)return i++,{value:new $([]),newIndex:i};let n=ht.parseFromLexeme(e,i);for(s.push(n.value),i=n.newIndex;i<e.length&&16&e[i].type;){if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after comma in tuple expression.");let t=ht.parseFromLexeme(e,i);s.push(t.value),i=t.newIndex}if(i>=e.length||8!==e[i].type)throw new Error(`Syntax error at position ${i}: Expected closing parenthesis but found "${i<e.length?e[i].value:"end of input"}". Tuple expressions in VALUES clause must be enclosed in parentheses.`);return i++,{value:new $(s),newIndex:i}}},ui=class{static parseFromLexeme(e,t){let i=t;if("fetch"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'FETCH' keyword but found "${e[i].value}".`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH' keyword.");let s=hi.parseFromLexeme(e,i),n=s.value;return i=s.newIndex,{value:new he(n),newIndex:i}}},hi=class{static parseFromLexeme(e,t){let i,s=t,n=e[s].value;if("first"===n)i="first";else{if("next"!==n)throw new Error(`Syntax error at position ${s}: Expected 'FIRST' or 'NEXT' after 'FETCH' but found "${e[s].value}".`);i="next"}if(s++,s>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH FIRST|NEXT'.");let r=null,a=null;if("row only"===e[s].value||"rows only"===e[s].value)return r=new C(1),a="rows only",s++,{value:new ce(i,r,a),newIndex:s};let o=ht.parseFromLexeme(e,s);if(r=o.value,s=o.newIndex,s>=e.length)throw new Error("Syntax error: Unexpected end of input after 'FETCH FIRST|NEXT <count>'.");if("rows only"===e[s].value?(a="rows only",s++):"percent"===e[s].value?(a="percent",s++):"percent with ties"===e[s].value&&(a="percent with ties",s++),!a)throw new Error("Syntax error: Expected 'ROWS ONLY', 'PERCENT', or 'PERCENT WITH TIES' after 'FETCH FIRST|NEXT <count>'.");return{value:new ce(i,r,a),newIndex:s}}},ci=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The OFFSET clause is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t;if("offset"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'OFFSET' keyword but found "${e[i].value}". OFFSET clauses must start with the OFFSET keyword.`);if(i++,i>=e.length)throw new Error("Syntax error: Unexpected end of input after 'OFFSET' keyword. The OFFSET clause requires a numeric expression.");let s=ht.parseFromLexeme(e,i);return i=s.newIndex,i<e.length&&("row"===e[i].value||"rows"===e[i].value)&&i++,{value:new ue(s.value),newIndex:i}}},pi=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`[SelectQueryParser] Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The SELECT query is complete but there are additional tokens.`);return i.value}static async parseAsync(e){return Promise.resolve(this.parse(e))}static{this.unionCommandSet=new Set(["union","union all","intersect","intersect all","except","except all"])}static{this.selectCommandSet=new Set(["with","select"])}static parseFromLexeme(e,t){let i=t;if(i>=e.length)throw new Error(`Syntax error: Unexpected end of input at position ${t}.`);let s=e[i].value;if(!this.selectCommandSet.has(s)&&"values"!==s)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' or 'VALUES' keyword but found "${e[i].value}".`);let n=this.selectCommandSet.has(s)?this.parseSimpleSelectQuery(e,i):this.parseValuesQuery(e,i),r=n.value;for(i=n.newIndex;i<e.length&&this.unionCommandSet.has(e[i].value.toLowerCase());){let t=e[i].value.toLowerCase();if(i++,i>=e.length)throw new Error(`Syntax error at position ${i}: Expected a query after '${t.toUpperCase()}' but found end of input.`);let s=e[i].value.toLowerCase();if(this.selectCommandSet.has(s)){let s=this.parseSimpleSelectQuery(e,i);r=new Mt(r,t,s.value),i=s.newIndex}else{if("values"!==s)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' or 'VALUES' after '${t.toUpperCase()}' but found "${e[i].value}".`);{let s=this.parseValuesQuery(e,i);r=new Mt(r,t,s.value),i=s.newIndex}}}return{value:r,newIndex:i}}static parseSimpleSelectQuery(e,t){let i=t,s=null;i<e.length&&"with"===e[i].value&&(s=oi.parseFromLexeme(e,i),i=s.newIndex);let n=i<e.length?e[i].comments:null;if(i>=e.length||"select"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'SELECT' keyword but found "${i<e.length?e[i].value:"end of input"}". SELECT queries must start with the SELECT keyword.`);let r=Jt.parseFromLexeme(e,i);i=r.newIndex,n&&r.value.comments&&JSON.stringify(n)===JSON.stringify(r.value.comments)&&(r.value.comments=null);let a=null;i<e.length&&"from"===e[i].value&&(a=Zt.parseFromLexeme(e,i),i=a.newIndex);let o=null;i<e.length&&"where"===e[i].value&&(o=ei.parseFromLexeme(e,i),i=o.newIndex);let l=null;i<e.length&&"group by"===e[i].value&&(l=ti.parseFromLexeme(e,i),i=l.newIndex);let u=null;i<e.length&&"having"===e[i].value&&(u=ii.parseFromLexeme(e,i),i=u.newIndex);let h=null;i<e.length&&"window"===e[i].value&&(h=si.parseFromLexeme(e,i),i=h.newIndex);let c=null;i<e.length&&"order by"===e[i].value&&(c=st.parseFromLexeme(e,i),i=c.newIndex);let p=null;i<e.length&&"limit"===e[i].value&&(p=ni.parseFromLexeme(e,i),i=p.newIndex);let d=null;i<e.length&&"offset"===e[i].value&&(d=ci.parseFromLexeme(e,i),i=d.newIndex);let m=null;i<e.length&&"fetch"===e[i].value&&(m=ui.parseFromLexeme(e,i),i=m.newIndex);let f=null;i<e.length&&"for"===e[i].value.toLowerCase()&&(f=ri.parseFromLexeme(e,i),i=f.newIndex);let w=new Dt({withClause:s?s.value:null,selectClause:r.value,fromClause:a?a.value:null,whereClause:o?o.value:null,groupByClause:l?l.value:null,havingClause:u?u.value:null,orderByClause:c?c.value:null,windowClause:h?h.value:null,limitClause:p?p.value:null,offsetClause:d?d.value:null,fetchClause:m?m.value:null,forClause:f?f.value:null});return w.comments=n,{value:w,newIndex:i}}static parseValuesQuery(e,t){let i=li.parseFromLexeme(e,t);return{value:i.value,newIndex:i.newIndex}}},di=class{static parse(e){let t=new He(e).readLexmes(),i=this.parseFromLexeme(t,0);if(i.newIndex<t.length)throw new Error(`Syntax error: Unexpected token "${t[i.newIndex].value}" at position ${i.newIndex}. The INSERT query is complete but there are additional tokens.`);return i.value}static parseFromLexeme(e,t){let i=t,s=null;if("with"===e[i].value){let t=oi.parseFromLexeme(e,i);s=t.value,i=t.newIndex}if("insert into"!==e[i].value)throw new Error(`Syntax error at position ${i}: Expected 'INSERT INTO' but found '${e[i].value}'.`);i++;let n=Ut.parseTableSourceFromLexemes(e,i);i=n.newIndex;let a=[];if(4===e[i]?.type){for(i++;i<e.length&&64===e[i].type&&(a.push(e[i].value),i++,16===e[i]?.type);)i++;if(8!==e[i]?.type)throw new Error(`Syntax error at position ${i}: Expected ')' after column list.`);i++}let o=pi.parseFromLexeme(e,i);if(s){if(!(o.value instanceof Dt))throw new Error("WITH clause is not supported in this context.");o.value.withClause=s}return i=o.newIndex,{value:new r({insertClause:new Ce(n.value,a),selectQuery:o.value}),newIndex:i}}},mi=class e{constructor(){this.dependencyGraph=null,this.cteMap=new Map,this.sourceCollector=new dt(!0),this.cteCollector=new ct}static{this.ERROR_MESSAGES={NOT_ANALYZED:"Must call analyzeDependencies first",CIRCULAR_REFERENCE:"Circular reference detected in CTE"}}analyzeDependencies(e){let t=this.cteCollector.collect(e);return this.buildCTEMap(t),this.dependencyGraph=this.buildDependencyGraph(t),this.dependencyGraph}getDependencies(e){this.ensureAnalyzed();let t=this.findNodeByName(e);return t?[...t.dependencies]:[]}getDependents(e){this.ensureAnalyzed();let t=this.findNodeByName(e);return t?[...t.dependents]:[]}hasCircularDependency(){this.ensureAnalyzed();try{return this.getExecutionOrder(),!1}catch(t){if(t instanceof Error&&t.message.includes(e.ERROR_MESSAGES.CIRCULAR_REFERENCE))return!0;throw t}}getExecutionOrder(){this.ensureAnalyzed();let t=new Set,i=new Set,s=[],n=new Map;for(let e of this.dependencyGraph.nodes)n.set(e.name,new Set(e.dependencies));let r=a=>{if(t.has(a))return;if(i.has(a))throw new Error(`${e.ERROR_MESSAGES.CIRCULAR_REFERENCE}: ${a}`);i.add(a);let o=n.get(a)||new Set;for(let e of o)r(e);i.delete(a),t.add(a),s.push(a)};for(let e of this.dependencyGraph.nodes)t.has(e.name)||r(e.name);return s}buildDependencyGraph(t){let i=[],s=[],n=new Map,r=new Map;for(let i of t){let t=e.getCTEName(i);n.set(t,new Set),r.set(t,new Set)}for(let i of t){let t=e.getCTEName(i),a=this.sourceCollector.collect(i.query);for(let e of a){let i=e.table.name;this.cteMap.has(i)&&i!==t&&(n.get(t).add(i),r.get(i).add(t),s.push({from:t,to:i}))}}for(let s of t){let t=e.getCTEName(s);i.push({name:t,cte:s,dependencies:Array.from(n.get(t)||new Set),dependents:Array.from(r.get(t)||new Set)})}return{nodes:i,edges:s}}ensureAnalyzed(){if(!this.dependencyGraph)throw new Error(e.ERROR_MESSAGES.NOT_ANALYZED)}buildCTEMap(t){this.cteMap.clear();for(let i of t){let t=e.getCTEName(i);this.cteMap.set(t,i)}}findNodeByName(e){return this.dependencyGraph?.nodes.find(t=>t.name===e)}static getCTEName(e){return e.aliasExpression.table.name}},fi=class{static addComment(e,t){e.comments||(e.comments=[]),e.comments.push(t)}static editComment(e,t,i){if(!e.comments||t<0||t>=e.comments.length)throw new Error(`Invalid comment index: ${t}. Component has ${e.comments?.length||0} comments.`);e.comments[t]=i}static deleteComment(e,t){if(!e.comments||t<0||t>=e.comments.length)throw new Error(`Invalid comment index: ${t}. Component has ${e.comments?.length||0} comments.`);e.comments.splice(t,1),0===e.comments.length&&(e.comments=null)}static deleteAllComments(e){e.comments=null}static getComments(e){return e.comments||[]}static findComponentsWithComment(e,t,i=!1){let s=[],r=i?t:t.toLowerCase(),a=e=>{e&&e instanceof n&&e.comments&&e.comments.some(e=>(i?e:e.toLowerCase()).includes(r))&&s.push(e);for(let t in e)e[t]&&"object"==typeof e[t]&&(Array.isArray(e[t])?e[t].forEach(a):a(e[t]))};return a(e),s}static replaceInComments(e,t,i,s=!1){let r=0,a=e=>{if(e&&e instanceof n&&e.comments)for(let n=0;n<e.comments.length;n++){let a=e.comments[n],o=s?"g":"gi",l=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o),u=a.replace(l,i);u!==a&&(e.comments[n]=u,r++)}for(let t in e)e[t]&&"object"==typeof e[t]&&(Array.isArray(e[t])?e[t].forEach(a):a(e[t]))};return a(e),r}static countComments(e){let t=0,i=e=>{e&&e instanceof n&&e.comments&&(t+=e.comments.length);for(let t in e)e[t]&&"object"==typeof e[t]&&(Array.isArray(e[t])?e[t].forEach(i):i(e[t]))};return i(e),t}static getAllComments(e){let t=[],i=e=>{e&&e instanceof n&&e.comments&&e.comments.forEach((i,s)=>{t.push({comment:i,component:e,index:s})});for(let t in e)e[t]&&"object"==typeof e[t]&&(Array.isArray(e[t])?e[t].forEach(i):i(e[t]))};return i(e),t}},wi=class{constructor(e,t){this.name=e,this.columns=t}},yi=class{constructor(e=null,t=!1){this.tableColumnResolver=e,this.allowWildcardWithoutResolver=t,this.tableSchemas=[],this.visitedNodes=new Set,this.commonTables=[],this.running=!1,this.handlers=new Map,this.handlers.set(Dt.kind,e=>this.visitSimpleSelectQuery(e)),this.handlers.set(Mt.kind,e=>this.visitBinarySelectQuery(e))}collect(e){return this.visit(e),this.tableSchemas}visit(e){if(this.running)this.visitNode(e);else{this.reset(),this.running=!0;try{if(!(e instanceof Dt||e instanceof Mt))throw new Error(`Unsupported SQL component type for schema collection. Received: ${e.constructor.name}. Expected: SimpleSelectQuery or BinarySelectQuery.`);let t=new ct;this.commonTables=t.collect(e),this.visitNode(e),this.consolidateTableSchemas()}finally{this.running=!1}}}visitNode(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}reset(){this.tableSchemas=[],this.visitedNodes=new Set,this.commonTables=[]}consolidateTableSchemas(){let e=new Map;for(let t of this.tableSchemas)if(e.has(t.name)){let i=e.get(t.name);t.columns.forEach(e=>i?.add(e))}else e.set(t.name,new Set(t.columns));this.tableSchemas=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>new wi(e,Array.from(t).sort()))}handleTableSource(e,t,i){if(!(e.datasource instanceof Y))throw new Error("Datasource is not an instance of TableSource");{let s=e.datasource.getSourceName(),n=this.commonTables.filter(e=>e.getSourceAliasName()===s);if(n.length>0)n[0].query.accept(this);else{let n=e.getAliasName()??s;this.processCollectTableSchema(s,n,t,i)}}}visitSimpleSelectQuery(e){if(null===e.fromClause)return;let t,i=new Lt(this.tableColumnResolver,!0,"fullName").collect(e);if(this.allowWildcardWithoutResolver){let s=this.getSelectClauseColumns(e);t=i.filter(e=>e.value instanceof l).map(e=>e.value).filter(e=>{let t=e.getNamespace(),i=e.column.name;return s.some(e=>{if(e.value instanceof l){let s=e.value.getNamespace(),n=e.value.column.name;if(s===t&&n===i)return!0;if("*"===n){if(this.allowWildcardWithoutResolver&&null===this.tableColumnResolver)return!1;if(""===s||s===t)return!0}}return!1})}).map(e=>({table:e.getNamespace(),column:e.column.name}))}else t=i.filter(e=>e.value instanceof l).map(e=>e.value).map(e=>({table:e.getNamespace(),column:e.column.name}));if(null!==e.fromClause.joins&&e.fromClause.joins.length>0){let e=t.filter(e=>""===e.table).map(e=>e.column);if(e.length>0)throw new Error(`Column reference(s) without table name found in query: ${e.join(", ")}`)}if(e.fromClause.source.datasource instanceof Y?this.handleTableSource(e.fromClause.source,t,!0):e.fromClause.source.datasource instanceof ee&&e.fromClause.source.datasource.query.accept(this),e.fromClause?.joins)for(let i of e.fromClause.joins)i.source.datasource instanceof Y?this.handleTableSource(i.source,t,!1):i.source.datasource instanceof ee&&i.source.datasource.query.accept(this)}visitBinarySelectQuery(e){this.visitNode(e.left),this.visitNode(e.right)}getSelectClauseColumns(e){if(!e.selectClause)return[];let t=[];for(let i of e.selectClause.items)if(i.value instanceof l){let e=i.value.column.name;t.push({name:e,value:i.value})}return t}processCollectTableSchema(e,t,i,s=!1){if(null===this.tableColumnResolver&&i.filter(e=>e.table===t||s&&""===e.table).filter(e=>"*"===e.column).length>0&&!this.allowWildcardWithoutResolver)throw new Error(e?`Wildcard (*) is used. A TableColumnResolver is required to resolve wildcards. Target table: ${e}`:"Wildcard (*) is used. A TableColumnResolver is required to resolve wildcards.");let n=i.filter(e=>"*"!==e.column).filter(e=>e.table===t||s&&""===e.table).map(e=>e.column),r=new wi(e,n);this.tableSchemas.push(r)}},Ci=class{static validate(e,t){let i="string"==typeof e?pi.parse(e):e,s=Array.isArray(t)?e=>{let i=t.find(t=>t.name===e);return i?i.columns:[]}:t,n=new yi(s).collect(i),r=[];for(let e of n){let t=s(e.name);if(0===t.length){r.push(`Table '${e.name}' is not defined.`);continue}let i=e.columns.filter(e=>!t.includes(e));i.length>0&&r.push(`Table '${e.name}' contains undefined columns: ${i.join(", ")}.`)}if(r.length>0)throw new Error(r.join("\n"))}},vi=class{constructor(e={}){this.knownCTENames=[],this.options=e,this.formatter=new It(e),this.dependencyAnalyzer=new mi}compose(e,t){if(0===e.length)return t;this.knownCTENames=e.map(e=>e.name);let i=e.map(e=>({name:e.name,query:this.extractPureQuery(e.query,e.name)})),s=this.buildTempQueryForAnalysis(i,t),n=this.dependencyAnalyzer.analyzeDependencies(s),r=this.sortCTEsByDependencies(i,n),a=`${this.detectRecursiveFromOriginalQueries(e)?"with recursive":"with"} ${r.map(e=>`${e.name} as (${e.query})`).join(", ")} ${t}`;return this.options.validateSchema&&this.options.schema&&this.validateComposedQuery(a),this.formatFinalQuery(a)}extractPureQuery(e,t){if(!/^\s*with\s+/i.test(e)||/^\s*with\s+recursive\s+/i.test(e))return e;try{let t=pi.parse(e);if(t.withClause&&t.withClause.tables){let e=this.getKnownCTENames();if(t.withClause.tables.map(e=>this.getCTEName(e)).every(t=>e.includes(t))){let e=new Dt({selectClause:t.selectClause,fromClause:t.fromClause,whereClause:t.whereClause,groupByClause:t.groupByClause,havingClause:t.havingClause,orderByClause:t.orderByClause,windowClause:t.windowClause,limitClause:t.limitClause,offsetClause:t.offsetClause,fetchClause:t.fetchClause,forClause:t.forClause,withClause:void 0});return new It({identifierEscape:{start:"",end:""}}).format(e).formattedSql}}}catch{}return e}getKnownCTENames(){return this.knownCTENames||[]}getCTEName(e){return e.aliasExpression.table.name}extractCTEWithRegex(e,t){let i=new RegExp(`${t}\\s+as\\s*\\(`,"i"),s=e.match(i);if(!s)return e;let n=s.index+s[0].length,r=1,a=n;for(;a<e.length&&r>0;){let t=e[a];"("===t?r++:")"===t&&r--,a++}return 0===r?e.substring(n,a-1).trim():e}buildTempQueryForAnalysis(e,t){let i=`with ${e.map(e=>`${e.name} as (${e.query})`).join(", ")} ${t}`;try{return pi.parse(i)}catch(e){throw new Error(`Failed to parse temporary query for dependency analysis: ${e}`)}}sortCTEsByDependencies(e,t){let i=new Map;return e.forEach(e=>i.set(e.name,e.query)),t.nodes.map(e=>({name:e.name,query:i.get(e.name)||""})).filter(e=>""!==e.query)}detectRecursiveFromOriginalQueries(e){return e.some(e=>e.query.toLowerCase().includes("with recursive"))}detectRecursiveCTEs(e){return!!e.withClause&&this.formatter.format(e).formattedSql.toLowerCase().includes("with recursive")}validateComposedQuery(e){try{let t=pi.parse(e),i=Object.entries(this.options.schema).map(([e,t])=>({name:e,columns:t}));Ci.validate(t,i)}catch(e){throw e instanceof Error?new Error(`Schema validation failed: ${e.message}`):e}}formatFinalQuery(e){if(this.options.preset||this.options.keywordCase)try{let t=pi.parse(e);return this.formatter.format(t).formattedSql}catch{return e}return e}},gi=class e{static{this.ERROR_MESSAGES={CIRCULAR_REFERENCE:"Circular reference detected in non-recursive CTEs",PARSING_FAILED:"Failed to parse query for comment injection"}}static{this.COMMENT_TEXTS={AUTO_GENERATED:"Auto-generated by CTE decomposer",ORIGINAL_CTE:"Original CTE:",DEPENDENCIES:"Dependencies:",DEPENDENTS:"Dependents:",RECURSIVE_TYPE:"Type: Recursive CTE",NONE:"none"}}constructor(e={}){this.options=e,this.dependencyAnalyzer=new mi,this.cteCollector=new ct,this.formatter=new It(e)}decompose(e){let t=this.cteCollector.collect(e);if(0===t.length)return[];let i=this.findRecursiveCTEs(e,t),s=this.dependencyAnalyzer.analyzeDependencies(e);return this.validateCircularDependencies(i.length>0),this.processCTENodes(e,s.nodes,i)}synchronize(e,t){if(0===e.length)return[];let i={...this.options,addComments:void 0},s=new vi(i).compose(e,t),n=pi.parse(s);return this.decompose(n)}validateCircularDependencies(t){if(this.dependencyAnalyzer.hasCircularDependency()&&!t)throw new Error(e.ERROR_MESSAGES.CIRCULAR_REFERENCE)}processCTENodes(e,t,i){let s=[];for(let n of t)i.includes(n.name)?s.push(this.createRecursiveCTE(n,e)):s.push(this.createStandardCTE(n,t));return s}createRecursiveCTE(e,t){let i=this.formatter.format(t).formattedSql,s=this.addCommentsToQuery(i,e.name,[],[],!0);return{name:e.name,query:s,dependencies:[],dependents:[],isRecursive:!0}}createStandardCTE(e,t){let i=this.buildExecutableQuery(e,t),s=this.addCommentsToQuery(i,e.name,e.dependencies,e.dependents,!1);return{name:e.name,query:s,dependencies:[...e.dependencies],dependents:[...e.dependents],isRecursive:!1}}buildExecutableQuery(e,t){let i=this.collectRequiredCTEs(e,t);return 0===i.length?this.formatter.format(e.cte.query).formattedSql:`${this.buildWithClause(i)} ${this.formatter.format(e.cte.query).formattedSql}`}collectRequiredCTEs(e,t){let i=new Set,s=[],n=new Map;for(let e of t)n.set(e.name,e);let r=t=>{if(i.has(t))return;i.add(t);let a=n.get(t);if(a){for(let e of a.dependencies)r(e);t!==e.name&&s.push(a)}};for(let t of e.dependencies)r(t);return s}buildWithClause(e){return 0===e.length?"":`with ${e.map(e=>`${e.name} as (${this.formatter.format(e.cte.query).formattedSql})`).join(", ")}`}findRecursiveCTEs(e,t){return e.withClause&&this.isRecursiveWithClause(e)?t.map(e=>this.getCTEName(e)):[]}isRecursiveWithClause(e){return this.formatter.format(e).formattedSql.toLowerCase().includes("with recursive")}addCommentsToQuery(t,i,s,n,r){if(!0!==this.options.addComments)return t;try{let e=pi.parse(t);return this.generateComments(i,s,n,r).forEach(t=>{fi.addComment(e,t)}),new It({...this.options,exportComment:!0}).format(e).formattedSql}catch(a){return console.warn(`${e.ERROR_MESSAGES.PARSING_FAILED}: ${a}`),this.addTextCommentsToQuery(t,i,s,n,r)}}generateComments(t,i,s,n){let{AUTO_GENERATED:r,ORIGINAL_CTE:a,DEPENDENCIES:o,DEPENDENTS:l,RECURSIVE_TYPE:u,NONE:h}=e.COMMENT_TEXTS,c=[];c.push(r),c.push(`${a} ${t}`),n&&c.push(u);let p=i.length>0?i.join(", "):h;c.push(`${o} ${p}`);let d=s.length>0?s.join(", "):h;return c.push(`${l} ${d}`),c}addTextCommentsToQuery(e,t,i,s,n){return`${this.generateComments(t,i,s,n).map(e=>`-- ${e}`).join("\n")}\n${e}`}getCTEName(e){return e.aliasExpression.table.name}},Ei=class{constructor(){this.columnReferences=[],this.visitedNodes=new Set,this.handlers=new Map,this.handlers.set(oe.kind,e=>this.visitWithClause(e)),this.handlers.set(ae.kind,e=>this.visitCommonTable(e)),this.handlers.set(Q.kind,e=>this.visitSelectClause(e)),this.handlers.set(re.kind,e=>this.visitFromClause(e)),this.handlers.set(W.kind,e=>this.visitWhereClause(e)),this.handlers.set(z.kind,e=>this.visitGroupByClause(e)),this.handlers.set(G.kind,e=>this.visitHavingClause(e)),this.handlers.set(J.kind,e=>this.visitOrderByClause(e)),this.handlers.set(K.kind,e=>this.visitWindowsClause(e)),this.handlers.set(le.kind,e=>this.visitLimitClause(e)),this.handlers.set(ue.kind,e=>this.visitOffsetClause(e)),this.handlers.set(he.kind,e=>this.visitFetchClause(e)),this.handlers.set(pe.kind,e=>this.visitForClause(e)),this.handlers.set(ne.kind,e=>this.visitJoinClause(e)),this.handlers.set(ie.kind,e=>this.visitJoinOnClause(e)),this.handlers.set(se.kind,e=>this.visitJoinUsingClause(e)),this.handlers.set(te.kind,e=>this.visitSourceExpression(e)),this.handlers.set(ee.kind,e=>this.visitSubQuerySource(e)),this.handlers.set(l.kind,e=>this.visitColumnReference(e)),this.handlers.set(y.kind,e=>this.visitBinaryExpression(e)),this.handlers.set(w.kind,e=>this.visitUnaryExpression(e)),this.handlers.set(u.kind,e=>this.visitFunctionCall(e)),this.handlers.set(b.kind,e=>this.visitCaseExpression(e)),this.handlers.set(k.kind,e=>this.visitCastExpression(e)),this.handlers.set(A.kind,e=>this.visitBetweenExpression(e)),this.handlers.set(T.kind,e=>this.visitParenExpression(e)),this.handlers.set(a.kind,e=>this.visitInlineQuery(e)),this.handlers.set(N.kind,e=>this.visitArrayExpression(e)),this.handlers.set(I.kind,e=>this.visitArrayQueryExpression(e)),this.handlers.set(o.kind,e=>this.visitValueList(e)),this.handlers.set(f.kind,e=>this.visitWindowFrameExpression(e))}collect(e){return this.columnReferences=[],this.visitedNodes.clear(),e instanceof Dt?this.collectFromSimpleQuery(e):e instanceof Mt?this.collectFromSimpleQuery(e.toSimpleQuery()):e.accept(this),[...this.columnReferences]}collectFromSimpleQuery(e){if(e.withClause&&e.withClause.tables)for(let t of e.withClause.tables)this.collectFromSimpleQuery(t.query);if(this.collectFromSelectClause(e.selectClause),e.fromClause&&this.collectFromFromClause(e.fromClause),e.whereClause&&this.collectFromValueComponent(e.whereClause.condition),e.groupByClause&&e.groupByClause.grouping)for(let t of e.groupByClause.grouping)this.collectFromValueComponent(t);if(e.havingClause&&this.collectFromValueComponent(e.havingClause.condition),e.orderByClause&&e.orderByClause.order)for(let t of e.orderByClause.order)"object"==typeof t&&"value"in t&&t.value?this.collectFromValueComponent(t.value):this.collectFromValueComponent(t)}collectFromSelectClause(e){for(let t of e.items)this.collectFromValueComponent(t.value)}collectFromFromClause(e){if(this.collectFromSourceExpression(e.source),e.joins)for(let t of e.joins)this.collectFromSourceExpression(t.source),t.condition&&this.collectFromValueComponent(t.condition.condition)}collectFromSourceExpression(e){e.datasource instanceof ee&&(e.datasource.query instanceof Dt?this.collectFromSimpleQuery(e.datasource.query):e.datasource.query instanceof Mt&&this.collectFromSimpleQuery(e.datasource.query.toSimpleQuery()))}collectFromValueComponent(e){if(e instanceof l)this.columnReferences.push(e);else if(e instanceof y)this.collectFromValueComponent(e.left),this.collectFromValueComponent(e.right);else if(e instanceof w)this.collectFromValueComponent(e.expression);else if(e instanceof u&&e.argument)this.collectFromValueComponent(e.argument);else if(e instanceof b){if(e.condition&&this.collectFromValueComponent(e.condition),e.switchCase&&e.switchCase.cases)for(let t of e.switchCase.cases)this.collectFromValueComponent(t.key),this.collectFromValueComponent(t.value);e.switchCase&&e.switchCase.elseValue&&this.collectFromValueComponent(e.switchCase.elseValue)}else e instanceof T?this.collectFromValueComponent(e.expression):e instanceof a&&(e.selectQuery instanceof Dt?this.collectFromSimpleQuery(e.selectQuery):e.selectQuery instanceof Mt&&this.collectFromSimpleQuery(e.selectQuery.toSimpleQuery()))}visit(e){if(this.visitedNodes.has(e))return;this.visitedNodes.add(e);let t=this.handlers.get(e.getKind());t&&t(e)}visitSimpleSelectQuery(e){e.withClause&&e.withClause.accept(this),e.selectClause.accept(this),e.fromClause&&e.fromClause.accept(this),e.whereClause&&e.whereClause.accept(this),e.groupByClause&&e.groupByClause.accept(this),e.havingClause&&e.havingClause.accept(this),e.orderByClause&&e.orderByClause.accept(this),e.windowClause&&e.windowClause.accept(this),e.limitClause&&e.limitClause.accept(this),e.offsetClause&&e.offsetClause.accept(this),e.fetchClause&&e.fetchClause.accept(this),e.forClause&&e.forClause.accept(this)}visitWithClause(e){for(let t of e.tables)t.accept(this)}visitCommonTable(e){e.query.accept(this)}visitSelectClause(e){for(let t of e.items)t.value.accept(this)}visitFromClause(e){if(e.source.accept(this),e.joins)for(let t of e.joins)t.accept(this)}visitWhereClause(e){e.condition.accept(this)}visitGroupByClause(e){if(e.grouping)for(let t of e.grouping)t.accept(this)}visitHavingClause(e){e.condition.accept(this)}visitOrderByClause(e){if(e.order)for(let t of e.order)"object"==typeof t&&"value"in t&&t.value?"object"==typeof t.value&&"accept"in t.value&&t.value.accept(this):"object"==typeof t&&"accept"in t&&t.accept(this)}visitWindowsClause(e){for(let t of e.windows)t.expression.accept(this)}visitLimitClause(e){e.value.accept(this)}visitOffsetClause(e){e.value.accept(this)}visitFetchClause(e){e.expression.accept(this)}visitForClause(e){}visitJoinClause(e){e.source.accept(this),e.condition&&e.condition.accept(this)}visitJoinOnClause(e){e.condition.accept(this)}visitJoinUsingClause(e){e.condition.accept(this)}visitSourceExpression(e){e.datasource.accept(this)}visitSubQuerySource(e){e.query.accept(this)}visitColumnReference(e){this.columnReferences.push(e)}visitBinaryExpression(e){e.left.accept(this),e.right.accept(this)}visitUnaryExpression(e){e.expression.accept(this)}visitFunctionCall(e){e.argument&&e.argument.accept(this)}visitCaseExpression(e){if(e.condition&&e.condition.accept(this),e.switchCase&&e.switchCase.cases)for(let t of e.switchCase.cases)t.key.accept(this),t.value.accept(this);e.switchCase&&e.switchCase.elseValue&&e.switchCase.elseValue.accept(this)}visitCastExpression(e){e.input.accept(this)}visitBetweenExpression(e){e.expression.accept(this),e.lower.accept(this),e.upper.accept(this)}visitParenExpression(e){e.expression.accept(this)}visitInlineQuery(e){e.selectQuery.accept(this)}visitArrayExpression(e){e.expression&&e.expression.accept(this)}visitArrayQueryExpression(e){e.query.accept(this)}visitValueList(e){if(e.values)for(let t of e.values)t.accept(this)}visitWindowFrameExpression(e){e.partition&&e.partition.accept(this),e.order&&e.order.accept(this)}},xi=e=>`CTE '${e}' does not exist`,Si=e=>`CTE '${e}' already exists`,Ti=e=>`CTE '${e}' not found`,ki=class{constructor(){this.dependencyAnalyzer=new mi,this.columnReferenceCollector=new Ei,this.tableSourceCollector=new dt}renameCTE(e,t,i){this.validateInputs(e,t,i);let s=t.trim(),n=i.trim();if(e instanceof Dt)this.renameInSimpleQuery(e,s,n);else{if(!(e instanceof Mt))throw new Error("Unsupported query type for CTE renaming");this.renameInBinaryQuery(e,s,n)}}validateInputs(e,t,i){if(!e)throw new Error("Query cannot be null or undefined");if(!t||"string"!=typeof t||""===t.trim())throw new Error("Old CTE name must be a non-empty string");if(!i||"string"!=typeof i||""===i.trim())throw new Error("New CTE name must be a non-empty string");if(t.trim()===i.trim())throw new Error("Old and new CTE names cannot be the same")}renameInSimpleQuery(e,t,i){let s=e.getCTENames();if(!s.includes(t))throw new Error(xi(t));if(s.includes(i))throw new Error(Si(i));this.renameCTEDefinition(e,t,i),this.updateAllReferences(e,t,i)}renameInBinaryQuery(e,t,i){let s=e.toSimpleQuery(),n=[];if(s.withClause&&s.withClause.tables&&(n=s.withClause.tables.map(e=>e.aliasExpression.table.name)),!n.includes(t))throw new Error(xi(t));if(n.includes(i))throw new Error(Si(i));this.renameCTEDefinition(s,t,i),s.withClause&&(e.withClause=s.withClause,e.left instanceof Dt&&(e.left.withClause=s.withClause)),this.renameInSelectQuery(e.left,t,i),this.renameInSelectQuery(e.right,t,i)}renameInSelectQuery(e,t,i){e instanceof Dt?this.updateAllReferences(e,t,i):e instanceof Mt&&(this.renameInSelectQuery(e.left,t,i),this.renameInSelectQuery(e.right,t,i))}renameCTEDefinition(e,t,i){if(!e.withClause||!e.withClause.tables)throw new Error(Ti(t));let s=e.withClause.tables.find(e=>e.aliasExpression.table.name===t);if(!s)throw new Error(Ti(t));s.aliasExpression.table.name=i}updateAllReferences(e,t,i){let s=this.columnReferenceCollector.collect(e);for(let e of s)if(e.namespaces&&e.namespaces.length>0)for(let s of e.namespaces)if(s.name===t){s.name=i;break}let n=this.tableSourceCollector.collect(e);for(let e of n)e.getSourceName()===t&&(e.qualifiedName.name instanceof l||("name"in e.qualifiedName.name?e.qualifiedName.name.name=i:e.qualifiedName.name.value=i));this.updateTableSourcesInCTEs(e,t,i)}updateTableSourcesInCTEs(e,t,i){if(e.withClause&&e.withClause.tables)for(let s of e.withClause.tables)this.updateTableSourcesInQuery(s.query,t,i)}updateTableSourcesInQuery(e,t,i){if(e.fromClause&&e.fromClause.source.datasource&&this.updateTableSource(e.fromClause.source.datasource,t,i),e.fromClause&&e.fromClause.joins)for(let s of e.fromClause.joins)s.source.datasource&&this.updateTableSource(s.source.datasource,t,i)}updateTableSource(e,t,i){if(!e||"object"!=typeof e)return;let s=e;if("function"==typeof s.getSourceName)try{if(s.getSourceName()===t&&s.qualifiedName&&"object"==typeof s.qualifiedName){let e=s.qualifiedName;if(e.name&&"object"==typeof e.name){let t=e.name;"name"in t&&"string"==typeof t.name?t.name=i:"value"in t&&"string"==typeof t.value&&(t.value=i)}}}catch(e){console.warn("Warning: Failed to update table source:",e)}}},bi=class e{constructor(){this.jsonColumnCounter=0,this.entityToJsonColumnMap=new Map,this.columnMappings=[]}static{this.CTE_OBJECT_PREFIX="cte_object_depth_"}static{this.WILDCARD_COLUMN="*"}buildObjectEntityCtes(t,i,s){this.jsonColumnCounter=0,this.entityToJsonColumnMap.clear(),this.columnMappings=[];let n=[t],r=t.aliasExpression.table.name,a=this.collectAndSortObjectEntities(s,i),o=this.groupEntitiesByDepth(a),l=Array.from(o.keys()).sort((e,t)=>t-e);for(let t of l){let a=o.get(t),l=`${e.CTE_OBJECT_PREFIX}${t}`,u=this.buildDepthCte(a,r,l,s,i);n.push(u),r=l}return{ctes:n,lastCteAlias:r,columnMappings:this.columnMappings}}generateUniqueJsonColumnName(e,t,i){this.jsonColumnCounter++;let s=`${e.toLowerCase()}_json_${this.jsonColumnCounter}`;return this.columnMappings.push({entityId:t,entityName:e,generatedColumnName:s,depth:i}),s}collectAndSortObjectEntities(e,t){let i=[],s=i=>{let s=t.get(i);if(!s)throw new Error(`Entity ${i} not found for depth calculation.`);if(s.isRoot)return 0;if(!s.parentId)return 1;let n=s.parentId,r=0,a=new Set;for(a.add(i);n;){if(a.has(n))throw new Error(`Circular dependency detected: ${n} already visited in path for ${i}`);a.add(n);let s=t.get(n);if(!s)throw new Error(`Parent entity ${n} not found during depth calculation for ${i}`);let o=!1;if(s.isRoot)o=!0;else{let t=e.nestedEntities.find(e=>e.id===n);if(!t)throw new Error(`Parent entity ${n} (ancestor of ${i}) has no definition in mapping.nestedEntities and is not root.`);"object"===t.relationshipType&&(o=!0)}if(o&&r++,s.isRoot)break;n=s.parentId}return r};return e.nestedEntities.forEach(e=>{if("object"===e.relationshipType){let n=t.get(e.id);n&&!n.isRoot&&i.push({entity:n,depth:s(e.id)})}}),i}groupEntitiesByDepth(e){let t=new Map;return e.forEach(e=>{let i=e.depth;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}buildDepthCte(t,i,s,n,r){let a=[new q(new l(null,new S(e.WILDCARD_COLUMN)))];for(let{entity:e}of t){let t=this.buildEntityJsonColumn(e,n,r);a.push(t)}let o=new Dt({selectClause:new Q(a),fromClause:new re(new te(new Y(null,new S(i)),null),null)});return new ae(o,new de(s,null),null)}buildEntityJsonColumn(e,t,i){let{jsonObjectArgs:s,nullChecks:n}=this.prepareEntityColumns(e);this.addChildObjectRelationships(e,s,t,i);let r=this.createJsonObject(s),a=this.buildNullCondition(n),o=this.createCaseExpression(a,r),l=this.calculateApproximateDepth(e,t),u=this.generateUniqueJsonColumnName(e.name,e.id,l);return this.entityToJsonColumnMap.set(e.id,u),new q(o,u)}calculateApproximateDepth(e,t){if(e.isRoot)return 0;if(!e.parentId)return 1;let i=1,s=e.parentId;for(;s&&s!==t.rootEntity.id;){let e=t.nestedEntities.find(e=>e.id===s);if(!e)break;i++,s=e.parentId}return i}prepareEntityColumns(e){let t=[],i=[];return Object.entries(e.columns).forEach(([e,s])=>{t.push(new C(e)),t.push(new l(null,new S(s))),i.push(new y(new l(null,new S(s)),"is",new C(null)))}),{jsonObjectArgs:t,nullChecks:i}}addChildObjectRelationships(e,t,i,s){i.nestedEntities.filter(t=>t.parentId===e.id&&"object"===t.relationshipType).forEach(e=>{let i=s.get(e.id);if(i){t.push(new C(e.propertyName));let s=this.entityToJsonColumnMap.get(i.id);if(!s)throw new Error(`JSON column name not found for child entity: ${i.id}`);t.push(new l(null,new S(s)))}})}createJsonObject(e){return new u(null,new x("jsonb_build_object"),new o(e),null)}buildNullCondition(e){return e.reduce((e,t)=>e?new y(e,"and",t):t)}createCaseExpression(e,t){return new b(null,new g([new E(e,new C(null))],t))}},Ni=class e{static{this.CTE_ARRAY_PREFIX="cte_array_depth_"}static{this.JSON_FUNCTIONS={BUILD_OBJECT:"jsonb_build_object",AGGREGATE:"jsonb_agg"}}buildArrayEntityCtes(e,t,i,s,n){let r=[...e],a=t,o=this.collectAndSortArrayEntities(s,i);if(0===o.length)return{updatedCtes:r,lastCteAlias:a};let l=this.groupEntitiesByDepth(o),u=Array.from(l.keys()).sort((e,t)=>t-e);for(let e of u){let t=l.get(e),{cte:i,newCteAlias:o}=this.buildDepthCte(t,a,r,e,s,n);r.push(i),a=o}return{updatedCtes:r,lastCteAlias:a}}collectAndSortArrayEntities(e,t){let i=[],s=e=>{let i=t.get(e);return!i||i.isRoot?0:i.parentId?1+s(i.parentId):1};return e.nestedEntities.forEach(e=>{if("array"===e.relationshipType){let n=t.get(e.id),r=t.get(e.parentId);if(!n||!r)throw new Error(`Configuration error: Array entity '${e.id}' or its parent '${e.parentId}' not found.`);let a=Object.values(r.columns);if(0===a.length)throw new Error(`Configuration error: Parent entity '${r.name}' (ID: ${r.id}) must have at least one column defined to serve as a linking key for child array '${e.name}'.`);let o=a[0];i.push({entity:n,parentEntity:r,parentIdColumnSqlName:o,depth:s(e.id)})}}),i.sort((e,t)=>t.depth-e.depth),i}groupEntitiesByDepth(e){let t=new Map;return e.forEach(e=>{let i=e.depth;t.has(i)||t.set(i,[]),t.get(i).push(e)}),t}buildDepthCte(t,i,s,n,r,a){let o=new Set;t.forEach(e=>{Object.values(e.entity.columns).forEach(e=>o.add(e));let t=e=>{r.nestedEntities.filter(t=>t.parentId===e).forEach(e=>{Object.values(e.columns).forEach(e=>{let t="string"==typeof e?e:e.column;o.add(t)}),t(e.id)})};t(e.entity.id)});let l=s.find(e=>e.aliasExpression.table.name===i)?.query;if(!l)throw new Error(`CTE not found: ${i}`);let u=new gt(null,s).collect(l),h=[],c=[],p=new Set;t.forEach(e=>{Object.values(e.entity.columns).forEach(e=>p.add(e))});let d=this.collectArrayEntityColumnsByDepth(r,n),m=new Set;a&&t.forEach(e=>{r.nestedEntities.filter(t=>t.parentId===e.entity.id&&"object"===t.relationshipType).forEach(e=>{let t=a.find(t=>t.entityId===e.id);t&&m.add(t.generatedColumnName)})}),this.processSelectVariablesForGroupBy(u,o,d,n,c,h,m);for(let e of t){let t=this.buildAggregationDetailsForArrayEntity(e.entity,r.nestedEntities,new Map,a);c.push(new q(t.jsonAgg,e.entity.propertyName))}let f=`${e.CTE_ARRAY_PREFIX}${n}`,w=new Dt({selectClause:new Q(c),fromClause:new re(new te(new Y(null,new S(i)),null),null),groupByClause:h.length>0?new z(h):null});return{cte:new ae(w,new de(f,null),null),newCteAlias:f}}buildAggregationDetailsForArrayEntity(t,i,s,n){let r=e.JSON_FUNCTIONS.BUILD_OBJECT,a=[];Object.entries(t.columns).forEach(([e,t])=>{a.push(new C(e)),a.push(new l(null,new S(t)))}),i.filter(e=>e.parentId===t.id).forEach(e=>{let t=e.originalPropertyName||e.propertyName;if(a.push(new C(t)),"object"===e.relationshipType){if(!n)throw new Error(` PostgresArrayEntityCteBuilder Error: Column mappings not provided\n\n Details:\n  - Entity ID: ${e.id}\n  - Entity Name: ${e.name||"unknown"}\n  - Property Name: ${e.propertyName}\n  - Relationship Type: ${e.relationshipType}\n\n Solution:\n  Column mappings are required for hybrid JSON column naming.\n  This error indicates that PostgresObjectEntityCteBuilder did not\n  pass column mappings to PostgresArrayEntityCteBuilder.\n\n Check:\n  1. Ensure PostgresJsonQueryBuilder.buildJsonWithCteStrategy() passes columnMappings\n  2. Verify PostgresObjectEntityCteBuilder.buildObjectEntityCtes() returns columnMappings\n  3. Check that Model-driven mapping conversion generates unique entity IDs`);let t=n.find(t=>t.entityId===e.id);if(!t){let t=n.map(e=>`${e.entityId}  ${e.generatedColumnName}`).join(", ");throw new Error(` PostgresArrayEntityCteBuilder Error: Column mapping not found\n\n Details:\n  - Looking for Entity ID: ${e.id}\n  - Entity Name: ${e.name||"unknown"}\n  - Property Name: ${e.propertyName}\n  - Relationship Type: ${e.relationshipType}\n\n Available Mappings:\n  ${t||"None"}\n\n Solution:\n  Entity IDs must match between mapping generation and usage.\n  This suggests a mismatch in entity ID generation or processing.\n\n Check:\n  1. Model-driven mapping conversion generates consistent entity IDs\n  2. PostgresObjectEntityCteBuilder processes all entities correctly\n  3. Entity hierarchy and parentId relationships are correct`)}a.push(new l(null,new S(t.generatedColumnName)))}else"array"===e.relationshipType&&a.push(new l(null,new S(e.propertyName)))});let h=new u(null,new x(r),new o(a),null),c=e.JSON_FUNCTIONS.AGGREGATE;return Object.values(t.columns)[0],{jsonAgg:new u(null,new x(c),new o([h]),null)}}collectArrayEntityColumnsByDepth(e,t){let i=new Map,s=Math.max(t+3,5);for(let e=t;e<=s;e++)i.set(e,new Set);return e.nestedEntities.filter(e=>"array"===e.relationshipType).forEach(t=>{let s=this.calculateEntityDepth(t,e);i.has(s)||i.set(s,new Set),this.addEntityColumnsToDepthSet(t,s,i),this.collectDescendantColumns(t.id,s,e,i)}),i}calculateEntityDepth(e,t){let i=0,s=e;for(;s.parentId&&s.parentId!==t.rootEntity.id;)i++,s=t.nestedEntities.find(e=>e.id===s.parentId)||s;return i}addEntityColumnsToDepthSet(e,t,i){Object.values(e.columns).forEach(e=>{let s="string"==typeof e?e:e.column;i.get(t).add(s)})}collectDescendantColumns(e,t,i,s){i.nestedEntities.filter(t=>t.parentId===e).forEach(e=>{this.addEntityColumnsToDepthSet(e,t,s),this.collectDescendantColumns(e.id,t,i,s)})}processSelectVariablesForGroupBy(e,t,i,s,n,r,a){e.forEach(e=>{if(!t.has(e.name)){if(a&&a.has(e.name))return;this.shouldIncludeColumnInGroupBy(e.name,i,s)&&(n.push(new q(new l(null,new S(e.name)),e.name)),e.name.endsWith("_json")||r.push(new l(null,new S(e.name))))}})}shouldIncludeColumnInGroupBy(e,t,i){let s=e.endsWith("_json"),n=!0;for(let[s,r]of t.entries())if(s>=i&&r.has(e)){n=!1;break}return s&&e.startsWith("entity_")&&(n=this.shouldIncludeJsonColumn(e,i)),n}shouldIncludeJsonColumn(e,t){let i=e.match(/entity_(\d+)_json/);return!(i&&t>0)||parseInt(i[1])<=2}},Ii=class{constructor(){this.selectValueCollector=new gt(null),this.objectEntityCteBuilder=new bi,this.arrayEntityCteBuilder=new Ni}validateMapping(e,t){let i=(new gt).collect(e),s=new Set(i.map(e=>e.name));for(let e in t.rootEntity.columns){let i=t.rootEntity.columns[e],n="string"==typeof i?i:i.column;if(!s.has(n))throw new Error(`Validation Error: Column "${n}" for JSON key "${e}" in root entity "${t.rootEntity.name}" not found in the query's select list.`)}let n=new Set([t.rootEntity.id]),r=new Map;t.nestedEntities.forEach(e=>{n.add(e.id),r.has(e.parentId)||r.set(e.parentId,[]),r.get(e.parentId).push(e.id)});for(let e of t.nestedEntities){if(!n.has(e.parentId))throw new Error(`Validation Error: Parent entity with ID "${e.parentId}" for nested entity "${e.name}" (ID: ${e.id}) not found.`);for(let t in e.columns){let i=e.columns[t],n="string"==typeof i?i:i.column;if(!s.has(n))throw new Error(`Validation Error: Column "${n}" for JSON key "${t}" in nested entity "${e.name}" (ID: ${e.id}) not found in the query's select list.`)}}let a=new Set([t.rootEntity.id,...t.nestedEntities.map(e=>e.parentId)]);for(let e of a){let i=t.nestedEntities.filter(t=>t.parentId===e);if(i.filter(e=>"array"===e.relationshipType).length>1){let i=e===t.rootEntity.id?t.rootEntity.name:t.nestedEntities.find(t=>t.id===e)?.name;throw new Error(`Validation Error: Parent entity "${i}" (ID: ${e}) has multiple direct array children. This is not supported.`)}let s=new Set;for(let n of i){if(s.has(n.propertyName)){let i=e===t.rootEntity.id?t.rootEntity.name:t.nestedEntities.find(t=>t.id===e)?.name;throw new Error(`Validation Error: Parent entity "${i}" (ID: ${e}) has duplicate property name "${n.propertyName}" for its children.`)}s.add(n.propertyName)}}}buildJsonQuery(e,t,i){if(!1===i?.jsonb)throw new Error("JSONB must be enabled for PostgreSQL GROUP BY compatibility. JSON type cannot be used in GROUP BY clauses. Please set jsonb: true or omit the jsonb option (defaults to true).");let s=e instanceof Dt?e:Vt.buildSimpleQuery(e);return this.buildJsonWithCteStrategy(s,t)}buildJson(e,t){return console.warn("buildJson is deprecated. Use buildJsonQuery instead."),this.buildJsonQuery(e,t)}buildJsonWithCteStrategy(e,t){this.validateMapping(e,t);let{initialCte:i,initialCteAlias:s}=this.createInitialCte(e),n=[i],r=s,a=new Map;a.set(t.rootEntity.id,{...t.rootEntity,isRoot:!0,propertyName:t.rootName}),t.nestedEntities.forEach(e=>a.set(e.id,{...e,isRoot:!1,propertyName:e.propertyName}));let o=this.objectEntityCteBuilder.buildObjectEntityCtes(i,a,t);n=o.ctes,r=o.lastCteAlias;let l=o.columnMappings,u=this.arrayEntityCteBuilder.buildArrayEntityCtes(n,r,a,t,l);return n=u.updatedCtes,r=u.lastCteAlias,this.buildFinalSelectQuery(n,r,a,t,l)}createInitialCte(e){let t="origin_query";return{initialCte:new ae(e,new de(t,null),null),initialCteAlias:t}}buildFinalSelectQuery(e,t,i,s,n){let r=[...e],a=`cte_root_${s.rootName.toLowerCase().replace(/[^a-z0-9_]/g,"_")}`,h=i.get(s.rootEntity.id);if(!h)throw new Error(`Root entity ${s.rootEntity.id} not found`);if("array"!==s.resultFormat&&s.resultFormat){let e=this.buildEntityJsonObject(h,null,s.nestedEntities,i,n),o=new q(e,s.rootName),u=new ae(new Dt({selectClause:new Q([o]),fromClause:new re(new te(new Y(null,new S(t)),null),null)}),new de(a,null),null);return r.push(u),new Dt({withClause:new oe(!1,r),selectClause:new Q([new q(new l(null,new S(s.rootName)),s.rootName)]),fromClause:new re(new te(new Y(null,new S(a)),null),null),limitClause:new le(new C(1))})}{let e=this.buildEntityJsonObject(h,null,s.nestedEntities,i,n),c=new q(e,s.rootName),p=new ae(new Dt({selectClause:new Q([c]),fromClause:new re(new te(new Y(null,new S(t)),null),null)}),new de(a,null),null);r.push(p);let d=new u(null,new x("jsonb_agg"),new o([new l(null,new S(s.rootName))]),null);return new Dt({withClause:new oe(!1,r),selectClause:new Q([new q(d,`${s.rootName}_array`)]),fromClause:new re(new te(new Y(null,new S(a)),null),null)})}}buildEntityJsonObject(e,t,i,s,n){let r=[];return Object.entries(e.columns).forEach(([e,t])=>{let i="string"==typeof t?t:t.column;r.push(new C(e)),r.push(new l(null,new S(i)))}),i.filter(t=>t.parentId===e.id).forEach(e=>{let t=s.get(e.id);if(t)if(r.push(new C(e.propertyName)),"object"===e.relationshipType){let e=n.find(e=>e.entityId===t.id);if(!e)throw new Error(`Column mapping not found for entity: ${t.id}`);r.push(new l(null,new S(e.generatedColumnName)))}else"array"===e.relationshipType&&r.push(new l(null,new S(e.propertyName)))}),new u(null,new x("jsonb_build_object"),new o(r),null)}};function Ai(e){let t=[],i=0,s={},n=()=>"entity_"+ ++i,r=e=>(s[e]||(s[e]=0),s[e]++,1===s[e]?e:`${e}_${s[e]}`),a=(e,i=null)=>{let s={},o=[];for(let[l,u]of Object.entries(e))if("string"==typeof u)s[l]=u;else if("column"in u&&"string"==typeof u.column&&(!("type"in u)||"object"!==u.type&&"array"!==u.type)){let e=u;"object"==typeof e&&"column"in e&&(s[l]=e.column,"string"===e.type&&t.push(e.column))}else if("from"in u&&"string"==typeof u.from&&(!("type"in u)||"object"!==u.type&&"array"!==u.type)){let e=u;"object"==typeof e&&"from"in e&&(s[l]=e.from,"string"===e.type&&t.push(e.from))}else if("type"in u&&("object"===u.type||"array"===u.type)){let e=u,t=r(l),s=n(),h=a(e.structure,s);o.push({id:s,name:l.charAt(0).toUpperCase()+l.slice(1),parentId:i||"root",propertyName:t,originalPropertyName:l,relationshipType:e.type,columns:h.columns}),o.push(...h.nestedEntities.map(e=>({...e,parentId:"root"===e.parentId?s:e.parentId})))}return{columns:s,nestedEntities:o}},o=a(e.structure),l={rootName:"root",rootEntity:{id:"root",name:"Root",columns:o.columns},nestedEntities:o.nestedEntities};return l.typeInfo=e.typeInfo,{jsonMapping:l,typeProtection:{protectedStringFields:t}}}function Oi(e){let t=[];return e.typeInfo?(e.typeInfo.interface||t.push("typeInfo.interface is required"),e.typeInfo.importPath||t.push("typeInfo.importPath is required")):t.push("typeInfo is required"),(!e.structure||"object"!=typeof e.structure)&&t.push("structure is required and must be an object"),t}function Pi(e){let t={};for(let[i,s]of Object.entries(e))t[i]="string"==typeof s?s:s&&"object"==typeof s?"column"in s?s.column:"from"in s?s.from:i:i;return t}function $i(e){if(!e)throw new Error("Input mapping is required");if(e.rootName&&e.rootEntity&&"object"==typeof e.rootEntity.columns&&!e.typeInfo&&!e.typeProtection&&!e.metadata&&Object.values(e.rootEntity.columns).every(e=>"string"==typeof e))return e;if(e.rootName&&e.rootEntity)return{rootName:e.rootName,rootEntity:{id:e.rootEntity.id||"root",name:e.rootEntity.name||e.rootName,columns:Pi(e.rootEntity.columns||{})},nestedEntities:(e.nestedEntities||[]).map(e=>({id:e.id,name:e.name,parentId:e.parentId,propertyName:e.propertyName,relationshipType:e.relationshipType,columns:Pi(e.columns||{})})),resultFormat:e.resultFormat,emptyResult:e.emptyResult};throw new Error("Unsupported mapping format")}function Fi(e){return{rootName:e.rootName,rootEntity:{id:e.rootEntity.id,name:e.rootEntity.name,columns:Pi(e.rootEntity.columns)},nestedEntities:e.nestedEntities.map(e=>({id:e.id,name:e.name,parentId:e.parentId,propertyName:e.propertyName,relationshipType:e.relationshipType,columns:Pi(e.columns)})),resultFormat:e.resultFormat,emptyResult:e.emptyResult}}function Li(e){let t=[],i=[],s=[];if(e.typeProtection)return{protectedStringFields:e.typeProtection.protectedStringFields||[],dateFields:e.typeProtection.dateFields,numberFields:e.typeProtection.numberFields,customTransforms:e.typeProtection.customTransforms};for(let[n,r]of Object.entries(e.rootEntity.columns))if("object"==typeof r&&r.type){let e=r.column;switch(r.type){case"string":t.push(e);break;case"date":i.push(e);break;case"number":s.push(e)}}for(let n of e.nestedEntities)for(let[e,r]of Object.entries(n.columns))if("object"==typeof r&&r.type){let e=r.column;switch(r.type){case"string":t.push(e);break;case"date":i.push(e);break;case"number":s.push(e)}}return{protectedStringFields:t,dateFields:i.length>0?i:void 0,numberFields:s.length>0?s:void 0,customTransforms:void 0}}function Ri(e){return null!=e&&"object"==typeof e}var _i=class{detect(e){if(!Ri(e))return!1;let t=e;if(!t||"string"!=typeof t.rootName||!t.rootEntity||!Array.isArray(t.nestedEntities))return!1;if(t.typeInfo||t.typeProtection||t.metadata)return!0;let i=e=>!(!e||"object"!=typeof e)&&Object.values(e).some(e=>"object"==typeof e&&null!==e&&"column"in e);return!!i(t.rootEntity.columns)||t.nestedEntities.some(e=>e&&"object"==typeof e&&i(e.columns))}convert(e){return{format:"enhanced",mapping:Fi(e),typeProtection:Li(e),originalInput:e,metadata:{typeInfo:e.typeInfo,version:e.metadata?.version,description:e.metadata?.description}}}},Bi=class{detect(e){if(!Ri(e))return!1;let t=e;return t&&t.typeInfo&&t.structure&&"string"==typeof t.typeInfo.interface}convert(e){let t=Ai(e);return{format:"model-driven",mapping:t.jsonMapping,typeProtection:t.typeProtection,originalInput:e,metadata:{typeInfo:e.typeInfo}}}},ji=class{detect(e){if(!Ri(e))return!1;let t=e;if(!t||"string"!=typeof t.rootName||!t.rootEntity||"object"!=typeof t.rootEntity.columns||t.typeInfo||t.typeProtection||t.metadata)return!1;let i=e=>!(!e||"object"!=typeof e)&&Object.values(e).some(e=>"object"==typeof e&&null!==e&&"column"in e);return!(i(t.rootEntity.columns)||t.nestedEntities&&Array.isArray(t.nestedEntities)&&t.nestedEntities.some(e=>e&&"object"==typeof e&&i(e.columns)))}convert(e){return{format:"legacy",mapping:e,typeProtection:{protectedStringFields:[]},originalInput:e}}},qi=class{constructor(){this.strategies=[new _i,new Bi,new ji]}detectFormat(e){for(let t of this.strategies)if(t.detect(e))return t.convert(e).format;throw new Error("Unsupported JSON mapping format")}convert(e){for(let t of this.strategies)if(t.detect(e))return t.convert(e);throw new Error("Unsupported JSON mapping format: Unable to detect a compatible strategy for the provided input")}toLegacyMapping(e){return this.convert(e).mapping}getTypeProtection(e){return this.convert(e).typeProtection}validate(e){let t=[];if(!e||"object"!=typeof e)return t.push("Input must be an object"),t;(!("rootName"in e)||!e.rootName)&&t.push("rootName is required");try{let i=this.convert(e);if(i.mapping.rootName||t.push("rootName is required"),i.mapping.rootEntity?(i.mapping.rootEntity.id||t.push("rootEntity.id is required"),i.mapping.rootEntity.columns||t.push("rootEntity.columns is required")):t.push("rootEntity is required"),i.mapping.nestedEntities)for(let e of i.mapping.nestedEntities)e.id||t.push(`Nested entity missing id: ${e.propertyName}`),e.parentId||t.push(`Nested entity missing parentId: ${e.id}`),e.propertyName||t.push(`Nested entity missing propertyName: ${e.id}`)}catch(e){0===t.length&&t.push(`Conversion failed: ${e instanceof Error?e.message:String(e)}`)}return t}upgradeToEnhanced(e,t){return{rootName:e.rootName,rootEntity:{id:e.rootEntity.id,name:e.rootEntity.name,columns:e.rootEntity.columns},nestedEntities:e.nestedEntities.map(e=>({id:e.id,name:e.name,parentId:e.parentId,propertyName:e.propertyName,relationshipType:e.relationshipType||"object",columns:e.columns})),resultFormat:e.resultFormat,emptyResult:e.emptyResult,typeInfo:t,metadata:{version:"1.0",description:"Upgraded from legacy format"}}}};function Qi(e){return e.typeInfo&&e.structure?"model-driven":e.rootName&&e.rootEntity?"unified":(e.columns||e.relationships,"legacy")}function Ui(e){let t={rootName:e.rootName||"root",rootEntity:{id:"root",name:e.rootName||"Root",columns:e.columns||{}},nestedEntities:[]};if(e.relationships&&"object"==typeof e.relationships)for(let[i,s]of Object.entries(e.relationships)){let e=s;t.nestedEntities.push({id:i,name:i.charAt(0).toUpperCase()+i.slice(1),parentId:"root",propertyName:i,relationshipType:"hasMany"===e.type?"array":"object",columns:e.columns||{}})}return t}function Vi(e){if(console.warn(" DEPRECATED: processJsonMapping() is deprecated. Use JsonMappingConverter.convert() instead."),console.warn("Migration guide: https://github.com/mk3008/rawsql-ts/blob/main/docs/migration-guide.md"),(e.columns||e.relationships)&&!e.rootName&&!e.rootEntity)return{format:"legacy",jsonMapping:Ui(e),originalInput:e,metadata:{}};let t=(new qi).convert(e),i=t.format;return"legacy"===t.format&&e.rootName&&e.rootEntity&&(i="unified"),{format:i,jsonMapping:t.mapping,originalInput:e,metadata:{typeInfo:t.metadata?.typeInfo,typeProtection:t.typeProtection}}}function Wi(e){return console.warn(" DEPRECATED: unifyJsonMapping() is deprecated. Use JsonMappingConverter.toLegacyMapping() instead."),console.warn("Migration guide: https://github.com/mk3008/rawsql-ts/blob/main/docs/migration-guide.md"),(new qi).toLegacyMapping(e)}function Di(e){return"model-driven"===Qi(e)}function Mi(e){return"unified"===Qi(e)}function Ki(e){return"legacy"===Qi(e)}var Ji=class{constructor(e={}){this.config={enableValueBasedDetection:!0,strictDateDetection:!1,...e}}transformResult(e){return null==e?e:Array.isArray(e)?e.map(e=>this.transformSingleObject(e)):this.transformSingleObject(e)}transformSingleObject(e){if(null==e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this.transformSingleObject(e));let t={};for(let[i,s]of Object.entries(e)){if(null==s){t[i]=s;continue}let e=this.config.columnTransformations?.[i];if(e){t[i]=this.applyTransformation(s,e);continue}if(this.config.enableValueBasedDetection){let e=this.detectValueBasedTransformation(s);if(e){t[i]=this.applyTransformation(s,e);continue}}let n=this.config.globalTransformations&&this.getGlobalTransformationForValue(s);n?t[i]=this.applyTransformation(s,n):"object"!=typeof s||Array.isArray(s)?Array.isArray(s)?t[i]=s.map(e=>"object"==typeof e?this.transformSingleObject(e):e):t[i]=s:t[i]=this.transformSingleObject(s)}return t}detectValueBasedTransformation(e){return"string"==typeof e&&this.isDateString(e)?{sourceType:"TIMESTAMP",targetType:"Date",handleNull:!0,validator:e=>"string"==typeof e&&!isNaN(Date.parse(e))}:"number"!=typeof e||Number.isSafeInteger(e)?"string"==typeof e&&/^\d{16,}$/.test(e)?{sourceType:"BIGINT",targetType:"bigint",handleNull:!0,validator:e=>{try{return("string"==typeof e||"number"==typeof e||"bigint"==typeof e||"boolean"==typeof e)&&(BigInt(e),!0)}catch{return!1}}}:null:{sourceType:"BIGINT",targetType:"bigint",handleNull:!0,validator:e=>{try{return("string"==typeof e||"number"==typeof e||"bigint"==typeof e||"boolean"==typeof e)&&(BigInt(e),!0)}catch{return!1}}}}getGlobalTransformationForValue(e){return this.config.globalTransformations,null}detectAndGetGlobalTransformation(e){return this.detectValueBasedTransformation(e)}isDateString(e){if(this.config.strictDateDetection){if(!/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d{3})?(?:Z|[+-]\d{2}:\d{2})?$/.test(e))return!1}else if(!/^\d{4}-\d{2}-\d{2}(?:T\d{2}:\d{2}:\d{2}(?:\.\d{3})?(?:Z|[+-]\d{2}:\d{2})?)?$/.test(e))return!1;let t=new Date(e);return!isNaN(t.getTime())}applyTransformation(e,t){if(null==e)return!1!==t.handleNull?e:null;if(t.validator&&!t.validator(e))return console.warn(`TypeTransformationPostProcessor: Value validation failed for ${e}`),e;try{switch(t.targetType){case"Date":return new Date(e);case"bigint":if("number"==typeof e){let t=Math.trunc(e);return BigInt(t.toString())}return BigInt(e);case"string":return e.toString();case"number":return"string"==typeof e?parseFloat(e):Number(e);case"object":return"string"==typeof e?JSON.parse(e):e;case"custom":if(t.customTransformer&&this.config.customTransformers?.[t.customTransformer])return this.config.customTransformers[t.customTransformer](e);break;default:return e}}catch(t){return console.warn(`TypeTransformationPostProcessor: Transformation failed for ${e}:`,t),e}return e}static createDefaultConfig(){return{enableValueBasedDetection:!0,strictDateDetection:!1,globalTransformations:{DATE:{sourceType:"DATE",targetType:"Date",handleNull:!0,validator:e=>"string"==typeof e&&!isNaN(Date.parse(e))},TIMESTAMP:{sourceType:"TIMESTAMP",targetType:"Date",handleNull:!0,validator:e=>"string"==typeof e&&!isNaN(Date.parse(e))},BIGINT:{sourceType:"BIGINT",targetType:"bigint",handleNull:!0,validator:e=>{try{return("string"==typeof e||"number"==typeof e||"bigint"==typeof e||"boolean"==typeof e)&&(BigInt(e),!0)}catch{return!1}}}}}}static createSafeConfig(e){return{enableValueBasedDetection:!1,strictDateDetection:!0,columnTransformations:e||{},globalTransformations:{DATE:{sourceType:"DATE",targetType:"Date",handleNull:!0,validator:e=>"string"==typeof e&&!isNaN(Date.parse(e))},TIMESTAMP:{sourceType:"TIMESTAMP",targetType:"Date",handleNull:!0,validator:e=>"string"==typeof e&&!isNaN(Date.parse(e))},BIGINT:{sourceType:"BIGINT",targetType:"bigint",handleNull:!0,validator:e=>{try{return("string"==typeof e||"number"==typeof e||"bigint"==typeof e||"boolean"==typeof e)&&(BigInt(e),!0)}catch{return!1}}}}}}};function Hi(e,t){return new Ji(t||Ji.createDefaultConfig()).transformResult(e)}var zi={toDate:e=>{if(null==e)return null;let t=new Date(e);return isNaN(t.getTime())?null:t},toBigInt:e=>{if(null==e)return null;try{return BigInt(e)}catch{return null}},toObject:e=>{if(null==e)return null;try{return JSON.parse(e)}catch{return null}}},Gi=class{constructor(e,t,i,s,n){this.id=e,this.label=t,this.type=i,this.shape=s,this.details=n}},Yi=class e extends Gi{constructor(e,t,i){super(e,t,i,"subquery"===i?"hexagon":"cylinder"),this.annotations=new Set}addAnnotation(e){this.annotations.add(e)}hasAnnotation(e){return this.annotations.has(e)}getMermaidRepresentation(){return"hexagon"===this.shape?`${this.id}{{${this.label}}}`:`${this.id}[(${this.label})]`}static createTable(t){return new e(`table_${t}`,t,"table")}static createCTE(t){return new e(`cte_${t}`,`CTE:${t}`,"cte")}static createSubquery(t){return new e(`subquery_${t}`,`SubQuery:${t}`,"subquery")}},Xi=class e extends Gi{constructor(e,t,i=""){super(i?`${i}_${t.toLowerCase().replace(/\s+/g,"_")}`:t.toLowerCase().replace(/\s+/g,"_"),t,"process","hexagon")}getMermaidRepresentation(){return`${this.id}{{${this.label}}}`}static createWhere(t){return new e(`${t}_where`,"WHERE",t)}static createGroupBy(t){return new e(`${t}_group_by`,"GROUP BY",t)}static createHaving(t){return new e(`${t}_having`,"HAVING",t)}static createSelect(t){return new e(`${t}_select`,"SELECT",t)}static createOrderBy(t){return new e(`${t}_order_by`,"ORDER BY",t)}static createLimit(t,i=!1){return new e(`${t}_limit`,i?"LIMIT/OFFSET":"LIMIT",t)}},Zi=class e extends Gi{constructor(e,t,i="diamond"){super(e,t,"operation",i)}getMermaidRepresentation(){switch(this.shape){case"rounded":return`${this.id}(${this.label})`;case"rectangle":return`${this.id}[${this.label}]`;case"hexagon":return`${this.id}{{${this.label}}}`;case"stadium":return`${this.id}([${this.label}])`;default:return`${this.id}{${this.label}}`}}static createJoin(t,i){let s,n=i.trim().toLowerCase();return s="join"===n?"INNER JOIN":n.endsWith(" join")?n.toUpperCase():n.toUpperCase()+" JOIN",new e(`join_${t}`,s,"rectangle")}static createUnion(t,i="UNION ALL"){return new e(`${i.toLowerCase().replace(/\s+/g,"_")}_${t}`,i.toUpperCase(),"rectangle")}static createSetOperation(t,i){let s=i.toUpperCase(),n=`${s.toLowerCase().replace(/\s+/g,"_")}_${t}`;return new e(n,s,"rectangle")}},es=class extends Gi{constructor(e="main"){super(`${e}_output`,"main"===e?"Final Result":`${e} Result`,"output","stadium")}getMermaidRepresentation(){return`${this.id}([${this.label}])`}},ts=class e{constructor(e,t,i){this.from=e,this.to=t,this.label=i}getMermaidRepresentation(){let e=this.label?` --\x3e|${this.label}| `:" --\x3e ";return`${this.from}${e}${this.to}`}static create(t,i,s){return new e(t,i,s)}static createWithNullability(t,i,s){return new e(t,i,s?"NULLABLE":"NOT NULL")}},is=class{constructor(){this.edges=[],this.connectionSet=new Set}add(e){let t=`${e.from}->${e.to}`;this.connectionSet.has(t)||(this.edges.push(e),this.connectionSet.add(t))}addConnection(e,t,i){this.add(ts.create(e,t,i))}addJoinConnection(e,t,i){this.add(ts.createWithNullability(e,t,i))}hasConnection(e,t){return this.connectionSet.has(`${e}->${t}`)}getAll(){return[...this.edges]}getMermaidRepresentation(){return this.edges.map(e=>e.getMermaidRepresentation()).join("\n    ")}},ss=class{constructor(){this.nodes=new Map,this.edges=new is}addNode(e){this.nodes.set(e.id,e)}addEdge(e){this.edges.add(e)}addConnection(e,t,i){this.edges.addConnection(e,t,i)}hasNode(e){return this.nodes.has(e)}hasConnection(e,t){return this.edges.hasConnection(e,t)}getNode(e){return this.nodes.get(e)}getAllNodes(){return Array.from(this.nodes.values())}getAllEdges(){return this.edges.getAll()}generateMermaid(e="TD",t){let i=`flowchart ${e}\n`;t&&(i+=`    %% ${t}\n`);let s=Array.from(this.nodes.values()).map(e=>`    ${e.getMermaidRepresentation()}`).join("\n");s&&(i+=s+"\n"),this.nodes.size>0&&this.edges.getAll().length>0&&(i+="\n");let n=this.edges.getMermaidRepresentation();return n&&(i+=`    ${n}\n`),i}getOrCreateTable(e){let t=`table_${e}`,i=this.nodes.get(t);return i||(i=Yi.createTable(e),this.addNode(i)),i}getOrCreateCTE(e){let t=`cte_${e}`,i=this.nodes.get(t);return i||(i=Yi.createCTE(e),this.addNode(i)),i}getOrCreateSubquery(e){let t=`subquery_${e}`,i=this.nodes.get(t);return i||(i=Yi.createSubquery(e),this.addNode(i)),i}createProcessNode(e,t){let i=new Xi(t,e);return this.addNode(i),i}createJoinNode(e,t){let i=Zi.createJoin(e,t);return this.addNode(i),i}createSetOperationNode(e,t){let i=Zi.createSetOperation(e,t);return this.addNode(i),i}createOutputNode(e="main"){let t=new es(e);return this.addNode(t),t}},ns=class{constructor(e){this.graph=e}processSource(e,t,i){if(e.datasource instanceof Y)return this.processTableSource(e.datasource,t);if(e.datasource instanceof ee)return this.processSubquerySource(e,t,i);throw new Error("Unsupported source type")}processTableSource(e,t){let i=e.getSourceName();return t.has(i)?this.graph.getOrCreateCTE(i).id:this.graph.getOrCreateTable(i).id}processSubquerySource(e,t,i){let s=e.aliasExpression?.table.name||"subquery",n=this.graph.getOrCreateSubquery(s),r=i(e.datasource.query,`subquery_${s}_internal`,t);return r&&!this.graph.hasConnection(r,n.id)&&this.graph.addConnection(r,n.id),n.id}extractTableNodeIds(e,t){let i=[],s=e.source;if(s.datasource instanceof Y){let e=s.datasource.getSourceName();if(t.has(e)){let t=this.graph.getOrCreateCTE(e);i.push(t.id)}else{let t=this.graph.getOrCreateTable(e);i.push(t.id)}}if(e.joins&&e.joins.length>0)for(let s of e.joins){let e=s.source;if(e.datasource instanceof Y){let s=e.datasource.getSourceName();if(t.has(s)){let e=this.graph.getOrCreateCTE(s);i.push(e.id)}else{let e=this.graph.getOrCreateTable(s);i.push(e.id)}}}return i}},rs=class{constructor(e,t){this.graph=e,this.dataSourceHandler=t,this.joinIdCounter=0}resetJoinCounter(){this.joinIdCounter=0}getNextJoinId(){return String(++this.joinIdCounter)}processFromClause(e,t,i){let s=this.dataSourceHandler.processSource(e.source,t,i);return e.joins&&e.joins.length>0?this.processJoins(e.joins,s,t,i):s}processJoins(e,t,i,s){let n=t;for(let t of e){let e=this.dataSourceHandler.processSource(t.source,i,s),r=this.getNextJoinId(),a=this.graph.createJoinNode(r,t.joinType.value),{leftLabel:o,rightLabel:l}=this.getJoinNullabilityLabels(t.joinType.value);n&&!this.graph.hasConnection(n,a.id)&&this.graph.addConnection(n,a.id,o),e&&!this.graph.hasConnection(e,a.id)&&this.graph.addConnection(e,a.id,l),n=a.id}return n}getJoinNullabilityLabels(e){switch(e.toLowerCase()){case"left join":return{leftLabel:"NOT NULL",rightLabel:"NULLABLE"};case"right join":return{leftLabel:"NULLABLE",rightLabel:"NOT NULL"};case"inner join":case"join":case"cross join":return{leftLabel:"NOT NULL",rightLabel:"NOT NULL"};case"full join":case"full outer join":return{leftLabel:"NULLABLE",rightLabel:"NULLABLE"};default:return{leftLabel:"",rightLabel:""}}}},as=class{constructor(e,t){this.graph=e,this.dataSourceHandler=t}processQueryClauses(e,t,i,s,n){return i}},os=class{constructor(e){this.graph=e}processCTEs(e,t,i){for(let i=0;i<e.tables.length;i++){let s=e.tables[i].getSourceAliasName(),n=this.graph.getOrCreateCTE(s);t.add(s),e.recursive&&0===i&&n.addAnnotation("recursive")}for(let s=0;s<e.tables.length;s++){let n=e.tables[s],r=n.getSourceAliasName(),a=this.graph.getOrCreateCTE(r),o=i(n.query,`cte_${r}`,t);if(o&&!this.graph.hasConnection(o,a.id)){let t=e.recursive&&0===s?"RECURSIVE":void 0;this.graph.addConnection(o,a.id,t)}}}detectRecursiveReference(e,t){return e.toString().toLowerCase().includes(t.toLowerCase())}},ls=class e{constructor(){this.graph=new ss,this.dataSourceHandler=new ns(this.graph),this.joinHandler=new rs(this.graph,this.dataSourceHandler),this.processHandler=new as(this.graph,this.dataSourceHandler),this.cteHandler=new os(this.graph)}generateMermaidFlow(e,t){this.graph=new ss,this.dataSourceHandler=new ns(this.graph),this.joinHandler=new rs(this.graph,this.dataSourceHandler),this.processHandler=new as(this.graph,this.dataSourceHandler),this.cteHandler=new os(this.graph),this.joinHandler.resetJoinCounter();let i="string"==typeof e?pi.parse(e):e,s=new Set;return this.processQuery(i,"main",s),this.graph.generateMermaid(t?.direction||"TD",t?.title)}static generate(t){return(new e).generateMermaidFlow(t)}processQuery(e,t,i){if(e instanceof Dt)return this.processSimpleQuery(e,t,i);if(e instanceof Mt)return this.processBinaryQuery(e,t,i);throw new Error("Unsupported query type")}processSimpleQuery(e,t,i){e.withClause&&this.cteHandler.processCTEs(e.withClause,i,this.processQuery.bind(this));let s="";return e.fromClause&&(s=e.fromClause.joins&&e.fromClause.joins.length>0?this.joinHandler.processFromClause(e.fromClause,i,this.processQuery.bind(this)):this.dataSourceHandler.processSource(e.fromClause.source,i,this.processQuery.bind(this))),s&&(s=this.processHandler.processQueryClauses(e,t,s,i,this.processQuery.bind(this))),this.handleOutputNode(s,t)}processBinaryQuery(e,t,i){let s=this.flattenBinaryChain(e,e.operator.value);return s.length>2?this.processMultiPartOperation(s,e.operator.value,t,i):this.processSimpleBinaryOperation(e,t,i)}processSimpleBinaryOperation(e,t,i){let s=this.processQuery(e.left,`${t}_left`,i),n=this.processQuery(e.right,`${t}_right`,i),r="main"===t?"main":t.replace(/^cte_/,""),a=this.graph.createSetOperationNode(r,e.operator.value);return s&&!this.graph.hasConnection(s,a.id)&&this.graph.addConnection(s,a.id),n&&!this.graph.hasConnection(n,a.id)&&this.graph.addConnection(n,a.id),a.id}processMultiPartOperation(e,t,i,s){let n=[],r="main"===i?"main":i.replace(/^cte_/,""),a=this.graph.createSetOperationNode(r,t);for(let t=0;t<e.length;t++){let r=`${i}_part${t+1}`,a=this.processQuery(e[t],r,s);n.push(a)}for(let e of n)e&&!this.graph.hasConnection(e,a.id)&&this.graph.addConnection(e,a.id);return a.id}handleOutputNode(e,t){if("main"===t){let i=this.graph.createOutputNode(t);return e&&this.graph.addConnection(e,i.id),i.id}return e}flattenBinaryChain(e,t){let i=[],s=e=>{e instanceof Mt&&e.operator.value===t?(s(e.left),s(e.right)):i.push(e)};return s(e),i}},us=class{constructor(e,t){"function"==typeof e?(this.tableColumnResolver=e,this.options=t||{}):(this.tableColumnResolver=void 0,this.options=e||{})}inject(e,t){"string"==typeof e&&(e=pi.parse(e));let i=new qt(this.tableColumnResolver,this.options),s=new Lt(this.tableColumnResolver),n=e=>this.options.ignoreCaseAndUnderscore?e.toLowerCase().replace(/_/g,""):e,r=["min","max","like","ilike","in","any","=","<",">","!=","<>","<=",">=","or","and","column"],a=Object.values(t);if(a.length>0&&a.every(e=>void 0===e)&&!this.options.allowAllUndefined)throw new Error("All parameters are undefined. This would result in fetching all records. Use allowAllUndefined: true option to explicitly allow this behavior.");for(let[a,o]of Object.entries(t))void 0!==o&&this.processStateParameter(a,o,e,i,s,n,r,h,l,p,d,c);function l(e,t,i,s,n,r){for(let r=0;r<i.length;r++){let a=i[r],l=a.column||t,h=n.find(e=>s(e.name)===s(l));if(!h)throw new Error(`Column '${l}' not found in query for AND condition`);let c=h.value;if("="in a&&void 0!==a["="]){let i=new v(`${t}_and_${r}_eq`,a["="]);e.appendWhere(new y(c,"=",i))}if("min"in a&&void 0!==a.min){let i=new v(`${t}_and_${r}_min`,a.min);e.appendWhere(new y(c,">=",i))}if("max"in a&&void 0!==a.max){let i=new v(`${t}_and_${r}_max`,a.max);e.appendWhere(new y(c,"<=",i))}if("like"in a&&void 0!==a.like){let i=new v(`${t}_and_${r}_like`,a.like);e.appendWhere(new y(c,"like",i))}if("ilike"in a&&void 0!==a.ilike){let i=new v(`${t}_and_${r}_ilike`,a.ilike);e.appendWhere(new y(c,"ilike",i))}if("in"in a&&void 0!==a.in){let i=a.in.map((e,i)=>new v(`${t}_and_${r}_in_${i}`,e));e.appendWhere(new y(c,"in",new T(new o(i))))}if("any"in a&&void 0!==a.any){let i=new v(`${t}_and_${r}_any`,a.any);e.appendWhere(new y(c,"=",new u(null,"any",i,null)))}if("<"in a&&void 0!==a["<"]){let i=new v(`${t}_and_${r}_lt`,a["<"]);e.appendWhere(new y(c,"<",i))}if(">"in a&&void 0!==a[">"]){let i=new v(`${t}_and_${r}_gt`,a[">"]);e.appendWhere(new y(c,">",i))}if("!="in a&&void 0!==a["!="]){let i=new v(`${t}_and_${r}_neq`,a["!="]);e.appendWhere(new y(c,"!=",i))}if("<>"in a&&void 0!==a["<>"]){let i=new v(`${t}_and_${r}_ne`,a["<>"]);e.appendWhere(new y(c,"<>",i))}if("<="in a&&void 0!==a["<="]){let i=new v(`${t}_and_${r}_le`,a["<="]);e.appendWhere(new y(c,"<=",i))}if(">="in a&&void 0!==a[">="]){let i=new v(`${t}_and_${r}_ge`,a[">="]);e.appendWhere(new y(c,">=",i))}}}function h(e,t,i,s,n,r){let a=[];for(let e=0;e<i.length;e++){let r=i[e],l=r.column||t,h=n.find(e=>s(e.name)===s(l));if(!h)throw new Error(`Column '${l}' not found in query for OR condition`);let c=h.value,p=[];if("="in r&&void 0!==r["="]){let i=new v(`${t}_or_${e}_eq`,r["="]);p.push(new y(c,"=",i))}if("min"in r&&void 0!==r.min){let i=new v(`${t}_or_${e}_min`,r.min);p.push(new y(c,">=",i))}if("max"in r&&void 0!==r.max){let i=new v(`${t}_or_${e}_max`,r.max);p.push(new y(c,"<=",i))}if("like"in r&&void 0!==r.like){let i=new v(`${t}_or_${e}_like`,r.like);p.push(new y(c,"like",i))}if("ilike"in r&&void 0!==r.ilike){let i=new v(`${t}_or_${e}_ilike`,r.ilike);p.push(new y(c,"ilike",i))}if("in"in r&&void 0!==r.in){let i=r.in.map((i,s)=>new v(`${t}_or_${e}_in_${s}`,i));p.push(new y(c,"in",new T(new o(i))))}if("any"in r&&void 0!==r.any){let i=new v(`${t}_or_${e}_any`,r.any);p.push(new y(c,"=",new u(null,"any",i,null)))}if("<"in r&&void 0!==r["<"]){let i=new v(`${t}_or_${e}_lt`,r["<"]);p.push(new y(c,"<",i))}if(">"in r&&void 0!==r[">"]){let i=new v(`${t}_or_${e}_gt`,r[">"]);p.push(new y(c,">",i))}if("!="in r&&void 0!==r["!="]){let i=new v(`${t}_or_${e}_neq`,r["!="]);p.push(new y(c,"!=",i))}if("<>"in r&&void 0!==r["<>"]){let i=new v(`${t}_or_${e}_ne`,r["<>"]);p.push(new y(c,"<>",i))}if("<="in r&&void 0!==r["<="]){let i=new v(`${t}_or_${e}_le`,r["<="]);p.push(new y(c,"<=",i))}if(">="in r&&void 0!==r[">="]){let i=new v(`${t}_or_${e}_ge`,r[">="]);p.push(new y(c,">=",i))}if(p.length>0){let e=p[0];for(let t=1;t<p.length;t++)e=new y(e,"and",p[t]);p.length>1?a.push(new T(e)):a.push(e)}}if(a.length>0){let t=a[0];for(let e=1;e<a.length;e++)t=new y(t,"or",a[e]);e.appendWhere(new T(t))}}function c(e,t,i){Object.keys(e).forEach(e=>{if(!t.includes(e))throw new Error(`Unsupported operator '${e}' for state key '${i}'`)})}function p(e,t,i,s){let n=new v(i,s);e.appendWhere(new y(t,"=",n))}function d(e,t,i,s){let n=[];if("="in s){let e=new v(i,s["="]);n.push(new y(t,"=",e))}if("min"in s){let e=new v(i+"_min",s.min);n.push(new y(t,">=",e))}if("max"in s){let e=new v(i+"_max",s.max);n.push(new y(t,"<=",e))}if("like"in s){let e=new v(i+"_like",s.like);n.push(new y(t,"like",e))}if("ilike"in s){let e=new v(i+"_ilike",s.ilike);n.push(new y(t,"ilike",e))}if("in"in s){let e=s.in.map((e,t)=>new v(`${i}_in_${t}`,e));n.push(new y(t,"in",new T(new o(e))))}if("any"in s){let e=new v(i+"_any",s.any);n.push(new y(t,"=",new u(null,"any",e,null)))}if("<"in s){let e=new v(i+"_lt",s["<"]);n.push(new y(t,"<",e))}if(">"in s){let e=new v(i+"_gt",s[">"]);n.push(new y(t,">",e))}if("!="in s){let e=new v(i+"_neq",s["!="]);n.push(new y(t,"!=",e))}if("<>"in s){let e=new v(i+"_ne",s["<>"]);n.push(new y(t,"<>",e))}if("<="in s){let e=new v(i+"_le",s["<="]);n.push(new y(t,"<=",e))}if(">="in s){let e=new v(i+"_ge",s[">="]);n.push(new y(t,">=",e))}if(1===n.length)e.appendWhere(n[0]);else if(n.length>1){let t=n[0];for(let e=1;e<n.length;e++)t=new y(t,"and",n[e]);e.appendWhere(new T(t))}}return e}isOrCondition(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"or"in e}isAndCondition(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"and"in e}isExplicitColumnMapping(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"column"in e&&!("or"in e)}isValidatableObject(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&Object.getPrototypeOf(e)===Object.prototype}hasColumnMapping(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"column"in e}isSimpleValue(e){return null===e||"object"!=typeof e||Array.isArray(e)||e instanceof Date}processStateParameter(e,t,i,s,n,r,a,o,l,u,h,c){if(this.isOrCondition(t)){let a=t.or;if(a&&a.length>0){let t=this.findTargetQueryForLogicalCondition(s,i,e,a),l=this.getAllAvailableColumns(t,n);return void o(t,e,a,r,l,n)}}if(this.isAndCondition(t)){let a=t.and;if(a&&a.length>0){let t=this.findTargetQueryForLogicalCondition(s,i,e,a),o=this.getAllAvailableColumns(t,n);return void l(t,e,a,r,o,n)}}if(this.isExplicitColumnMapping(t)){let o=t.column;if(o){let l=s.find(i,o);if(0===l.length)throw new Error(`Explicit column '${o}' not found in query`);for(let i of l){let s=this.getAllAvailableColumns(i,n).find(e=>r(e.name)===r(o));if(!s)throw new Error(`Explicit column '${o}' not found in query`);this.isValidatableObject(t)&&c(t,a,e),h(i,s.value,e,t)}return}}this.processRegularColumnCondition(e,t,i,s,n,r,a,u,h,c)}processRegularColumnCondition(e,t,i,s,n,r,a,o,l,u){let h=s.find(i,e);if(0===h.length)throw new Error(`Column '${e}' not found in query`);for(let i of h){let s=this.getAllAvailableColumns(i,n),h=s.find(t=>r(t.name)===r(e));if(!h)throw new Error(`Column '${e}' not found in query`);let c=h.value;this.isValidatableObject(t)&&u(t,a,e);let p=c,d=e;if(this.hasColumnMapping(t)){let e=t.column;if(e){let t=s.find(t=>r(t.name)===r(e));t&&(p=t.value,d=e)}}this.isSimpleValue(t)?o(i,p,d,t):l(i,p,d,t)}}findTargetQueryForLogicalCondition(e,t,i,s){let n=s.map(e=>e.column||i).filter((e,t,i)=>i.indexOf(e)===t);for(let i of n){let s=e.find(t,i);if(s.length>0)return s[0]}let r=s===s.or?"OR":"AND";throw new Error(`None of the ${r} condition columns [${n.join(", ")}] found in query`)}getAllAvailableColumns(e,t){return[...t.collect(e),...this.collectCTEColumns(e)]}collectCTEColumns(e){let t=[];if(e.withClause)for(let i of e.withClause.tables)try{let e=this.collectColumnsFromSelectQuery(i.query);t.push(...e)}catch(e){console.warn(`Failed to collect columns from CTE '${i.getSourceAliasName()}':`,e)}return t}collectColumnsFromSelectQuery(e){return e instanceof Dt?new Lt(this.tableColumnResolver).collect(e):e instanceof Mt?this.collectColumnsFromSelectQuery(e.left):[]}},hs=class{constructor(e){this.tableColumnResolver=e}static removeOrderBy(e){if("string"==typeof e&&(e=pi.parse(e)),!(e instanceof Dt))throw new Error("Complex queries are not supported for ORDER BY removal");return new Dt({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:null,windowClause:e.windowClause,limitClause:e.limitClause,offsetClause:e.offsetClause,fetchClause:e.fetchClause,forClause:e.forClause})}inject(e,t){if("string"==typeof e&&(e=pi.parse(e)),!(e instanceof Dt))throw new Error("Complex queries are not supported for sorting");let i=new Lt(this.tableColumnResolver).collect(e);for(let e of Object.keys(t))if(!i.find(t=>t.name===e))throw new Error(`Column or alias '${e}' not found in current query`);let s=[];for(let[e,n]of Object.entries(t)){let t=i.find(t=>t.name===e);if(!t)continue;let r,a=t.value;this.validateSortCondition(e,n),r=n.desc?"desc":"asc";let o=null;n.nullsFirst?o="first":n.nullsLast&&(o="last");let l=new H(a,r,o);s.push(l)}let n=[];n=e.orderByClause?[...e.orderByClause.order,...s]:s;let r=n.length>0?new J(n):null;return new Dt({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:r,windowClause:e.windowClause,limitClause:e.limitClause,offsetClause:e.offsetClause,fetchClause:e.fetchClause,forClause:e.forClause})}validateSortCondition(e,t){if(t.asc&&t.desc)throw new Error(`Conflicting sort directions for column '${e}': both asc and desc specified`);if(t.nullsFirst&&t.nullsLast)throw new Error(`Conflicting nulls positions for column '${e}': both nullsFirst and nullsLast specified`);if(!(t.asc||t.desc||t.nullsFirst||t.nullsLast))throw new Error(`Empty sort condition for column '${e}': at least one sort option must be specified`)}},cs=class{inject(e,t){if(this.validatePaginationOptions(t),"string"==typeof e&&(e=pi.parse(e)),!(e instanceof Dt))throw new Error("Complex queries are not supported for pagination");if(e.limitClause||e.offsetClause)throw new Error("Query already contains LIMIT or OFFSET clause. Use removePagination() first if you want to override existing pagination.");let i=(t.page-1)*t.pageSize,s=new le(new v("paging_limit",t.pageSize)),n=new ue(new v("paging_offset",i));return new Dt({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:e.orderByClause,windowClause:e.windowClause,limitClause:s,offsetClause:n,fetchClause:e.fetchClause,forClause:e.forClause})}static removePagination(e){if("string"==typeof e&&(e=pi.parse(e)),!(e instanceof Dt))throw new Error("Complex queries are not supported for pagination removal");return new Dt({withClause:e.withClause,selectClause:e.selectClause,fromClause:e.fromClause,whereClause:e.whereClause,groupByClause:e.groupByClause,havingClause:e.havingClause,orderByClause:e.orderByClause,windowClause:e.windowClause,limitClause:null,offsetClause:null,fetchClause:e.fetchClause,forClause:e.forClause})}validatePaginationOptions(e){if(!e)throw new Error("Pagination options are required");if("number"!=typeof e.page||e.page<1)throw new Error("Page number must be a positive integer (1 or greater)");if("number"!=typeof e.pageSize||e.pageSize<1)throw new Error("Page size must be a positive integer (1 or greater)");if(e.pageSize>1e3)throw new Error("Page size cannot exceed 1000 items")}},ps=class{static extractParameterNames(e){return wt.collect(e).map(e=>e.name.value)}static hasParameter(e,t){return this.extractParameterNames(e).includes(t)}static separateFilters(e,t){let i=this.extractParameterNames(e),s={},n={};for(let[e,r]of Object.entries(t))i.includes(e)?s[e]=r:n[e]=r;return{hardcodedParams:s,dynamicFilters:n}}},ds=class{constructor(e={}){this.options={requireAllParameters:!0,...e}}bind(e,t){let i=e,s=ps.extractParameterNames(i);if(this.options.requireAllParameters){let e=s.filter(e=>!(e in t)||void 0===t[e]);if(e.length>0)throw new Error(`Missing values for required parameters: ${e.join(", ")}`)}for(let[e,n]of Object.entries(t))if(s.includes(e))try{Wt.set(i,e,n)}catch(t){throw new Error(`Failed to bind parameter '${e}': ${t instanceof Error?t.message:"Unknown error"}`)}return i}bindToSimpleQuery(e,t){return this.bind(e,t)}},ms=class{constructor(e){this.tableColumnResolver=e}buildQuery(e,t={}){let i;try{i=pi.parse(e)}catch(e){throw new Error(`Failed to parse SQL: ${e instanceof Error?e.message:"Unknown error"}`)}let s=i;if(t.filter&&Object.keys(t.filter).length>0){let{hardcodedParams:e,dynamicFilters:i}=ps.separateFilters(s,t.filter);if(Object.keys(e).length>0&&(s=new ds({requireAllParameters:!1}).bind(s,e)),Object.keys(i).length>0){let e=new us(this.tableColumnResolver),t=Vt.buildSimpleQuery(s);s=e.inject(t,i)}}if(t.sort&&Object.keys(t.sort).length>0){let e=new hs(this.tableColumnResolver),i=Vt.buildSimpleQuery(s);s=e.inject(i,t.sort)}if(t.paging){let{page:e=1,pageSize:i}=t.paging;if(void 0!==i){let t=new cs,n={page:e,pageSize:i},r=Vt.buildSimpleQuery(s);s=t.inject(r,n)}}if(t.serialize&&"object"==typeof t.serialize){let e=new Ii,i=Vt.buildSimpleQuery(s);s=e.buildJsonQuery(i,t.serialize)}return s}buildFilteredQuery(e,t){return this.buildQuery(e,{filter:t})}buildSortedQuery(e,t){return this.buildQuery(e,{sort:t})}buildPaginatedQuery(e,t){return this.buildQuery(e,{paging:t})}buildSerializedQuery(e,t){return this.buildQuery(e,{serialize:t})}validateSql(e){try{return pi.parse(e),!0}catch(e){throw new Error(`Invalid SQL: ${e instanceof Error?e.message:"Unknown error"}`)}}},fs=class{static validate(e,t){let i=this.extractStructureFromJsonMapping(e);return this.compareStructures(i,t)}static validateStrict(e,t){let i=this.validate(e,t);if(!i.isValid){let e=["JsonMapping validation failed:",...i.errors].join("\n");throw new Error(e)}}static extractStructureFromJsonMapping(e){let t={};return e.rootEntity&&e.rootEntity.columns&&Object.keys(e.rootEntity.columns).forEach(e=>{t[e]="primitive"}),e.nestedEntities&&e.nestedEntities.filter(t=>t.parentId===e.rootEntity.id).forEach(i=>{i.propertyName&&i.columns&&("object"===i.relationshipType?t[i.propertyName]=this.extractNestedEntityStructure(i,e):"array"===i.relationshipType&&(t[i.propertyName]=[this.extractNestedEntityStructure(i,e)]))}),t}static extractNestedEntityStructure(e,t){let i={};return e.columns&&Object.keys(e.columns).forEach(e=>{i[e]="primitive"}),t.nestedEntities&&t.nestedEntities.filter(t=>t.parentId===e.id).forEach(e=>{e.propertyName&&e.columns&&("object"===e.relationshipType?i[e.propertyName]=this.extractNestedEntityStructure(e,t):"array"===e.relationshipType&&(i[e.propertyName]=[this.extractNestedEntityStructure(e,t)]))}),i}static compareStructures(e,t,i=""){let s=[],n=[],r=[];if("primitive"===e&&"primitive"===t)return{isValid:!0,errors:[],missingProperties:[],extraProperties:[]};if(Array.isArray(t)&&Array.isArray(e)){if(t.length>0&&e.length>0){let a=this.compareStructures(e[0],t[0],`${i}[]`);s.push(...a.errors),n.push(...a.missingProperties),r.push(...a.extraProperties)}return{isValid:0===s.length,errors:s,missingProperties:n,extraProperties:r}}if("object"!=typeof e||"object"!=typeof t||Array.isArray(e)||Array.isArray(t)||null===e||null===t)return{isValid:!0,errors:[],missingProperties:[],extraProperties:[]};let a=e,o=t;return Object.keys(o).forEach(e=>{let t=i?`${i}.${e}`:e;if(!(e in a))return n.push(t),void s.push(`Missing property: ${t}`);let l=a[e],u=o[e],h=this.compareStructures(l,u,t);s.push(...h.errors),n.push(...h.missingProperties),r.push(...h.extraProperties)}),Object.keys(a).forEach(e=>{let t=i?`${i}.${e}`:e;e in o||r.push(t)}),{isValid:0===s.length,errors:s,missingProperties:n,extraProperties:r}}static validateAgainstSample(e,t){let i=this.extractStructureFromSample(t);return this.validate(e,i)}static validateAgainstSampleStrict(e,t){let i=this.validateAgainstSample(e,t);if(!i.isValid){let e=["JsonMapping validation against sample object failed:",...i.errors].join("\n");throw new Error(e)}}static extractStructureFromSample(e){if(null==e)return"primitive";if(Array.isArray(e))return 0===e.length?[]:[this.extractStructureFromSample(e[0])];if("object"==typeof e){let t={};return Object.keys(e).forEach(i=>{t[i]=this.extractStructureFromSample(e[i])}),t}return"primitive"}},ws=class{constructor(e){this.schemas=e,this.validateSchemas()}validateSchemas(){let e=Object.keys(this.schemas),t=[];if(Object.entries(this.schemas).forEach(([i,s])=>{0===Object.entries(s.columns).filter(([e,t])=>t.isPrimaryKey).map(([e,t])=>e).length&&t.push(`Table '${i}' has no primary key defined`),s.relationships?.forEach(s=>{e.includes(s.table)||t.push(`Table '${i}' references unknown table '${s.table}' in relationship`)})}),t.length>0)throw new Error(`Schema validation failed:\\n${t.join("\\n")}`)}getTableColumns(e){let t=this.schemas[e];return t?Object.keys(t.columns):[]}createTableColumnResolver(){return e=>this.getTableColumns(e)}createJsonMapping(e){let t=this.schemas[e];if(!t)throw new Error(`Table '${e}' not found in schema registry`);let i={};Object.entries(t.columns).forEach(([e,t])=>{i[e]=t.jsonAlias||t.name});let s=[];return t.relationships?.forEach(t=>{let i=this.schemas[t.table];if(!i)throw new Error(`Related table '${t.table}' not found in schema registry`);let n={};Object.entries(i.columns).forEach(([e,t])=>{n[e]=t.jsonAlias||t.name});let r=t.type;s.push({id:t.propertyName,name:i.displayName||t.table,parentId:e,propertyName:t.propertyName,relationshipType:r,columns:n})}),{rootName:e,rootEntity:{id:e,name:t.displayName||e,columns:i},nestedEntities:s,resultFormat:"single"}}getTableNames(){return Object.keys(this.schemas)}getTable(e){return this.schemas[e]}getPrimaryKey(e){let t=this.schemas[e];if(!t)return;let i=Object.entries(t.columns).find(([e,t])=>t.isPrimaryKey);return i?i[0]:void 0}getForeignKeys(e){let t=this.schemas[e];if(!t)return[];let i=[];return Object.entries(t.columns).forEach(([e,t])=>{t.foreignKey&&i.push({column:e,referencedTable:t.foreignKey.table,referencedColumn:t.foreignKey.column})}),i}};function ys(e){return new ws(e)}function Cs(e){return new ws(e).createTableColumnResolver()}function vs(e,t){return new ws(e).createJsonMapping(t)}var gs=class{static{this.SQL_COMMANDS=new Set(["select","from","where","and","or","order","by","group","having","limit","offset","as","on","inner","left","right","join","union","insert","update","delete","into","values","set"])}static findLexemeAtPosition(e,t){if(t<0||t>=e.length)return null;let i=this.getAllLexemesWithPosition(e);for(let e of i)if(e.position&&t>=e.position.startPosition&&t<e.position.endPosition)return e;return null}static getAllLexemesWithPosition(e){if(!e?.trim())return[];try{let t=[],i=0;for(;i<e.length&&(i=this.skipWhitespace(e,i),!(i>=e.length));){let s=this.parseNextToken(e,i);s?(t.push(s),i=s.position.endPosition):i++}return t}catch{return[]}}static skipWhitespace(e,t){for(;t<e.length&&/\s/.test(e[t]);)t++;return t}static parseNextToken(e,t){let i=e[t];return"'"===i||'"'===i?this.parseStringLiteral(e,t):/[=<>!+\-*/%().*]/.test(i)?this.parseOperator(e,t):","===i?this.createLexeme(16,",",t,t+1):/[a-zA-Z0-9_]/.test(i)?this.parseWordToken(e,t):null}static parseStringLiteral(e,t){let i=e[t],s=t+1,n=i;for(;s<e.length&&e[s]!==i;)n+=e[s++];return s<e.length&&(n+=e[s++]),this.createLexeme(1,n,t,s)}static parseOperator(e,t){let i=e[t],s=t+1;s<e.length&&/[=<>!]/.test(e[s])&&/[=<>!]/.test(i)&&(i+=e[s++]);let n=this.getOperatorTokenType(i);return this.createLexeme(n,i,t,s)}static parseWordToken(e,t){let i=t,s="";for(;i<e.length&&/[a-zA-Z0-9_]/.test(e[i]);)s+=e[i++];let n=this.getWordTokenType(s,e,i),r=this.shouldLowercase(n)?s.toLowerCase():s;return this.createLexeme(n,r,t,i)}static getOperatorTokenType(e){switch(e){case"(":return 4;case")":return 8;case"*":return 64;default:return 2}}static getWordTokenType(e,t,i){let s=e.toLowerCase();if(this.SQL_COMMANDS.has(s))return 128;let n=this.skipWhitespace(t,i);return n<t.length&&"("===t[n]?2048:64}static shouldLowercase(e){return!!(128&e)||!!(2&e)||!!(2048&e)}static createLexeme(e,t,i,s){return{type:e,value:t,comments:null,position:{startPosition:i,endPosition:s}}}}}}]);